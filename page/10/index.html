<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="æŒç»­ç²¾è¿›">
<meta property="og:type" content="website">
<meta property="og:title" content="Jay&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/10/index.html">
<meta property="og:site_name" content="Jay&#39;s Blog">
<meta property="og:description" content="æŒç»­ç²¾è¿›">
<meta property="og:locale">
<meta property="article:author" content="å²æµ·æ°">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/10/"/>





  <title>Jay's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?1dc984dfc86062a60470cc7297fb0653";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




<meta name="generator" content="Hexo 7.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jay's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">çŸ¥è€Œä¸è¡Œä¸ºä¸çŸ¥</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            å…³äº
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            ç•™è¨€
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            æœç´¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="æœç´¢..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/11/10/atomic-classes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/11/10/atomic-classes/" itemprop="url">Atomic åŸå­ç±»æ€»ç»“</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2022-11-10T20:52:15+08:00">
                2022-11-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ï¼Œ 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/%E5%B9%B6%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">å¹¶å‘</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2022/11/10/atomic-classes/" class="leancloud_visitors" data-flag-title="Atomic åŸå­ç±»æ€»ç»“">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  3k å­—
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  13 åˆ†é’Ÿ
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Atomic-åŸå­ç±»ä»‹ç»"><a href="#Atomic-åŸå­ç±»ä»‹ç»" class="headerlink" title="Atomic åŸå­ç±»ä»‹ç»"></a>Atomic åŸå­ç±»ä»‹ç»</h2><p><code>Atomic</code> ç¿»è¯‘æˆä¸­æ–‡æ˜¯â€œåŸå­â€çš„æ„æ€ã€‚åœ¨åŒ–å­¦ä¸Šï¼ŒåŸå­æ˜¯æ„æˆç‰©è´¨çš„æœ€å°å•ä½ï¼Œåœ¨åŒ–å­¦ååº”ä¸­ä¸å¯åˆ†å‰²ã€‚åœ¨ç¼–ç¨‹ä¸­ï¼Œ<code>Atomic</code> æŒ‡çš„æ˜¯ä¸€ä¸ªæ“ä½œå…·æœ‰åŸå­æ€§ï¼Œå³è¯¥æ“ä½œä¸å¯åˆ†å‰²ã€ä¸å¯ä¸­æ–­ã€‚å³ä½¿åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œæ—¶ï¼Œè¯¥æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå®Œæˆï¼Œè¦ä¹ˆä¸æ‰§è¡Œï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹çœ‹åˆ°éƒ¨åˆ†å®Œæˆçš„çŠ¶æ€ã€‚</p>
<p>åŸå­ç±»ç®€å•æ¥è¯´å°±æ˜¯å…·æœ‰åŸå­æ€§æ“ä½œç‰¹å¾çš„ç±»ã€‚</p>
<p><code>java.util.concurrent.atomic</code> åŒ…ä¸­çš„ <code>Atomic</code> åŸå­ç±»æä¾›äº†ä¸€ç§çº¿ç¨‹å®‰å…¨çš„æ–¹å¼æ¥æ“ä½œå•ä¸ªå˜é‡ã€‚</p>
<p><code>Atomic</code> ç±»ä¾èµ–äº CASï¼ˆCompare-And-Swapï¼Œæ¯”è¾ƒå¹¶äº¤æ¢ï¼‰ä¹è§‚é”æ¥ä¿è¯å…¶æ–¹æ³•çš„åŸå­æ€§ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ä¼ ç»Ÿçš„é”æœºåˆ¶ï¼ˆå¦‚ <code>synchronized</code> å—æˆ– <code>ReentrantLock</code>ï¼‰ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« æˆ‘ä»¬åªä»‹ç» Atomic åŸå­ç±»çš„æ¦‚å¿µï¼Œå…·ä½“å®ç°åŸç†å¯ä»¥é˜…è¯»ç¬”è€…å†™çš„è¿™ç¯‡æ–‡ç« ï¼š<a href="./cas.md">CAS è¯¦è§£</a>ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/JUC%E5%8E%9F%E5%AD%90%E7%B1%BB%E6%A6%82%E8%A7%88.png" alt="JUCåŸå­ç±»æ¦‚è§ˆ"></p>
<p>æ ¹æ®æ“ä½œçš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥å°† JUC åŒ…ä¸­çš„åŸå­ç±»åˆ†ä¸º 4 ç±»ï¼š</p>
<p><strong>1ã€åŸºæœ¬ç±»å‹</strong></p>
<p>ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°åŸºæœ¬ç±»å‹</p>
<ul>
<li><code>AtomicInteger</code>ï¼šæ•´å‹åŸå­ç±»</li>
<li><code>AtomicLong</code>ï¼šé•¿æ•´å‹åŸå­ç±»</li>
<li><code>AtomicBoolean</code>ï¼šå¸ƒå°”å‹åŸå­ç±»</li>
</ul>
<p><strong>2ã€æ•°ç»„ç±»å‹</strong></p>
<p>ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„é‡Œçš„æŸä¸ªå…ƒç´ </p>
<ul>
<li><code>AtomicIntegerArray</code>ï¼šæ•´å‹æ•°ç»„åŸå­ç±»</li>
<li><code>AtomicLongArray</code>ï¼šé•¿æ•´å‹æ•°ç»„åŸå­ç±»</li>
<li><code>AtomicReferenceArray</code>ï¼šå¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»</li>
</ul>
<p><strong>3ã€å¼•ç”¨ç±»å‹</strong></p>
<ul>
<li><code>AtomicReference</code>ï¼šå¼•ç”¨ç±»å‹åŸå­ç±»</li>
<li><code>AtomicMarkableReference</code>ï¼šåŸå­æ›´æ–°å¸¦æœ‰æ ‡è®°çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°† boolean æ ‡è®°ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œ<del>ä¹Ÿå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ ABA é—®é¢˜</del>ã€‚</li>
<li><code>AtomicStampedReference</code>ï¼šåŸå­æ›´æ–°å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°†æ•´æ•°å€¼ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œå¯ç”¨äºè§£å†³åŸå­çš„æ›´æ–°æ•°æ®å’Œæ•°æ®çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ ABA é—®é¢˜ã€‚</li>
</ul>
<p><strong>ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š<a href="https://github.com/Snailclimb/JavaGuide/issues/626">issue#626</a>ï¼‰</strong> : <code>AtomicMarkableReference</code> ä¸èƒ½è§£å†³ ABA é—®é¢˜ã€‚</p>
<p><strong>4ã€å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹</strong></p>
<ul>
<li><code>AtomicIntegerFieldUpdater</code>:åŸå­æ›´æ–°æ•´å‹å­—æ®µçš„æ›´æ–°å™¨</li>
<li><code>AtomicLongFieldUpdater</code>ï¼šåŸå­æ›´æ–°é•¿æ•´å‹å­—æ®µçš„æ›´æ–°å™¨</li>
<li><code>AtomicReferenceFieldUpdater</code>ï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹é‡Œçš„å­—æ®µ</li>
</ul>
<h2 id="åŸºæœ¬ç±»å‹åŸå­ç±»"><a href="#åŸºæœ¬ç±»å‹åŸå­ç±»" class="headerlink" title="åŸºæœ¬ç±»å‹åŸå­ç±»"></a>åŸºæœ¬ç±»å‹åŸå­ç±»</h2><p>ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°åŸºæœ¬ç±»å‹</p>
<ul>
<li><code>AtomicInteger</code>ï¼šæ•´å‹åŸå­ç±»</li>
<li><code>AtomicLong</code>ï¼šé•¿æ•´å‹åŸå­ç±»</li>
<li><code>AtomicBoolean</code>ï¼šå¸ƒå°”å‹åŸå­ç±»</li>
</ul>
<p>ä¸Šé¢ä¸‰ä¸ªç±»æä¾›çš„æ–¹æ³•å‡ ä¹ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä»¥ <code>AtomicInteger</code> ä¸ºä¾‹å­æ¥ä»‹ç»ã€‚</p>
<p><strong><code>AtomicInteger</code> ç±»å¸¸ç”¨æ–¹æ³•</strong> ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> <span class="comment">//è·å–å½“å‰çš„å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndSet</span><span class="params">(<span class="type">int</span> newValue)</span><span class="comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">()</span><span class="comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndDecrement</span><span class="params">()</span> <span class="comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndAdd</span><span class="params">(<span class="type">int</span> delta)</span> <span class="comment">//è·å–å½“å‰çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span> expect, <span class="type">int</span> update)</span> <span class="comment">//å¦‚æœè¾“å…¥çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼ï¼ˆupdateï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lazySet</span><span class="params">(<span class="type">int</span> newValue)</span><span class="comment">//æœ€ç»ˆè®¾ç½®ä¸ºnewValue, lazySet æä¾›äº†ä¸€ç§æ¯” set æ–¹æ³•æ›´å¼±çš„è¯­ä¹‰ï¼Œå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ï¼Œä½†å¯èƒ½æ›´é«˜æ•ˆã€‚</span></span><br></pre></td></tr></table></figure>

<p><strong><code>AtomicInteger</code> ç±»ä½¿ç”¨ç¤ºä¾‹</strong> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ– AtomicInteger å¯¹è±¡ï¼Œåˆå§‹å€¼ä¸º 0</span></span><br><span class="line"><span class="type">AtomicInteger</span> <span class="variable">atomicInt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ getAndSet æ–¹æ³•è·å–å½“å‰å€¼ï¼Œå¹¶è®¾ç½®æ–°å€¼ä¸º 3</span></span><br><span class="line"><span class="type">int</span> <span class="variable">tempValue</span> <span class="operator">=</span> atomicInt.getAndSet(<span class="number">3</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;tempValue: &quot;</span> + tempValue + <span class="string">&quot;; atomicInt: &quot;</span> + atomicInt);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ getAndIncrement æ–¹æ³•è·å–å½“å‰å€¼ï¼Œå¹¶è‡ªå¢ 1</span></span><br><span class="line">tempValue = atomicInt.getAndIncrement();</span><br><span class="line">System.out.println(<span class="string">&quot;tempValue: &quot;</span> + tempValue + <span class="string">&quot;; atomicInt: &quot;</span> + atomicInt);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ getAndAdd æ–¹æ³•è·å–å½“å‰å€¼ï¼Œå¹¶å¢åŠ æŒ‡å®šå€¼ 5</span></span><br><span class="line">tempValue = atomicInt.getAndAdd(<span class="number">5</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;tempValue: &quot;</span> + tempValue + <span class="string">&quot;; atomicInt: &quot;</span> + atomicInt);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ compareAndSet æ–¹æ³•è¿›è¡ŒåŸå­æ€§æ¡ä»¶æ›´æ–°ï¼ŒæœŸæœ›å€¼ä¸º 9ï¼Œæ›´æ–°å€¼ä¸º 10</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">updateSuccess</span> <span class="operator">=</span> atomicInt.compareAndSet(<span class="number">9</span>, <span class="number">10</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;Update Success: &quot;</span> + updateSuccess + <span class="string">&quot;; atomicInt: &quot;</span> + atomicInt);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰å€¼</span></span><br><span class="line"><span class="type">int</span> <span class="variable">currentValue</span> <span class="operator">=</span> atomicInt.get();</span><br><span class="line">System.out.println(<span class="string">&quot;Current value: &quot;</span> + currentValue);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ lazySet æ–¹æ³•è®¾ç½®æ–°å€¼ä¸º 15</span></span><br><span class="line">atomicInt.lazySet(<span class="number">15</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;After lazySet, atomicInt: &quot;</span> + atomicInt);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tempValue: <span class="number">0</span>; atomicInt: <span class="number">3</span></span><br><span class="line">tempValue: <span class="number">3</span>; atomicInt: <span class="number">4</span></span><br><span class="line">tempValue: <span class="number">4</span>; atomicInt: <span class="number">9</span></span><br><span class="line">Update Success: <span class="literal">true</span>; atomicInt: <span class="number">10</span></span><br><span class="line">Current value: <span class="number">10</span></span><br><span class="line">After lazySet, atomicInt: <span class="number">15</span></span><br></pre></td></tr></table></figure>

<h2 id="æ•°ç»„ç±»å‹åŸå­ç±»"><a href="#æ•°ç»„ç±»å‹åŸå­ç±»" class="headerlink" title="æ•°ç»„ç±»å‹åŸå­ç±»"></a>æ•°ç»„ç±»å‹åŸå­ç±»</h2><p>ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„é‡Œçš„æŸä¸ªå…ƒç´ </p>
<ul>
<li><code>AtomicIntegerArray</code>ï¼šæ•´å½¢æ•°ç»„åŸå­ç±»</li>
<li><code>AtomicLongArray</code>ï¼šé•¿æ•´å½¢æ•°ç»„åŸå­ç±»</li>
<li><code>AtomicReferenceArray</code>ï¼šå¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»</li>
</ul>
<p>ä¸Šé¢ä¸‰ä¸ªç±»æä¾›çš„æ–¹æ³•å‡ ä¹ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä»¥ <code>AtomicIntegerArray</code> ä¸ºä¾‹å­æ¥ä»‹ç»ã€‚</p>
<p><strong><code>AtomicIntegerArray</code> ç±»å¸¸ç”¨æ–¹æ³•</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> i)</span> <span class="comment">//è·å– index=i ä½ç½®å…ƒç´ çš„å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndSet</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> newValue)</span><span class="comment">//è¿”å› index=i ä½ç½®çš„å½“å‰çš„å€¼ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºæ–°å€¼ï¼šnewValue</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">(<span class="type">int</span> i)</span><span class="comment">//è·å– index=i ä½ç½®å…ƒç´ çš„å€¼ï¼Œå¹¶è®©è¯¥ä½ç½®çš„å…ƒç´ è‡ªå¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndDecrement</span><span class="params">(<span class="type">int</span> i)</span> <span class="comment">//è·å– index=i ä½ç½®å…ƒç´ çš„å€¼ï¼Œå¹¶è®©è¯¥ä½ç½®çš„å…ƒç´ è‡ªå‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndAdd</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> delta)</span> <span class="comment">//è·å– index=i ä½ç½®å…ƒç´ çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> expect, <span class="type">int</span> update)</span> <span class="comment">//å¦‚æœè¾“å…¥çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°† index=i ä½ç½®çš„å…ƒç´ å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼ï¼ˆupdateï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lazySet</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> newValue)</span><span class="comment">//æœ€ç»ˆ å°†index=i ä½ç½®çš„å…ƒç´ è®¾ç½®ä¸ºnewValue,ä½¿ç”¨ lazySet è®¾ç½®ä¹‹åå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ã€‚</span></span><br></pre></td></tr></table></figure>

<p><strong><code>AtomicIntegerArray</code> ç±»ä½¿ç”¨ç¤ºä¾‹</strong> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] nums = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;;</span><br><span class="line"><span class="comment">// åˆ›å»º AtomicIntegerArray</span></span><br><span class="line"><span class="type">AtomicIntegerArray</span> <span class="variable">atomicArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(nums);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å° AtomicIntegerArray ä¸­çš„åˆå§‹å€¼</span></span><br><span class="line">System.out.println(<span class="string">&quot;Initial values in AtomicIntegerArray:&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; nums.length; j++) &#123;</span><br><span class="line">    System.out.print(<span class="string">&quot;Index &quot;</span> + j + <span class="string">&quot;: &quot;</span> + atomicArray.get(j) + <span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ getAndSet æ–¹æ³•å°†ç´¢å¼• 0 å¤„çš„å€¼è®¾ç½®ä¸º 2ï¼Œå¹¶è¿”å›æ—§å€¼</span></span><br><span class="line"><span class="type">int</span> <span class="variable">tempValue</span> <span class="operator">=</span> atomicArray.getAndSet(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;\nAfter getAndSet(0, 2):&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;Returned value: &quot;</span> + tempValue);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; atomicArray.length(); j++) &#123;</span><br><span class="line">    System.out.print(<span class="string">&quot;Index &quot;</span> + j + <span class="string">&quot;: &quot;</span> + atomicArray.get(j) + <span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ getAndIncrement æ–¹æ³•å°†ç´¢å¼• 0 å¤„çš„å€¼åŠ  1ï¼Œå¹¶è¿”å›æ—§å€¼</span></span><br><span class="line">tempValue = atomicArray.getAndIncrement(<span class="number">0</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;\nAfter getAndIncrement(0):&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;Returned value: &quot;</span> + tempValue);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; atomicArray.length(); j++) &#123;</span><br><span class="line">    System.out.print(<span class="string">&quot;Index &quot;</span> + j + <span class="string">&quot;: &quot;</span> + atomicArray.get(j) + <span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ getAndAdd æ–¹æ³•å°†ç´¢å¼• 0 å¤„çš„å€¼å¢åŠ  5ï¼Œå¹¶è¿”å›æ—§å€¼</span></span><br><span class="line">tempValue = atomicArray.getAndAdd(<span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;\nAfter getAndAdd(0, 5):&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;Returned value: &quot;</span> + tempValue);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; atomicArray.length(); j++) &#123;</span><br><span class="line">    System.out.print(<span class="string">&quot;Index &quot;</span> + j + <span class="string">&quot;: &quot;</span> + atomicArray.get(j) + <span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Initial values in AtomicIntegerArray:</span><br><span class="line">Index 0: 1 Index 1: 2 Index 2: 3 Index 3: 4 Index 4: 5 Index 5: 6</span><br><span class="line">After getAndSet(0, 2):</span><br><span class="line">Returned value: 1</span><br><span class="line">Index 0: 2 Index 1: 2 Index 2: 3 Index 3: 4 Index 4: 5 Index 5: 6</span><br><span class="line">After getAndIncrement(0):</span><br><span class="line">Returned value: 2</span><br><span class="line">Index 0: 3 Index 1: 2 Index 2: 3 Index 3: 4 Index 4: 5 Index 5: 6</span><br><span class="line">After getAndAdd(0, 5):</span><br><span class="line">Returned value: 3</span><br><span class="line">Index 0: 8 Index 1: 2 Index 2: 3 Index 3: 4 Index 4: 5 Index 5: 6</span><br></pre></td></tr></table></figure>

<h2 id="å¼•ç”¨ç±»å‹åŸå­ç±»"><a href="#å¼•ç”¨ç±»å‹åŸå­ç±»" class="headerlink" title="å¼•ç”¨ç±»å‹åŸå­ç±»"></a>å¼•ç”¨ç±»å‹åŸå­ç±»</h2><p>åŸºæœ¬ç±»å‹åŸå­ç±»åªèƒ½æ›´æ–°ä¸€ä¸ªå˜é‡ï¼Œå¦‚æœéœ€è¦åŸå­æ›´æ–°å¤šä¸ªå˜é‡ï¼Œéœ€è¦ä½¿ç”¨ å¼•ç”¨ç±»å‹åŸå­ç±»ã€‚</p>
<ul>
<li><code>AtomicReference</code>ï¼šå¼•ç”¨ç±»å‹åŸå­ç±»</li>
<li><code>AtomicStampedReference</code>ï¼šåŸå­æ›´æ–°å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°†æ•´æ•°å€¼ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œå¯ç”¨äºè§£å†³åŸå­çš„æ›´æ–°æ•°æ®å’Œæ•°æ®çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ ABA é—®é¢˜ã€‚</li>
<li><code>AtomicMarkableReference</code>ï¼šåŸå­æ›´æ–°å¸¦æœ‰æ ‡è®°çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°† boolean æ ‡è®°ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œ<del>ä¹Ÿå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ ABA é—®é¢˜ã€‚</del></li>
</ul>
<p>ä¸Šé¢ä¸‰ä¸ªç±»æä¾›çš„æ–¹æ³•å‡ ä¹ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä»¥ <code>AtomicReference</code> ä¸ºä¾‹å­æ¥ä»‹ç»ã€‚</p>
<p><strong><code>AtomicReference</code> ç±»ä½¿ç”¨ç¤ºä¾‹</strong> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Person ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="comment">//çœç•¥getter/setterå’ŒtoString</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»º AtomicReference å¯¹è±¡å¹¶è®¾ç½®åˆå§‹å€¼</span></span><br><span class="line">AtomicReference&lt;Person&gt; ar = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;SnailClimb&quot;</span>, <span class="number">22</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°åˆå§‹å€¼</span></span><br><span class="line">System.out.println(<span class="string">&quot;Initial Person: &quot;</span> + ar.get().toString());</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°å€¼</span></span><br><span class="line"><span class="type">Person</span> <span class="variable">updatePerson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Daisy&quot;</span>, <span class="number">20</span>);</span><br><span class="line">ar.compareAndSet(ar.get(), updatePerson);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°æ›´æ–°åçš„å€¼</span></span><br><span class="line">System.out.println(<span class="string">&quot;Updated Person: &quot;</span> + ar.get().toString());</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è¯•å†æ¬¡æ›´æ–°</span></span><br><span class="line"><span class="type">Person</span> <span class="variable">anotherUpdatePerson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;John&quot;</span>, <span class="number">30</span>);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">isUpdated</span> <span class="operator">=</span> ar.compareAndSet(updatePerson, anotherUpdatePerson);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°æ˜¯å¦æ›´æ–°æˆåŠŸåŠæœ€ç»ˆå€¼</span></span><br><span class="line">System.out.println(<span class="string">&quot;Second Update Success: &quot;</span> + isUpdated);</span><br><span class="line">System.out.println(<span class="string">&quot;Final Person: &quot;</span> + ar.get().toString());</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Initial Person: Person&#123;name=&#x27;SnailClimb&#x27;, age=22&#125;</span><br><span class="line">Updated Person: Person&#123;name=&#x27;Daisy&#x27;, age=20&#125;</span><br><span class="line">Second Update Success: true</span><br><span class="line">Final Person: Person&#123;name=&#x27;John&#x27;, age=30&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>AtomicStampedReference</code> ç±»ä½¿ç”¨ç¤ºä¾‹</strong> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ª AtomicStampedReference å¯¹è±¡ï¼Œåˆå§‹å€¼ä¸º &quot;SnailClimb&quot;ï¼Œåˆå§‹ç‰ˆæœ¬å·ä¸º 1</span></span><br><span class="line">AtomicStampedReference&lt;String&gt; asr = <span class="keyword">new</span> <span class="title class_">AtomicStampedReference</span>&lt;&gt;(<span class="string">&quot;SnailClimb&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°åˆå§‹å€¼å’Œç‰ˆæœ¬å·</span></span><br><span class="line"><span class="type">int</span>[] initialStamp = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span>];</span><br><span class="line"><span class="type">String</span> <span class="variable">initialRef</span> <span class="operator">=</span> asr.get(initialStamp);</span><br><span class="line">System.out.println(<span class="string">&quot;Initial Reference: &quot;</span> + initialRef + <span class="string">&quot;, Initial Stamp: &quot;</span> + initialStamp[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°å€¼å’Œç‰ˆæœ¬å·</span></span><br><span class="line"><span class="type">int</span> <span class="variable">oldStamp</span> <span class="operator">=</span> initialStamp[<span class="number">0</span>];</span><br><span class="line"><span class="type">String</span> <span class="variable">oldRef</span> <span class="operator">=</span> initialRef;</span><br><span class="line"><span class="type">String</span> <span class="variable">newRef</span> <span class="operator">=</span> <span class="string">&quot;Daisy&quot;</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">newStamp</span> <span class="operator">=</span> oldStamp + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isUpdated</span> <span class="operator">=</span> asr.compareAndSet(oldRef, newRef, oldStamp, newStamp);</span><br><span class="line">System.out.println(<span class="string">&quot;Update Success: &quot;</span> + isUpdated);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°æ›´æ–°åçš„å€¼å’Œç‰ˆæœ¬å·</span></span><br><span class="line"><span class="type">int</span>[] updatedStamp = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span>];</span><br><span class="line"><span class="type">String</span> <span class="variable">updatedRef</span> <span class="operator">=</span> asr.get(updatedStamp);</span><br><span class="line">System.out.println(<span class="string">&quot;Updated Reference: &quot;</span> + updatedRef + <span class="string">&quot;, Updated Stamp: &quot;</span> + updatedStamp[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è¯•ç”¨é”™è¯¯çš„ç‰ˆæœ¬å·æ›´æ–°</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isUpdatedWithWrongStamp</span> <span class="operator">=</span> asr.compareAndSet(newRef, <span class="string">&quot;John&quot;</span>, oldStamp, newStamp + <span class="number">1</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;Update with Wrong Stamp Success: &quot;</span> + isUpdatedWithWrongStamp);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°æœ€ç»ˆçš„å€¼å’Œç‰ˆæœ¬å·</span></span><br><span class="line"><span class="type">int</span>[] finalStamp = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span>];</span><br><span class="line"><span class="type">String</span> <span class="variable">finalRef</span> <span class="operator">=</span> asr.get(finalStamp);</span><br><span class="line">System.out.println(<span class="string">&quot;Final Reference: &quot;</span> + finalRef + <span class="string">&quot;, Final Stamp: &quot;</span> + finalStamp[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Initial Reference: SnailClimb, Initial Stamp: 1</span><br><span class="line">Update Success: true</span><br><span class="line">Updated Reference: Daisy, Updated Stamp: 2</span><br><span class="line">Update with Wrong Stamp Success: false</span><br><span class="line">Final Reference: Daisy, Final Stamp: 2</span><br></pre></td></tr></table></figure>

<p><strong><code>AtomicMarkableReference</code> ç±»ä½¿ç”¨ç¤ºä¾‹</strong> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ª AtomicMarkableReference å¯¹è±¡ï¼Œåˆå§‹å€¼ä¸º &quot;SnailClimb&quot;ï¼Œåˆå§‹æ ‡è®°ä¸º false</span></span><br><span class="line">AtomicMarkableReference&lt;String&gt; amr = <span class="keyword">new</span> <span class="title class_">AtomicMarkableReference</span>&lt;&gt;(<span class="string">&quot;SnailClimb&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°åˆå§‹å€¼å’Œæ ‡è®°</span></span><br><span class="line"><span class="type">boolean</span>[] initialMark = <span class="keyword">new</span> <span class="title class_">boolean</span>[<span class="number">1</span>];</span><br><span class="line"><span class="type">String</span> <span class="variable">initialRef</span> <span class="operator">=</span> amr.get(initialMark);</span><br><span class="line">System.out.println(<span class="string">&quot;Initial Reference: &quot;</span> + initialRef + <span class="string">&quot;, Initial Mark: &quot;</span> + initialMark[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°å€¼å’Œæ ‡è®°</span></span><br><span class="line"><span class="type">String</span> <span class="variable">oldRef</span> <span class="operator">=</span> initialRef;</span><br><span class="line"><span class="type">String</span> <span class="variable">newRef</span> <span class="operator">=</span> <span class="string">&quot;Daisy&quot;</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="variable">oldMark</span> <span class="operator">=</span> initialMark[<span class="number">0</span>];</span><br><span class="line"><span class="type">boolean</span> <span class="variable">newMark</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isUpdated</span> <span class="operator">=</span> amr.compareAndSet(oldRef, newRef, oldMark, newMark);</span><br><span class="line">System.out.println(<span class="string">&quot;Update Success: &quot;</span> + isUpdated);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°æ›´æ–°åçš„å€¼å’Œæ ‡è®°</span></span><br><span class="line"><span class="type">boolean</span>[] updatedMark = <span class="keyword">new</span> <span class="title class_">boolean</span>[<span class="number">1</span>];</span><br><span class="line"><span class="type">String</span> <span class="variable">updatedRef</span> <span class="operator">=</span> amr.get(updatedMark);</span><br><span class="line">System.out.println(<span class="string">&quot;Updated Reference: &quot;</span> + updatedRef + <span class="string">&quot;, Updated Mark: &quot;</span> + updatedMark[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è¯•ç”¨é”™è¯¯çš„æ ‡è®°æ›´æ–°</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isUpdatedWithWrongMark</span> <span class="operator">=</span> amr.compareAndSet(newRef, <span class="string">&quot;John&quot;</span>, oldMark, !newMark);</span><br><span class="line">System.out.println(<span class="string">&quot;Update with Wrong Mark Success: &quot;</span> + isUpdatedWithWrongMark);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°æœ€ç»ˆçš„å€¼å’Œæ ‡è®°</span></span><br><span class="line"><span class="type">boolean</span>[] finalMark = <span class="keyword">new</span> <span class="title class_">boolean</span>[<span class="number">1</span>];</span><br><span class="line"><span class="type">String</span> <span class="variable">finalRef</span> <span class="operator">=</span> amr.get(finalMark);</span><br><span class="line">System.out.println(<span class="string">&quot;Final Reference: &quot;</span> + finalRef + <span class="string">&quot;, Final Mark: &quot;</span> + finalMark[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Initial Reference: SnailClimb, Initial Mark: false</span><br><span class="line">Update Success: true</span><br><span class="line">Updated Reference: Daisy, Updated Mark: true</span><br><span class="line">Update with Wrong Mark Success: false</span><br><span class="line">Final Reference: Daisy, Final Mark: true</span><br></pre></td></tr></table></figure>

<h2 id="å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»"><a href="#å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»" class="headerlink" title="å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»"></a>å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»</h2><p>å¦‚æœéœ€è¦åŸå­æ›´æ–°æŸä¸ªç±»é‡Œçš„æŸä¸ªå­—æ®µæ—¶ï¼Œéœ€è¦ç”¨åˆ°å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»ã€‚</p>
<ul>
<li><code>AtomicIntegerFieldUpdater</code>:åŸå­æ›´æ–°æ•´å½¢å­—æ®µçš„æ›´æ–°å™¨</li>
<li><code>AtomicLongFieldUpdater</code>ï¼šåŸå­æ›´æ–°é•¿æ•´å½¢å­—æ®µçš„æ›´æ–°å™¨</li>
<li><code>AtomicReferenceFieldUpdater</code>ï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹é‡Œçš„å­—æ®µçš„æ›´æ–°å™¨</li>
</ul>
<p>è¦æƒ³åŸå­åœ°æ›´æ–°å¯¹è±¡çš„å±æ€§éœ€è¦ä¸¤æ­¥ã€‚ç¬¬ä¸€æ­¥ï¼Œå› ä¸ºå¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œæ‰€ä»¥æ¯æ¬¡ä½¿ç”¨éƒ½å¿…é¡»ä½¿ç”¨é™æ€æ–¹æ³• newUpdater()åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®æƒ³è¦æ›´æ–°çš„ç±»å’Œå±æ€§ã€‚ç¬¬äºŒæ­¥ï¼Œæ›´æ–°çš„å¯¹è±¡å±æ€§å¿…é¡»ä½¿ç”¨ public volatile ä¿®é¥°ç¬¦ã€‚</p>
<p>ä¸Šé¢ä¸‰ä¸ªç±»æä¾›çš„æ–¹æ³•å‡ ä¹ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä»¥ <code>AtomicIntegerFieldUpdater</code>ä¸ºä¾‹å­æ¥ä»‹ç»ã€‚</p>
<p><strong><code>AtomicIntegerFieldUpdater</code> ç±»ä½¿ç”¨ç¤ºä¾‹</strong> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Person ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">// è¦ä½¿ç”¨ AtomicIntegerFieldUpdaterï¼Œå­—æ®µå¿…é¡»æ˜¯ public volatile</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="comment">//çœç•¥getter/setterå’ŒtoString</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»º AtomicIntegerFieldUpdater å¯¹è±¡</span></span><br><span class="line">AtomicIntegerFieldUpdater&lt;Person&gt; ageUpdater = AtomicIntegerFieldUpdater.newUpdater(Person.class, <span class="string">&quot;age&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»º Person å¯¹è±¡</span></span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;SnailClimb&quot;</span>, <span class="number">22</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°åˆå§‹å€¼</span></span><br><span class="line">System.out.println(<span class="string">&quot;Initial Person: &quot;</span> + person);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–° age å­—æ®µ</span></span><br><span class="line">ageUpdater.incrementAndGet(person); <span class="comment">// è‡ªå¢</span></span><br><span class="line">System.out.println(<span class="string">&quot;After Increment: &quot;</span> + person);</span><br><span class="line"></span><br><span class="line">ageUpdater.addAndGet(person, <span class="number">5</span>); <span class="comment">// å¢åŠ  5</span></span><br><span class="line">System.out.println(<span class="string">&quot;After Adding 5: &quot;</span> + person);</span><br><span class="line"></span><br><span class="line">ageUpdater.compareAndSet(person, <span class="number">28</span>, <span class="number">30</span>); <span class="comment">// å¦‚æœå½“å‰å€¼æ˜¯ 28ï¼Œåˆ™è®¾ç½®ä¸º 30</span></span><br><span class="line">System.out.println(<span class="string">&quot;After Compare and Set (28 to 30): &quot;</span> + person);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è¯•ä½¿ç”¨é”™è¯¯çš„æ¯”è¾ƒå€¼è¿›è¡Œæ›´æ–°</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isUpdated</span> <span class="operator">=</span> ageUpdater.compareAndSet(person, <span class="number">28</span>, <span class="number">35</span>); <span class="comment">// è¿™æ¬¡åº”è¯¥å¤±è´¥</span></span><br><span class="line">System.out.println(<span class="string">&quot;Compare and Set (28 to 35) Success: &quot;</span> + isUpdated);</span><br><span class="line">System.out.println(<span class="string">&quot;Final Person: &quot;</span> + person);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Initial Person: Name: SnailClimb, Age: 22</span><br><span class="line">After Increment: Name: SnailClimb, Age: 23</span><br><span class="line">After Adding 5: Name: SnailClimb, Age: 28</span><br><span class="line">After Compare and Set (28 to 30): Name: SnailClimb, Age: 30</span><br><span class="line">Compare and Set (28 to 35) Success: false</span><br><span class="line">Final Person: Name: SnailClimb, Age: 30</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li>ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹</li>
</ul>
<!-- @include: @article-footer.snippet.md -->

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/11/03/transaction-isolation-level/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/11/03/transaction-isolation-level/" itemprop="url">MySQLäº‹åŠ¡éš”ç¦»çº§åˆ«è¯¦è§£</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2022-11-03T20:59:10+08:00">
                2022-11-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">æ•°æ®åº“</span>
                  </a>
                </span>

                
                
                  ï¼Œ 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MYSQL/" itemprop="url" rel="index">
                    <span itemprop="name">MYSQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2022/11/03/transaction-isolation-level/" class="leancloud_visitors" data-flag-title="MySQLäº‹åŠ¡éš”ç¦»çº§åˆ«è¯¦è§£">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  1.3k å­—
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  4 åˆ†é’Ÿ
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>æœ¬æ–‡ç”± <a href="https://github.com/Snailclimb">SnailClimb</a> å’Œ <a href="https://github.com/guang19">guang19</a> å…±åŒå®Œæˆã€‚</p>
</blockquote>
<p>å…³äºäº‹åŠ¡åŸºæœ¬æ¦‚è§ˆçš„ä»‹ç»ï¼Œè¯·çœ‹è¿™ç¯‡æ–‡ç« çš„ä»‹ç»ï¼š<a href="./mysql-questions-01.md#MySQL-%E4%BA%8B%E5%8A%A1">MySQL å¸¸è§çŸ¥è¯†ç‚¹&amp;é¢è¯•é¢˜æ€»ç»“</a></p>
<h2 id="äº‹åŠ¡éš”ç¦»çº§åˆ«æ€»ç»“"><a href="#äº‹åŠ¡éš”ç¦»çº§åˆ«æ€»ç»“" class="headerlink" title="äº‹åŠ¡éš”ç¦»çº§åˆ«æ€»ç»“"></a>äº‹åŠ¡éš”ç¦»çº§åˆ«æ€»ç»“</h2><p>SQL æ ‡å‡†å®šä¹‰äº†å››ä¸ªéš”ç¦»çº§åˆ«ï¼š</p>
<ul>
<li><strong>READ-UNCOMMITTED(è¯»å–æœªæäº¤)</strong> ï¼šæœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ã€‚</li>
<li><strong>READ-COMMITTED(è¯»å–å·²æäº¤)</strong> ï¼šå…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚</li>
<li><strong>REPEATABLE-READ(å¯é‡å¤è¯»)</strong> ï¼šå¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ï¼Œå¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚</li>
<li><strong>SERIALIZABLE(å¯ä¸²è¡ŒåŒ–)</strong> ï¼šæœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨æœä» ACID çš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œï¼Œè¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚</li>
</ul>
<hr>
<table>
<thead>
<tr>
<th align="center">éš”ç¦»çº§åˆ«</th>
<th align="center">è„è¯»</th>
<th align="center">ä¸å¯é‡å¤è¯»</th>
<th align="center">å¹»è¯»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">READ-UNCOMMITTED</td>
<td align="center">âˆš</td>
<td align="center">âˆš</td>
<td align="center">âˆš</td>
</tr>
<tr>
<td align="center">READ-COMMITTED</td>
<td align="center">Ã—</td>
<td align="center">âˆš</td>
<td align="center">âˆš</td>
</tr>
<tr>
<td align="center">REPEATABLE-READ</td>
<td align="center">Ã—</td>
<td align="center">Ã—</td>
<td align="center">âˆš</td>
</tr>
<tr>
<td align="center">SERIALIZABLE</td>
<td align="center">Ã—</td>
<td align="center">Ã—</td>
<td align="center">Ã—</td>
</tr>
</tbody></table>
<p>MySQL InnoDB å­˜å‚¨å¼•æ“çš„é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯ <strong>REPEATABLE-READï¼ˆå¯é‡è¯»ï¼‰</strong>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>SELECT @@tx_isolation;</code>å‘½ä»¤æ¥æŸ¥çœ‹ï¼ŒMySQL 8.0 è¯¥å‘½ä»¤æ”¹ä¸º<code>SELECT @@transaction_isolation;</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MySQL<span class="operator">&gt;</span> <span class="keyword">SELECT</span> @<span class="variable">@tx_isolation</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@tx_isolation</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢å¯¹ SQL æ ‡å‡†å®šä¹‰äº†å››ä¸ªéš”ç¦»çº§åˆ«çš„ä»‹ç»å¯ä»¥çœ‹å‡ºï¼Œæ ‡å‡†çš„ SQL éš”ç¦»çº§åˆ«å®šä¹‰é‡Œï¼ŒREPEATABLE-READ(å¯é‡å¤è¯»)æ˜¯ä¸å¯ä»¥é˜²æ­¢å¹»è¯»çš„ã€‚</p>
<p>ä½†æ˜¯ï¼InnoDB å®ç°çš„ REPEATABLE-READ éš”ç¦»çº§åˆ«å…¶å®æ˜¯å¯ä»¥è§£å†³å¹»è¯»é—®é¢˜å‘ç”Ÿçš„ï¼Œä¸»è¦æœ‰ä¸‹é¢ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li><strong>å¿«ç…§è¯»</strong>ï¼šç”± MVCC æœºåˆ¶æ¥ä¿è¯ä¸å‡ºç°å¹»è¯»ã€‚</li>
<li><strong>å½“å‰è¯»</strong>ï¼šä½¿ç”¨ Next-Key Lock è¿›è¡ŒåŠ é”æ¥ä¿è¯ä¸å‡ºç°å¹»è¯»ï¼ŒNext-Key Lock æ˜¯è¡Œé”ï¼ˆRecord Lockï¼‰å’Œé—´éš™é”ï¼ˆGap Lockï¼‰çš„ç»“åˆï¼Œè¡Œé”åªèƒ½é”ä½å·²ç»å­˜åœ¨çš„è¡Œï¼Œä¸ºäº†é¿å…æ’å…¥æ–°è¡Œï¼Œéœ€è¦ä¾èµ–é—´éš™é”ã€‚</li>
</ul>
<p>å› ä¸ºéš”ç¦»çº§åˆ«è¶Šä½ï¼Œäº‹åŠ¡è¯·æ±‚çš„é”è¶Šå°‘ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æ•°æ®åº“ç³»ç»Ÿçš„éš”ç¦»çº§åˆ«éƒ½æ˜¯ <strong>READ-COMMITTED</strong> ï¼Œä½†æ˜¯ä½ è¦çŸ¥é“çš„æ˜¯ InnoDB å­˜å‚¨å¼•æ“é»˜è®¤ä½¿ç”¨ <strong>REPEATABLE-READ</strong> å¹¶ä¸ä¼šæœ‰ä»»ä½•æ€§èƒ½æŸå¤±ã€‚</p>
<p>InnoDB å­˜å‚¨å¼•æ“åœ¨åˆ†å¸ƒå¼äº‹åŠ¡çš„æƒ…å†µä¸‹ä¸€èˆ¬ä¼šç”¨åˆ° SERIALIZABLE éš”ç¦»çº§åˆ«ã€‚</p>
<p>ã€ŠMySQL æŠ€æœ¯å†…å¹•ï¼šInnoDB å­˜å‚¨å¼•æ“(ç¬¬ 2 ç‰ˆ)ã€‹7.7 ç« è¿™æ ·å†™åˆ°ï¼š</p>
<blockquote>
<p>InnoDB å­˜å‚¨å¼•æ“æä¾›äº†å¯¹ XA äº‹åŠ¡çš„æ”¯æŒï¼Œå¹¶é€šè¿‡ XA äº‹åŠ¡æ¥æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ã€‚åˆ†å¸ƒå¼äº‹åŠ¡æŒ‡çš„æ˜¯å…è®¸å¤šä¸ªç‹¬ç«‹çš„äº‹åŠ¡èµ„æºï¼ˆtransactional resourcesï¼‰å‚ä¸åˆ°ä¸€ä¸ªå…¨å±€çš„äº‹åŠ¡ä¸­ã€‚äº‹åŠ¡èµ„æºé€šå¸¸æ˜¯å…³ç³»å‹æ•°æ®åº“ç³»ç»Ÿï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ç±»å‹çš„èµ„æºã€‚å…¨å±€äº‹åŠ¡è¦æ±‚åœ¨å…¶ä¸­çš„æ‰€æœ‰å‚ä¸çš„äº‹åŠ¡è¦ä¹ˆéƒ½æäº¤ï¼Œè¦ä¹ˆéƒ½å›æ»šï¼Œè¿™å¯¹äºäº‹åŠ¡åŸæœ‰çš„ ACID è¦æ±‚åˆæœ‰äº†æé«˜ã€‚å¦å¤–ï¼Œåœ¨ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼ŒInnoDB å­˜å‚¨å¼•æ“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«å¿…é¡»è®¾ç½®ä¸º SERIALIZABLEã€‚</p>
</blockquote>
<h2 id="å®é™…æƒ…å†µæ¼”ç¤º"><a href="#å®é™…æƒ…å†µæ¼”ç¤º" class="headerlink" title="å®é™…æƒ…å†µæ¼”ç¤º"></a>å®é™…æƒ…å†µæ¼”ç¤º</h2><p>åœ¨ä¸‹é¢æˆ‘ä¼šä½¿ç”¨ 2 ä¸ªå‘½ä»¤è¡Œ MySQL ï¼Œæ¨¡æ‹Ÿå¤šçº¿ç¨‹ï¼ˆå¤šäº‹åŠ¡ï¼‰å¯¹åŒä¸€ä»½æ•°æ®çš„è„è¯»é—®é¢˜ã€‚</p>
<p>MySQL å‘½ä»¤è¡Œçš„é»˜è®¤é…ç½®ä¸­äº‹åŠ¡éƒ½æ˜¯è‡ªåŠ¨æäº¤çš„ï¼Œå³æ‰§è¡Œ SQL è¯­å¥åå°±ä¼šé©¬ä¸Šæ‰§è¡Œ COMMIT æ“ä½œã€‚å¦‚æœè¦æ˜¾å¼åœ°å¼€å¯ä¸€ä¸ªäº‹åŠ¡éœ€è¦ä½¿ç”¨å‘½ä»¤ï¼š<code>START TRANSACTION</code>ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥è®¾ç½®éš”ç¦»çº§åˆ«ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> [SESSION<span class="operator">|</span><span class="keyword">GLOBAL</span>] TRANSACTION ISOLATION LEVEL [READ UNCOMMITTED<span class="operator">|</span>READ COMMITTED<span class="operator">|</span>REPEATABLE READ<span class="operator">|</span>SERIALIZABLE]</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬åœ¨ä¸‹é¢å®é™…æ“ä½œä¸­ä½¿ç”¨åˆ°çš„ä¸€äº›å¹¶å‘æ§åˆ¶è¯­å¥:</p>
<ul>
<li><code>START TRANSACTION</code> |<code>BEGIN</code>ï¼šæ˜¾å¼åœ°å¼€å¯ä¸€ä¸ªäº‹åŠ¡ã€‚</li>
<li><code>COMMIT</code>ï¼šæäº¤äº‹åŠ¡ï¼Œä½¿å¾—å¯¹æ•°æ®åº“åšçš„æ‰€æœ‰ä¿®æ”¹æˆä¸ºæ°¸ä¹…æ€§ã€‚</li>
<li><code>ROLLBACK</code>ï¼šå›æ»šä¼šç»“æŸç”¨æˆ·çš„äº‹åŠ¡ï¼Œå¹¶æ’¤é”€æ­£åœ¨è¿›è¡Œçš„æ‰€æœ‰æœªæäº¤çš„ä¿®æ”¹ã€‚</li>
</ul>
<h3 id="è„è¯»-è¯»æœªæäº¤"><a href="#è„è¯»-è¯»æœªæäº¤" class="headerlink" title="è„è¯»(è¯»æœªæäº¤)"></a>è„è¯»(è¯»æœªæäº¤)</h3><p><img src="https://oss.javaguide.cn/github/javaguide/2019-31-1%E8%84%8F%E8%AF%BB(%E8%AF%BB%E6%9C%AA%E6%8F%90%E4%BA%A4)%E5%AE%9E%E4%BE%8B.jpg"></p>
<h3 id="é¿å…è„è¯»-è¯»å·²æäº¤"><a href="#é¿å…è„è¯»-è¯»å·²æäº¤" class="headerlink" title="é¿å…è„è¯»(è¯»å·²æäº¤)"></a>é¿å…è„è¯»(è¯»å·²æäº¤)</h3><p><img src="https://oss.javaguide.cn/github/javaguide/2019-31-2%E8%AF%BB%E5%B7%B2%E6%8F%90%E4%BA%A4%E5%AE%9E%E4%BE%8B.jpg"></p>
<h3 id="ä¸å¯é‡å¤è¯»"><a href="#ä¸å¯é‡å¤è¯»" class="headerlink" title="ä¸å¯é‡å¤è¯»"></a>ä¸å¯é‡å¤è¯»</h3><p>è¿˜æ˜¯åˆšæ‰ä¸Šé¢çš„è¯»å·²æäº¤çš„å›¾ï¼Œè™½ç„¶é¿å…äº†è¯»æœªæäº¤ï¼Œä½†æ˜¯å´å‡ºç°äº†ï¼Œä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰ç»“æŸï¼Œå°±å‘ç”Ÿäº† ä¸å¯é‡å¤è¯»é—®é¢˜ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/2019-32-1%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB%E5%AE%9E%E4%BE%8B.jpg"></p>
<h3 id="å¯é‡å¤è¯»"><a href="#å¯é‡å¤è¯»" class="headerlink" title="å¯é‡å¤è¯»"></a>å¯é‡å¤è¯»</h3><p><img src="https://oss.javaguide.cn/github/javaguide/2019-33-2%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB.jpg"></p>
<h3 id="å¹»è¯»"><a href="#å¹»è¯»" class="headerlink" title="å¹»è¯»"></a>å¹»è¯»</h3><h4 id="æ¼”ç¤ºå¹»è¯»å‡ºç°çš„æƒ…å†µ"><a href="#æ¼”ç¤ºå¹»è¯»å‡ºç°çš„æƒ…å†µ" class="headerlink" title="æ¼”ç¤ºå¹»è¯»å‡ºç°çš„æƒ…å†µ"></a>æ¼”ç¤ºå¹»è¯»å‡ºç°çš„æƒ…å†µ</h4><p><img src="https://oss.javaguide.cn/github/javaguide/phantom_read.png"></p>
<p>SQL è„šæœ¬ 1 åœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢å·¥èµ„ä¸º 500 çš„è®°å½•æ—¶åªæœ‰ä¸€æ¡ï¼ŒSQL è„šæœ¬ 2 æ’å…¥äº†ä¸€æ¡å·¥èµ„ä¸º 500 çš„è®°å½•ï¼Œæäº¤ä¹‹åï¼›SQL è„šæœ¬ 1 åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å†æ¬¡ä½¿ç”¨å½“å‰è¯»æŸ¥è¯¢å‘ç°å‡ºç°äº†ä¸¤æ¡å·¥èµ„ä¸º 500 çš„è®°å½•è¿™ç§å°±æ˜¯å¹»è¯»ã€‚</p>
<h4 id="è§£å†³å¹»è¯»çš„æ–¹æ³•"><a href="#è§£å†³å¹»è¯»çš„æ–¹æ³•" class="headerlink" title="è§£å†³å¹»è¯»çš„æ–¹æ³•"></a>è§£å†³å¹»è¯»çš„æ–¹æ³•</h4><p>è§£å†³å¹»è¯»çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œä½†æ˜¯å®ƒä»¬çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ä¸€ä¸ªäº‹åŠ¡åœ¨æ“ä½œæŸå¼ è¡¨æ•°æ®çš„æ—¶å€™ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¸å…è®¸æ–°å¢æˆ–è€…åˆ é™¤è¿™å¼ è¡¨ä¸­çš„æ•°æ®äº†ã€‚è§£å†³å¹»è¯»çš„æ–¹å¼ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ol>
<li>å°†äº‹åŠ¡éš”ç¦»çº§åˆ«è°ƒæ•´ä¸º <code>SERIALIZABLE</code> ã€‚</li>
<li>åœ¨å¯é‡å¤è¯»çš„äº‹åŠ¡çº§åˆ«ä¸‹ï¼Œç»™äº‹åŠ¡æ“ä½œçš„è¿™å¼ è¡¨æ·»åŠ è¡¨é”ã€‚</li>
<li>åœ¨å¯é‡å¤è¯»çš„äº‹åŠ¡çº§åˆ«ä¸‹ï¼Œç»™äº‹åŠ¡æ“ä½œçš„è¿™å¼ è¡¨æ·»åŠ  <code>Next-key Lockï¼ˆRecord Lock+Gap Lockï¼‰</code>ã€‚</li>
</ol>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul>
<li>ã€ŠMySQL æŠ€æœ¯å†…å¹•ï¼šInnoDB å­˜å‚¨å¼•æ“ã€‹</li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/">https://dev.MySQL.com/doc/refman/5.7/en/</a></li>
<li><a href="https://tech.youzan.com/seven-questions-about-the-lock-of-MySQL/">Mysql é”ï¼šçµé­‚ä¸ƒæ‹·é—®</a></li>
<li><a href="https://tech.meituan.com/2014/08/20/innodb-lock.html">Innodb ä¸­çš„äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œé”çš„å…³ç³»</a></li>
</ul>
<!-- @include: @article-footer.snippet.md -->

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/11/02/unsafe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/11/02/unsafe/" itemprop="url">Java Unsafe è¯¦è§£</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2022-11-02T15:13:16+08:00">
                2022-11-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ï¼Œ 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Java%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">JavaåŸºç¡€</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2022/11/02/unsafe/" class="leancloud_visitors" data-flag-title="Java Unsafe è¯¦è§£">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  7.8k å­—
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  30 åˆ†é’Ÿ
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>æœ¬æ–‡æ•´ç†å®Œå–„è‡ªä¸‹é¢è¿™ä¸¤ç¯‡ä¼˜ç§€çš„æ–‡ç« ï¼š</p>
<ul>
<li><a href="https://tech.meituan.com/2019/02/14/talk-about-java-magic-class-unsafe.html">Java é­”æ³•ç±»ï¼šUnsafe åº”ç”¨è§£æ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ -2019</a></li>
<li><a href="https://xie.infoq.cn/article/8b6ed4195e475bfb32dacc5cb">Java åŒåˆƒå‰‘ä¹‹ Unsafe ç±»è¯¦è§£ - ç å†œå‚ä¸Š - 2021</a></li>
</ul>
</blockquote>
<!-- markdownlint-disable MD024 -->

<p>é˜…è¯»è¿‡ JUC æºç çš„åŒå­¦ï¼Œä¸€å®šä¼šå‘ç°å¾ˆå¤šå¹¶å‘å·¥å…·ç±»éƒ½è°ƒç”¨äº†ä¸€ä¸ªå«åš <code>Unsafe</code> çš„ç±»ã€‚</p>
<p>é‚£è¿™ä¸ªç±»ä¸»è¦æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿæœ‰ä»€ä¹ˆä½¿ç”¨åœºæ™¯å‘¢ï¼Ÿè¿™ç¯‡æ–‡ç« å°±å¸¦ä½ ææ¸…æ¥šï¼</p>
<h2 id="Unsafe-ä»‹ç»"><a href="#Unsafe-ä»‹ç»" class="headerlink" title="Unsafe ä»‹ç»"></a>Unsafe ä»‹ç»</h2><p><code>Unsafe</code> æ˜¯ä½äº <code>sun.misc</code> åŒ…ä¸‹çš„ä¸€ä¸ªç±»ï¼Œä¸»è¦æä¾›ä¸€äº›ç”¨äºæ‰§è¡Œä½çº§åˆ«ã€ä¸å®‰å…¨æ“ä½œçš„æ–¹æ³•ï¼Œå¦‚ç›´æ¥è®¿é—®ç³»ç»Ÿå†…å­˜èµ„æºã€è‡ªä¸»ç®¡ç†å†…å­˜èµ„æºç­‰ï¼Œè¿™äº›æ–¹æ³•åœ¨æå‡ Java è¿è¡Œæ•ˆç‡ã€å¢å¼º Java è¯­è¨€åº•å±‚èµ„æºæ“ä½œèƒ½åŠ›æ–¹é¢èµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨ã€‚ä½†ç”±äº <code>Unsafe</code> ç±»ä½¿ Java è¯­è¨€æ‹¥æœ‰äº†ç±»ä¼¼ C è¯­è¨€æŒ‡é’ˆä¸€æ ·æ“ä½œå†…å­˜ç©ºé—´çš„èƒ½åŠ›ï¼Œè¿™æ— ç–‘ä¹Ÿå¢åŠ äº†ç¨‹åºå‘ç”Ÿç›¸å…³æŒ‡é’ˆé—®é¢˜çš„é£é™©ã€‚åœ¨ç¨‹åºä¸­è¿‡åº¦ã€ä¸æ­£ç¡®ä½¿ç”¨ <code>Unsafe</code> ç±»ä¼šä½¿å¾—ç¨‹åºå‡ºé”™çš„æ¦‚ç‡å˜å¤§ï¼Œä½¿å¾— Java è¿™ç§å®‰å…¨çš„è¯­è¨€å˜å¾—ä¸å†â€œå®‰å…¨â€ï¼Œå› æ­¤å¯¹ <code>Unsafe</code> çš„ä½¿ç”¨ä¸€å®šè¦æ…é‡ã€‚</p>
<p>å¦å¤–ï¼Œ<code>Unsafe</code> æä¾›çš„è¿™äº›åŠŸèƒ½çš„å®ç°éœ€è¦ä¾èµ–æœ¬åœ°æ–¹æ³•ï¼ˆNative Methodï¼‰ã€‚ä½ å¯ä»¥å°†æœ¬åœ°æ–¹æ³•çœ‹ä½œæ˜¯ Java ä¸­ä½¿ç”¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„æ–¹æ³•ã€‚æœ¬åœ°æ–¹æ³•ä½¿ç”¨ <strong><code>native</code></strong> å…³é”®å­—ä¿®é¥°ï¼ŒJava ä»£ç ä¸­åªæ˜¯å£°æ˜æ–¹æ³•å¤´ï¼Œå…·ä½“çš„å®ç°åˆ™äº¤ç»™ <strong>æœ¬åœ°ä»£ç </strong>ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/basis/unsafe/image-20220717115231125.png"></p>
<p><strong>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æœ¬åœ°æ–¹æ³•å‘¢ï¼Ÿ</strong></p>
<ol>
<li>éœ€è¦ç”¨åˆ° Java ä¸­ä¸å…·å¤‡çš„ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ç‰¹æ€§ï¼ŒJava åœ¨å®ç°è·¨å¹³å°çš„åŒæ—¶è¦å®ç°å¯¹åº•å±‚çš„æ§åˆ¶ï¼Œéœ€è¦å€ŸåŠ©å…¶ä»–è¯­è¨€å‘æŒ¥ä½œç”¨ã€‚</li>
<li>å¯¹äºå…¶ä»–è¯­è¨€å·²ç»å®Œæˆçš„ä¸€äº›ç°æˆåŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨ Java ç›´æ¥è°ƒç”¨ã€‚</li>
<li>ç¨‹åºå¯¹æ—¶é—´æ•æ„Ÿæˆ–å¯¹æ€§èƒ½è¦æ±‚éå¸¸é«˜æ—¶ï¼Œæœ‰å¿…è¦ä½¿ç”¨æ›´åŠ åº•å±‚çš„è¯­è¨€ï¼Œä¾‹å¦‚ C&#x2F;C++ç”šè‡³æ˜¯æ±‡ç¼–ã€‚</li>
</ol>
<p>åœ¨ JUC åŒ…çš„å¾ˆå¤šå¹¶å‘å·¥å…·ç±»åœ¨å®ç°å¹¶å‘æœºåˆ¶æ—¶ï¼Œéƒ½è°ƒç”¨äº†æœ¬åœ°æ–¹æ³•ï¼Œé€šè¿‡å®ƒä»¬æ‰“ç ´äº† Java è¿è¡Œæ—¶çš„ç•Œé™ï¼Œèƒ½å¤Ÿæ¥è§¦åˆ°æ“ä½œç³»ç»Ÿåº•å±‚çš„æŸäº›åŠŸèƒ½ã€‚å¯¹äºåŒä¸€æœ¬åœ°æ–¹æ³•ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿå¯èƒ½ä¼šé€šè¿‡ä¸åŒçš„æ–¹å¼æ¥å®ç°ï¼Œä½†æ˜¯å¯¹äºä½¿ç”¨è€…æ¥è¯´æ˜¯é€æ˜çš„ï¼Œæœ€ç»ˆéƒ½ä¼šå¾—åˆ°ç›¸åŒçš„ç»“æœã€‚</p>
<h2 id="Unsafe-åˆ›å»º"><a href="#Unsafe-åˆ›å»º" class="headerlink" title="Unsafe åˆ›å»º"></a>Unsafe åˆ›å»º</h2><p><code>sun.misc.Unsafe</code> éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Unsafe</span> &#123;</span><br><span class="line">  <span class="comment">// å•ä¾‹å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe theUnsafe;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">Unsafe</span><span class="params">()</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@CallerSensitive</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">var0</span> <span class="operator">=</span> Reflection.getCallerClass();</span><br><span class="line">    <span class="comment">// ä»…åœ¨å¼•å¯¼ç±»åŠ è½½å™¨`BootstrapClassLoader`åŠ è½½æ—¶æ‰åˆæ³•</span></span><br><span class="line">    <span class="keyword">if</span>(!VM.isSystemDomainLoader(var0.getClassLoader())) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Unsafe&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> theUnsafe;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Unsafe</code> ç±»ä¸ºä¸€å•ä¾‹å®ç°ï¼Œæä¾›é™æ€æ–¹æ³• <code>getUnsafe</code> è·å– <code>Unsafe</code>å®ä¾‹ã€‚è¿™ä¸ªçœ‹ä¸Šå»è²Œä¼¼å¯ä»¥ç”¨æ¥è·å– <code>Unsafe</code> å®ä¾‹ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬ç›´æ¥è°ƒç”¨è¿™ä¸ªé™æ€æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæŠ›å‡º <code>SecurityException</code> å¼‚å¸¸ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.SecurityException: Unsafe</span><br><span class="line"> at sun.misc.Unsafe.getUnsafe(Unsafe.java:90)</span><br><span class="line"> at com.cn.test.GetUnsafeTest.main(GetUnsafeTest.java:12)</span><br></pre></td></tr></table></figure>

<p><strong>ä¸ºä»€ä¹ˆ <code>public static</code> æ–¹æ³•æ— æ³•è¢«ç›´æ¥è°ƒç”¨å‘¢ï¼Ÿ</strong></p>
<p>è¿™æ˜¯å› ä¸ºåœ¨<code>getUnsafe</code>æ–¹æ³•ä¸­ï¼Œä¼šå¯¹è°ƒç”¨è€…çš„<code>classLoader</code>è¿›è¡Œæ£€æŸ¥ï¼Œåˆ¤æ–­å½“å‰ç±»æ˜¯å¦ç”±<code>Bootstrap classLoader</code>åŠ è½½ï¼Œå¦‚æœä¸æ˜¯çš„è¯é‚£ä¹ˆå°±ä¼šæŠ›å‡ºä¸€ä¸ª<code>SecurityException</code>å¼‚å¸¸ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ‰èƒ½å¤Ÿè°ƒç”¨ Unsafe ç±»ä¸­çš„æ–¹æ³•ï¼Œæ¥é˜²æ­¢è¿™äº›æ–¹æ³•åœ¨ä¸å¯ä¿¡çš„ä»£ç ä¸­è¢«è°ƒç”¨ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆè¦å¯¹ Unsafe ç±»è¿›è¡Œè¿™ä¹ˆè°¨æ…çš„ä½¿ç”¨é™åˆ¶å‘¢?</strong></p>
<p><code>Unsafe</code> æä¾›çš„åŠŸèƒ½è¿‡äºåº•å±‚ï¼ˆå¦‚ç›´æ¥è®¿é—®ç³»ç»Ÿå†…å­˜èµ„æºã€è‡ªä¸»ç®¡ç†å†…å­˜èµ„æºç­‰ï¼‰ï¼Œå®‰å…¨éšæ‚£ä¹Ÿæ¯”è¾ƒå¤§ï¼Œä½¿ç”¨ä¸å½“çš„è¯ï¼Œå¾ˆå®¹æ˜“å‡ºç°å¾ˆä¸¥é‡çš„é—®é¢˜ã€‚</p>
<p><strong>å¦‚è‹¥æƒ³ä½¿ç”¨ <code>Unsafe</code> è¿™ä¸ªç±»çš„è¯ï¼Œåº”è¯¥å¦‚ä½•è·å–å…¶å®ä¾‹å‘¢ï¼Ÿ</strong></p>
<p>è¿™é‡Œä»‹ç»ä¸¤ä¸ªå¯è¡Œçš„æ–¹æ¡ˆã€‚</p>
<p>1ã€åˆ©ç”¨åå°„è·å¾— Unsafe ç±»ä¸­å·²ç»å®ä¾‹åŒ–å®Œæˆçš„å•ä¾‹å¯¹è±¡ <code>theUnsafe</code> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Unsafe <span class="title function_">reflectGetUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">      field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      <span class="keyword">return</span> (Unsafe) field.get(<span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      log.error(e.getMessage(), e);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2ã€ä»<code>getUnsafe</code>æ–¹æ³•çš„ä½¿ç”¨é™åˆ¶æ¡ä»¶å‡ºå‘ï¼Œé€šè¿‡ Java å‘½ä»¤è¡Œå‘½ä»¤<code>-Xbootclasspath/a</code>æŠŠè°ƒç”¨ Unsafe ç›¸å…³æ–¹æ³•çš„ç±» A æ‰€åœ¨ jar åŒ…è·¯å¾„è¿½åŠ åˆ°é»˜è®¤çš„ bootstrap è·¯å¾„ä¸­ï¼Œä½¿å¾— A è¢«å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½ï¼Œä»è€Œé€šè¿‡<code>Unsafe.getUnsafe</code>æ–¹æ³•å®‰å…¨çš„è·å– Unsafe å®ä¾‹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xbootclasspath/a: <span class="variable">$&#123;path&#125;</span>   // å…¶ä¸­pathä¸ºè°ƒç”¨Unsafeç›¸å…³æ–¹æ³•çš„ç±»æ‰€åœ¨jaråŒ…è·¯å¾„</span><br></pre></td></tr></table></figure>

<h2 id="Unsafe-åŠŸèƒ½"><a href="#Unsafe-åŠŸèƒ½" class="headerlink" title="Unsafe åŠŸèƒ½"></a>Unsafe åŠŸèƒ½</h2><p>æ¦‚æ‹¬çš„æ¥è¯´ï¼Œ<code>Unsafe</code> ç±»å®ç°åŠŸèƒ½å¯ä»¥è¢«åˆ†ä¸ºä¸‹é¢ 8 ç±»ï¼š</p>
<ol>
<li>å†…å­˜æ“ä½œ</li>
<li>å†…å­˜å±éšœ</li>
<li>å¯¹è±¡æ“ä½œ</li>
<li>æ•°æ®æ“ä½œ</li>
<li>CAS æ“ä½œ</li>
<li>çº¿ç¨‹è°ƒåº¦</li>
<li>Class æ“ä½œ</li>
<li>ç³»ç»Ÿä¿¡æ¯</li>
</ol>
<h3 id="å†…å­˜æ“ä½œ"><a href="#å†…å­˜æ“ä½œ" class="headerlink" title="å†…å­˜æ“ä½œ"></a>å†…å­˜æ“ä½œ</h3><h4 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>å¦‚æœä½ æ˜¯ä¸€ä¸ªå†™è¿‡ C æˆ–è€… C++ çš„ç¨‹åºå‘˜ï¼Œä¸€å®šå¯¹å†…å­˜æ“ä½œä¸ä¼šé™Œç”Ÿï¼Œè€Œåœ¨ Java ä¸­æ˜¯ä¸å…è®¸ç›´æ¥å¯¹å†…å­˜è¿›è¡Œæ“ä½œçš„ï¼Œå¯¹è±¡å†…å­˜çš„åˆ†é…å’Œå›æ”¶éƒ½æ˜¯ç”± JVM è‡ªå·±å®ç°çš„ã€‚ä½†æ˜¯åœ¨ <code>Unsafe</code> ä¸­ï¼Œæä¾›çš„ä¸‹åˆ—æ¥å£å¯ä»¥ç›´æ¥è¿›è¡Œå†…å­˜æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ†é…æ–°çš„æœ¬åœ°ç©ºé—´</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">allocateMemory</span><span class="params">(<span class="type">long</span> bytes)</span>;</span><br><span class="line"><span class="comment">//é‡æ–°è°ƒæ•´å†…å­˜ç©ºé—´çš„å¤§å°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">reallocateMemory</span><span class="params">(<span class="type">long</span> address, <span class="type">long</span> bytes)</span>;</span><br><span class="line"><span class="comment">//å°†å†…å­˜è®¾ç½®ä¸ºæŒ‡å®šå€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">setMemory</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">long</span> bytes, <span class="type">byte</span> value)</span>;</span><br><span class="line"><span class="comment">//å†…å­˜æ‹·è´</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">copyMemory</span><span class="params">(Object srcBase, <span class="type">long</span> srcOffset,Object destBase, <span class="type">long</span> destOffset,<span class="type">long</span> bytes)</span>;</span><br><span class="line"><span class="comment">//æ¸…é™¤å†…å­˜</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">freeMemory</span><span class="params">(<span class="type">long</span> address)</span>;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ä¸‹é¢çš„ä»£ç è¿›è¡Œæµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">memoryTest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">addr</span> <span class="operator">=</span> unsafe.allocateMemory(size);</span><br><span class="line">    <span class="type">long</span> <span class="variable">addr3</span> <span class="operator">=</span> unsafe.reallocateMemory(addr, size * <span class="number">2</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;addr: &quot;</span>+addr);</span><br><span class="line">    System.out.println(<span class="string">&quot;addr3: &quot;</span>+addr3);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        unsafe.setMemory(<span class="literal">null</span>,addr ,size,(<span class="type">byte</span>)<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            unsafe.copyMemory(<span class="literal">null</span>,addr,<span class="literal">null</span>,addr3+size*i,<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(unsafe.getInt(addr));</span><br><span class="line">        System.out.println(unsafe.getLong(addr3));</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        unsafe.freeMemory(addr);</span><br><span class="line">        unsafe.freeMemory(addr3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆçœ‹ç»“æœè¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">addr: 2433733895744</span><br><span class="line">addr3: 2433733894944</span><br><span class="line">16843009</span><br><span class="line">72340172838076673</span><br></pre></td></tr></table></figure>

<p>åˆ†æä¸€ä¸‹è¿è¡Œç»“æœï¼Œé¦–å…ˆä½¿ç”¨<code>allocateMemory</code>æ–¹æ³•ç”³è¯· 4 å­—èŠ‚é•¿åº¦çš„å†…å­˜ç©ºé—´ï¼Œè°ƒç”¨<code>setMemory</code>æ–¹æ³•å‘æ¯ä¸ªå­—èŠ‚å†™å…¥å†…å®¹ä¸º<code>byte</code>ç±»å‹çš„ 1ï¼Œå½“ä½¿ç”¨ Unsafe è°ƒç”¨<code>getInt</code>æ–¹æ³•æ—¶ï¼Œå› ä¸ºä¸€ä¸ª<code>int</code>å‹å˜é‡å  4 ä¸ªå­—èŠ‚ï¼Œä¼šä¸€æ¬¡æ€§è¯»å– 4 ä¸ªå­—èŠ‚ï¼Œç»„æˆä¸€ä¸ª<code>int</code>çš„å€¼ï¼Œå¯¹åº”çš„åè¿›åˆ¶ç»“æœä¸º 16843009ã€‚</p>
<p>ä½ å¯ä»¥é€šè¿‡ä¸‹å›¾ç†è§£è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/basis/unsafe/image-20220717144344005.png"></p>
<p>åœ¨ä»£ç ä¸­è°ƒç”¨<code>reallocateMemory</code>æ–¹æ³•é‡æ–°åˆ†é…äº†ä¸€å— 8 å­—èŠ‚é•¿åº¦çš„å†…å­˜ç©ºé—´ï¼Œé€šè¿‡æ¯”è¾ƒ<code>addr</code>å’Œ<code>addr3</code>å¯ä»¥çœ‹åˆ°å’Œä¹‹å‰ç”³è¯·çš„å†…å­˜åœ°å€æ˜¯ä¸åŒçš„ã€‚åœ¨ä»£ç ä¸­çš„ç¬¬äºŒä¸ª for å¾ªç¯é‡Œï¼Œè°ƒç”¨<code>copyMemory</code>æ–¹æ³•è¿›è¡Œäº†ä¸¤æ¬¡å†…å­˜çš„æ‹·è´ï¼Œæ¯æ¬¡æ‹·è´å†…å­˜åœ°å€<code>addr</code>å¼€å§‹çš„ 4 ä¸ªå­—èŠ‚ï¼Œåˆ†åˆ«æ‹·è´åˆ°ä»¥<code>addr3</code>å’Œ<code>addr3+4</code>å¼€å§‹çš„å†…å­˜ç©ºé—´ä¸Šï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/basis/unsafe/image-20220717144354582.png"></p>
<p>æ‹·è´å®Œæˆåï¼Œä½¿ç”¨<code>getLong</code>æ–¹æ³•ä¸€æ¬¡æ€§è¯»å– 8 ä¸ªå­—èŠ‚ï¼Œå¾—åˆ°<code>long</code>ç±»å‹çš„å€¼ä¸º 72340172838076673ã€‚</p>
<p>éœ€è¦æ³¨æ„ï¼Œé€šè¿‡è¿™ç§æ–¹å¼åˆ†é…çš„å†…å­˜å±äº å †å¤–å†…å­˜ ï¼Œæ˜¯æ— æ³•è¿›è¡Œåƒåœ¾å›æ”¶çš„ï¼Œéœ€è¦æˆ‘ä»¬æŠŠè¿™äº›å†…å­˜å½“åšä¸€ç§èµ„æºå»æ‰‹åŠ¨è°ƒç”¨<code>freeMemory</code>æ–¹æ³•è¿›è¡Œé‡Šæ”¾ï¼Œå¦åˆ™ä¼šäº§ç”Ÿå†…å­˜æ³„æ¼ã€‚é€šç”¨çš„æ“ä½œå†…å­˜æ–¹å¼æ˜¯åœ¨<code>try</code>ä¸­æ‰§è¡Œå¯¹å†…å­˜çš„æ“ä½œï¼Œæœ€ç»ˆåœ¨<code>finally</code>å—ä¸­è¿›è¡Œå†…å­˜çš„é‡Šæ”¾ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å †å¤–å†…å­˜ï¼Ÿ</strong></p>
<ul>
<li>å¯¹åƒåœ¾å›æ”¶åœé¡¿çš„æ”¹å–„ã€‚ç”±äºå †å¤–å†…å­˜æ˜¯ç›´æ¥å—æ“ä½œç³»ç»Ÿç®¡ç†è€Œä¸æ˜¯ JVMï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ä½¿ç”¨å †å¤–å†…å­˜æ—¶ï¼Œå³å¯ä¿æŒè¾ƒå°çš„å †å†…å†…å­˜è§„æ¨¡ã€‚ä»è€Œåœ¨ GC æ—¶å‡å°‘å›æ”¶åœé¡¿å¯¹äºåº”ç”¨çš„å½±å“ã€‚</li>
<li>æå‡ç¨‹åº I&#x2F;O æ“ä½œçš„æ€§èƒ½ã€‚é€šå¸¸åœ¨ I&#x2F;O é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œä¼šå­˜åœ¨å †å†…å†…å­˜åˆ°å †å¤–å†…å­˜çš„æ•°æ®æ‹·è´æ“ä½œï¼Œå¯¹äºéœ€è¦é¢‘ç¹è¿›è¡Œå†…å­˜é—´æ•°æ®æ‹·è´ä¸”ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„æš‚å­˜æ•°æ®ï¼Œéƒ½å»ºè®®å­˜å‚¨åˆ°å †å¤–å†…å­˜ã€‚</li>
</ul>
<h4 id="å…¸å‹åº”ç”¨"><a href="#å…¸å‹åº”ç”¨" class="headerlink" title="å…¸å‹åº”ç”¨"></a>å…¸å‹åº”ç”¨</h4><p><code>DirectByteBuffer</code> æ˜¯ Java ç”¨äºå®ç°å †å¤–å†…å­˜çš„ä¸€ä¸ªé‡è¦ç±»ï¼Œé€šå¸¸ç”¨åœ¨é€šä¿¡è¿‡ç¨‹ä¸­åšç¼“å†²æ± ï¼Œå¦‚åœ¨ Nettyã€MINA ç­‰ NIO æ¡†æ¶ä¸­åº”ç”¨å¹¿æ³›ã€‚<code>DirectByteBuffer</code> å¯¹äºå †å¤–å†…å­˜çš„åˆ›å»ºã€ä½¿ç”¨ã€é”€æ¯ç­‰é€»è¾‘å‡ç”± Unsafe æä¾›çš„å †å¤–å†…å­˜ API æ¥å®ç°ã€‚</p>
<p>ä¸‹å›¾ä¸º <code>DirectByteBuffer</code> æ„é€ å‡½æ•°ï¼Œåˆ›å»º <code>DirectByteBuffer</code> çš„æ—¶å€™ï¼Œé€šè¿‡ <code>Unsafe.allocateMemory</code> åˆ†é…å†…å­˜ã€<code>Unsafe.setMemory</code> è¿›è¡Œå†…å­˜åˆå§‹åŒ–ï¼Œè€Œåæ„å»º <code>Cleaner</code> å¯¹è±¡ç”¨äºè·Ÿè¸ª <code>DirectByteBuffer</code> å¯¹è±¡çš„åƒåœ¾å›æ”¶ï¼Œä»¥å®ç°å½“ <code>DirectByteBuffer</code> è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œåˆ†é…çš„å †å¤–å†…å­˜ä¸€èµ·è¢«é‡Šæ”¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">DirectByteBuffer(<span class="type">int</span> cap) &#123;                   <span class="comment">// package-private</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>(-<span class="number">1</span>, <span class="number">0</span>, cap, cap);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">pa</span> <span class="operator">=</span> VM.isDirectMemoryPageAligned();</span><br><span class="line">    <span class="type">int</span> <span class="variable">ps</span> <span class="operator">=</span> Bits.pageSize();</span><br><span class="line">    <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> Math.max(<span class="number">1L</span>, (<span class="type">long</span>)cap + (pa ? ps : <span class="number">0</span>));</span><br><span class="line">    Bits.reserveMemory(size, cap);</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">base</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ†é…å†…å­˜å¹¶è¿”å›åŸºåœ°å€</span></span><br><span class="line">        base = unsafe.allocateMemory(size);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (OutOfMemoryError x) &#123;</span><br><span class="line">        Bits.unreserveMemory(size, cap);</span><br><span class="line">        <span class="keyword">throw</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å†…å­˜åˆå§‹åŒ–</span></span><br><span class="line">    unsafe.setMemory(base, size, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pa &amp;&amp; (base % ps != <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="comment">// Round up to page boundary</span></span><br><span class="line">        address = base + ps - (base &amp; (ps - <span class="number">1</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        address = base;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·Ÿè¸ª DirectByteBuffer å¯¹è±¡çš„åƒåœ¾å›æ”¶ï¼Œä»¥å®ç°å †å¤–å†…å­˜é‡Šæ”¾</span></span><br><span class="line">    cleaner = Cleaner.create(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">Deallocator</span>(base, size, cap));</span><br><span class="line">    att = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å†…å­˜å±éšœ"><a href="#å†…å­˜å±éšœ" class="headerlink" title="å†…å­˜å±éšœ"></a>å†…å­˜å±éšœ</h3><h4 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>åœ¨ä»‹ç»å†…å­˜å±éšœå‰ï¼Œéœ€è¦çŸ¥é“ç¼–è¯‘å™¨å’Œ CPU ä¼šåœ¨ä¿è¯ç¨‹åºè¾“å‡ºç»“æœä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œä¼šå¯¹ä»£ç è¿›è¡Œé‡æ’åºï¼Œä»æŒ‡ä»¤ä¼˜åŒ–è§’åº¦æå‡æ€§èƒ½ã€‚è€ŒæŒ‡ä»¤é‡æ’åºå¯èƒ½ä¼šå¸¦æ¥ä¸€ä¸ªä¸å¥½çš„ç»“æœï¼Œå¯¼è‡´ CPU çš„é«˜é€Ÿç¼“å­˜å’Œå†…å­˜ä¸­æ•°æ®çš„ä¸ä¸€è‡´ï¼Œè€Œå†…å­˜å±éšœï¼ˆ<code>Memory Barrier</code>ï¼‰å°±æ˜¯é€šè¿‡é˜»æ­¢å±éšœä¸¤è¾¹çš„æŒ‡ä»¤é‡æ’åºä»è€Œé¿å…ç¼–è¯‘å™¨å’Œç¡¬ä»¶çš„ä¸æ­£ç¡®ä¼˜åŒ–æƒ…å†µã€‚</p>
<p>åœ¨ç¡¬ä»¶å±‚é¢ä¸Šï¼Œå†…å­˜å±éšœæ˜¯ CPU ä¸ºäº†é˜²æ­¢ä»£ç è¿›è¡Œé‡æ’åºè€Œæä¾›çš„æŒ‡ä»¤ï¼Œä¸åŒçš„ç¡¬ä»¶å¹³å°ä¸Šå®ç°å†…å­˜å±éšœçš„æ–¹æ³•å¯èƒ½å¹¶ä¸ç›¸åŒã€‚åœ¨ Java8 ä¸­ï¼Œå¼•å…¥äº† 3 ä¸ªå†…å­˜å±éšœçš„å‡½æ•°ï¼Œå®ƒå±è”½äº†æ“ä½œç³»ç»Ÿåº•å±‚çš„å·®å¼‚ï¼Œå…è®¸åœ¨ä»£ç ä¸­å®šä¹‰ã€å¹¶ç»Ÿä¸€ç”± JVM æ¥ç”Ÿæˆå†…å­˜å±éšœæŒ‡ä»¤ï¼Œæ¥å®ç°å†…å­˜å±éšœçš„åŠŸèƒ½ã€‚</p>
<p><code>Unsafe</code> ä¸­æä¾›äº†ä¸‹é¢ä¸‰ä¸ªå†…å­˜å±éšœç›¸å…³æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å†…å­˜å±éšœï¼Œç¦æ­¢loadæ“ä½œé‡æ’åºã€‚å±éšœå‰çš„loadæ“ä½œä¸èƒ½è¢«é‡æ’åºåˆ°å±éšœåï¼Œå±éšœåçš„loadæ“ä½œä¸èƒ½è¢«é‡æ’åºåˆ°å±éšœå‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">loadFence</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//å†…å­˜å±éšœï¼Œç¦æ­¢storeæ“ä½œé‡æ’åºã€‚å±éšœå‰çš„storeæ“ä½œä¸èƒ½è¢«é‡æ’åºåˆ°å±éšœåï¼Œå±éšœåçš„storeæ“ä½œä¸èƒ½è¢«é‡æ’åºåˆ°å±éšœå‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">storeFence</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//å†…å­˜å±éšœï¼Œç¦æ­¢loadã€storeæ“ä½œé‡æ’åº</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">fullFence</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>å†…å­˜å±éšœå¯ä»¥çœ‹åšå¯¹å†…å­˜éšæœºè®¿é—®çš„æ“ä½œä¸­çš„ä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œä½¿å¾—æ­¤ç‚¹ä¹‹å‰çš„æ‰€æœ‰è¯»å†™æ“ä½œéƒ½æ‰§è¡Œåæ‰å¯ä»¥å¼€å§‹æ‰§è¡Œæ­¤ç‚¹ä¹‹åçš„æ“ä½œã€‚ä»¥<code>loadFence</code>æ–¹æ³•ä¸ºä¾‹ï¼Œå®ƒä¼šç¦æ­¢è¯»æ“ä½œé‡æ’åºï¼Œä¿è¯åœ¨è¿™ä¸ªå±éšœä¹‹å‰çš„æ‰€æœ‰è¯»æ“ä½œéƒ½å·²ç»å®Œæˆï¼Œå¹¶ä¸”å°†ç¼“å­˜æ•°æ®è®¾ä¸ºæ— æ•ˆï¼Œé‡æ–°ä»ä¸»å­˜ä¸­è¿›è¡ŒåŠ è½½ã€‚</p>
<p>çœ‹åˆ°è¿™ä¼°è®¡å¾ˆå¤šå°ä¼™ä¼´ä»¬ä¼šæƒ³åˆ°<code>volatile</code>å…³é”®å­—äº†ï¼Œå¦‚æœåœ¨å­—æ®µä¸Šæ·»åŠ äº†<code>volatile</code>å…³é”®å­—ï¼Œå°±èƒ½å¤Ÿå®ç°å­—æ®µåœ¨å¤šçº¿ç¨‹ä¸‹çš„å¯è§æ€§ã€‚åŸºäºè¯»å†…å­˜å±éšœï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚ä¸‹é¢å®šä¹‰ä¸€ä¸ªçº¿ç¨‹æ–¹æ³•ï¼Œåœ¨çº¿ç¨‹ä¸­å»ä¿®æ”¹<code>flag</code>æ ‡å¿—ä½ï¼Œæ³¨æ„è¿™é‡Œçš„<code>flag</code>æ˜¯æ²¡æœ‰è¢«<code>volatile</code>ä¿®é¥°çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChangeThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="comment">/**volatile**/</span> <span class="type">boolean</span> flag=<span class="literal">false</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;subThread change flag to:&quot;</span> + flag);</span><br><span class="line">        flag = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸»çº¿ç¨‹çš„<code>while</code>å¾ªç¯ä¸­ï¼ŒåŠ å…¥å†…å­˜å±éšœï¼Œæµ‹è¯•æ˜¯å¦èƒ½å¤Ÿæ„ŸçŸ¥åˆ°<code>flag</code>çš„ä¿®æ”¹å˜åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    <span class="type">ChangeThread</span> <span class="variable">changeThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChangeThread</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(changeThread).start();</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> changeThread.isFlag();</span><br><span class="line">        unsafe.loadFence(); <span class="comment">//åŠ å…¥è¯»å†…å­˜å±éšœ</span></span><br><span class="line">        <span class="keyword">if</span> (flag)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;detected flag changed&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;main thread end&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subThread change flag to:false</span><br><span class="line">detected flag changed</span><br><span class="line">main thread end</span><br></pre></td></tr></table></figure>

<p>è€Œå¦‚æœåˆ æ‰ä¸Šé¢ä»£ç ä¸­çš„<code>loadFence</code>æ–¹æ³•ï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹å°†æ— æ³•æ„ŸçŸ¥åˆ°<code>flag</code>å‘ç”Ÿçš„å˜åŒ–ï¼Œä¼šä¸€ç›´åœ¨<code>while</code>ä¸­å¾ªç¯ã€‚å¯ä»¥ç”¨å›¾æ¥è¡¨ç¤ºä¸Šé¢çš„è¿‡ç¨‹ï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/basis/unsafe/image-20220717144703446.png"></p>
<p>äº†è§£ Java å†…å­˜æ¨¡å‹ï¼ˆ<code>JMM</code>ï¼‰çš„å°ä¼™ä¼´ä»¬åº”è¯¥æ¸…æ¥šï¼Œè¿è¡Œä¸­çš„çº¿ç¨‹ä¸æ˜¯ç›´æ¥è¯»å–ä¸»å†…å­˜ä¸­çš„å˜é‡çš„ï¼Œåªèƒ½æ“ä½œè‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œç„¶ååŒæ­¥åˆ°ä¸»å†…å­˜ä¸­ï¼Œå¹¶ä¸”çº¿ç¨‹çš„å·¥ä½œå†…å­˜æ˜¯ä¸èƒ½å…±äº«çš„ã€‚ä¸Šé¢çš„å›¾ä¸­çš„æµç¨‹å°±æ˜¯å­çº¿ç¨‹å€ŸåŠ©äºä¸»å†…å­˜ï¼Œå°†ä¿®æ”¹åçš„ç»“æœåŒæ­¥ç»™äº†ä¸»çº¿ç¨‹ï¼Œè¿›è€Œä¿®æ”¹ä¸»çº¿ç¨‹ä¸­çš„å·¥ä½œç©ºé—´ï¼Œè·³å‡ºå¾ªç¯ã€‚</p>
<h4 id="å…¸å‹åº”ç”¨-1"><a href="#å…¸å‹åº”ç”¨-1" class="headerlink" title="å…¸å‹åº”ç”¨"></a>å…¸å‹åº”ç”¨</h4><p>åœ¨ Java 8 ä¸­å¼•å…¥äº†ä¸€ç§é”çš„æ–°æœºåˆ¶â€”â€”<code>StampedLock</code>ï¼Œå®ƒå¯ä»¥çœ‹æˆæ˜¯è¯»å†™é”çš„ä¸€ä¸ªæ”¹è¿›ç‰ˆæœ¬ã€‚<code>StampedLock</code> æä¾›äº†ä¸€ç§ä¹è§‚è¯»é”çš„å®ç°ï¼Œè¿™ç§ä¹è§‚è¯»é”ç±»ä¼¼äºæ— é”çš„æ“ä½œï¼Œå®Œå…¨ä¸ä¼šé˜»å¡å†™çº¿ç¨‹è·å–å†™é”ï¼Œä»è€Œç¼“è§£è¯»å¤šå†™å°‘æ—¶å†™çº¿ç¨‹â€œé¥¥é¥¿â€ç°è±¡ã€‚ç”±äº <code>StampedLock</code> æä¾›çš„ä¹è§‚è¯»é”ä¸é˜»å¡å†™çº¿ç¨‹è·å–è¯»é”ï¼Œå½“çº¿ç¨‹å…±äº«å˜é‡ä»ä¸»å†…å­˜ load åˆ°çº¿ç¨‹å·¥ä½œå†…å­˜æ—¶ï¼Œä¼šå­˜åœ¨æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<code>StampedLock</code> çš„ <code>validate</code> æ–¹æ³•ä¼šé€šè¿‡ <code>Unsafe</code> çš„ <code>loadFence</code> æ–¹æ³•åŠ å…¥ä¸€ä¸ª <code>load</code> å†…å­˜å±éšœã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">validate</span><span class="params">(<span class="type">long</span> stamp)</span> &#123;</span><br><span class="line">   U.loadFence();</span><br><span class="line">   <span class="keyword">return</span> (stamp &amp; SBITS) == (state &amp; SBITS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¯¹è±¡æ“ä½œ"><a href="#å¯¹è±¡æ“ä½œ" class="headerlink" title="å¯¹è±¡æ“ä½œ"></a>å¯¹è±¡æ“ä½œ</h3><h4 id="ä»‹ç»-2"><a href="#ä»‹ç»-2" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p><strong>ä¾‹å­</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> reflectGetUnsafe();</span><br><span class="line">        <span class="keyword">assert</span> unsafe != <span class="literal">null</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> unsafe.objectFieldOffset(Main.class.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">        <span class="type">Main</span> <span class="variable">main</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Main</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;value before putInt: &quot;</span> + main.value);</span><br><span class="line">        unsafe.putInt(main, offset, <span class="number">42</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;value after putInt: &quot;</span> + main.value);</span><br><span class="line">  System.out.println(<span class="string">&quot;value after putInt: &quot;</span> + unsafe.getInt(main, offset));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Unsafe <span class="title function_">reflectGetUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> (Unsafe) field.get(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">value before putInt: 0</span><br><span class="line">value after putInt: 42</span><br><span class="line">value after putInt: 42</span><br></pre></td></tr></table></figure>

<p><strong>å¯¹è±¡å±æ€§</strong></p>
<p>å¯¹è±¡æˆå‘˜å±æ€§çš„å†…å­˜åç§»é‡è·å–ï¼Œä»¥åŠå­—æ®µå±æ€§å€¼çš„ä¿®æ”¹ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­æˆ‘ä»¬å·²ç»æµ‹è¯•è¿‡äº†ã€‚é™¤äº†å‰é¢çš„<code>putInt</code>ã€<code>getInt</code>æ–¹æ³•å¤–ï¼ŒUnsafe æä¾›äº†å…¨éƒ¨ 8 ç§åŸºç¡€æ•°æ®ç±»å‹ä»¥åŠ<code>Object</code>çš„<code>put</code>å’Œ<code>get</code>æ–¹æ³•ï¼Œå¹¶ä¸”æ‰€æœ‰çš„<code>put</code>æ–¹æ³•éƒ½å¯ä»¥è¶Šè¿‡è®¿é—®æƒé™ï¼Œç›´æ¥ä¿®æ”¹å†…å­˜ä¸­çš„æ•°æ®ã€‚é˜…è¯» openJDK æºç ä¸­çš„æ³¨é‡Šå‘ç°ï¼ŒåŸºç¡€æ•°æ®ç±»å‹å’Œ<code>Object</code>çš„è¯»å†™ç¨æœ‰ä¸åŒï¼ŒåŸºç¡€æ•°æ®ç±»å‹æ˜¯ç›´æ¥æ“ä½œçš„å±æ€§å€¼ï¼ˆ<code>value</code>ï¼‰ï¼Œè€Œ<code>Object</code>çš„æ“ä½œåˆ™æ˜¯åŸºäºå¼•ç”¨å€¼ï¼ˆ<code>reference value</code>ï¼‰ã€‚ä¸‹é¢æ˜¯<code>Object</code>çš„è¯»å†™æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨å¯¹è±¡çš„æŒ‡å®šåç§»åœ°å€è·å–ä¸€ä¸ªå¯¹è±¡å¼•ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">getObject</span><span class="params">(Object o, <span class="type">long</span> offset)</span>;</span><br><span class="line"><span class="comment">//åœ¨å¯¹è±¡æŒ‡å®šåç§»åœ°å€å†™å…¥ä¸€ä¸ªå¯¹è±¡å¼•ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putObject</span><span class="params">(Object o, <span class="type">long</span> offset, Object x)</span>;</span><br></pre></td></tr></table></figure>

<p>é™¤äº†å¯¹è±¡å±æ€§çš„æ™®é€šè¯»å†™å¤–ï¼Œ<code>Unsafe</code> è¿˜æä¾›äº† <strong>volatile è¯»å†™</strong>å’Œ<strong>æœ‰åºå†™å…¥</strong>æ–¹æ³•ã€‚<code>volatile</code>è¯»å†™æ–¹æ³•çš„è¦†ç›–èŒƒå›´ä¸æ™®é€šè¯»å†™ç›¸åŒï¼ŒåŒ…å«äº†å…¨éƒ¨åŸºç¡€æ•°æ®ç±»å‹å’Œ<code>Object</code>ç±»å‹ï¼Œä»¥<code>int</code>ç±»å‹ä¸ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨å¯¹è±¡çš„æŒ‡å®šåç§»åœ°å€å¤„è¯»å–ä¸€ä¸ªintå€¼ï¼Œæ”¯æŒvolatile loadè¯­ä¹‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">getIntVolatile</span><span class="params">(Object o, <span class="type">long</span> offset)</span>;</span><br><span class="line"><span class="comment">//åœ¨å¯¹è±¡æŒ‡å®šåç§»åœ°å€å¤„å†™å…¥ä¸€ä¸ªintï¼Œæ”¯æŒvolatile storeè¯­ä¹‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putIntVolatile</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">int</span> x)</span>;</span><br></pre></td></tr></table></figure>

<p>ç›¸å¯¹äºæ™®é€šè¯»å†™æ¥è¯´ï¼Œ<code>volatile</code>è¯»å†™å…·æœ‰æ›´é«˜çš„æˆæœ¬ï¼Œå› ä¸ºå®ƒéœ€è¦ä¿è¯å¯è§æ€§å’Œæœ‰åºæ€§ã€‚åœ¨æ‰§è¡Œ<code>get</code>æ“ä½œæ—¶ï¼Œä¼šå¼ºåˆ¶ä»ä¸»å­˜ä¸­è·å–å±æ€§å€¼ï¼Œåœ¨ä½¿ç”¨<code>put</code>æ–¹æ³•è®¾ç½®å±æ€§å€¼æ—¶ï¼Œä¼šå¼ºåˆ¶å°†å€¼æ›´æ–°åˆ°ä¸»å­˜ä¸­ï¼Œä»è€Œä¿è¯è¿™äº›å˜æ›´å¯¹å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ã€‚</p>
<p>æœ‰åºå†™å…¥çš„æ–¹æ³•æœ‰ä»¥ä¸‹ä¸‰ä¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putOrderedObject</span><span class="params">(Object o, <span class="type">long</span> offset, Object x)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putOrderedInt</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">int</span> x)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putOrderedLong</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">long</span> x)</span>;</span><br></pre></td></tr></table></figure>

<p>æœ‰åºå†™å…¥çš„æˆæœ¬ç›¸å¯¹<code>volatile</code>è¾ƒä½ï¼Œå› ä¸ºå®ƒåªä¿è¯å†™å…¥æ—¶çš„æœ‰åºæ€§ï¼Œè€Œä¸ä¿è¯å¯è§æ€§ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹å†™å…¥çš„å€¼ä¸èƒ½ä¿è¯å…¶ä»–çº¿ç¨‹ç«‹å³å¯è§ã€‚ä¸ºäº†è§£å†³è¿™é‡Œçš„å·®å¼‚æ€§ï¼Œéœ€è¦å¯¹å†…å­˜å±éšœçš„çŸ¥è¯†ç‚¹å†è¿›ä¸€æ­¥è¿›è¡Œè¡¥å……ï¼Œé¦–å…ˆéœ€è¦äº†è§£ä¸¤ä¸ªæŒ‡ä»¤çš„æ¦‚å¿µï¼š</p>
<ul>
<li><code>Load</code>ï¼šå°†ä¸»å†…å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°å¤„ç†å™¨çš„ç¼“å­˜ä¸­</li>
<li><code>Store</code>ï¼šå°†å¤„ç†å™¨ç¼“å­˜çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­</li>
</ul>
<p>é¡ºåºå†™å…¥ä¸<code>volatile</code>å†™å…¥çš„å·®åˆ«åœ¨äºï¼Œåœ¨é¡ºåºå†™æ—¶åŠ å…¥çš„å†…å­˜å±éšœç±»å‹ä¸º<code>StoreStore</code>ç±»å‹ï¼Œè€Œåœ¨<code>volatile</code>å†™å…¥æ—¶åŠ å…¥çš„å†…å­˜å±éšœæ˜¯<code>StoreLoad</code>ç±»å‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/basis/unsafe/image-20220717144834132.png"></p>
<p>åœ¨æœ‰åºå†™å…¥æ–¹æ³•ä¸­ï¼Œä½¿ç”¨çš„æ˜¯<code>StoreStore</code>å±éšœï¼Œè¯¥å±éšœç¡®ä¿<code>Store1</code>ç«‹åˆ»åˆ·æ–°æ•°æ®åˆ°å†…å­˜ï¼Œè¿™ä¸€æ“ä½œå…ˆäº<code>Store2</code>ä»¥åŠåç»­çš„å­˜å‚¨æŒ‡ä»¤æ“ä½œã€‚è€Œåœ¨<code>volatile</code>å†™å…¥ä¸­ï¼Œä½¿ç”¨çš„æ˜¯<code>StoreLoad</code>å±éšœï¼Œè¯¥å±éšœç¡®ä¿<code>Store1</code>ç«‹åˆ»åˆ·æ–°æ•°æ®åˆ°å†…å­˜ï¼Œè¿™ä¸€æ“ä½œå…ˆäº<code>Load2</code>åŠåç»­çš„è£…è½½æŒ‡ä»¤ï¼Œå¹¶ä¸”ï¼Œ<code>StoreLoad</code>å±éšœä¼šä½¿è¯¥å±éšœä¹‹å‰çš„æ‰€æœ‰å†…å­˜è®¿é—®æŒ‡ä»¤ï¼ŒåŒ…æ‹¬å­˜å‚¨æŒ‡ä»¤å’Œè®¿é—®æŒ‡ä»¤å…¨éƒ¨å®Œæˆä¹‹åï¼Œæ‰æ‰§è¡Œè¯¥å±éšœä¹‹åçš„å†…å­˜è®¿é—®æŒ‡ä»¤ã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨ä¸Šé¢çš„ä¸‰ç±»å†™å…¥æ–¹æ³•ä¸­ï¼Œåœ¨å†™å…¥æ•ˆç‡æ–¹é¢ï¼ŒæŒ‰ç…§<code>put</code>ã€<code>putOrder</code>ã€<code>putVolatile</code>çš„é¡ºåºæ•ˆç‡é€æ¸é™ä½ã€‚</p>
<p><strong>å¯¹è±¡å®ä¾‹åŒ–</strong></p>
<p>ä½¿ç”¨ <code>Unsafe</code> çš„ <code>allocateInstance</code> æ–¹æ³•ï¼Œå…è®¸æˆ‘ä»¬ä½¿ç”¨éå¸¸è§„çš„æ–¹å¼è¿›è¡Œå¯¹è±¡çš„å®ä¾‹åŒ–ï¼Œé¦–å…ˆå®šä¹‰ä¸€ä¸ªå®ä½“ç±»ï¼Œå¹¶ä¸”åœ¨æ„é€ å‡½æ•°ä¸­å¯¹å…¶æˆå‘˜å˜é‡è¿›è¡Œèµ‹å€¼æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> b;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">A</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.b =<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ†åˆ«åŸºäºæ„é€ å‡½æ•°ã€åå°„ä»¥åŠ <code>Unsafe</code> æ–¹æ³•çš„ä¸åŒæ–¹å¼åˆ›å»ºå¯¹è±¡è¿›è¡Œæ¯”è¾ƒï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">objTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    A a1=<span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">    System.out.println(a1.getB());</span><br><span class="line">    <span class="type">A</span> <span class="variable">a2</span> <span class="operator">=</span> A.class.newInstance();</span><br><span class="line">    System.out.println(a2.getB());</span><br><span class="line">    A a3= (A) unsafe.allocateInstance(A.class);</span><br><span class="line">    System.out.println(a3.getB());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰“å°ç»“æœåˆ†åˆ«ä¸º 1ã€1ã€0ï¼Œè¯´æ˜é€šè¿‡<code>allocateInstance</code>æ–¹æ³•åˆ›å»ºå¯¹è±¡è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•ã€‚ä½¿ç”¨è¿™ç§æ–¹å¼åˆ›å»ºå¯¹è±¡æ—¶ï¼Œåªç”¨åˆ°äº†<code>Class</code>å¯¹è±¡ï¼Œæ‰€ä»¥è¯´å¦‚æœæƒ³è¦è·³è¿‡å¯¹è±¡çš„åˆå§‹åŒ–é˜¶æ®µæˆ–è€…è·³è¿‡æ„é€ å™¨çš„å®‰å…¨æ£€æŸ¥ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœå°† A ç±»çš„æ„é€ å‡½æ•°æ”¹ä¸º<code>private</code>ç±»å‹ï¼Œå°†æ— æ³•é€šè¿‡æ„é€ å‡½æ•°å’Œåå°„åˆ›å»ºå¯¹è±¡ï¼ˆå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°å¯¹è±¡ setAccessible ååˆ›å»ºå¯¹è±¡ï¼‰ï¼Œä½†<code>allocateInstance</code>æ–¹æ³•ä»ç„¶æœ‰æ•ˆã€‚</p>
<h4 id="å…¸å‹åº”ç”¨-2"><a href="#å…¸å‹åº”ç”¨-2" class="headerlink" title="å…¸å‹åº”ç”¨"></a>å…¸å‹åº”ç”¨</h4><ul>
<li><strong>å¸¸è§„å¯¹è±¡å®ä¾‹åŒ–æ–¹å¼</strong>ï¼šæˆ‘ä»¬é€šå¸¸æ‰€ç”¨åˆ°çš„åˆ›å»ºå¯¹è±¡çš„æ–¹å¼ï¼Œä»æœ¬è´¨ä¸Šæ¥è®²ï¼Œéƒ½æ˜¯é€šè¿‡ new æœºåˆ¶æ¥å®ç°å¯¹è±¡çš„åˆ›å»ºã€‚ä½†æ˜¯ï¼Œnew æœºåˆ¶æœ‰ä¸ªç‰¹ç‚¹å°±æ˜¯å½“ç±»åªæä¾›æœ‰å‚çš„æ„é€ å‡½æ•°ä¸”æ— æ˜¾å¼å£°æ˜æ— å‚æ„é€ å‡½æ•°æ—¶ï¼Œåˆ™å¿…é¡»ä½¿ç”¨æœ‰å‚æ„é€ å‡½æ•°è¿›è¡Œå¯¹è±¡æ„é€ ï¼Œè€Œä½¿ç”¨æœ‰å‚æ„é€ å‡½æ•°æ—¶ï¼Œå¿…é¡»ä¼ é€’ç›¸åº”ä¸ªæ•°çš„å‚æ•°æ‰èƒ½å®Œæˆå¯¹è±¡å®ä¾‹åŒ–ã€‚</li>
<li><strong>éå¸¸è§„çš„å®ä¾‹åŒ–æ–¹å¼</strong>ï¼šè€Œ Unsafe ä¸­æä¾› allocateInstance æ–¹æ³•ï¼Œä»…é€šè¿‡ Class å¯¹è±¡å°±å¯ä»¥åˆ›å»ºæ­¤ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œè€Œä¸”ä¸éœ€è¦è°ƒç”¨å…¶æ„é€ å‡½æ•°ã€åˆå§‹åŒ–ä»£ç ã€JVM å®‰å…¨æ£€æŸ¥ç­‰ã€‚å®ƒæŠ‘åˆ¶ä¿®é¥°ç¬¦æ£€æµ‹ï¼Œä¹Ÿå°±æ˜¯å³ä½¿æ„é€ å™¨æ˜¯ private ä¿®é¥°çš„ä¹Ÿèƒ½é€šè¿‡æ­¤æ–¹æ³•å®ä¾‹åŒ–ï¼Œåªéœ€æç±»å¯¹è±¡å³å¯åˆ›å»ºç›¸åº”çš„å¯¹è±¡ã€‚ç”±äºè¿™ç§ç‰¹æ€§ï¼ŒallocateInstance åœ¨ java.lang.invokeã€Objenesisï¼ˆæä¾›ç»•è¿‡ç±»æ„é€ å™¨çš„å¯¹è±¡ç”Ÿæˆæ–¹å¼ï¼‰ã€Gsonï¼ˆååºåˆ—åŒ–æ—¶ç”¨åˆ°ï¼‰ä¸­éƒ½æœ‰ç›¸åº”çš„åº”ç”¨ã€‚</li>
</ul>
<h3 id="æ•°ç»„æ“ä½œ"><a href="#æ•°ç»„æ“ä½œ" class="headerlink" title="æ•°ç»„æ“ä½œ"></a>æ•°ç»„æ“ä½œ</h3><h4 id="ä»‹ç»-3"><a href="#ä»‹ç»-3" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p><code>arrayBaseOffset</code> ä¸ <code>arrayIndexScale</code> è¿™ä¸¤ä¸ªæ–¹æ³•é…åˆèµ·æ¥ä½¿ç”¨ï¼Œå³å¯å®šä½æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ åœ¨å†…å­˜ä¸­çš„ä½ç½®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿”å›æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">arrayBaseOffset</span><span class="params">(Class&lt;?&gt; arrayClass)</span>;</span><br><span class="line"><span class="comment">//è¿”å›æ•°ç»„ä¸­ä¸€ä¸ªå…ƒç´ å ç”¨çš„å¤§å°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">arrayIndexScale</span><span class="params">(Class&lt;?&gt; arrayClass)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="å…¸å‹åº”ç”¨-3"><a href="#å…¸å‹åº”ç”¨-3" class="headerlink" title="å…¸å‹åº”ç”¨"></a>å…¸å‹åº”ç”¨</h4><p>è¿™ä¸¤ä¸ªä¸æ•°æ®æ“ä½œç›¸å…³çš„æ–¹æ³•ï¼Œåœ¨ <code>java.util.concurrent.atomic</code> åŒ…ä¸‹çš„ <code>AtomicIntegerArray</code>ï¼ˆå¯ä»¥å®ç°å¯¹ <code>Integer</code> æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„åŸå­æ€§æ“ä½œï¼‰ä¸­æœ‰å…¸å‹çš„åº”ç”¨ï¼Œå¦‚ä¸‹å›¾ <code>AtomicIntegerArray</code> æºç æ‰€ç¤ºï¼Œé€šè¿‡ <code>Unsafe</code> çš„ <code>arrayBaseOffset</code>ã€<code>arrayIndexScale</code> åˆ†åˆ«è·å–æ•°ç»„é¦–å…ƒç´ çš„åç§»åœ°å€ <code>base</code> åŠå•ä¸ªå…ƒç´ å¤§å°å› å­ <code>scale</code> ã€‚åç»­ç›¸å…³åŸå­æ€§æ“ä½œï¼Œå‡ä¾èµ–äºè¿™ä¸¤ä¸ªå€¼è¿›è¡Œæ•°ç»„ä¸­å…ƒç´ çš„å®šä½ï¼Œå¦‚ä¸‹å›¾äºŒæ‰€ç¤ºçš„ <code>getAndAdd</code> æ–¹æ³•å³é€šè¿‡ <code>checkedByteOffset</code> æ–¹æ³•è·å–æŸæ•°ç»„å…ƒç´ çš„åç§»åœ°å€ï¼Œè€Œåé€šè¿‡ CAS å®ç°åŸå­æ€§æ“ä½œã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/basis/unsafe/image-20220717144927257.png"></p>
<h3 id="CAS-æ“ä½œ"><a href="#CAS-æ“ä½œ" class="headerlink" title="CAS æ“ä½œ"></a>CAS æ“ä½œ</h3><h4 id="ä»‹ç»-4"><a href="#ä»‹ç»-4" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>è¿™éƒ¨åˆ†ä¸»è¦ä¸º CAS ç›¸å…³æ“ä½œçš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  *  CAS</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> o         åŒ…å«è¦ä¿®æ”¹fieldçš„å¯¹è±¡</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> offset    å¯¹è±¡ä¸­æŸfieldçš„åç§»é‡</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> expected  æœŸæœ›å€¼</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> update    æ›´æ–°å€¼</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span>          true | false</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapObject</span><span class="params">(Object o, <span class="type">long</span> offset,  Object expected, Object update)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapInt</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">int</span> expected,<span class="type">int</span> update)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapLong</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">long</span> expected, <span class="type">long</span> update)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ä»€ä¹ˆæ˜¯ CAS?</strong> CAS å³æ¯”è¾ƒå¹¶æ›¿æ¢ï¼ˆCompare And Swap)ï¼Œæ˜¯å®ç°å¹¶å‘ç®—æ³•æ—¶å¸¸ç”¨åˆ°çš„ä¸€ç§æŠ€æœ¯ã€‚CAS æ“ä½œåŒ…å«ä¸‰ä¸ªæ“ä½œæ•°â€”â€”å†…å­˜ä½ç½®ã€é¢„æœŸåŸå€¼åŠæ–°å€¼ã€‚æ‰§è¡Œ CAS æ“ä½œçš„æ—¶å€™ï¼Œå°†å†…å­˜ä½ç½®çš„å€¼ä¸é¢„æœŸåŸå€¼æ¯”è¾ƒï¼Œå¦‚æœç›¸åŒ¹é…ï¼Œé‚£ä¹ˆå¤„ç†å™¨ä¼šè‡ªåŠ¨å°†è¯¥ä½ç½®å€¼æ›´æ–°ä¸ºæ–°å€¼ï¼Œå¦åˆ™ï¼Œå¤„ç†å™¨ä¸åšä»»ä½•æ“ä½œã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒCAS æ˜¯ä¸€æ¡ CPU çš„åŸå­æŒ‡ä»¤ï¼ˆcmpxchg æŒ‡ä»¤ï¼‰ï¼Œä¸ä¼šé€ æˆæ‰€è°“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œ<code>Unsafe</code> æä¾›çš„ CAS æ–¹æ³•ï¼ˆå¦‚ <code>compareAndSwapXXX</code>ï¼‰åº•å±‚å®ç°å³ä¸º CPU æŒ‡ä»¤ <code>cmpxchg</code> ã€‚</p>
<h4 id="å…¸å‹åº”ç”¨-4"><a href="#å…¸å‹åº”ç”¨-4" class="headerlink" title="å…¸å‹åº”ç”¨"></a>å…¸å‹åº”ç”¨</h4><p>åœ¨ JUC åŒ…çš„å¹¶å‘å·¥å…·ç±»ä¸­å¤§é‡åœ°ä½¿ç”¨äº† CAS æ“ä½œï¼Œåƒåœ¨å‰é¢ä»‹ç»<code>synchronized</code>å’Œ<code>AQS</code>çš„æ–‡ç« ä¸­ä¹Ÿå¤šæ¬¡æåˆ°äº† CASï¼Œå…¶ä½œä¸ºä¹è§‚é”åœ¨å¹¶å‘å·¥å…·ç±»ä¸­å¹¿æ³›å‘æŒ¥äº†ä½œç”¨ã€‚åœ¨ <code>Unsafe</code> ç±»ä¸­ï¼Œæä¾›äº†<code>compareAndSwapObject</code>ã€<code>compareAndSwapInt</code>ã€<code>compareAndSwapLong</code>æ–¹æ³•æ¥å®ç°çš„å¯¹<code>Object</code>ã€<code>int</code>ã€<code>long</code>ç±»å‹çš„ CAS æ“ä½œã€‚ä»¥<code>compareAndSwapInt</code>æ–¹æ³•ä¸ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapInt</span><span class="params">(Object o, <span class="type">long</span> offset,<span class="type">int</span> expected,<span class="type">int</span> x)</span>;</span><br></pre></td></tr></table></figure>

<p>å‚æ•°ä¸­<code>o</code>ä¸ºéœ€è¦æ›´æ–°çš„å¯¹è±¡ï¼Œ<code>offset</code>æ˜¯å¯¹è±¡<code>o</code>ä¸­æ•´å½¢å­—æ®µçš„åç§»é‡ï¼Œå¦‚æœè¿™ä¸ªå­—æ®µçš„å€¼ä¸<code>expected</code>ç›¸åŒï¼Œåˆ™å°†å­—æ®µçš„å€¼è®¾ä¸º<code>x</code>è¿™ä¸ªæ–°å€¼ï¼Œå¹¶ä¸”æ­¤æ›´æ–°æ˜¯ä¸å¯è¢«ä¸­æ–­çš„ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨<code>compareAndSwapInt</code>çš„ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> a;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    CasTest casTest=<span class="keyword">new</span> <span class="title class_">CasTest</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            casTest.increment(i);</span><br><span class="line">            System.out.print(casTest.a+<span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">5</span> ; i &lt;<span class="number">10</span> ; i++) &#123;</span><br><span class="line">            casTest.increment(i);</span><br><span class="line">            System.out.print(casTest.a+<span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">(<span class="type">int</span> x)</span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">fieldOffset</span> <span class="operator">=</span> unsafe.objectFieldOffset(CasTest.class.getDeclaredField(<span class="string">&quot;a&quot;</span>));</span><br><span class="line">            <span class="keyword">if</span> (unsafe.compareAndSwapInt(<span class="built_in">this</span>,fieldOffset,x-<span class="number">1</span>,x))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä»£ç ä¼šä¾æ¬¡è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 2 3 4 5 6 7 8 9</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹å»ä¿®æ”¹<code>int</code>å‹å±æ€§<code>a</code>çš„å€¼ï¼Œå¹¶ä¸”åªæœ‰åœ¨<code>a</code>çš„å€¼ç­‰äºä¼ å…¥çš„å‚æ•°<code>x</code>å‡ä¸€æ—¶ï¼Œæ‰ä¼šå°†<code>a</code>çš„å€¼å˜ä¸º<code>x</code>ï¼Œä¹Ÿå°±æ˜¯å®ç°å¯¹<code>a</code>çš„åŠ ä¸€çš„æ“ä½œã€‚æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/basis/unsafe/image-20220717144939826.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è°ƒç”¨<code>compareAndSwapInt</code>æ–¹æ³•åï¼Œä¼šç›´æ¥è¿”å›<code>true</code>æˆ–<code>false</code>çš„ä¿®æ”¹ç»“æœï¼Œå› æ­¤éœ€è¦æˆ‘ä»¬åœ¨ä»£ç ä¸­æ‰‹åŠ¨æ·»åŠ è‡ªæ—‹çš„é€»è¾‘ã€‚åœ¨<code>AtomicInteger</code>ç±»çš„è®¾è®¡ä¸­ï¼Œä¹Ÿæ˜¯é‡‡ç”¨äº†å°†<code>compareAndSwapInt</code>çš„ç»“æœä½œä¸ºå¾ªç¯æ¡ä»¶ï¼Œç›´è‡³ä¿®æ”¹æˆåŠŸæ‰é€€å‡ºæ­»å¾ªç¯çš„æ–¹å¼æ¥å®ç°çš„åŸå­æ€§çš„è‡ªå¢æ“ä½œã€‚</p>
<h3 id="çº¿ç¨‹è°ƒåº¦"><a href="#çº¿ç¨‹è°ƒåº¦" class="headerlink" title="çº¿ç¨‹è°ƒåº¦"></a>çº¿ç¨‹è°ƒåº¦</h3><h4 id="ä»‹ç»-5"><a href="#ä»‹ç»-5" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p><code>Unsafe</code> ç±»ä¸­æä¾›äº†<code>park</code>ã€<code>unpark</code>ã€<code>monitorEnter</code>ã€<code>monitorExit</code>ã€<code>tryMonitorEnter</code>æ–¹æ³•è¿›è¡Œçº¿ç¨‹è°ƒåº¦ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å–æ¶ˆé˜»å¡çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">unpark</span><span class="params">(Object thread)</span>;</span><br><span class="line"><span class="comment">//é˜»å¡çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">park</span><span class="params">(<span class="type">boolean</span> isAbsolute, <span class="type">long</span> time)</span>;</span><br><span class="line"><span class="comment">//è·å¾—å¯¹è±¡é”ï¼ˆå¯é‡å…¥é”ï¼‰</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">monitorEnter</span><span class="params">(Object o)</span>;</span><br><span class="line"><span class="comment">//é‡Šæ”¾å¯¹è±¡é”</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">monitorExit</span><span class="params">(Object o)</span>;</span><br><span class="line"><span class="comment">//å°è¯•è·å–å¯¹è±¡é”</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">tryMonitorEnter</span><span class="params">(Object o)</span>;</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³• <code>park</code>ã€<code>unpark</code> å³å¯å®ç°çº¿ç¨‹çš„æŒ‚èµ·ä¸æ¢å¤ï¼Œå°†ä¸€ä¸ªçº¿ç¨‹è¿›è¡ŒæŒ‚èµ·æ˜¯é€šè¿‡ <code>park</code> æ–¹æ³•å®ç°çš„ï¼Œè°ƒç”¨ <code>park</code> æ–¹æ³•åï¼Œçº¿ç¨‹å°†ä¸€ç›´é˜»å¡ç›´åˆ°è¶…æ—¶æˆ–è€…ä¸­æ–­ç­‰æ¡ä»¶å‡ºç°ï¼›<code>unpark</code> å¯ä»¥ç»ˆæ­¢ä¸€ä¸ªæŒ‚èµ·çš„çº¿ç¨‹ï¼Œä½¿å…¶æ¢å¤æ­£å¸¸ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>Unsafe</code> æºç ä¸­<code>monitor</code>ç›¸å…³çš„ä¸‰ä¸ªæ–¹æ³•å·²ç»è¢«æ ‡è®°ä¸º<code>deprecated</code>ï¼Œä¸å»ºè®®è¢«ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å¾—å¯¹è±¡é”</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">monitorEnter</span><span class="params">(Object var1)</span>;</span><br><span class="line"><span class="comment">//é‡Šæ”¾å¯¹è±¡é”</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">monitorExit</span><span class="params">(Object var1)</span>;</span><br><span class="line"><span class="comment">//å°è¯•è·å¾—å¯¹è±¡é”</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">tryMonitorEnter</span><span class="params">(Object var1)</span>;</span><br></pre></td></tr></table></figure>

<p><code>monitorEnter</code>æ–¹æ³•ç”¨äºè·å¾—å¯¹è±¡é”ï¼Œ<code>monitorExit</code>ç”¨äºé‡Šæ”¾å¯¹è±¡é”ï¼Œå¦‚æœå¯¹ä¸€ä¸ªæ²¡æœ‰è¢«<code>monitorEnter</code>åŠ é”çš„å¯¹è±¡æ‰§è¡Œæ­¤æ–¹æ³•ï¼Œä¼šæŠ›å‡º<code>IllegalMonitorStateException</code>å¼‚å¸¸ã€‚<code>tryMonitorEnter</code>æ–¹æ³•å°è¯•è·å–å¯¹è±¡é”ï¼Œå¦‚æœæˆåŠŸåˆ™è¿”å›<code>true</code>ï¼Œåä¹‹è¿”å›<code>false</code>ã€‚</p>
<h4 id="å…¸å‹åº”ç”¨-5"><a href="#å…¸å‹åº”ç”¨-5" class="headerlink" title="å…¸å‹åº”ç”¨"></a>å…¸å‹åº”ç”¨</h4><p>Java é”å’ŒåŒæ­¥å™¨æ¡†æ¶çš„æ ¸å¿ƒç±» <code>AbstractQueuedSynchronizer</code> (AQS)ï¼Œå°±æ˜¯é€šè¿‡è°ƒç”¨<code>LockSupport.park()</code>å’Œ<code>LockSupport.unpark()</code>å®ç°çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’çš„ï¼Œè€Œ <code>LockSupport</code> çš„ <code>park</code>ã€<code>unpark</code> æ–¹æ³•å®é™…æ˜¯è°ƒç”¨ <code>Unsafe</code> çš„ <code>park</code>ã€<code>unpark</code> æ–¹å¼å®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">park</span><span class="params">(Object blocker)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    setBlocker(t, blocker);</span><br><span class="line">    UNSAFE.park(<span class="literal">false</span>, <span class="number">0L</span>);</span><br><span class="line">    setBlocker(t, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unpark</span><span class="params">(Thread thread)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (thread != <span class="literal">null</span>)</span><br><span class="line">        UNSAFE.unpark(thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LockSupport</code> çš„<code>park</code>æ–¹æ³•è°ƒç”¨äº† <code>Unsafe</code> çš„<code>park</code>æ–¹æ³•æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ­¤æ–¹æ³•å°†çº¿ç¨‹é˜»å¡åå°±ä¸ä¼šç»§ç»­å¾€åæ‰§è¡Œï¼Œç›´åˆ°æœ‰å…¶ä»–çº¿ç¨‹è°ƒç”¨<code>unpark</code>æ–¹æ³•å”¤é†’å½“å‰çº¿ç¨‹ã€‚ä¸‹é¢çš„ä¾‹å­å¯¹ <code>Unsafe</code> çš„è¿™ä¸¤ä¸ªæ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">mainThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;subThread try to unpark mainThread&quot;</span>);</span><br><span class="line">            unsafe.unpark(mainThread);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;park main mainThread&quot;</span>);</span><br><span class="line">    unsafe.park(<span class="literal">false</span>,<span class="number">0L</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;unpark mainThread success&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºè¾“å‡ºä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">park main mainThread</span><br><span class="line">subThread try to unpark mainThread</span><br><span class="line">unpark mainThread success</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºè¿è¡Œçš„æµç¨‹ä¹Ÿæ¯”è¾ƒå®¹æ˜“çœ‹æ‡‚ï¼Œå­çº¿ç¨‹å¼€å§‹è¿è¡Œåå…ˆè¿›è¡Œç¡çœ ï¼Œç¡®ä¿ä¸»çº¿ç¨‹èƒ½å¤Ÿè°ƒç”¨<code>park</code>æ–¹æ³•é˜»å¡è‡ªå·±ï¼Œå­çº¿ç¨‹åœ¨ç¡çœ  5 ç§’åï¼Œè°ƒç”¨<code>unpark</code>æ–¹æ³•å”¤é†’ä¸»çº¿ç¨‹ï¼Œä½¿ä¸»çº¿ç¨‹èƒ½ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/basis/unsafe/image-20220717144950116.png"></p>
<h3 id="Class-æ“ä½œ"><a href="#Class-æ“ä½œ" class="headerlink" title="Class æ“ä½œ"></a>Class æ“ä½œ</h3><h4 id="ä»‹ç»-6"><a href="#ä»‹ç»-6" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p><code>Unsafe</code> å¯¹<code>Class</code>çš„ç›¸å…³æ“ä½œä¸»è¦åŒ…æ‹¬ç±»åŠ è½½å’Œé™æ€å˜é‡çš„æ“ä½œæ–¹æ³•ã€‚</p>
<p><strong>é™æ€å±æ€§è¯»å–ç›¸å…³çš„æ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–é™æ€å±æ€§çš„åç§»é‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">staticFieldOffset</span><span class="params">(Field f)</span>;</span><br><span class="line"><span class="comment">//è·å–é™æ€å±æ€§çš„å¯¹è±¡æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">staticFieldBase</span><span class="params">(Field f)</span>;</span><br><span class="line"><span class="comment">//åˆ¤æ–­ç±»æ˜¯å¦éœ€è¦åˆå§‹åŒ–ï¼ˆç”¨äºè·å–ç±»çš„é™æ€å±æ€§å‰è¿›è¡Œæ£€æµ‹ï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">shouldBeInitialized</span><span class="params">(Class&lt;?&gt; c)</span>;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸€ä¸ªåŒ…å«é™æ€å±æ€§çš„ç±»ï¼Œè¿›è¡Œæµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String name=<span class="string">&quot;Hydra&quot;</span>;</span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">staticTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    User user=<span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    <span class="comment">// ä¹Ÿå¯ä»¥ç”¨ä¸‹é¢çš„è¯­å¥è§¦å‘ç±»åˆå§‹åŒ–</span></span><br><span class="line">    <span class="comment">// 1.</span></span><br><span class="line">    <span class="comment">// unsafe.ensureClassInitialized(User.class);</span></span><br><span class="line">    <span class="comment">// 2.</span></span><br><span class="line">    <span class="comment">// System.out.println(User.name);</span></span><br><span class="line">    System.out.println(unsafe.shouldBeInitialized(User.class));</span><br><span class="line">    <span class="type">Field</span> <span class="variable">sexField</span> <span class="operator">=</span> User.class.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">fieldOffset</span> <span class="operator">=</span> unsafe.staticFieldOffset(sexField);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">fieldBase</span> <span class="operator">=</span> unsafe.staticFieldBase(sexField);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> unsafe.getObject(fieldBase, fieldOffset);</span><br><span class="line">    System.out.println(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">false</span><br><span class="line">Hydra</span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>Unsafe</code> çš„å¯¹è±¡æ“ä½œä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†é€šè¿‡<code>objectFieldOffset</code>æ–¹æ³•è·å–å¯¹è±¡å±æ€§åç§»é‡å¹¶åŸºäºå®ƒå¯¹å˜é‡çš„å€¼è¿›è¡Œå­˜å–ï¼Œä½†æ˜¯å®ƒä¸é€‚ç”¨äºç±»ä¸­çš„é™æ€å±æ€§ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨<code>staticFieldOffset</code>æ–¹æ³•ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œåªæœ‰åœ¨è·å–<code>Field</code>å¯¹è±¡çš„è¿‡ç¨‹ä¸­ä¾èµ–åˆ°äº†<code>Class</code>ï¼Œè€Œè·å–é™æ€å˜é‡çš„å±æ€§æ—¶ä¸å†ä¾èµ–äº<code>Class</code>ã€‚</p>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­é¦–å…ˆåˆ›å»ºä¸€ä¸ª<code>User</code>å¯¹è±¡ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœä¸€ä¸ªç±»æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå®ƒçš„é™æ€å±æ€§ä¹Ÿä¸ä¼šè¢«åˆå§‹åŒ–ï¼Œæœ€åè·å–çš„å­—æ®µå±æ€§å°†æ˜¯<code>null</code>ã€‚æ‰€ä»¥åœ¨è·å–é™æ€å±æ€§å‰ï¼Œéœ€è¦è°ƒç”¨<code>shouldBeInitialized</code>æ–¹æ³•ï¼Œåˆ¤æ–­åœ¨è·å–å‰æ˜¯å¦éœ€è¦åˆå§‹åŒ–è¿™ä¸ªç±»ã€‚å¦‚æœåˆ é™¤åˆ›å»º User å¯¹è±¡çš„è¯­å¥ï¼Œè¿è¡Œç»“æœä¼šå˜ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">null</span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨<code>defineClass</code>æ–¹æ³•å…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°åˆ›å»ºä¸€ä¸ªç±»</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Class&lt;?&gt; defineClass(String name, <span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len, ClassLoader loader,ProtectionDomain protectionDomain);</span><br></pre></td></tr></table></figure>

<p>åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥åªä¼ å…¥å­—èŠ‚æ•°ç»„ã€èµ·å§‹å­—èŠ‚çš„ä¸‹æ ‡ä»¥åŠè¯»å–çš„å­—èŠ‚é•¿åº¦ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç±»åŠ è½½å™¨ï¼ˆ<code>ClassLoader</code>ï¼‰å’Œä¿æŠ¤åŸŸï¼ˆ<code>ProtectionDomain</code>ï¼‰æ¥æºäºè°ƒç”¨æ­¤æ–¹æ³•çš„å®ä¾‹ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­å®ç°äº†åç¼–è¯‘ç”Ÿæˆåçš„ class æ–‡ä»¶çš„åŠŸèƒ½ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">defineTest</span><span class="params">()</span> &#123;</span><br><span class="line">    String fileName=<span class="string">&quot;F:\\workspace\\unsafe-test\\target\\classes\\com\\cn\\model\\User.class&quot;</span>;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(fileName);</span><br><span class="line">    <span class="keyword">try</span>(<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file)) &#123;</span><br><span class="line">        <span class="type">byte</span>[] content=<span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>)file.length()];</span><br><span class="line">        fis.read(content);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> unsafe.defineClass(<span class="literal">null</span>, content, <span class="number">0</span>, content.length, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> clazz.newInstance();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">age</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;getAge&quot;</span>).invoke(o, <span class="literal">null</span>);</span><br><span class="line">        System.out.println(age);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé¦–å…ˆè¯»å–äº†ä¸€ä¸ª<code>class</code>æ–‡ä»¶å¹¶é€šè¿‡æ–‡ä»¶æµå°†å®ƒè½¬åŒ–ä¸ºå­—èŠ‚æ•°ç»„ï¼Œä¹‹åä½¿ç”¨<code>defineClass</code>æ–¹æ³•åŠ¨æ€çš„åˆ›å»ºäº†ä¸€ä¸ªç±»ï¼Œå¹¶åœ¨åç»­å®Œæˆäº†å®ƒçš„å®ä¾‹åŒ–å·¥ä½œï¼Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¹¶ä¸”é€šè¿‡è¿™ç§æ–¹å¼åˆ›å»ºçš„ç±»ï¼Œä¼šè·³è¿‡ JVM çš„æ‰€æœ‰å®‰å…¨æ£€æŸ¥ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/basis/unsafe/image-20220717145000710.png"></p>
<p>é™¤äº†<code>defineClass</code>æ–¹æ³•å¤–ï¼ŒUnsafe è¿˜æä¾›äº†ä¸€ä¸ª<code>defineAnonymousClass</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Class&lt;?&gt; defineAnonymousClass(Class&lt;?&gt; hostClass, <span class="type">byte</span>[] data, Object[] cpPatches);</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨è¯¥æ–¹æ³•å¯ä»¥ç”¨æ¥åŠ¨æ€çš„åˆ›å»ºä¸€ä¸ªåŒ¿åç±»ï¼Œåœ¨<code>Lambda</code>è¡¨è¾¾å¼ä¸­å°±æ˜¯ä½¿ç”¨ ASM åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç ï¼Œç„¶ååˆ©ç”¨è¯¥æ–¹æ³•å®šä¹‰å®ç°ç›¸åº”çš„å‡½æ•°å¼æ¥å£çš„åŒ¿åç±»ã€‚åœ¨ JDK 15 å‘å¸ƒçš„æ–°ç‰¹æ€§ä¸­ï¼Œåœ¨éšè—ç±»ï¼ˆ<code>Hidden classes</code>ï¼‰ä¸€æ¡ä¸­ï¼ŒæŒ‡å‡ºå°†åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­å¼ƒç”¨ <code>Unsafe</code> çš„<code>defineAnonymousClass</code>æ–¹æ³•ã€‚</p>
<h4 id="å…¸å‹åº”ç”¨-6"><a href="#å…¸å‹åº”ç”¨-6" class="headerlink" title="å…¸å‹åº”ç”¨"></a>å…¸å‹åº”ç”¨</h4><p>Lambda è¡¨è¾¾å¼å®ç°éœ€è¦ä¾èµ– <code>Unsafe</code> çš„ <code>defineAnonymousClass</code> æ–¹æ³•å®šä¹‰å®ç°ç›¸åº”çš„å‡½æ•°å¼æ¥å£çš„åŒ¿åç±»ã€‚</p>
<h3 id="ç³»ç»Ÿä¿¡æ¯"><a href="#ç³»ç»Ÿä¿¡æ¯" class="headerlink" title="ç³»ç»Ÿä¿¡æ¯"></a>ç³»ç»Ÿä¿¡æ¯</h3><h4 id="ä»‹ç»-7"><a href="#ä»‹ç»-7" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>è¿™éƒ¨åˆ†åŒ…å«ä¸¤ä¸ªè·å–ç³»ç»Ÿç›¸å…³ä¿¡æ¯çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿”å›ç³»ç»ŸæŒ‡é’ˆçš„å¤§å°ã€‚è¿”å›å€¼ä¸º4ï¼ˆ32ä½ç³»ç»Ÿï¼‰æˆ– 8ï¼ˆ64ä½ç³»ç»Ÿï¼‰ã€‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">addressSize</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//å†…å­˜é¡µçš„å¤§å°ï¼Œæ­¤å€¼ä¸º2çš„å¹‚æ¬¡æ–¹ã€‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">pageSize</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h4 id="å…¸å‹åº”ç”¨-7"><a href="#å…¸å‹åº”ç”¨-7" class="headerlink" title="å…¸å‹åº”ç”¨"></a>å…¸å‹åº”ç”¨</h4><p>è¿™ä¸¤ä¸ªæ–¹æ³•çš„åº”ç”¨åœºæ™¯æ¯”è¾ƒå°‘ï¼Œåœ¨<code>java.nio.Bits</code>ç±»ä¸­ï¼Œåœ¨ä½¿ç”¨<code>pageCount</code>è®¡ç®—æ‰€éœ€çš„å†…å­˜é¡µçš„æ•°é‡æ—¶ï¼Œè°ƒç”¨äº†<code>pageSize</code>æ–¹æ³•è·å–å†…å­˜é¡µçš„å¤§å°ã€‚å¦å¤–ï¼Œåœ¨ä½¿ç”¨<code>copySwapMemory</code>æ–¹æ³•æ‹·è´å†…å­˜æ—¶ï¼Œè°ƒç”¨äº†<code>addressSize</code>æ–¹æ³•ï¼Œæ£€æµ‹ 32 ä½ç³»ç»Ÿçš„æƒ…å†µã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆä»‹ç»äº† <code>Unsafe</code> çš„åŸºæœ¬æ¦‚å¿µã€å·¥ä½œåŸç†ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¯¹å®ƒçš„ API è¿›è¡Œäº†è¯´æ˜ä¸å®è·µã€‚ç›¸ä¿¡å¤§å®¶é€šè¿‡è¿™ä¸€è¿‡ç¨‹ï¼Œèƒ½å¤Ÿå‘ç° <code>Unsafe</code> åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œç¡®å®èƒ½å¤Ÿä¸ºæˆ‘ä»¬æä¾›ç¼–ç¨‹ä¸­çš„ä¾¿åˆ©ã€‚ä½†æ˜¯å›åˆ°å¼€å¤´çš„è¯é¢˜ï¼Œåœ¨ä½¿ç”¨è¿™äº›ä¾¿åˆ©æ—¶ï¼Œç¡®å®å­˜åœ¨ç€ä¸€äº›å®‰å…¨ä¸Šçš„éšæ‚£ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œä¸€é¡¹æŠ€æœ¯å…·æœ‰ä¸å®‰å…¨å› ç´ å¹¶ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯å®ƒåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­è¢«æ»¥ç”¨ã€‚å°½ç®¡ä¹‹å‰æœ‰ä¼ è¨€è¯´ä¼šåœ¨ Java9 ä¸­ç§»é™¤ <code>Unsafe</code> ç±»ï¼Œä¸è¿‡å®ƒè¿˜æ˜¯ç…§æ ·å·²ç»å­˜æ´»åˆ°äº† Java16ã€‚æŒ‰ç…§å­˜åœ¨å³åˆç†çš„é€»è¾‘ï¼Œåªè¦ä½¿ç”¨å¾—å½“ï¼Œå®ƒè¿˜æ˜¯èƒ½ç»™æˆ‘ä»¬å¸¦æ¥ä¸å°‘çš„å¸®åŠ©ï¼Œå› æ­¤æœ€åè¿˜æ˜¯å»ºè®®å¤§å®¶ï¼Œåœ¨ä½¿ç”¨ <code>Unsafe</code> çš„è¿‡ç¨‹ä¸­ä¸€å®šè¦åšåˆ°ä½¿ç”¨è°¨æ…ä½¿ç”¨ã€é¿å…æ»¥ç”¨ã€‚</p>
<!-- @include: @article-footer.snippet.md -->

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/09/10/completablefuture-intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/09/10/completablefuture-intro/" itemprop="url">CompletableFuture è¯¦è§£</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2022-09-10T18:20:12+08:00">
                2022-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ï¼Œ 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/%E5%B9%B6%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">å¹¶å‘</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2022/09/10/completablefuture-intro/" class="leancloud_visitors" data-flag-title="CompletableFuture è¯¦è§£">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  5.6k å­—
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  23 åˆ†é’Ÿ
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>å®é™…é¡¹ç›®ä¸­ï¼Œä¸€ä¸ªæ¥å£å¯èƒ½éœ€è¦åŒæ—¶è·å–å¤šç§ä¸åŒçš„æ•°æ®ï¼Œç„¶åå†æ±‡æ€»è¿”å›ï¼Œè¿™ç§åœºæ™¯è¿˜æ˜¯æŒºå¸¸è§çš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼šç”¨æˆ·è¯·æ±‚è·å–è®¢å•ä¿¡æ¯ï¼Œå¯èƒ½éœ€è¦åŒæ—¶è·å–ç”¨æˆ·ä¿¡æ¯ã€å•†å“è¯¦æƒ…ã€ç‰©æµä¿¡æ¯ã€å•†å“æ¨èç­‰æ•°æ®ã€‚</p>
<p>å¦‚æœæ˜¯ä¸²è¡Œï¼ˆæŒ‰é¡ºåºä¾æ¬¡æ‰§è¡Œæ¯ä¸ªä»»åŠ¡ï¼‰æ‰§è¡Œçš„è¯ï¼Œæ¥å£çš„å“åº”é€Ÿåº¦ä¼šéå¸¸æ…¢ã€‚è€ƒè™‘åˆ°è¿™äº›ä»»åŠ¡ä¹‹é—´æœ‰å¤§éƒ¨åˆ†éƒ½æ˜¯ <strong>æ— å‰åé¡ºåºå…³è”</strong> çš„ï¼Œå¯ä»¥ <strong>å¹¶è¡Œæ‰§è¡Œ</strong> ï¼Œå°±æ¯”å¦‚è¯´è°ƒç”¨è·å–å•†å“è¯¦æƒ…çš„æ—¶å€™ï¼Œå¯ä»¥åŒæ—¶è°ƒç”¨è·å–ç‰©æµä¿¡æ¯ã€‚é€šè¿‡å¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„æ–¹å¼ï¼Œæ¥å£çš„å“åº”é€Ÿåº¦ä¼šå¾—åˆ°å¤§å¹…ä¼˜åŒ–ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/high-performance/serial-to-parallel.png"></p>
<p>å¯¹äºå­˜åœ¨å‰åè°ƒç”¨é¡ºåºå…³ç³»çš„ä»»åŠ¡ï¼Œå¯ä»¥è¿›è¡Œä»»åŠ¡ç¼–æ’ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/high-performance/serial-to-parallel2.png"></p>
<ol>
<li>è·å–ç”¨æˆ·ä¿¡æ¯ä¹‹åï¼Œæ‰èƒ½è°ƒç”¨å•†å“è¯¦æƒ…å’Œç‰©æµä¿¡æ¯æ¥å£ã€‚</li>
<li>æˆåŠŸè·å–å•†å“è¯¦æƒ…å’Œç‰©æµä¿¡æ¯ä¹‹åï¼Œæ‰èƒ½è°ƒç”¨å•†å“æ¨èæ¥å£ã€‚</li>
</ol>
<p>å¯èƒ½ä¼šç”¨åˆ°å¤šçº¿ç¨‹å¼‚æ­¥ä»»åŠ¡ç¼–æ’çš„åœºæ™¯ï¼ˆè¿™é‡Œåªæ˜¯ä¸¾ä¾‹ï¼Œæ•°æ®ä¸ä¸€å®šæ˜¯ä¸€æ¬¡è¿”å›ï¼Œå¯èƒ½ä¼šå¯¹æ¥å£è¿›è¡Œæ‹†åˆ†ï¼‰ï¼š</p>
<ol>
<li>é¦–é¡µï¼šä¾‹å¦‚æŠ€æœ¯ç¤¾åŒºçš„é¦–é¡µå¯èƒ½éœ€è¦åŒæ—¶è·å–æ–‡ç« æ¨èåˆ—è¡¨ã€å¹¿å‘Šæ ã€æ–‡ç« æ’è¡Œæ¦œã€çƒ­é—¨è¯é¢˜ç­‰ä¿¡æ¯ã€‚</li>
<li>è¯¦æƒ…é¡µï¼šä¾‹å¦‚æŠ€æœ¯ç¤¾åŒºçš„æ–‡ç« è¯¦æƒ…é¡µå¯èƒ½éœ€è¦åŒæ—¶è·å–ä½œè€…ä¿¡æ¯ã€æ–‡ç« è¯¦æƒ…ã€æ–‡ç« è¯„è®ºç­‰ä¿¡æ¯ã€‚</li>
<li>ç»Ÿè®¡æ¨¡å—ï¼šä¾‹å¦‚æŠ€æœ¯ç¤¾åŒºçš„åå°ç»Ÿè®¡æ¨¡å—å¯èƒ½éœ€è¦åŒæ—¶è·å–ç²‰ä¸æ•°æ±‡æ€»ã€æ–‡ç« æ•°æ®ï¼ˆé˜…è¯»é‡ã€è¯„è®ºé‡ã€æ”¶è—é‡ï¼‰æ±‡æ€»ç­‰ä¿¡æ¯ã€‚</li>
</ol>
<p>å¯¹äº Java ç¨‹åºæ¥è¯´ï¼ŒJava 8 æ‰è¢«å¼•å…¥çš„ <code>CompletableFuture</code> å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ¥åšå¤šä¸ªä»»åŠ¡çš„ç¼–æ’ï¼ŒåŠŸèƒ½éå¸¸å¼ºå¤§ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« æ˜¯ <code>CompletableFuture</code> çš„ç®€å•å…¥é—¨ï¼Œå¸¦å¤§å®¶çœ‹çœ‹ <code>CompletableFuture</code> å¸¸ç”¨çš„ APIã€‚</p>
<h2 id="Future-ä»‹ç»"><a href="#Future-ä»‹ç»" class="headerlink" title="Future ä»‹ç»"></a>Future ä»‹ç»</h2><p><code>Future</code> ç±»æ˜¯å¼‚æ­¥æ€æƒ³çš„å…¸å‹è¿ç”¨ï¼Œä¸»è¦ç”¨åœ¨ä¸€äº›éœ€è¦æ‰§è¡Œè€—æ—¶ä»»åŠ¡çš„åœºæ™¯ï¼Œé¿å…ç¨‹åºä¸€ç›´åŸåœ°ç­‰å¾…è€—æ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰§è¡Œæ•ˆç‡å¤ªä½ã€‚å…·ä½“æ¥è¯´æ˜¯è¿™æ ·çš„ï¼šå½“æˆ‘ä»¬æ‰§è¡ŒæŸä¸€è€—æ—¶çš„ä»»åŠ¡æ—¶ï¼Œå¯ä»¥å°†è¿™ä¸ªè€—æ—¶ä»»åŠ¡äº¤ç»™ä¸€ä¸ªå­çº¿ç¨‹å»å¼‚æ­¥æ‰§è¡Œï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥å¹²ç‚¹å…¶ä»–äº‹æƒ…ï¼Œä¸ç”¨å‚»å‚»ç­‰å¾…è€—æ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚ç­‰æˆ‘ä»¬çš„äº‹æƒ…å¹²å®Œåï¼Œæˆ‘ä»¬å†é€šè¿‡ <code>Future</code> ç±»è·å–åˆ°è€—æ—¶ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚è¿™æ ·ä¸€æ¥ï¼Œç¨‹åºçš„æ‰§è¡Œæ•ˆç‡å°±æ˜æ˜¾æé«˜äº†ã€‚</p>
<p>è¿™å…¶å®å°±æ˜¯å¤šçº¿ç¨‹ä¸­ç»å…¸çš„ <strong>Future æ¨¡å¼</strong>ï¼Œä½ å¯ä»¥å°†å…¶çœ‹ä½œæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œä¸»è¦ç”¨åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼Œå¹¶é Java è¯­è¨€ç‹¬æœ‰ã€‚</p>
<p>åœ¨ Java ä¸­ï¼Œ<code>Future</code> ç±»åªæ˜¯ä¸€ä¸ªæ³›å‹æ¥å£ï¼Œä½äº <code>java.util.concurrent</code> åŒ…ä¸‹ï¼Œå…¶ä¸­å®šä¹‰äº† 5 ä¸ªæ–¹æ³•ï¼Œä¸»è¦åŒ…æ‹¬ä¸‹é¢è¿™ 4 ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li>å–æ¶ˆä»»åŠ¡ï¼›</li>
<li>åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ;</li>
<li>åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ;</li>
<li>è·å–ä»»åŠ¡æ‰§è¡Œç»“æœã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// V ä»£è¡¨äº†Futureæ‰§è¡Œçš„ä»»åŠ¡è¿”å›å€¼çš„ç±»å‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Future</span>&lt;V&gt; &#123;</span><br><span class="line">    <span class="comment">// å–æ¶ˆä»»åŠ¡æ‰§è¡Œ</span></span><br><span class="line">    <span class="comment">// æˆåŠŸå–æ¶ˆè¿”å› trueï¼Œå¦åˆ™è¿”å› false</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> mayInterruptIfRunning)</span>;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCancelled</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isDone</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ</span></span><br><span class="line">    V <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException;</span><br><span class="line">    <span class="comment">// æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è¿”å›è®¡ç®—ç»“æœå°±æŠ›å‡º TimeOutException å¼‚å¸¸</span></span><br><span class="line">    V <span class="title function_">get</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutExceptio</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç®€å•ç†è§£å°±æ˜¯ï¼šæˆ‘æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œæäº¤ç»™äº† <code>Future</code> æ¥å¤„ç†ã€‚ä»»åŠ¡æ‰§è¡ŒæœŸé—´æˆ‘è‡ªå·±å¯ä»¥å»åšä»»ä½•æƒ³åšçš„äº‹æƒ…ã€‚å¹¶ä¸”ï¼Œåœ¨è¿™æœŸé—´æˆ‘è¿˜å¯ä»¥å–æ¶ˆä»»åŠ¡ä»¥åŠè·å–ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ã€‚ä¸€æ®µæ—¶é—´ä¹‹åï¼Œæˆ‘å°±å¯ä»¥ <code>Future</code> é‚£é‡Œç›´æ¥å–å‡ºä»»åŠ¡æ‰§è¡Œç»“æœã€‚</p>
<h2 id="CompletableFuture-ä»‹ç»"><a href="#CompletableFuture-ä»‹ç»" class="headerlink" title="CompletableFuture ä»‹ç»"></a>CompletableFuture ä»‹ç»</h2><p><code>Future</code> åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­å­˜åœ¨ä¸€äº›å±€é™æ€§æ¯”å¦‚ä¸æ”¯æŒå¼‚æ­¥ä»»åŠ¡çš„ç¼–æ’ç»„åˆã€è·å–è®¡ç®—ç»“æœçš„ <code>get()</code> æ–¹æ³•ä¸ºé˜»å¡è°ƒç”¨ã€‚</p>
<p>Java 8 æ‰è¢«å¼•å…¥<code>CompletableFuture</code> ç±»å¯ä»¥è§£å†³<code>Future</code> çš„è¿™äº›ç¼ºé™·ã€‚<code>CompletableFuture</code> é™¤äº†æä¾›äº†æ›´ä¸ºå¥½ç”¨å’Œå¼ºå¤§çš„ <code>Future</code> ç‰¹æ€§ä¹‹å¤–ï¼Œè¿˜æä¾›äº†å‡½æ•°å¼ç¼–ç¨‹ã€å¼‚æ­¥ä»»åŠ¡ç¼–æ’ç»„åˆï¼ˆå¯ä»¥å°†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ä¸²è”èµ·æ¥ï¼Œç»„æˆä¸€ä¸ªå®Œæ•´çš„é“¾å¼è°ƒç”¨ï¼‰ç­‰èƒ½åŠ›ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥ç®€å•çœ‹çœ‹ <code>CompletableFuture</code> ç±»çš„å®šä¹‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletableFuture</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Future</span>&lt;T&gt;, CompletionStage&lt;T&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>CompletableFuture</code> åŒæ—¶å®ç°äº† <code>Future</code> å’Œ <code>CompletionStage</code> æ¥å£ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/concurrent/completablefuture-class-diagram.jpg"></p>
<p><code>CompletionStage</code> æ¥å£æè¿°äº†ä¸€ä¸ªå¼‚æ­¥è®¡ç®—çš„é˜¶æ®µã€‚å¾ˆå¤šè®¡ç®—å¯ä»¥åˆ†æˆå¤šä¸ªé˜¶æ®µæˆ–æ­¥éª¤ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å®ƒå°†æ‰€æœ‰æ­¥éª¤ç»„åˆèµ·æ¥ï¼Œå½¢æˆå¼‚æ­¥è®¡ç®—çš„æµæ°´çº¿ã€‚</p>
<p><code>CompletableFuture</code> é™¤äº†æä¾›äº†æ›´ä¸ºå¥½ç”¨å’Œå¼ºå¤§çš„ <code>Future</code> ç‰¹æ€§ä¹‹å¤–ï¼Œè¿˜æä¾›äº†å‡½æ•°å¼ç¼–ç¨‹çš„èƒ½åŠ›ã€‚</p>
<p><img src="https://oss.javaguide.cn/javaguide/image-20210902092441434.png"></p>
<p><code>Future</code> æ¥å£æœ‰ 5 ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><code>boolean cancel(boolean mayInterruptIfRunning)</code>ï¼šå°è¯•å–æ¶ˆæ‰§è¡Œä»»åŠ¡ã€‚</li>
<li><code>boolean isCancelled()</code>ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆã€‚</li>
<li><code>boolean isDone()</code>ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»è¢«æ‰§è¡Œå®Œæˆã€‚</li>
<li><code>get()</code>ï¼šç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆå¹¶è·å–è¿ç®—ç»“æœã€‚</li>
<li><code>get(long timeout, TimeUnit unit)</code>ï¼šå¤šäº†ä¸€ä¸ªè¶…æ—¶æ—¶é—´ã€‚</li>
</ul>
<p><code>CompletionStage</code> æ¥å£æè¿°äº†ä¸€ä¸ªå¼‚æ­¥è®¡ç®—çš„é˜¶æ®µã€‚å¾ˆå¤šè®¡ç®—å¯ä»¥åˆ†æˆå¤šä¸ªé˜¶æ®µæˆ–æ­¥éª¤ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å®ƒå°†æ‰€æœ‰æ­¥éª¤ç»„åˆèµ·æ¥ï¼Œå½¢æˆå¼‚æ­¥è®¡ç®—çš„æµæ°´çº¿ã€‚</p>
<p><code>CompletionStage</code> æ¥å£ä¸­çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œ<code>CompletableFuture</code> çš„å‡½æ•°å¼èƒ½åŠ›å°±æ˜¯è¿™ä¸ªæ¥å£èµ‹äºˆçš„ã€‚ä»è¿™ä¸ªæ¥å£çš„æ–¹æ³•å‚æ•°ä½ å°±å¯ä»¥å‘ç°å…¶å¤§é‡ä½¿ç”¨äº† Java8 å¼•å…¥çš„å‡½æ•°å¼ç¼–ç¨‹ã€‚</p>
<p><img src="https://oss.javaguide.cn/javaguide/image-20210902093026059.png"></p>
<p>ç”±äºæ–¹æ³•ä¼—å¤šï¼Œæ‰€ä»¥è¿™é‡Œä¸èƒ½ä¸€ä¸€è®²è§£ï¼Œä¸‹æ–‡ä¸­æˆ‘ä¼šä»‹ç»å¤§éƒ¨åˆ†å¸¸è§æ–¹æ³•çš„ä½¿ç”¨ã€‚</p>
<h2 id="CompletableFuture-å¸¸è§æ“ä½œ"><a href="#CompletableFuture-å¸¸è§æ“ä½œ" class="headerlink" title="CompletableFuture å¸¸è§æ“ä½œ"></a>CompletableFuture å¸¸è§æ“ä½œ</h2><h3 id="åˆ›å»º-CompletableFuture"><a href="#åˆ›å»º-CompletableFuture" class="headerlink" title="åˆ›å»º CompletableFuture"></a>åˆ›å»º CompletableFuture</h3><p>å¸¸è§çš„åˆ›å»º <code>CompletableFuture</code> å¯¹è±¡çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ol>
<li>é€šè¿‡ new å…³é”®å­—ã€‚</li>
<li>åŸºäº <code>CompletableFuture</code> è‡ªå¸¦çš„é™æ€å·¥å‚æ–¹æ³•ï¼š<code>runAsync()</code>ã€<code>supplyAsync()</code> ã€‚</li>
</ol>
<h4 id="new-å…³é”®å­—"><a href="#new-å…³é”®å­—" class="headerlink" title="new å…³é”®å­—"></a>new å…³é”®å­—</h4><p>é€šè¿‡ new å…³é”®å­—åˆ›å»º <code>CompletableFuture</code> å¯¹è±¡è¿™ç§ä½¿ç”¨æ–¹å¼å¯ä»¥çœ‹ä½œæ˜¯å°† <code>CompletableFuture</code> å½“åš <code>Future</code> æ¥ä½¿ç”¨ã€‚</p>
<p>æˆ‘åœ¨æˆ‘çš„å¼€æºé¡¹ç›® <a href="https://github.com/Snailclimb/guide-rpc-framework">guide-rpc-framework</a> ä¸­å°±æ˜¯è¿™ç§æ–¹å¼åˆ›å»ºçš„ <code>CompletableFuture</code> å¯¹è±¡ã€‚</p>
<p>ä¸‹é¢å’±ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡åˆ›å»ºäº†ä¸€ä¸ªç»“æœå€¼ç±»å‹ä¸º <code>RpcResponse&lt;Object&gt;</code> çš„ <code>CompletableFuture</code>ï¼Œä½ å¯ä»¥æŠŠ <code>resultFuture</code> çœ‹ä½œæ˜¯å¼‚æ­¥è¿ç®—ç»“æœçš„è½½ä½“ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; resultFuture = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>å‡è®¾åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»ï¼Œæˆ‘ä»¬å¾—åˆ°äº†æœ€ç»ˆçš„ç»“æœã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ <code>complete()</code> æ–¹æ³•ä¸ºå…¶ä¼ å…¥ç»“æœï¼Œè¿™è¡¨ç¤º <code>resultFuture</code> å·²ç»è¢«å®Œæˆäº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// complete() æ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œåç»­è°ƒç”¨å°†è¢«å¿½ç•¥ã€‚</span></span><br><span class="line">resultFuture.complete(rpcResponse);</span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥é€šè¿‡ <code>isDone()</code> æ–¹æ³•æ¥æ£€æŸ¥æ˜¯å¦å·²ç»å®Œæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isDone</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> result != <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·å–å¼‚æ­¥è®¡ç®—çš„ç»“æœä¹Ÿéå¸¸ç®€å•ï¼Œç›´æ¥è°ƒç”¨ <code>get()</code> æ–¹æ³•å³å¯ã€‚è°ƒç”¨ <code>get()</code> æ–¹æ³•çš„çº¿ç¨‹ä¼šé˜»å¡ç›´åˆ° <code>CompletableFuture</code> å®Œæˆè¿ç®—ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpcResponse = completableFuture.get();</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½ å·²ç»çŸ¥é“è®¡ç®—çš„ç»“æœçš„è¯ï¼Œå¯ä»¥ä½¿ç”¨é™æ€æ–¹æ³• <code>completedFuture()</code> æ¥åˆ›å»º <code>CompletableFuture</code> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; future = CompletableFuture.completedFuture(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">assertEquals(<span class="string">&quot;hello!&quot;</span>, future.get());</span><br></pre></td></tr></table></figure>

<p><code>completedFuture()</code> æ–¹æ³•åº•å±‚è°ƒç”¨çš„æ˜¯å¸¦å‚æ•°çš„ new æ–¹æ³•ï¼Œåªä¸è¿‡ï¼Œè¿™ä¸ªæ–¹æ³•ä¸å¯¹å¤–æš´éœ²ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">completedFuture</span><span class="params">(U value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;U&gt;((value == <span class="literal">null</span>) ? NIL : value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="é™æ€å·¥å‚æ–¹æ³•"><a href="#é™æ€å·¥å‚æ–¹æ³•" class="headerlink" title="é™æ€å·¥å‚æ–¹æ³•"></a>é™æ€å·¥å‚æ–¹æ³•</h4><p>è¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬å°è£…è®¡ç®—é€»è¾‘ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier)</span>;</span><br><span class="line"><span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± (æ¨è)</span></span><br><span class="line"><span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier, Executor executor)</span>;</span><br><span class="line"><span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable)</span>;</span><br><span class="line"><span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± (æ¨è)</span></span><br><span class="line"><span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable, Executor executor)</span>;</span><br></pre></td></tr></table></figure>

<p><code>runAsync()</code> æ–¹æ³•æ¥å—çš„å‚æ•°æ˜¯ <code>Runnable</code> ï¼Œè¿™æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œä¸å…è®¸è¿”å›å€¼ã€‚å½“ä½ éœ€è¦å¼‚æ­¥æ“ä½œä¸”ä¸å…³å¿ƒè¿”å›ç»“æœçš„æ—¶å€™å¯ä»¥ä½¿ç”¨ <code>runAsync()</code> æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>supplyAsync()</code> æ–¹æ³•æ¥å—çš„å‚æ•°æ˜¯ <code>Supplier&lt;U&gt;</code> ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œ<code>U</code> æ˜¯è¿”å›ç»“æœå€¼çš„ç±»å‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Supplier</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets a result.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    T <span class="title function_">get</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ä½ éœ€è¦å¼‚æ­¥æ“ä½œä¸”å…³å¿ƒè¿”å›ç»“æœçš„æ—¶å€™,å¯ä»¥ä½¿ç”¨ <code>supplyAsync()</code> æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(() -&gt; System.out.println(<span class="string">&quot;hello!&quot;</span>));</span><br><span class="line">future.get();<span class="comment">// è¾“å‡º &quot;hello!&quot;</span></span><br><span class="line">CompletableFuture&lt;String&gt; future2 = CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">assertEquals(<span class="string">&quot;hello!&quot;</span>, future2.get());</span><br></pre></td></tr></table></figure>

<h3 id="å¤„ç†å¼‚æ­¥ç»“ç®—çš„ç»“æœ"><a href="#å¤„ç†å¼‚æ­¥ç»“ç®—çš„ç»“æœ" class="headerlink" title="å¤„ç†å¼‚æ­¥ç»“ç®—çš„ç»“æœ"></a>å¤„ç†å¼‚æ­¥ç»“ç®—çš„ç»“æœ</h3><p>å½“æˆ‘ä»¬è·å–åˆ°å¼‚æ­¥è®¡ç®—çš„ç»“æœä¹‹åï¼Œè¿˜å¯ä»¥å¯¹å…¶è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æ–¹æ³•æœ‰ä¸‹é¢å‡ ä¸ªï¼š</p>
<ul>
<li><code>thenApply()</code></li>
<li><code>thenAccept()</code></li>
<li><code>thenRun()</code></li>
<li><code>whenComplete()</code></li>
</ul>
<p><code>thenApply()</code> æ–¹æ³•æ¥å—ä¸€ä¸ª <code>Function</code> å®ä¾‹ï¼Œç”¨å®ƒæ¥å¤„ç†ç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ²¿ç”¨ä¸Šä¸€ä¸ªä»»åŠ¡çš„çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApply</span><span class="params">(</span></span><br><span class="line"><span class="params">    Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniApplyStage(<span class="literal">null</span>, fn);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨é»˜è®¤çš„ ForkJoinPool çº¿ç¨‹æ± ï¼ˆä¸æ¨èï¼‰</span></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApplyAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">    Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniApplyStage(defaultExecutor(), fn);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± (æ¨è)</span></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApplyAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">    Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn, Executor executor)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniApplyStage(screenExecutor(executor), fn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>thenApply()</code> æ–¹æ³•ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; future = CompletableFuture.completedFuture(<span class="string">&quot;hello!&quot;</span>)</span><br><span class="line">        .thenApply(s -&gt; s + <span class="string">&quot;world!&quot;</span>);</span><br><span class="line">assertEquals(<span class="string">&quot;hello!world!&quot;</span>, future.get());</span><br><span class="line"><span class="comment">// è¿™æ¬¡è°ƒç”¨å°†è¢«å¿½ç•¥ã€‚</span></span><br><span class="line">future.thenApply(s -&gt; s + <span class="string">&quot;nice!&quot;</span>);</span><br><span class="line">assertEquals(<span class="string">&quot;hello!world!&quot;</span>, future.get());</span><br></pre></td></tr></table></figure>

<p>ä½ è¿˜å¯ä»¥è¿›è¡Œ <strong>æµå¼è°ƒç”¨</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; future = CompletableFuture.completedFuture(<span class="string">&quot;hello!&quot;</span>)</span><br><span class="line">        .thenApply(s -&gt; s + <span class="string">&quot;world!&quot;</span>).thenApply(s -&gt; s + <span class="string">&quot;nice!&quot;</span>);</span><br><span class="line">assertEquals(<span class="string">&quot;hello!world!nice!&quot;</span>, future.get());</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœä½ ä¸éœ€è¦ä»å›è°ƒå‡½æ•°ä¸­è·å–è¿”å›ç»“æœï¼Œå¯ä»¥ä½¿ç”¨ <code>thenAccept()</code> æˆ–è€… <code>thenRun()</code>ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•çš„åŒºåˆ«åœ¨äº <code>thenRun()</code> ä¸èƒ½è®¿é—®å¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚</strong></p>
<p><code>thenAccept()</code> æ–¹æ³•çš„å‚æ•°æ˜¯ <code>Consumer&lt;? super T&gt;</code> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenAccept</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniAcceptStage(<span class="literal">null</span>, action);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenAcceptAsync</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniAcceptStage(defaultExecutor(), action);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenAcceptAsync</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action,</span></span><br><span class="line"><span class="params">                                               Executor executor)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniAcceptStage(screenExecutor(executor), action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¡¾åæ€ä¹‰ï¼Œ<code>Consumer</code> å±äºæ¶ˆè´¹å‹æ¥å£ï¼Œå®ƒå¯ä»¥æ¥æ”¶ 1 ä¸ªè¾“å…¥å¯¹è±¡ç„¶åè¿›è¡Œâ€œæ¶ˆè´¹â€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Consumer</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(T t)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> Consumer&lt;T&gt; <span class="title function_">andThen</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; after)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(after);</span><br><span class="line">        <span class="keyword">return</span> (T t) -&gt; &#123; accept(t); after.accept(t); &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>thenRun()</code> çš„æ–¹æ³•æ˜¯çš„å‚æ•°æ˜¯ <code>Runnable</code> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenRun</span><span class="params">(Runnable action)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniRunStage(<span class="literal">null</span>, action);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenRunAsync</span><span class="params">(Runnable action)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniRunStage(defaultExecutor(), action);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenRunAsync</span><span class="params">(Runnable action,</span></span><br><span class="line"><span class="params">                                            Executor executor)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniRunStage(screenExecutor(executor), action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>thenAccept()</code> å’Œ <code>thenRun()</code> ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture.completedFuture(<span class="string">&quot;hello!&quot;</span>)</span><br><span class="line">        .thenApply(s -&gt; s + <span class="string">&quot;world!&quot;</span>).thenApply(s -&gt; s + <span class="string">&quot;nice!&quot;</span>).thenAccept(System.out::println);<span class="comment">//hello!world!nice!</span></span><br><span class="line"></span><br><span class="line">CompletableFuture.completedFuture(<span class="string">&quot;hello!&quot;</span>)</span><br><span class="line">        .thenApply(s -&gt; s + <span class="string">&quot;world!&quot;</span>).thenApply(s -&gt; s + <span class="string">&quot;nice!&quot;</span>).thenRun(() -&gt; System.out.println(<span class="string">&quot;hello!&quot;</span>));<span class="comment">//hello!</span></span><br></pre></td></tr></table></figure>

<p><code>whenComplete()</code> çš„æ–¹æ³•çš„å‚æ•°æ˜¯ <code>BiConsumer&lt;? super T, ? super Throwable&gt;</code> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletableFuture&lt;T&gt; <span class="title function_">whenComplete</span><span class="params">(</span></span><br><span class="line"><span class="params">    BiConsumer&lt;? <span class="built_in">super</span> T, ? <span class="built_in">super</span> Throwable&gt; action)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniWhenCompleteStage(<span class="literal">null</span>, action);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;T&gt; <span class="title function_">whenCompleteAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">    BiConsumer&lt;? <span class="built_in">super</span> T, ? <span class="built_in">super</span> Throwable&gt; action)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniWhenCompleteStage(defaultExecutor(), action);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± (æ¨è)</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;T&gt; <span class="title function_">whenCompleteAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">    BiConsumer&lt;? <span class="built_in">super</span> T, ? <span class="built_in">super</span> Throwable&gt; action, Executor executor)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniWhenCompleteStage(screenExecutor(executor), action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›¸å¯¹äº <code>Consumer</code> ï¼Œ <code>BiConsumer</code> å¯ä»¥æ¥æ”¶ 2 ä¸ªè¾“å…¥å¯¹è±¡ç„¶åè¿›è¡Œâ€œæ¶ˆè´¹â€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BiConsumer</span>&lt;T, U&gt; &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(T t, U u)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> BiConsumer&lt;T, U&gt; <span class="title function_">andThen</span><span class="params">(BiConsumer&lt;? <span class="built_in">super</span> T, ? <span class="built_in">super</span> U&gt; after)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(after);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (l, r) -&gt; &#123;</span><br><span class="line">            accept(l, r);</span><br><span class="line">            after.accept(l, r);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>whenComplete()</code> ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;hello!&quot;</span>)</span><br><span class="line">        .whenComplete((res, ex) -&gt; &#123;</span><br><span class="line">            <span class="comment">// res ä»£è¡¨è¿”å›çš„ç»“æœ</span></span><br><span class="line">            <span class="comment">// ex çš„ç±»å‹ä¸º Throwable ï¼Œä»£è¡¨æŠ›å‡ºçš„å¼‚å¸¸</span></span><br><span class="line">            System.out.println(res);</span><br><span class="line">            <span class="comment">// è¿™é‡Œæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸æ‰€æœ‰ä¸º null</span></span><br><span class="line">            assertNull(ex);</span><br><span class="line">        &#125;);</span><br><span class="line">assertEquals(<span class="string">&quot;hello!&quot;</span>, future.get());</span><br></pre></td></tr></table></figure>

<h3 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h3><p>ä½ å¯ä»¥é€šè¿‡ <code>handle()</code> æ–¹æ³•æ¥å¤„ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„æŠ›å‡ºå¼‚å¸¸çš„æƒ…å†µã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">handle</span><span class="params">(</span></span><br><span class="line"><span class="params">    BiFunction&lt;? <span class="built_in">super</span> T, Throwable, ? extends U&gt; fn)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniHandleStage(<span class="literal">null</span>, fn);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">handleAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">    BiFunction&lt;? <span class="built_in">super</span> T, Throwable, ? extends U&gt; fn)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniHandleStage(defaultExecutor(), fn);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">handleAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">    BiFunction&lt;? <span class="built_in">super</span> T, Throwable, ? extends U&gt; fn, Executor executor)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniHandleStage(screenExecutor(executor), fn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; future</span><br><span class="line">        = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Computation error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello!&quot;</span>;</span><br><span class="line">&#125;).handle((res, ex) -&gt; &#123;</span><br><span class="line">    <span class="comment">// res ä»£è¡¨è¿”å›çš„ç»“æœ</span></span><br><span class="line">    <span class="comment">// ex çš„ç±»å‹ä¸º Throwable ï¼Œä»£è¡¨æŠ›å‡ºçš„å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">return</span> res != <span class="literal">null</span> ? res : <span class="string">&quot;world!&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line">assertEquals(<span class="string">&quot;world!&quot;</span>, future.get());</span><br></pre></td></tr></table></figure>

<p>ä½ è¿˜å¯ä»¥é€šè¿‡ <code>exceptionally()</code> æ–¹æ³•æ¥å¤„ç†å¼‚å¸¸æƒ…å†µã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; future</span><br><span class="line">        = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Computation error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello!&quot;</span>;</span><br><span class="line">&#125;).exceptionally(ex -&gt; &#123;</span><br><span class="line">    System.out.println(ex.toString());<span class="comment">// CompletionException</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;world!&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line">assertEquals(<span class="string">&quot;world!&quot;</span>, future.get());</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½ æƒ³è®© <code>CompletableFuture</code> çš„ç»“æœå°±æ˜¯å¼‚å¸¸çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ <code>completeExceptionally()</code> æ–¹æ³•ä¸ºå…¶èµ‹å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; completableFuture = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">completableFuture.completeExceptionally(</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Calculation failed!&quot;</span>));</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">completableFuture.get(); <span class="comment">// ExecutionException</span></span><br></pre></td></tr></table></figure>

<h3 id="ç»„åˆ-CompletableFuture"><a href="#ç»„åˆ-CompletableFuture" class="headerlink" title="ç»„åˆ CompletableFuture"></a>ç»„åˆ CompletableFuture</h3><p>ä½ å¯ä»¥ä½¿ç”¨ <code>thenCompose()</code> æŒ‰é¡ºåºé“¾æ¥ä¸¤ä¸ª <code>CompletableFuture</code> å¯¹è±¡ï¼Œå®ç°å¼‚æ­¥çš„ä»»åŠ¡é“¾ã€‚å®ƒçš„ä½œç”¨æ˜¯å°†å‰ä¸€ä¸ªä»»åŠ¡çš„è¿”å›ç»“æœä½œä¸ºä¸‹ä¸€ä¸ªä»»åŠ¡çš„è¾“å…¥å‚æ•°ï¼Œä»è€Œå½¢æˆä¸€ä¸ªä¾èµ–å…³ç³»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenCompose</span><span class="params">(</span></span><br><span class="line"><span class="params">    Function&lt;? <span class="built_in">super</span> T, ? extends CompletionStage&lt;U&gt;&gt; fn)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniComposeStage(<span class="literal">null</span>, fn);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenComposeAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">    Function&lt;? <span class="built_in">super</span> T, ? extends CompletionStage&lt;U&gt;&gt; fn)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniComposeStage(defaultExecutor(), fn);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenComposeAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">    Function&lt;? <span class="built_in">super</span> T, ? extends CompletionStage&lt;U&gt;&gt; fn,</span></span><br><span class="line"><span class="params">    Executor executor)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uniComposeStage(screenExecutor(executor), fn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>thenCompose()</code> æ–¹æ³•ä¼šä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; future</span><br><span class="line">        = CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;hello!&quot;</span>)</span><br><span class="line">        .thenCompose(s -&gt; CompletableFuture.supplyAsync(() -&gt; s + <span class="string">&quot;world!&quot;</span>));</span><br><span class="line">assertEquals(<span class="string">&quot;hello!world!&quot;</span>, future.get());</span><br></pre></td></tr></table></figure>

<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•è¿˜æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚æ¯”å¦‚è¯´ï¼Œtask1 å’Œ task2 éƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä½† task1 å¿…é¡»æ‰§è¡Œå®Œæˆåæ‰èƒ½å¼€å§‹æ‰§è¡Œ task2ï¼ˆtask2 ä¾èµ– task1 çš„æ‰§è¡Œç»“æœï¼‰ã€‚</p>
<p>å’Œ <code>thenCompose()</code> æ–¹æ³•ç±»ä¼¼çš„è¿˜æœ‰ <code>thenCombine()</code> æ–¹æ³•ï¼Œ å®ƒåŒæ ·å¯ä»¥ç»„åˆä¸¤ä¸ª <code>CompletableFuture</code> å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; completableFuture</span><br><span class="line">        = CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;hello!&quot;</span>)</span><br><span class="line">        .thenCombine(CompletableFuture.supplyAsync(</span><br><span class="line">                () -&gt; <span class="string">&quot;world!&quot;</span>), (s1, s2) -&gt; s1 + s2)</span><br><span class="line">        .thenCompose(s -&gt; CompletableFuture.supplyAsync(() -&gt; s + <span class="string">&quot;nice!&quot;</span>));</span><br><span class="line">assertEquals(<span class="string">&quot;hello!world!nice!&quot;</span>, completableFuture.get());</span><br></pre></td></tr></table></figure>

<p><strong>é‚£ <code>thenCompose()</code> å’Œ <code>thenCombine()</code> æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</strong></p>
<ul>
<li><code>thenCompose()</code> å¯ä»¥é“¾æ¥ä¸¤ä¸ª <code>CompletableFuture</code> å¯¹è±¡ï¼Œå¹¶å°†å‰ä¸€ä¸ªä»»åŠ¡çš„è¿”å›ç»“æœä½œä¸ºä¸‹ä¸€ä¸ªä»»åŠ¡çš„å‚æ•°ï¼Œå®ƒä»¬ä¹‹é—´å­˜åœ¨ç€å…ˆåé¡ºåºã€‚</li>
<li><code>thenCombine()</code> ä¼šåœ¨ä¸¤ä¸ªä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆåï¼ŒæŠŠä¸¤ä¸ªä»»åŠ¡çš„ç»“æœåˆå¹¶ã€‚ä¸¤ä¸ªä»»åŠ¡æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œå®ƒä»¬ä¹‹é—´å¹¶æ²¡æœ‰å…ˆåä¾èµ–é¡ºåºã€‚</li>
</ul>
<p>é™¤äº† <code>thenCompose()</code> å’Œ <code>thenCombine()</code> ä¹‹å¤–ï¼Œ è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ç»„åˆ <code>CompletableFuture</code> çš„æ–¹æ³•ç”¨äºå®ç°ä¸åŒçš„æ•ˆæœï¼Œæ»¡è¶³ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å®ç° task1 å’Œ task2 ä¸­çš„ä»»æ„ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œåå°±æ‰§è¡Œ task3 çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ <code>acceptEither()</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">acceptEither</span><span class="params">(</span></span><br><span class="line"><span class="params">    CompletionStage&lt;? extends T&gt; other, Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> orAcceptStage(<span class="literal">null</span>, other, action);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">acceptEitherAsync</span><span class="params">(</span></span><br><span class="line"><span class="params">    CompletionStage&lt;? extends T&gt; other, Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> orAcceptStage(asyncPool, other, action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç®€å•ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;String&gt; task = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡1å¼€å§‹æ‰§è¡Œï¼Œå½“å‰æ—¶é—´ï¼š&quot;</span> + System.currentTimeMillis());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡1æ‰§è¡Œå®Œæ¯•ï¼Œå½“å‰æ—¶é—´ï¼š&quot;</span> + System.currentTimeMillis());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;task1&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">CompletableFuture&lt;String&gt; task2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡2å¼€å§‹æ‰§è¡Œï¼Œå½“å‰æ—¶é—´ï¼š&quot;</span> + System.currentTimeMillis());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡2æ‰§è¡Œå®Œæ¯•ï¼Œå½“å‰æ—¶é—´ï¼š&quot;</span> + System.currentTimeMillis());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;task2&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">task.acceptEitherAsync(task2, (res) -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡3å¼€å§‹æ‰§è¡Œï¼Œå½“å‰æ—¶é—´ï¼š&quot;</span> + System.currentTimeMillis());</span><br><span class="line">    System.out.println(<span class="string">&quot;ä¸Šä¸€ä¸ªä»»åŠ¡çš„ç»“æœä¸ºï¼š&quot;</span> + res);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¢åŠ ä¸€äº›å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿å¼‚æ­¥ä»»åŠ¡æœ‰è¶³å¤Ÿçš„æ—¶é—´å®Œæˆ</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ä»»åŠ¡1å¼€å§‹æ‰§è¡Œï¼Œå½“å‰æ—¶é—´ï¼š1695088058520</span><br><span class="line">ä»»åŠ¡2å¼€å§‹æ‰§è¡Œï¼Œå½“å‰æ—¶é—´ï¼š1695088058521</span><br><span class="line">ä»»åŠ¡1æ‰§è¡Œå®Œæ¯•ï¼Œå½“å‰æ—¶é—´ï¼š1695088059023</span><br><span class="line">ä»»åŠ¡3å¼€å§‹æ‰§è¡Œï¼Œå½“å‰æ—¶é—´ï¼š1695088059023</span><br><span class="line">ä¸Šä¸€ä¸ªä»»åŠ¡çš„ç»“æœä¸ºï¼štask1</span><br><span class="line">ä»»åŠ¡2æ‰§è¡Œå®Œæ¯•ï¼Œå½“å‰æ—¶é—´ï¼š1695088059523</span><br></pre></td></tr></table></figure>

<p>ä»»åŠ¡ç»„åˆæ“ä½œ<code>acceptEitherAsync()</code>ä¼šåœ¨å¼‚æ­¥ä»»åŠ¡ 1 å’Œå¼‚æ­¥ä»»åŠ¡ 2 ä¸­çš„ä»»æ„ä¸€ä¸ªå®Œæˆæ—¶è§¦å‘æ‰§è¡Œä»»åŠ¡ 3ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œè¿™ä¸ªè§¦å‘æ—¶æœºæ˜¯ä¸ç¡®å®šçš„ã€‚å¦‚æœä»»åŠ¡ 1 å’Œä»»åŠ¡ 2 éƒ½è¿˜æœªå®Œæˆï¼Œé‚£ä¹ˆä»»åŠ¡ 3 å°±ä¸èƒ½è¢«æ‰§è¡Œã€‚</p>
<h3 id="å¹¶è¡Œè¿è¡Œå¤šä¸ª-CompletableFuture"><a href="#å¹¶è¡Œè¿è¡Œå¤šä¸ª-CompletableFuture" class="headerlink" title="å¹¶è¡Œè¿è¡Œå¤šä¸ª CompletableFuture"></a>å¹¶è¡Œè¿è¡Œå¤šä¸ª CompletableFuture</h3><p>ä½ å¯ä»¥é€šè¿‡ <code>CompletableFuture</code> çš„ <code>allOf()</code>è¿™ä¸ªé™æ€æ–¹æ³•æ¥å¹¶è¡Œè¿è¡Œå¤šä¸ª <code>CompletableFuture</code> ã€‚</p>
<p>å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¹¶è¡Œè¿è¡Œå¤šä¸ªäº’ä¸ç›¸å…³çš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¯ä»¥äº’ç›¸ç‹¬ç«‹åœ°è¿è¡Œã€‚</p>
<p>æ¯”è¯´æˆ‘ä»¬è¦è¯»å–å¤„ç† 6 ä¸ªæ–‡ä»¶ï¼Œè¿™ 6 ä¸ªä»»åŠ¡éƒ½æ˜¯æ²¡æœ‰æ‰§è¡Œé¡ºåºä¾èµ–çš„ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿”å›ç»™ç”¨æˆ·çš„æ—¶å€™å°†è¿™å‡ ä¸ªæ–‡ä»¶çš„å¤„ç†çš„ç»“æœè¿›è¡Œç»Ÿè®¡æ•´ç†ã€‚åƒè¿™ç§æƒ…å†µæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å¹¶è¡Œè¿è¡Œå¤šä¸ª <code>CompletableFuture</code> æ¥å¤„ç†ã€‚</p>
<p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Void&gt; task1 =</span><br><span class="line">  CompletableFuture.supplyAsync(()-&gt;&#123;</span><br><span class="line">    <span class="comment">//è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ</span></span><br><span class="line">  &#125;);</span><br><span class="line">......</span><br><span class="line">CompletableFuture&lt;Void&gt; task6 =</span><br><span class="line">  CompletableFuture.supplyAsync(()-&gt;&#123;</span><br><span class="line">    <span class="comment">//è‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œ</span></span><br><span class="line">  &#125;);</span><br><span class="line">......</span><br><span class="line"> CompletableFuture&lt;Void&gt; headerFuture=CompletableFuture.allOf(task1,.....,task6);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    headerFuture.join();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line">System.out.println(<span class="string">&quot;all done. &quot;</span>);</span><br></pre></td></tr></table></figure>

<p>ç»å¸¸å’Œ <code>allOf()</code> æ–¹æ³•æ‹¿æ¥å¯¹æ¯”çš„æ˜¯ <code>anyOf()</code> æ–¹æ³•ã€‚</p>
<p><strong><code>allOf()</code> æ–¹æ³•ä¼šç­‰åˆ°æ‰€æœ‰çš„ <code>CompletableFuture</code> éƒ½è¿è¡Œå®Œæˆä¹‹åå†è¿”å›</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Random</span> <span class="variable">rand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span> + rand.nextInt(<span class="number">1000</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;future1 done...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line">CompletableFuture&lt;String&gt; future2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span> + rand.nextInt(<span class="number">1000</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;future2 done...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;efg&quot;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ <code>join()</code> å¯ä»¥è®©ç¨‹åºç­‰<code>future1</code> å’Œ <code>future2</code> éƒ½è¿è¡Œå®Œäº†ä¹‹åå†ç»§ç»­æ‰§è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Void&gt; completableFuture = CompletableFuture.allOf(future1, future2);</span><br><span class="line">completableFuture.join();</span><br><span class="line">assertTrue(completableFuture.isDone());</span><br><span class="line">System.out.println(<span class="string">&quot;all futures done...&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">future1 done...</span><br><span class="line">future2 done...</span><br><span class="line">all futures done...</span><br></pre></td></tr></table></figure>

<p><strong><code>anyOf()</code> æ–¹æ³•ä¸ä¼šç­‰å¾…æ‰€æœ‰çš„ <code>CompletableFuture</code> éƒ½è¿è¡Œå®Œæˆä¹‹åå†è¿”å›ï¼Œåªè¦æœ‰ä¸€ä¸ªæ‰§è¡Œå®Œæˆå³å¯ï¼</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Object&gt; f = CompletableFuture.anyOf(future1, future2);</span><br><span class="line">System.out.println(f.get());</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœå¯èƒ½æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">future2 done...</span><br><span class="line">efg</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯èƒ½æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">future1 done...</span><br><span class="line">abc</span><br></pre></td></tr></table></figure>

<h2 id="CompletableFuture-ä½¿ç”¨å»ºè®®"><a href="#CompletableFuture-ä½¿ç”¨å»ºè®®" class="headerlink" title="CompletableFuture ä½¿ç”¨å»ºè®®"></a>CompletableFuture ä½¿ç”¨å»ºè®®</h2><h3 id="ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± "><a href="#ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± " class="headerlink" title="ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± "></a>ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± </h3><p>æˆ‘ä»¬ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œéƒ½æ²¡æœ‰é€‰æ‹©è‡ªå®šä¹‰çº¿ç¨‹æ± ã€‚å®é™…é¡¹ç›®ä¸­ï¼Œè¿™æ˜¯ä¸å¯å–çš„ã€‚</p>
<p><code>CompletableFuture</code> é»˜è®¤ä½¿ç”¨å…¨å±€å…±äº«çš„ <code>ForkJoinPool.commonPool()</code> ä½œä¸ºæ‰§è¡Œå™¨ï¼Œæ‰€æœ‰æœªæŒ‡å®šæ‰§è¡Œå™¨çš„å¼‚æ­¥ä»»åŠ¡éƒ½ä¼šä½¿ç”¨è¯¥çº¿ç¨‹æ± ã€‚è¿™æ„å‘³ç€åº”ç”¨ç¨‹åºã€å¤šä¸ªåº“æˆ–æ¡†æ¶ï¼ˆå¦‚ Springã€ç¬¬ä¸‰æ–¹åº“ï¼‰è‹¥éƒ½ä¾èµ– <code>CompletableFuture</code>ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒä»¬éƒ½ä¼šå…±äº«åŒä¸€ä¸ªçº¿ç¨‹æ± ã€‚</p>
<p>è™½ç„¶ <code>ForkJoinPool</code> æ•ˆç‡å¾ˆé«˜ï¼Œä½†å½“åŒæ—¶æäº¤å¤§é‡ä»»åŠ¡æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´èµ„æºç«äº‰å’Œçº¿ç¨‹é¥¥é¥¿ï¼Œè¿›è€Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚</p>
<p>ä¸ºé¿å…è¿™äº›é—®é¢˜ï¼Œå»ºè®®ä¸º <code>CompletableFuture</code> æä¾›è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œå¸¦æ¥ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
<ul>
<li><strong>éš”ç¦»æ€§</strong>ï¼šä¸ºä¸åŒä»»åŠ¡åˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹æ± ï¼Œé¿å…å…¨å±€çº¿ç¨‹æ± èµ„æºäº‰å¤ºã€‚</li>
<li><strong>èµ„æºæ§åˆ¶</strong>ï¼šæ ¹æ®ä»»åŠ¡ç‰¹æ€§è°ƒæ•´çº¿ç¨‹æ± å¤§å°å’Œé˜Ÿåˆ—ç±»å‹ï¼Œä¼˜åŒ–æ€§èƒ½è¡¨ç°ã€‚</li>
<li><strong>å¼‚å¸¸å¤„ç†</strong>ï¼šé€šè¿‡è‡ªå®šä¹‰ <code>ThreadFactory</code> æ›´å¥½åœ°å¤„ç†çº¿ç¨‹ä¸­çš„å¼‚å¸¸æƒ…å†µã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">10</span>, <span class="number">10</span>,</span><br><span class="line">        <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line"></span><br><span class="line">CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">     <span class="comment">//...</span></span><br><span class="line">&#125;, executor);</span><br></pre></td></tr></table></figure>

<h3 id="å°½é‡é¿å…ä½¿ç”¨-get"><a href="#å°½é‡é¿å…ä½¿ç”¨-get" class="headerlink" title="å°½é‡é¿å…ä½¿ç”¨ get()"></a>å°½é‡é¿å…ä½¿ç”¨ get()</h3><p><code>CompletableFuture</code>çš„<code>get()</code>æ–¹æ³•æ˜¯é˜»å¡çš„ï¼Œå°½é‡é¿å…ä½¿ç”¨ã€‚å¦‚æœå¿…é¡»è¦ä½¿ç”¨çš„è¯ï¼Œéœ€è¦æ·»åŠ è¶…æ—¶æ—¶é—´ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´ä¸»çº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œæ— æ³•æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10_000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, world!&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å¼‚æ­¥ä»»åŠ¡çš„è¿”å›å€¼ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 5 ç§’</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> future.get(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException | TimeoutException e) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†å¼‚å¸¸</span></span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™æ®µä»£ç åœ¨è°ƒç”¨ <code>get()</code> æ—¶æŠ›å‡ºäº† <code>TimeoutException</code> å¼‚å¸¸ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨å¼‚å¸¸å¤„ç†ä¸­è¿›è¡Œç›¸åº”çš„æ“ä½œï¼Œæ¯”å¦‚å–æ¶ˆä»»åŠ¡ã€é‡è¯•ä»»åŠ¡ã€è®°å½•æ—¥å¿—ç­‰ã€‚</p>
<h3 id="æ­£ç¡®è¿›è¡Œå¼‚å¸¸å¤„ç†"><a href="#æ­£ç¡®è¿›è¡Œå¼‚å¸¸å¤„ç†" class="headerlink" title="æ­£ç¡®è¿›è¡Œå¼‚å¸¸å¤„ç†"></a>æ­£ç¡®è¿›è¡Œå¼‚å¸¸å¤„ç†</h3><p>ä½¿ç”¨ <code>CompletableFuture</code>çš„æ—¶å€™ä¸€å®šè¦ä»¥æ­£ç¡®çš„æ–¹å¼è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œé¿å…å¼‚å¸¸ä¸¢å¤±æˆ–è€…å‡ºç°ä¸å¯æ§é—®é¢˜ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€äº›å»ºè®®ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>whenComplete</code> æ–¹æ³•å¯ä»¥åœ¨ä»»åŠ¡å®Œæˆæ—¶è§¦å‘å›è°ƒå‡½æ•°ï¼Œå¹¶æ­£ç¡®åœ°å¤„ç†å¼‚å¸¸ï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸è¢«åå™¬æˆ–ä¸¢å¤±ã€‚</li>
<li>ä½¿ç”¨ <code>exceptionally</code> æ–¹æ³•å¯ä»¥å¤„ç†å¼‚å¸¸å¹¶é‡æ–°æŠ›å‡ºï¼Œä»¥ä¾¿å¼‚å¸¸èƒ½å¤Ÿä¼ æ’­åˆ°åç»­é˜¶æ®µï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸è¢«å¿½ç•¥æˆ–ç»ˆæ­¢ã€‚</li>
<li>ä½¿ç”¨ <code>handle</code> æ–¹æ³•å¯ä»¥å¤„ç†æ­£å¸¸çš„è¿”å›ç»“æœå’Œå¼‚å¸¸ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ç»“æœï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸å½±å“æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li>ä½¿ç”¨ <code>CompletableFuture.allOf</code> æ–¹æ³•å¯ä»¥ç»„åˆå¤šä¸ª <code>CompletableFuture</code>ï¼Œå¹¶ç»Ÿä¸€å¤„ç†æ‰€æœ‰ä»»åŠ¡çš„å¼‚å¸¸ï¼Œè€Œä¸æ˜¯è®©å¼‚å¸¸å¤„ç†è¿‡äºå†—é•¿æˆ–é‡å¤ã€‚</li>
<li>â€¦â€¦</li>
</ul>
<h3 id="åˆç†ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡"><a href="#åˆç†ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡" class="headerlink" title="åˆç†ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡"></a>åˆç†ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡</h3><p>æ­£ç¡®ä½¿ç”¨ <code>thenCompose()</code> ã€ <code>thenCombine()</code> ã€<code>acceptEither()</code>ã€<code>allOf()</code>ã€<code>anyOf()</code>ç­‰æ–¹æ³•æ¥ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œä»¥æ»¡è¶³å®é™…ä¸šåŠ¡çš„éœ€æ±‚ï¼Œæé«˜ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚</p>
<p>å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨æˆ–è€…å‚è€ƒç°æˆçš„å¼‚æ­¥ä»»åŠ¡ç¼–æ’æ¡†æ¶ï¼Œæ¯”å¦‚äº¬ä¸œçš„ <a href="https://gitee.com/jd-platform-opensource/asyncTool">asyncTool</a> ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/concurrent/asyncTool-readme.png" alt="asyncTool README æ–‡æ¡£"></p>
<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>è¿™ç¯‡æ–‡ç« åªæ˜¯ç®€å•ä»‹ç»äº† <code>CompletableFuture</code> çš„æ ¸å¿ƒæ¦‚å¿µå’Œæ¯”è¾ƒå¸¸ç”¨çš„ä¸€äº› API ã€‚å¦‚æœæƒ³è¦æ·±å…¥å­¦ä¹ çš„è¯ï¼Œè¿˜å¯ä»¥å¤šæ‰¾ä¸€äº›ä¹¦ç±å’Œåšå®¢çœ‹ï¼Œæ¯”å¦‚ä¸‹é¢å‡ ç¯‡æ–‡ç« å°±æŒºä¸é”™ï¼š</p>
<ul>
<li><a href="https://tech.meituan.com/2022/05/12/principles-and-practices-of-completablefuture.html">CompletableFuture åŸç†ä¸å®è·µ-å¤–å–å•†å®¶ç«¯ API çš„å¼‚æ­¥åŒ– - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ</a>ï¼šè¿™ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº† <code>CompletableFuture</code> åœ¨å®é™…é¡¹ç›®ä¸­çš„è¿ç”¨ã€‚å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼Œå¯ä»¥å¯¹é¡¹ç›®ä¸­ç±»ä¼¼çš„åœºæ™¯è¿›è¡Œä¼˜åŒ–ï¼Œä¹Ÿç®—æ˜¯ä¸€ä¸ªå°äº®ç‚¹äº†ã€‚è¿™ç§æ€§èƒ½ä¼˜åŒ–æ–¹å¼æ¯”è¾ƒç®€å•ä¸”æ•ˆæœè¿˜ä¸é”™ï¼</li>
<li><a href="https://mp.weixin.qq.com/s/32Ak-WFLynQfpn0Cg0N-0A">è¯» RocketMQ æºç ï¼Œå­¦ä¹ å¹¶å‘ç¼–ç¨‹ä¸‰å¤§ç¥å™¨ - å‹‡å“¥ java å®æˆ˜åˆ†äº«</a>ï¼šè¿™ç¯‡æ–‡ç« ä»‹ç»äº† RocketMQ å¯¹<code>CompletableFuture</code>çš„åº”ç”¨ã€‚å…·ä½“æ¥è¯´ï¼Œä» RocketMQ 4.7 å¼€å§‹ï¼ŒRocketMQ å¼•å…¥äº† <code>CompletableFuture</code>æ¥å®ç°å¼‚æ­¥æ¶ˆæ¯å¤„ç† ã€‚</li>
</ul>
<p>å¦å¤–ï¼Œå»ºè®® G å‹ä»¬å¯ä»¥çœ‹çœ‹äº¬ä¸œçš„ <a href="https://gitee.com/jd-platform-opensource/asyncTool">asyncTool</a> è¿™ä¸ªå¹¶å‘æ¡†æ¶ï¼Œé‡Œé¢å¤§é‡ä½¿ç”¨åˆ°äº† <code>CompletableFuture</code> ã€‚</p>
<!-- @include: @article-footer.snippet.md -->

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/08/29/jmm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/08/29/jmm/" itemprop="url">JMMï¼ˆJava å†…å­˜æ¨¡å‹ï¼‰è¯¦è§£</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2022-08-29T23:05:02+08:00">
                2022-08-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ï¼Œ 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/%E5%B9%B6%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">å¹¶å‘</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2022/08/29/jmm/" class="leancloud_visitors" data-flag-title="JMMï¼ˆJava å†…å­˜æ¨¡å‹ï¼‰è¯¦è§£">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  5.6k å­—
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  19 åˆ†é’Ÿ
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>JMM(Java å†…å­˜æ¨¡å‹)ä¸»è¦å®šä¹‰äº†å¯¹äºä¸€ä¸ªå…±äº«å˜é‡ï¼Œå½“å¦ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªå…±äº«å˜é‡æ‰§è¡Œå†™æ“ä½œåï¼Œè¿™ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªå…±äº«å˜é‡çš„å¯è§æ€§ã€‚</p>
<p>è¦æƒ³ç†è§£é€å½» JMMï¼ˆJava å†…å­˜æ¨¡å‹ï¼‰ï¼Œæˆ‘ä»¬å…ˆè¦ä» <strong>CPU ç¼“å­˜æ¨¡å‹å’ŒæŒ‡ä»¤é‡æ’åº</strong> è¯´èµ·ï¼</p>
<h2 id="ä»-CPU-ç¼“å­˜æ¨¡å‹è¯´èµ·"><a href="#ä»-CPU-ç¼“å­˜æ¨¡å‹è¯´èµ·" class="headerlink" title="ä» CPU ç¼“å­˜æ¨¡å‹è¯´èµ·"></a>ä» CPU ç¼“å­˜æ¨¡å‹è¯´èµ·</h2><p><strong>ä¸ºä»€ä¹ˆè¦å¼„ä¸€ä¸ª CPU é«˜é€Ÿç¼“å­˜å‘¢ï¼Ÿ</strong> ç±»æ¯”æˆ‘ä»¬å¼€å‘ç½‘ç«™åå°ç³»ç»Ÿä½¿ç”¨çš„ç¼“å­˜ï¼ˆæ¯”å¦‚ Redisï¼‰æ˜¯ä¸ºäº†è§£å†³ç¨‹åºå¤„ç†é€Ÿåº¦å’Œè®¿é—®å¸¸è§„å…³ç³»å‹æ•°æ®åº“é€Ÿåº¦ä¸å¯¹ç­‰çš„é—®é¢˜ã€‚ <strong>CPU ç¼“å­˜åˆ™æ˜¯ä¸ºäº†è§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜å¤„ç†é€Ÿåº¦ä¸å¯¹ç­‰çš„é—®é¢˜ã€‚</strong></p>
<p>æˆ‘ä»¬ç”šè‡³å¯ä»¥æŠŠ <strong>å†…å­˜çœ‹ä½œå¤–å­˜çš„é«˜é€Ÿç¼“å­˜</strong>ï¼Œç¨‹åºè¿è¡Œçš„æ—¶å€™æˆ‘ä»¬æŠŠå¤–å­˜çš„æ•°æ®å¤åˆ¶åˆ°å†…å­˜ï¼Œç”±äºå†…å­˜çš„å¤„ç†é€Ÿåº¦è¿œè¿œé«˜äºå¤–å­˜ï¼Œè¿™æ ·æé«˜äº†å¤„ç†é€Ÿåº¦ã€‚</p>
<p>æ€»ç»“ï¼š<strong>CPU Cache ç¼“å­˜çš„æ˜¯å†…å­˜æ•°æ®ç”¨äºè§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜ä¸åŒ¹é…çš„é—®é¢˜ï¼Œå†…å­˜ç¼“å­˜çš„æ˜¯ç¡¬ç›˜æ•°æ®ç”¨äºè§£å†³ç¡¬ç›˜è®¿é—®é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜ã€‚</strong></p>
<p>ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘ç”»äº†ä¸€ä¸ªç®€å•çš„ CPU Cache ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<blockquote>
<p><strong>ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š<a href="https://github.com/Snailclimb/JavaGuide/issues/1848">issue#1848</a>ï¼‰</strong>ï¼šå¯¹ CPU ç¼“å­˜æ¨¡å‹ç»˜å›¾ä¸ä¸¥è°¨çš„åœ°æ–¹è¿›è¡Œå®Œå–„ã€‚</p>
</blockquote>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/concurrent/cpu-cache.png" alt="CPU ç¼“å­˜æ¨¡å‹ç¤ºæ„å›¾"></p>
<p>ç°ä»£çš„ CPU Cache é€šå¸¸åˆ†ä¸ºä¸‰å±‚ï¼Œåˆ†åˆ«å« L1,L2,L3 Cacheã€‚æœ‰äº› CPU å¯èƒ½è¿˜æœ‰ L4 Cacheï¼Œè¿™é‡Œä¸åšè®¨è®ºï¼Œå¹¶ä¸å¸¸è§</p>
<p><strong>CPU Cache çš„å·¥ä½œæ–¹å¼ï¼š</strong> å…ˆå¤åˆ¶ä¸€ä»½æ•°æ®åˆ° CPU Cache ä¸­ï¼Œå½“ CPU éœ€è¦ç”¨åˆ°çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ä» CPU Cache ä¸­è¯»å–æ•°æ®ï¼Œå½“è¿ç®—å®Œæˆåï¼Œå†å°†è¿ç®—å¾—åˆ°çš„æ•°æ®å†™å› Main Memory ä¸­ã€‚ä½†æ˜¯ï¼Œè¿™æ ·å­˜åœ¨ <strong>å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§çš„é—®é¢˜</strong> ï¼æ¯”å¦‚æˆ‘æ‰§è¡Œä¸€ä¸ª i++ æ“ä½œçš„è¯ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œçš„è¯ï¼Œå‡è®¾ä¸¤ä¸ªçº¿ç¨‹ä» CPU Cache ä¸­è¯»å–çš„ i&#x3D;1ï¼Œä¸¤ä¸ªçº¿ç¨‹åšäº† i++ è¿ç®—å®Œä¹‹åå†å†™å› Main Memory ä¹‹å i&#x3D;2ï¼Œè€Œæ­£ç¡®ç»“æœåº”è¯¥æ˜¯ i&#x3D;3ã€‚</p>
<p><strong>CPU ä¸ºäº†è§£å†³å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜å¯ä»¥é€šè¿‡åˆ¶å®šç¼“å­˜ä¸€è‡´åè®®ï¼ˆæ¯”å¦‚ <a href="https://zh.wikipedia.org/wiki/MESI%E5%8D%8F%E8%AE%AE">MESI åè®®</a>ï¼‰æˆ–è€…å…¶ä»–æ‰‹æ®µæ¥è§£å†³ã€‚</strong> è¿™ä¸ªç¼“å­˜ä¸€è‡´æ€§åè®®æŒ‡çš„æ˜¯åœ¨ CPU é«˜é€Ÿç¼“å­˜ä¸ä¸»å†…å­˜äº¤äº’çš„æ—¶å€™éœ€è¦éµå®ˆçš„åŸåˆ™å’Œè§„èŒƒã€‚ä¸åŒçš„ CPU ä¸­ï¼Œä½¿ç”¨çš„ç¼“å­˜ä¸€è‡´æ€§åè®®é€šå¸¸ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/concurrent/cpu-cache-protocol.png" alt="ç¼“å­˜ä¸€è‡´æ€§åè®®"></p>
<p>æˆ‘ä»¬çš„ç¨‹åºè¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œæ“ä½œç³»ç»Ÿå±è”½äº†åº•å±‚ç¡¬ä»¶çš„æ“ä½œç»†èŠ‚ï¼Œå°†å„ç§ç¡¬ä»¶èµ„æºè™šæ‹ŸåŒ–ã€‚äºæ˜¯ï¼Œæ“ä½œç³»ç»Ÿä¹Ÿå°±åŒæ ·éœ€è¦è§£å†³å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
<p>æ“ä½œç³»ç»Ÿé€šè¿‡ <strong>å†…å­˜æ¨¡å‹ï¼ˆMemory Modelï¼‰</strong> å®šä¹‰ä¸€ç³»åˆ—è§„èŒƒæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ— è®ºæ˜¯ Windows ç³»ç»Ÿï¼Œè¿˜æ˜¯ Linux ç³»ç»Ÿï¼Œå®ƒä»¬éƒ½æœ‰ç‰¹å®šçš„å†…å­˜æ¨¡å‹ã€‚</p>
<h2 id="æŒ‡ä»¤é‡æ’åº"><a href="#æŒ‡ä»¤é‡æ’åº" class="headerlink" title="æŒ‡ä»¤é‡æ’åº"></a>æŒ‡ä»¤é‡æ’åº</h2><p>è¯´å®Œäº† CPU ç¼“å­˜æ¨¡å‹ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦å¤–ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µ <strong>æŒ‡ä»¤é‡æ’åº</strong> ã€‚</p>
<p>ä¸ºäº†æå‡æ‰§è¡Œé€Ÿåº¦&#x2F;æ€§èƒ½ï¼Œè®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºä»£ç çš„æ—¶å€™ï¼Œä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºã€‚</p>
<p><strong>ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’åºï¼Ÿ</strong> ç®€å•æ¥è¯´å°±æ˜¯ç³»ç»Ÿåœ¨æ‰§è¡Œä»£ç çš„æ—¶å€™å¹¶ä¸ä¸€å®šæ˜¯æŒ‰ç…§ä½ å†™çš„ä»£ç çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚</p>
<p>å¸¸è§çš„æŒ‡ä»¤é‡æ’åºæœ‰ä¸‹é¢ 2 ç§æƒ…å†µï¼š</p>
<ul>
<li><strong>ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’</strong>ï¼šç¼–è¯‘å™¨ï¼ˆåŒ…æ‹¬ JVMã€JIT ç¼–è¯‘å™¨ç­‰ï¼‰åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œé‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚</li>
<li><strong>æŒ‡ä»¤å¹¶è¡Œé‡æ’</strong>ï¼šç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯(Instruction-Level Parallelismï¼ŒILP)æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚</li>
</ul>
<p>å¦å¤–ï¼Œå†…å­˜ç³»ç»Ÿä¹Ÿä¼šæœ‰â€œé‡æ’åºâ€ï¼Œä½†åˆä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„é‡æ’åºã€‚åœ¨ JMM é‡Œè¡¨ç°ä¸ºä¸»å­˜å’Œæœ¬åœ°å†…å­˜çš„å†…å®¹å¯èƒ½ä¸ä¸€è‡´ï¼Œè¿›è€Œå¯¼è‡´ç¨‹åºåœ¨å¤šçº¿ç¨‹ä¸‹æ‰§è¡Œå¯èƒ½å‡ºç°é—®é¢˜ã€‚</p>
<p>Java æºä»£ç ä¼šç»å† <strong>ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’ â€”&gt; æŒ‡ä»¤å¹¶è¡Œé‡æ’ â€”&gt; å†…å­˜ç³»ç»Ÿé‡æ’</strong> çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆæ‰å˜æˆæ“ä½œç³»ç»Ÿå¯æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ã€‚</p>
<p><strong>æŒ‡ä»¤é‡æ’åºå¯ä»¥ä¿è¯ä¸²è¡Œè¯­ä¹‰ä¸€è‡´ï¼Œä½†æ˜¯æ²¡æœ‰ä¹‰åŠ¡ä¿è¯å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¹Ÿä¸€è‡´</strong> ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹ï¼ŒæŒ‡ä»¤é‡æ’åºå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚</p>
<p>å¯¹äºç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’å’Œå¤„ç†å™¨çš„æŒ‡ä»¤é‡æ’åºï¼ˆæŒ‡ä»¤å¹¶è¡Œé‡æ’å’Œå†…å­˜ç³»ç»Ÿé‡æ’éƒ½å±äºæ˜¯å¤„ç†å™¨çº§åˆ«çš„æŒ‡ä»¤é‡æ’åºï¼‰ï¼Œå¤„ç†è¯¥é—®é¢˜çš„æ–¹å¼ä¸ä¸€æ ·ã€‚</p>
<ul>
<li><p>å¯¹äºç¼–è¯‘å™¨ï¼Œé€šè¿‡ç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºçš„æ–¹å¼æ¥ç¦æ­¢é‡æ’åºã€‚</p>
</li>
<li><p>å¯¹äºå¤„ç†å™¨ï¼Œé€šè¿‡æ’å…¥å†…å­˜å±éšœï¼ˆMemory Barrierï¼Œæˆ–æœ‰æ—¶å«åšå†…å­˜æ …æ ï¼ŒMemory Fenceï¼‰çš„æ–¹å¼æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚</p>
</li>
</ul>
<blockquote>
<p>å†…å­˜å±éšœï¼ˆMemory Barrierï¼Œæˆ–æœ‰æ—¶å«åšå†…å­˜æ …æ ï¼ŒMemory Fenceï¼‰æ˜¯ä¸€ç§ CPU æŒ‡ä»¤ï¼Œç”¨æ¥ç¦æ­¢å¤„ç†å™¨æŒ‡ä»¤å‘ç”Ÿé‡æ’åºï¼ˆåƒå±éšœä¸€æ ·ï¼‰ï¼Œä»è€Œä¿éšœæŒ‡ä»¤æ‰§è¡Œçš„æœ‰åºæ€§ã€‚å¦å¤–ï¼Œä¸ºäº†è¾¾åˆ°å±éšœçš„æ•ˆæœï¼Œå®ƒä¹Ÿä¼šä½¿å¤„ç†å™¨å†™å…¥ã€è¯»å–å€¼ä¹‹å‰ï¼Œå°†ä¸»å†…å­˜çš„å€¼å†™å…¥é«˜é€Ÿç¼“å­˜ï¼Œæ¸…ç©ºæ— æ•ˆé˜Ÿåˆ—ï¼Œä»è€Œä¿éšœå˜é‡çš„å¯è§æ€§ã€‚</p>
</blockquote>
<h2 id="JMM-Java-Memory-Model"><a href="#JMM-Java-Memory-Model" class="headerlink" title="JMM(Java Memory Model)"></a>JMM(Java Memory Model)</h2><h3 id="ä»€ä¹ˆæ˜¯-JMMï¼Ÿä¸ºä»€ä¹ˆéœ€è¦-JMMï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-JMMï¼Ÿä¸ºä»€ä¹ˆéœ€è¦-JMMï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ JMMï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ JMMï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ JMMï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ JMMï¼Ÿ</h3><p>Java æ˜¯æœ€æ—©å°è¯•æä¾›å†…å­˜æ¨¡å‹çš„ç¼–ç¨‹è¯­è¨€ã€‚ç”±äºæ—©æœŸå†…å­˜æ¨¡å‹å­˜åœ¨ä¸€äº›ç¼ºé™·ï¼ˆæ¯”å¦‚éå¸¸å®¹æ˜“å‰Šå¼±ç¼–è¯‘å™¨çš„ä¼˜åŒ–èƒ½åŠ›ï¼‰ï¼Œä» Java5 å¼€å§‹ï¼ŒJava å¼€å§‹ä½¿ç”¨æ–°çš„å†…å­˜æ¨¡å‹ <a href="http://www.cs.umd.edu/~pugh/java/memoryModel/CommunityReview.pdf">ã€ŠJSR-133ï¼šJava Memory Model and Thread Specificationã€‹</a> ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œç¼–ç¨‹è¯­è¨€ä¹Ÿå¯ä»¥ç›´æ¥å¤ç”¨æ“ä½œç³»ç»Ÿå±‚é¢çš„å†…å­˜æ¨¡å‹ã€‚ä¸è¿‡ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿå†…å­˜æ¨¡å‹ä¸åŒã€‚å¦‚æœç›´æ¥å¤ç”¨æ“ä½œç³»ç»Ÿå±‚é¢çš„å†…å­˜æ¨¡å‹ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´åŒæ ·ä¸€å¥—ä»£ç æ¢äº†ä¸€ä¸ªæ“ä½œç³»ç»Ÿå°±æ— æ³•æ‰§è¡Œäº†ã€‚Java è¯­è¨€æ˜¯è·¨å¹³å°çš„ï¼Œå®ƒéœ€è¦è‡ªå·±æä¾›ä¸€å¥—å†…å­˜æ¨¡å‹ä»¥å±è”½ç³»ç»Ÿå·®å¼‚ã€‚</p>
<p>è¿™åªæ˜¯ JMM å­˜åœ¨çš„å…¶ä¸­ä¸€ä¸ªåŸå› ã€‚å®é™…ä¸Šï¼Œå¯¹äº Java æ¥è¯´ï¼Œä½ å¯ä»¥æŠŠ JMM çœ‹ä½œæ˜¯ Java å®šä¹‰çš„å¹¶å‘ç¼–ç¨‹ç›¸å…³çš„ä¸€ç»„è§„èŒƒï¼Œé™¤äº†æŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ä¹‹å¤–ï¼Œå…¶è¿˜è§„å®šäº†ä» Java æºä»£ç åˆ° CPU å¯æ‰§è¡ŒæŒ‡ä»¤çš„è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹è¦éµå®ˆå“ªäº›å’Œå¹¶å‘ç›¸å…³çš„åŸåˆ™å’Œè§„èŒƒï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¢å¼ºç¨‹åºå¯ç§»æ¤æ€§çš„ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆè¦éµå®ˆè¿™äº›å¹¶å‘ç›¸å…³çš„åŸåˆ™å’Œè§„èŒƒå‘¢ï¼Ÿ</strong> è¿™æ˜¯å› ä¸ºå¹¶å‘ç¼–ç¨‹ä¸‹ï¼Œåƒ CPU å¤šçº§ç¼“å­˜å’ŒæŒ‡ä»¤é‡æ’è¿™ç±»è®¾è®¡å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºè¿è¡Œå‡ºç°ä¸€äº›é—®é¢˜ã€‚å°±æ¯”å¦‚è¯´æˆ‘ä»¬ä¸Šé¢æåˆ°çš„æŒ‡ä»¤é‡æ’åºå°±å¯èƒ½ä¼šè®©å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œå‡ºç°é—®é¢˜ï¼Œä¸ºæ­¤ï¼ŒJMM æŠ½è±¡äº† happens-before åŸåˆ™ï¼ˆåæ–‡ä¼šè¯¦ç»†ä»‹ç»åˆ°ï¼‰æ¥è§£å†³è¿™ä¸ªæŒ‡ä»¤é‡æ’åºé—®é¢˜ã€‚</p>
<p>JMM è¯´ç™½äº†å°±æ˜¯å®šä¹‰äº†ä¸€äº›è§„èŒƒæ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œå¼€å‘è€…å¯ä»¥åˆ©ç”¨è¿™äº›è§„èŒƒæ›´æ–¹ä¾¿åœ°å¼€å‘å¤šçº¿ç¨‹ç¨‹åºã€‚å¯¹äº Java å¼€å‘è€…è¯´ï¼Œä½ ä¸éœ€è¦äº†è§£åº•å±‚åŸç†ï¼Œç›´æ¥ä½¿ç”¨å¹¶å‘ç›¸å…³çš„ä¸€äº›å…³é”®å­—å’Œç±»ï¼ˆæ¯”å¦‚ <code>volatile</code>ã€<code>synchronized</code>ã€å„ç§ <code>Lock</code>ï¼‰å³å¯å¼€å‘å‡ºå¹¶å‘å®‰å…¨çš„ç¨‹åºã€‚</p>
<h3 id="JMM-æ˜¯å¦‚ä½•æŠ½è±¡çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ï¼Ÿ"><a href="#JMM-æ˜¯å¦‚ä½•æŠ½è±¡çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ï¼Ÿ" class="headerlink" title="JMM æ˜¯å¦‚ä½•æŠ½è±¡çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ï¼Ÿ"></a>JMM æ˜¯å¦‚ä½•æŠ½è±¡çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ï¼Ÿ</h3><p><strong>Java å†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰</strong> æŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ï¼Œå°±æ¯”å¦‚è¯´çº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å¿…é¡»å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ã€‚</p>
<p>åœ¨ JDK1.2 ä¹‹å‰ï¼ŒJava çš„å†…å­˜æ¨¡å‹å®ç°æ€»æ˜¯ä» <strong>ä¸»å­˜</strong> ï¼ˆå³å…±äº«å†…å­˜ï¼‰è¯»å–å˜é‡ï¼Œæ˜¯ä¸éœ€è¦è¿›è¡Œç‰¹åˆ«çš„æ³¨æ„çš„ã€‚è€Œåœ¨å½“å‰çš„ Java å†…å­˜æ¨¡å‹ä¸‹ï¼Œçº¿ç¨‹å¯ä»¥æŠŠå˜é‡ä¿å­˜ <strong>æœ¬åœ°å†…å­˜</strong> ï¼ˆæ¯”å¦‚æœºå™¨çš„å¯„å­˜å™¨ï¼‰ä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨ä¸»å­˜ä¸­è¿›è¡Œè¯»å†™ã€‚è¿™å°±å¯èƒ½é€ æˆä¸€ä¸ªçº¿ç¨‹åœ¨ä¸»å­˜ä¸­ä¿®æ”¹äº†ä¸€ä¸ªå˜é‡çš„å€¼ï¼Œè€Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿˜ç»§ç»­ä½¿ç”¨å®ƒåœ¨å¯„å­˜å™¨ä¸­çš„å˜é‡å€¼çš„æ‹·è´ï¼Œé€ æˆæ•°æ®çš„ä¸ä¸€è‡´ã€‚</p>
<p>è¿™å’Œæˆ‘ä»¬ä¸Šé¢è®²åˆ°çš„ CPU ç¼“å­˜æ¨¡å‹éå¸¸ç›¸ä¼¼ã€‚</p>
<p><strong>ä»€ä¹ˆæ˜¯ä¸»å†…å­˜ï¼Ÿä»€ä¹ˆæ˜¯æœ¬åœ°å†…å­˜ï¼Ÿ</strong></p>
<ul>
<li><strong>ä¸»å†…å­˜</strong>ï¼šæ‰€æœ‰çº¿ç¨‹åˆ›å»ºçš„å®ä¾‹å¯¹è±¡éƒ½å­˜æ”¾åœ¨ä¸»å†…å­˜ä¸­ï¼Œä¸ç®¡è¯¥å®ä¾‹å¯¹è±¡æ˜¯æˆå‘˜å˜é‡ï¼Œè¿˜æ˜¯å±€éƒ¨å˜é‡ï¼Œç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡éƒ½æ˜¯æ”¾åœ¨ä¸»å†…å­˜ä¸­ã€‚ä¸ºäº†è·å–æ›´å¥½çš„è¿è¡Œé€Ÿåº¦ï¼Œè™šæ‹ŸæœºåŠç¡¬ä»¶ç³»ç»Ÿå¯èƒ½ä¼šè®©å·¥ä½œå†…å­˜ä¼˜å…ˆå­˜å‚¨äºå¯„å­˜å™¨å’Œé«˜é€Ÿç¼“å­˜ä¸­ã€‚</li>
<li><strong>æœ¬åœ°å†…å­˜</strong>ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼Œæœ¬åœ°å†…å­˜å­˜å‚¨äº†è¯¥çº¿ç¨‹ä»¥è¯» &#x2F; å†™å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚æ¯ä¸ªçº¿ç¨‹åªèƒ½æ“ä½œè‡ªå·±æœ¬åœ°å†…å­˜ä¸­çš„å˜é‡ï¼Œæ— æ³•ç›´æ¥è®¿é—®å…¶ä»–çº¿ç¨‹çš„æœ¬åœ°å†…å­˜ã€‚å¦‚æœçº¿ç¨‹é—´éœ€è¦é€šä¿¡ï¼Œå¿…é¡»é€šè¿‡ä¸»å†…å­˜æ¥è¿›è¡Œã€‚æœ¬åœ°å†…å­˜æ˜¯ JMM æŠ½è±¡å‡ºæ¥çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå¹¶ä¸çœŸå®å­˜åœ¨ï¼Œå®ƒæ¶µç›–äº†ç¼“å­˜ã€å†™ç¼“å†²åŒºã€å¯„å­˜å™¨ä»¥åŠå…¶ä»–çš„ç¡¬ä»¶å’Œç¼–è¯‘å™¨ä¼˜åŒ–ã€‚</li>
</ul>
<p>Java å†…å­˜æ¨¡å‹çš„æŠ½è±¡ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/concurrent/jmm.png" alt="JMM(Java å†…å­˜æ¨¡å‹)"></p>
<p>ä»ä¸Šå›¾æ¥çœ‹ï¼Œçº¿ç¨‹ 1 ä¸çº¿ç¨‹ 2 ä¹‹é—´å¦‚æœè¦è¿›è¡Œé€šä¿¡çš„è¯ï¼Œå¿…é¡»è¦ç»å†ä¸‹é¢ 2 ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>çº¿ç¨‹ 1 æŠŠæœ¬åœ°å†…å­˜ä¸­ä¿®æ”¹è¿‡çš„å…±äº«å˜é‡å‰¯æœ¬çš„å€¼åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­å»ã€‚</li>
<li>çº¿ç¨‹ 2 åˆ°ä¸»å­˜ä¸­è¯»å–å¯¹åº”çš„å…±äº«å˜é‡çš„å€¼ã€‚</li>
</ol>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒJMM ä¸ºå…±äº«å˜é‡æä¾›äº†å¯è§æ€§çš„ä¿éšœã€‚</p>
<p>ä¸è¿‡ï¼Œå¤šçº¿ç¨‹ä¸‹ï¼Œå¯¹ä¸»å†…å­˜ä¸­çš„ä¸€ä¸ªå…±äº«å˜é‡è¿›è¡Œæ“ä½œæœ‰å¯èƒ½è¯±å‘çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<ol>
<li>çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 åˆ†åˆ«å¯¹åŒä¸€ä¸ªå…±äº«å˜é‡è¿›è¡Œæ“ä½œï¼Œä¸€ä¸ªæ‰§è¡Œä¿®æ”¹ï¼Œä¸€ä¸ªæ‰§è¡Œè¯»å–ã€‚</li>
<li>çº¿ç¨‹ 2 è¯»å–åˆ°çš„æ˜¯çº¿ç¨‹ 1 ä¿®æ”¹ä¹‹å‰çš„å€¼è¿˜æ˜¯ä¿®æ”¹åçš„å€¼å¹¶ä¸ç¡®å®šï¼Œéƒ½æœ‰å¯èƒ½ï¼Œå› ä¸ºçº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 éƒ½æ˜¯å…ˆå°†å…±äº«å˜é‡ä»ä¸»å†…å­˜æ‹·è´åˆ°å¯¹åº”çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ã€‚</li>
</ol>
<p>å…³äºä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ç›´æ¥çš„å…·ä½“äº¤äº’åè®®ï¼Œå³ä¸€ä¸ªå˜é‡å¦‚ä½•ä»ä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ï¼Œå¦‚ä½•ä»å·¥ä½œå†…å­˜åŒæ­¥åˆ°ä¸»å†…å­˜ä¹‹é—´çš„å®ç°ç»†èŠ‚ï¼ŒJava å†…å­˜æ¨¡å‹å®šä¹‰æ¥ä»¥ä¸‹å…«ç§åŒæ­¥æ“ä½œï¼ˆäº†è§£å³å¯ï¼Œæ— éœ€æ­»è®°ç¡¬èƒŒï¼‰ï¼š</p>
<ul>
<li><strong>é”å®šï¼ˆlockï¼‰</strong>: ä½œç”¨äºä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œå°†ä»–æ ‡è®°ä¸ºä¸€ä¸ªçº¿ç¨‹ç‹¬äº«å˜é‡ã€‚</li>
<li><strong>è§£é”ï¼ˆunlockï¼‰</strong>: ä½œç”¨äºä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œè§£é™¤å˜é‡çš„é”å®šçŠ¶æ€ï¼Œè¢«è§£é™¤é”å®šçŠ¶æ€çš„å˜é‡æ‰èƒ½è¢«å…¶ä»–çº¿ç¨‹é”å®šã€‚</li>
<li><strong>readï¼ˆè¯»å–ï¼‰</strong>ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„ load åŠ¨ä½œä½¿ç”¨ã€‚</li>
<li>**load(è½½å…¥)**ï¼šæŠŠ read æ“ä½œä»ä¸»å†…å­˜ä¸­å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡çš„å‰¯æœ¬ä¸­ã€‚</li>
<li>**use(ä½¿ç”¨)**ï¼šæŠŠå·¥ä½œå†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ ç»™æ‰§è¡Œå¼•æ“ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªä½¿ç”¨åˆ°å˜é‡çš„æŒ‡ä»¤æ—¶éƒ½ä¼šä½¿ç”¨è¯¥æŒ‡ä»¤ã€‚</li>
<li><strong>assignï¼ˆèµ‹å€¼ï¼‰</strong>ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»æ‰§è¡Œå¼•æ“æ¥æ”¶åˆ°çš„å€¼èµ‹ç»™å·¥ä½œå†…å­˜çš„å˜é‡ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªç»™å˜é‡èµ‹å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶æ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚</li>
<li><strong>storeï¼ˆå­˜å‚¨ï¼‰</strong>ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„ write æ“ä½œä½¿ç”¨ã€‚</li>
<li><strong>writeï¼ˆå†™å…¥ï¼‰</strong>ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠ store æ“ä½œä»å·¥ä½œå†…å­˜ä¸­å¾—åˆ°çš„å˜é‡çš„å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­ã€‚</li>
</ul>
<p>é™¤äº†è¿™ 8 ç§åŒæ­¥æ“ä½œä¹‹å¤–ï¼Œè¿˜è§„å®šäº†ä¸‹é¢è¿™äº›åŒæ­¥è§„åˆ™æ¥ä¿è¯è¿™äº›åŒæ­¥æ“ä½œçš„æ­£ç¡®æ‰§è¡Œï¼ˆäº†è§£å³å¯ï¼Œæ— éœ€æ­»è®°ç¡¬èƒŒï¼‰ï¼š</p>
<ul>
<li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°ï¼ˆæ²¡æœ‰å‘ç”Ÿè¿‡ä»»ä½• assign æ“ä½œï¼‰æŠŠæ•°æ®ä»çº¿ç¨‹çš„å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¸­ã€‚</li>
<li>ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­ â€œè¯ç”Ÿâ€ï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆload æˆ– assignï¼‰çš„å˜é‡ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡å®æ–½ use å’Œ store æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæ‰§è¡Œè¿‡äº† assign å’Œ load æ“ä½œã€‚</li>
<li>ä¸€ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œ lock æ“ä½œï¼Œä½† lock æ“ä½œå¯ä»¥è¢«åŒä¸€æ¡çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œ lock åï¼Œåªæœ‰æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„ unlock æ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ã€‚</li>
<li>å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ lock æ“ä½œï¼Œå°†ä¼šæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡å‰ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œ load æˆ– assign æ“ä½œåˆå§‹åŒ–å˜é‡çš„å€¼ã€‚</li>
<li>å¦‚æœä¸€ä¸ªå˜é‡äº‹å…ˆæ²¡æœ‰è¢« lock æ“ä½œé”å®šï¼Œåˆ™ä¸å…è®¸å¯¹å®ƒæ‰§è¡Œ unlock æ“ä½œï¼Œä¹Ÿä¸å…è®¸å» unlock ä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šä½çš„å˜é‡ã€‚</li>
<li>â€¦â€¦</li>
</ul>
<h3 id="Java-å†…å­˜åŒºåŸŸå’Œ-JMM-æœ‰ä½•åŒºåˆ«ï¼Ÿ"><a href="#Java-å†…å­˜åŒºåŸŸå’Œ-JMM-æœ‰ä½•åŒºåˆ«ï¼Ÿ" class="headerlink" title="Java å†…å­˜åŒºåŸŸå’Œ JMM æœ‰ä½•åŒºåˆ«ï¼Ÿ"></a>Java å†…å­˜åŒºåŸŸå’Œ JMM æœ‰ä½•åŒºåˆ«ï¼Ÿ</h3><p>è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„é—®é¢˜ï¼Œå¾ˆå¤šåˆå­¦è€…éå¸¸å®¹æ˜“ææ··ã€‚ <strong>Java å†…å­˜åŒºåŸŸå’Œå†…å­˜æ¨¡å‹æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ä¸¤ä¸ªä¸œè¥¿</strong>ï¼š</p>
<ul>
<li>JVM å†…å­˜ç»“æ„å’Œ Java è™šæ‹Ÿæœºçš„è¿è¡Œæ—¶åŒºåŸŸç›¸å…³ï¼Œå®šä¹‰äº† JVM åœ¨è¿è¡Œæ—¶å¦‚ä½•åˆ†åŒºå­˜å‚¨ç¨‹åºæ•°æ®ï¼Œå°±æ¯”å¦‚è¯´å †ä¸»è¦ç”¨äºå­˜æ”¾å¯¹è±¡å®ä¾‹ã€‚</li>
<li>Java å†…å­˜æ¨¡å‹å’Œ Java çš„å¹¶å‘ç¼–ç¨‹ç›¸å…³ï¼ŒæŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»å°±æ¯”å¦‚è¯´çº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å¿…é¡»å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œè§„å®šäº†ä» Java æºä»£ç åˆ° CPU å¯æ‰§è¡ŒæŒ‡ä»¤çš„è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹è¦éµå®ˆå“ªäº›å’Œå¹¶å‘ç›¸å…³çš„åŸåˆ™å’Œè§„èŒƒï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¢å¼ºç¨‹åºå¯ç§»æ¤æ€§çš„ã€‚</li>
</ul>
<h3 id="happens-before-åŸåˆ™æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#happens-before-åŸåˆ™æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="happens-before åŸåˆ™æ˜¯ä»€ä¹ˆï¼Ÿ"></a>happens-before åŸåˆ™æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>happens-before è¿™ä¸ªæ¦‚å¿µæœ€æ—©è¯ç”Ÿäº Leslie Lamport äº 1978 å¹´å‘è¡¨çš„è®ºæ–‡<a href="https://lamport.azurewebsites.net/pubs/time-clocks.pdf">ã€ŠTimeï¼ŒClocks and the Ordering of Events in a Distributed Systemã€‹</a>ã€‚åœ¨è¿™ç¯‡è®ºæ–‡ä¸­ï¼ŒLeslie Lamport æå‡ºäº†<a href="https://writings.sh/post/logical-clocks">é€»è¾‘æ—¶é’Ÿ</a>çš„æ¦‚å¿µï¼Œè¿™ä¹Ÿæˆäº†ç¬¬ä¸€ä¸ªé€»è¾‘æ—¶é’Ÿç®—æ³• ã€‚åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œé€šè¿‡ä¸€ç³»åˆ—è§„åˆ™æ¥å®šä¹‰é€»è¾‘æ—¶é’Ÿçš„å˜åŒ–ï¼Œä»è€Œèƒ½é€šè¿‡é€»è¾‘æ—¶é’Ÿæ¥å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„äº‹ä»¶çš„å…ˆåé¡ºåºè¿›è¡Œåˆ¤æ–­ã€‚<strong>é€»è¾‘æ—¶é’Ÿå¹¶ä¸åº¦é‡æ—¶é—´æœ¬èº«ï¼Œä»…åŒºåˆ†äº‹ä»¶å‘ç”Ÿçš„å‰åé¡ºåºï¼Œå…¶æœ¬è´¨å°±æ˜¯å®šä¹‰äº†ä¸€ç§ happens-before å…³ç³»ã€‚</strong></p>
<p>ä¸Šé¢æåˆ°çš„ happens-before è¿™ä¸ªæ¦‚å¿µè¯ç”Ÿçš„èƒŒæ™¯å¹¶ä¸æ˜¯é‡ç‚¹ï¼Œç®€å•äº†è§£å³å¯ã€‚</p>
<p>JSR 133 å¼•å…¥äº† happens-before è¿™ä¸ªæ¦‚å¿µæ¥æè¿°ä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦ happens-before åŸåˆ™ï¼Ÿ</strong> happens-before åŸåˆ™çš„è¯ç”Ÿæ˜¯ä¸ºäº†ç¨‹åºå‘˜å’Œç¼–è¯‘å™¨ã€å¤„ç†å™¨ä¹‹é—´çš„å¹³è¡¡ã€‚ç¨‹åºå‘˜è¿½æ±‚çš„æ˜¯æ˜“äºç†è§£å’Œç¼–ç¨‹çš„å¼ºå†…å­˜æ¨¡å‹ï¼Œéµå®ˆæ—¢å®šè§„åˆ™ç¼–ç å³å¯ã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨è¿½æ±‚çš„æ˜¯è¾ƒå°‘çº¦æŸçš„å¼±å†…å­˜æ¨¡å‹ï¼Œè®©å®ƒä»¬å°½å·±æ‰€èƒ½åœ°å»ä¼˜åŒ–æ€§èƒ½ï¼Œè®©æ€§èƒ½æœ€å¤§åŒ–ã€‚happens-before åŸåˆ™çš„è®¾è®¡æ€æƒ³å…¶å®éå¸¸ç®€å•ï¼š</p>
<ul>
<li>ä¸ºäº†å¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„çº¦æŸå°½å¯èƒ½å°‘ï¼Œåªè¦ä¸æ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœï¼ˆå•çº¿ç¨‹ç¨‹åºå’Œæ­£ç¡®æ‰§è¡Œçš„å¤šçº¿ç¨‹ç¨‹åºï¼‰ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨æ€ä¹ˆè¿›è¡Œé‡æ’åºä¼˜åŒ–éƒ½è¡Œã€‚</li>
<li>å¯¹äºä¼šæ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„é‡æ’åºï¼ŒJMM è¦æ±‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¿…é¡»ç¦æ­¢è¿™ç§é‡æ’åºã€‚</li>
</ul>
<p>ä¸‹é¢è¿™å¼ æ˜¯ ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹è¿™æœ¬ä¹¦ä¸­çš„ä¸€å¼  JMM è®¾è®¡æ€æƒ³çš„ç¤ºæ„å›¾ï¼Œéå¸¸æ¸…æ™°ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/concurrent/image-20220731155332375.png"></p>
<p>äº†è§£äº† happens-before åŸåˆ™çš„è®¾è®¡æ€æƒ³ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ JSR-133 å¯¹ happens-before åŸåˆ™çš„å®šä¹‰ï¼š</p>
<ul>
<li>å¦‚æœä¸€ä¸ªæ“ä½œ happens-before å¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœå°†å¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚</li>
<li>ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨ happens-before å…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€ Java å¹³å°çš„å…·ä½“å®ç°å¿…é¡»è¦æŒ‰ç…§ happens-before å…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚å¦‚æœé‡æ’åºä¹‹åçš„æ‰§è¡Œç»“æœï¼Œä¸æŒ‰ happens-before å…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆ JMM ä¹Ÿå…è®¸è¿™æ ·çš„é‡æ’åºã€‚</li>
</ul>
<p>æˆ‘ä»¬çœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">userNum</span> <span class="operator">=</span> getUserNum();   <span class="comment">// 1</span></span><br><span class="line"><span class="type">int</span> <span class="variable">teacherNum</span> <span class="operator">=</span> getTeacherNum();   <span class="comment">// 2</span></span><br><span class="line"><span class="type">int</span> <span class="variable">totalNum</span> <span class="operator">=</span> userNum + teacherNum;  <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<ul>
<li>1 happens-before 2</li>
<li>2 happens-before 3</li>
<li>1 happens-before 3</li>
</ul>
<p>è™½ç„¶ 1 happens-before 2ï¼Œä½†å¯¹ 1 å’Œ 2 è¿›è¡Œé‡æ’åºä¸ä¼šå½±å“ä»£ç çš„æ‰§è¡Œç»“æœï¼Œæ‰€ä»¥ JMM æ˜¯å…è®¸ç¼–è¯‘å™¨å’Œå¤„ç†å™¨æ‰§è¡Œè¿™ç§é‡æ’åºçš„ã€‚ä½† 1 å’Œ 2 å¿…é¡»æ˜¯åœ¨ 3 æ‰§è¡Œä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯è¯´ 1,2 happens-before 3 ã€‚</p>
<p><strong>happens-before åŸåˆ™è¡¨è¾¾çš„æ„ä¹‰å…¶å®å¹¶ä¸æ˜¯ä¸€ä¸ªæ“ä½œå‘ç”Ÿåœ¨å¦å¤–ä¸€ä¸ªæ“ä½œçš„å‰é¢ï¼Œè™½ç„¶è¿™ä»ç¨‹åºå‘˜çš„è§’åº¦ä¸Šæ¥è¯´ä¹Ÿå¹¶æ— å¤§ç¢ã€‚æ›´å‡†ç¡®åœ°æ¥è¯´ï¼Œå®ƒæ›´æƒ³è¡¨è¾¾çš„æ„ä¹‰æ˜¯å‰ä¸€ä¸ªæ“ä½œçš„ç»“æœå¯¹äºåä¸€ä¸ªæ“ä½œæ˜¯å¯è§çš„ï¼Œæ— è®ºè¿™ä¸¤ä¸ªæ“ä½œæ˜¯å¦åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œã€‚</strong></p>
<p>ä¸¾ä¸ªä¾‹å­ï¼šæ“ä½œ 1 happens-before æ“ä½œ 2ï¼Œå³ä½¿æ“ä½œ 1 å’Œæ“ä½œ 2 ä¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒJMM ä¹Ÿä¼šä¿è¯æ“ä½œ 1 çš„ç»“æœå¯¹æ“ä½œ 2 æ˜¯å¯è§çš„ã€‚</p>
<h3 id="happens-before-å¸¸è§è§„åˆ™æœ‰å“ªäº›ï¼Ÿè°ˆè°ˆä½ çš„ç†è§£ï¼Ÿ"><a href="#happens-before-å¸¸è§è§„åˆ™æœ‰å“ªäº›ï¼Ÿè°ˆè°ˆä½ çš„ç†è§£ï¼Ÿ" class="headerlink" title="happens-before å¸¸è§è§„åˆ™æœ‰å“ªäº›ï¼Ÿè°ˆè°ˆä½ çš„ç†è§£ï¼Ÿ"></a>happens-before å¸¸è§è§„åˆ™æœ‰å“ªäº›ï¼Ÿè°ˆè°ˆä½ çš„ç†è§£ï¼Ÿ</h3><p>happens-before çš„è§„åˆ™å°± 8 æ¡ï¼Œè¯´å¤šä¸å¤šï¼Œé‡ç‚¹äº†è§£ä¸‹é¢åˆ—ä¸¾çš„ 5 æ¡å³å¯ã€‚å…¨è®°æ˜¯ä¸å¯èƒ½çš„ï¼Œå¾ˆå¿«å°±å¿˜è®°äº†ï¼Œæ„ä¹‰ä¸å¤§ï¼Œéšæ—¶æŸ¥é˜…å³å¯ã€‚</p>
<ol>
<li><strong>ç¨‹åºé¡ºåºè§„åˆ™</strong>ï¼šä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§ä»£ç é¡ºåºï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œ happens-before äºä¹¦å†™åœ¨åé¢çš„æ“ä½œï¼›</li>
<li><strong>è§£é”è§„åˆ™</strong>ï¼šè§£é” happens-before äºåŠ é”ï¼›</li>
<li><strong>volatile å˜é‡è§„åˆ™</strong>ï¼šå¯¹ä¸€ä¸ª volatile å˜é‡çš„å†™æ“ä½œ happens-before äºåé¢å¯¹è¿™ä¸ª volatile å˜é‡çš„è¯»æ“ä½œã€‚è¯´ç™½äº†å°±æ˜¯å¯¹ volatile å˜é‡çš„å†™æ“ä½œçš„ç»“æœå¯¹äºå‘ç”Ÿäºå…¶åçš„ä»»ä½•æ“ä½œéƒ½æ˜¯å¯è§çš„ã€‚</li>
<li><strong>ä¼ é€’è§„åˆ™</strong>ï¼šå¦‚æœ A happens-before Bï¼Œä¸” B happens-before Cï¼Œé‚£ä¹ˆ A happens-before Cï¼›</li>
<li><strong>çº¿ç¨‹å¯åŠ¨è§„åˆ™</strong>ï¼šThread å¯¹è±¡çš„ <code>start()</code>æ–¹æ³• happens-before äºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚</li>
</ol>
<p>å¦‚æœä¸¤ä¸ªæ“ä½œä¸æ»¡è¶³ä¸Šè¿°ä»»æ„ä¸€ä¸ª happens-before è§„åˆ™ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œå°±æ²¡æœ‰é¡ºåºçš„ä¿éšœï¼ŒJVM å¯ä»¥å¯¹è¿™ä¸¤ä¸ªæ“ä½œè¿›è¡Œé‡æ’åºã€‚</p>
<h3 id="happens-before-å’Œ-JMM-ä»€ä¹ˆå…³ç³»ï¼Ÿ"><a href="#happens-before-å’Œ-JMM-ä»€ä¹ˆå…³ç³»ï¼Ÿ" class="headerlink" title="happens-before å’Œ JMM ä»€ä¹ˆå…³ç³»ï¼Ÿ"></a>happens-before å’Œ JMM ä»€ä¹ˆå…³ç³»ï¼Ÿ</h3><p>happens-before ä¸ JMM çš„å…³ç³»ç”¨ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹è¿™æœ¬ä¹¦ä¸­çš„ä¸€å¼ å›¾å°±å¯ä»¥éå¸¸å¥½çš„è§£é‡Šæ¸…æ¥šã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/concurrent/image-20220731084604667.png" alt="happens-before ä¸ JMM çš„å…³ç³»"></p>
<h2 id="å†çœ‹å¹¶å‘ç¼–ç¨‹ä¸‰ä¸ªé‡è¦ç‰¹æ€§"><a href="#å†çœ‹å¹¶å‘ç¼–ç¨‹ä¸‰ä¸ªé‡è¦ç‰¹æ€§" class="headerlink" title="å†çœ‹å¹¶å‘ç¼–ç¨‹ä¸‰ä¸ªé‡è¦ç‰¹æ€§"></a>å†çœ‹å¹¶å‘ç¼–ç¨‹ä¸‰ä¸ªé‡è¦ç‰¹æ€§</h2><h3 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h3><p>ä¸€æ¬¡æ“ä½œæˆ–è€…å¤šæ¬¡æ“ä½œï¼Œè¦ä¹ˆæ‰€æœ‰çš„æ“ä½œå…¨éƒ¨éƒ½å¾—åˆ°æ‰§è¡Œå¹¶ä¸”ä¸ä¼šå—åˆ°ä»»ä½•å› ç´ çš„å¹²æ‰°è€Œä¸­æ–­ï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚</p>
<p>åœ¨ Java ä¸­ï¼Œå¯ä»¥å€ŸåŠ©<code>synchronized</code>ã€å„ç§ <code>Lock</code> ä»¥åŠå„ç§åŸå­ç±»å®ç°åŸå­æ€§ã€‚</p>
<p><code>synchronized</code> å’Œå„ç§ <code>Lock</code> å¯ä»¥ä¿è¯ä»»ä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®è¯¥ä»£ç å—ï¼Œå› æ­¤å¯ä»¥ä¿éšœåŸå­æ€§ã€‚å„ç§åŸå­ç±»æ˜¯åˆ©ç”¨ CAS (compare and swap) æ“ä½œï¼ˆå¯èƒ½ä¹Ÿä¼šç”¨åˆ° <code>volatile</code>æˆ–è€…<code>final</code>å…³é”®å­—ï¼‰æ¥ä¿è¯åŸå­æ“ä½œã€‚</p>
<h3 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h3><p>å½“ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå¦å¤–çš„çº¿ç¨‹éƒ½æ˜¯ç«‹å³å¯ä»¥çœ‹åˆ°ä¿®æ”¹åçš„æœ€æ–°å€¼ã€‚</p>
<p>åœ¨ Java ä¸­ï¼Œå¯ä»¥å€ŸåŠ©<code>synchronized</code>ã€<code>volatile</code> ä»¥åŠå„ç§ <code>Lock</code> å®ç°å¯è§æ€§ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬å°†å˜é‡å£°æ˜ä¸º <code>volatile</code> ï¼Œè¿™å°±æŒ‡ç¤º JVMï¼Œè¿™ä¸ªå˜é‡æ˜¯å…±äº«ä¸”ä¸ç¨³å®šçš„ï¼Œæ¯æ¬¡ä½¿ç”¨å®ƒéƒ½åˆ°ä¸»å­˜ä¸­è¿›è¡Œè¯»å–ã€‚</p>
<h3 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h3><p>ç”±äºæŒ‡ä»¤é‡æ’åºé—®é¢˜ï¼Œä»£ç çš„æ‰§è¡Œé¡ºåºæœªå¿…å°±æ˜¯ç¼–å†™ä»£ç æ—¶å€™çš„é¡ºåºã€‚</p>
<p>æˆ‘ä»¬ä¸Šé¢è®²é‡æ’åºçš„æ—¶å€™ä¹Ÿæåˆ°è¿‡ï¼š</p>
<blockquote>
<p><strong>æŒ‡ä»¤é‡æ’åºå¯ä»¥ä¿è¯ä¸²è¡Œè¯­ä¹‰ä¸€è‡´ï¼Œä½†æ˜¯æ²¡æœ‰ä¹‰åŠ¡ä¿è¯å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¹Ÿä¸€è‡´</strong> ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹ï¼ŒæŒ‡ä»¤é‡æ’åºå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚</p>
</blockquote>
<p>åœ¨ Java ä¸­ï¼Œ<code>volatile</code> å…³é”®å­—å¯ä»¥ç¦æ­¢æŒ‡ä»¤è¿›è¡Œé‡æ’åºä¼˜åŒ–ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li>Java æ˜¯æœ€æ—©å°è¯•æä¾›å†…å­˜æ¨¡å‹çš„è¯­è¨€ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¢å¼ºç¨‹åºå¯ç§»æ¤æ€§çš„ã€‚</li>
<li>CPU å¯ä»¥é€šè¿‡åˆ¶å®šç¼“å­˜ä¸€è‡´åè®®ï¼ˆæ¯”å¦‚ <a href="https://zh.wikipedia.org/wiki/MESI%E5%8D%8F%E8%AE%AE">MESI åè®®</a>ï¼‰æ¥è§£å†³å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚</li>
<li>ä¸ºäº†æå‡æ‰§è¡Œé€Ÿåº¦&#x2F;æ€§èƒ½ï¼Œè®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºä»£ç çš„æ—¶å€™ï¼Œä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºã€‚ ç®€å•æ¥è¯´å°±æ˜¯ç³»ç»Ÿåœ¨æ‰§è¡Œä»£ç çš„æ—¶å€™å¹¶ä¸ä¸€å®šæ˜¯æŒ‰ç…§ä½ å†™çš„ä»£ç çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚<strong>æŒ‡ä»¤é‡æ’åºå¯ä»¥ä¿è¯ä¸²è¡Œè¯­ä¹‰ä¸€è‡´ï¼Œä½†æ˜¯æ²¡æœ‰ä¹‰åŠ¡ä¿è¯å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¹Ÿä¸€è‡´</strong> ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹ï¼ŒæŒ‡ä»¤é‡æ’åºå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚</li>
<li>ä½ å¯ä»¥æŠŠ JMM çœ‹ä½œæ˜¯ Java å®šä¹‰çš„å¹¶å‘ç¼–ç¨‹ç›¸å…³çš„ä¸€ç»„è§„èŒƒï¼Œé™¤äº†æŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ä¹‹å¤–ï¼Œå…¶è¿˜è§„å®šäº†ä» Java æºä»£ç åˆ° CPU å¯æ‰§è¡ŒæŒ‡ä»¤çš„è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹è¦éµå®ˆå“ªäº›å’Œå¹¶å‘ç›¸å…³çš„åŸåˆ™å’Œè§„èŒƒï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¢å¼ºç¨‹åºå¯ç§»æ¤æ€§çš„ã€‚</li>
<li>JSR 133 å¼•å…¥äº† happens-before è¿™ä¸ªæ¦‚å¿µæ¥æè¿°ä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li>ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ç¬¬ä¸‰ç«  Java å†…å­˜æ¨¡å‹</li>
<li>ã€Šæ·±å…¥æµ…å‡º Java å¤šçº¿ç¨‹ã€‹ï¼š<a href="http://concurrent.redspider.group/RedSpider.html">http://concurrent.redspider.group/RedSpider.html</a></li>
<li>Java å†…å­˜è®¿é—®é‡æ’åºçš„ç ”ç©¶ï¼š<a href="https://tech.meituan.com/2014/09/23/java-memory-reordering.html">https://tech.meituan.com/2014/09/23/java-memory-reordering.html</a></li>
<li>å˜¿ï¼ŒåŒå­¦ï¼Œä½ è¦çš„ Java å†…å­˜æ¨¡å‹ (JMM) æ¥äº†ï¼š<a href="https://xie.infoq.cn/article/739920a92d0d27e2053174ef2">https://xie.infoq.cn/article/739920a92d0d27e2053174ef2</a></li>
<li>JSR 133 (Java Memory Model) FAQï¼š<a href="https://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html">https://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html</a></li>
</ul>
<!-- @include: @article-footer.snippet.md -->

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/08/26/mybatis-interview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/08/26/mybatis-interview/" itemprop="url">MyBatiså¸¸è§é¢è¯•é¢˜æ€»ç»“</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2022-08-26T20:56:07+08:00">
                2022-08-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ï¼Œ 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index">
                    <span itemprop="name">æ¡†æ¶</span>
                  </a>
                </span>

                
                
                  ï¼Œ 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/%E6%A1%86%E6%9E%B6/Mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">Mybatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2022/08/26/mybatis-interview/" class="leancloud_visitors" data-flag-title="MyBatiså¸¸è§é¢è¯•é¢˜æ€»ç»“">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  4.2k å­—
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  16 åˆ†é’Ÿ
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <!-- @include: @small-advertisement.snippet.md -->

<blockquote>
<p>æœ¬ç¯‡æ–‡ç« ç”± JavaGuide æ”¶é›†è‡ªç½‘ç»œï¼ŒåŸå‡ºå¤„ä¸æ˜ã€‚</p>
<p>æ¯”èµ·è¿™äº›æ¯ç‡¥çš„é¢è¯•é¢˜ï¼Œæˆ‘æ›´å»ºè®®ä½ çœ‹çœ‹æ–‡æœ«æ¨èçš„ MyBatis ä¼˜è´¨å¥½æ–‡ã€‚</p>
</blockquote>
<h3 id="å’Œ-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#å’Œ-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="#{} å’Œ ${} çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"></a>#{} å’Œ ${} çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>æ³¨ï¼šè¿™é“é¢˜æ˜¯é¢è¯•å®˜é¢è¯•æˆ‘åŒäº‹çš„ã€‚</p>
<p>ç­”ï¼š</p>
<ul>
<li><code>$&#123;&#125;</code>æ˜¯ Properties æ–‡ä»¶ä¸­çš„å˜é‡å ä½ç¬¦ï¼Œå®ƒå¯ä»¥ç”¨äºæ ‡ç­¾å±æ€§å€¼å’Œ sql å†…éƒ¨ï¼Œå±äºåŸæ ·æ–‡æœ¬æ›¿æ¢ï¼Œå¯ä»¥æ›¿æ¢ä»»æ„å†…å®¹ï¼Œæ¯”å¦‚${driver}ä¼šè¢«åŸæ ·æ›¿æ¢ä¸º<code>com.mysql.jdbc. Driver</code>ã€‚</li>
</ul>
<p>ä¸€ä¸ªç¤ºä¾‹ï¼šæ ¹æ®å‚æ•°æŒ‰ä»»æ„å­—æ®µæ’åºï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">order</span> <span class="keyword">by</span> $&#123;orderCols&#125;</span><br></pre></td></tr></table></figure>

<p><code>orderCols</code>å¯ä»¥æ˜¯ <code>name</code>ã€<code>name desc</code>ã€<code>name,sex asc</code>ç­‰ï¼Œå®ç°çµæ´»çš„æ’åºã€‚</p>
<ul>
<li><code>#&#123;&#125;</code>æ˜¯ sql çš„å‚æ•°å ä½ç¬¦ï¼ŒMyBatis ä¼šå°† sql ä¸­çš„<code>#&#123;&#125;</code>æ›¿æ¢ä¸º? å·ï¼Œåœ¨ sql æ‰§è¡Œå‰ä¼šä½¿ç”¨ PreparedStatement çš„å‚æ•°è®¾ç½®æ–¹æ³•ï¼ŒæŒ‰åºç»™ sql çš„? å·å ä½ç¬¦è®¾ç½®å‚æ•°å€¼ï¼Œæ¯”å¦‚ ps.setInt(0, parameterValue)ï¼Œ<code>#&#123;item.name&#125;</code> çš„å–å€¼æ–¹å¼ä¸ºä½¿ç”¨åå°„ä»å‚æ•°å¯¹è±¡ä¸­è·å– item å¯¹è±¡çš„ name å±æ€§å€¼ï¼Œç›¸å½“äº <code>param.getItem().getName()</code>ã€‚</li>
</ul>
<h3 id="xml-æ˜ å°„æ–‡ä»¶ä¸­ï¼Œé™¤äº†å¸¸è§çš„-selectã€insertã€updateã€delete-æ ‡ç­¾ä¹‹å¤–ï¼Œè¿˜æœ‰å“ªäº›æ ‡ç­¾ï¼Ÿ"><a href="#xml-æ˜ å°„æ–‡ä»¶ä¸­ï¼Œé™¤äº†å¸¸è§çš„-selectã€insertã€updateã€delete-æ ‡ç­¾ä¹‹å¤–ï¼Œè¿˜æœ‰å“ªäº›æ ‡ç­¾ï¼Ÿ" class="headerlink" title="xml æ˜ å°„æ–‡ä»¶ä¸­ï¼Œé™¤äº†å¸¸è§çš„ selectã€insertã€updateã€delete æ ‡ç­¾ä¹‹å¤–ï¼Œè¿˜æœ‰å“ªäº›æ ‡ç­¾ï¼Ÿ"></a>xml æ˜ å°„æ–‡ä»¶ä¸­ï¼Œé™¤äº†å¸¸è§çš„ selectã€insertã€updateã€delete æ ‡ç­¾ä¹‹å¤–ï¼Œè¿˜æœ‰å“ªäº›æ ‡ç­¾ï¼Ÿ</h3><p>æ³¨ï¼šè¿™é“é¢˜æ˜¯äº¬ä¸œé¢è¯•å®˜é¢è¯•æˆ‘æ—¶é—®çš„ã€‚</p>
<p>ç­”ï¼šè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ ‡ç­¾ï¼Œ <code>&lt;resultMap&gt;</code>ã€ <code>&lt;parameterMap&gt;</code>ã€ <code>&lt;sql&gt;</code>ã€ <code>&lt;include&gt;</code>ã€ <code>&lt;selectKey&gt;</code> ï¼ŒåŠ ä¸ŠåŠ¨æ€ sql çš„ 9 ä¸ªæ ‡ç­¾ï¼Œ <code>trim|where|set|foreach|if|choose|when|otherwise|bind</code> ç­‰ï¼Œå…¶ä¸­ <code>&lt;sql&gt;</code> ä¸º sql ç‰‡æ®µæ ‡ç­¾ï¼Œé€šè¿‡ <code>&lt;include&gt;</code> æ ‡ç­¾å¼•å…¥ sql ç‰‡æ®µï¼Œ <code>&lt;selectKey&gt;</code> ä¸ºä¸æ”¯æŒè‡ªå¢çš„ä¸»é”®ç”Ÿæˆç­–ç•¥æ ‡ç­¾ã€‚</p>
<h3 id="Dao-æ¥å£çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼ŸDao-æ¥å£é‡Œçš„æ–¹æ³•ï¼Œå‚æ•°ä¸åŒæ—¶ï¼Œæ–¹æ³•èƒ½é‡è½½å—ï¼Ÿ"><a href="#Dao-æ¥å£çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼ŸDao-æ¥å£é‡Œçš„æ–¹æ³•ï¼Œå‚æ•°ä¸åŒæ—¶ï¼Œæ–¹æ³•èƒ½é‡è½½å—ï¼Ÿ" class="headerlink" title="Dao æ¥å£çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼ŸDao æ¥å£é‡Œçš„æ–¹æ³•ï¼Œå‚æ•°ä¸åŒæ—¶ï¼Œæ–¹æ³•èƒ½é‡è½½å—ï¼Ÿ"></a>Dao æ¥å£çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼ŸDao æ¥å£é‡Œçš„æ–¹æ³•ï¼Œå‚æ•°ä¸åŒæ—¶ï¼Œæ–¹æ³•èƒ½é‡è½½å—ï¼Ÿ</h3><p>æ³¨ï¼šè¿™é“é¢˜ä¹Ÿæ˜¯äº¬ä¸œé¢è¯•å®˜é¢è¯•æˆ‘è¢«é—®çš„ã€‚</p>
<p>ç­”ï¼šæœ€ä½³å®è·µä¸­ï¼Œé€šå¸¸ä¸€ä¸ª xml æ˜ å°„æ–‡ä»¶ï¼Œéƒ½ä¼šå†™ä¸€ä¸ª Dao æ¥å£ä¸ä¹‹å¯¹åº”ã€‚Dao æ¥å£å°±æ˜¯äººä»¬å¸¸è¯´çš„ <code>Mapper</code> æ¥å£ï¼Œæ¥å£çš„å…¨é™åï¼Œå°±æ˜¯æ˜ å°„æ–‡ä»¶ä¸­çš„ namespace çš„å€¼ï¼Œæ¥å£çš„æ–¹æ³•åï¼Œå°±æ˜¯æ˜ å°„æ–‡ä»¶ä¸­ <code>MappedStatement</code> çš„ id å€¼ï¼Œæ¥å£æ–¹æ³•å†…çš„å‚æ•°ï¼Œå°±æ˜¯ä¼ é€’ç»™ sql çš„å‚æ•°ã€‚ <code>Mapper</code> æ¥å£æ˜¯æ²¡æœ‰å®ç°ç±»çš„ï¼Œå½“è°ƒç”¨æ¥å£æ–¹æ³•æ—¶ï¼Œæ¥å£å…¨é™å+æ–¹æ³•åæ‹¼æ¥å­—ç¬¦ä¸²ä½œä¸º key å€¼ï¼Œå¯å”¯ä¸€å®šä½ä¸€ä¸ª <code>MappedStatement</code> ï¼Œä¸¾ä¾‹ï¼š<code>com.mybatis3.mappers. StudentDao.findStudentById</code> ï¼Œå¯ä»¥å”¯ä¸€æ‰¾åˆ° namespace ä¸º <code>com.mybatis3.mappers. StudentDao</code> ä¸‹é¢ <code>id = findStudentById</code> çš„ <code>MappedStatement</code> ã€‚åœ¨ MyBatis ä¸­ï¼Œæ¯ä¸€ä¸ª <code>&lt;select&gt;</code>ã€ <code>&lt;insert&gt;</code>ã€ <code>&lt;update&gt;</code>ã€ <code>&lt;delete&gt;</code> æ ‡ç­¾ï¼Œéƒ½ä¼šè¢«è§£æä¸ºä¸€ä¸ª <code>MappedStatement</code> å¯¹è±¡ã€‚</p>
<p><del>Dao æ¥å£é‡Œçš„æ–¹æ³•ï¼Œæ˜¯ä¸èƒ½é‡è½½çš„ï¼Œå› ä¸ºæ˜¯å…¨é™å+æ–¹æ³•åçš„ä¿å­˜å’Œå¯»æ‰¾ç­–ç•¥ã€‚</del></p>
<p>Dao æ¥å£é‡Œçš„æ–¹æ³•å¯ä»¥é‡è½½ï¼Œä½†æ˜¯ Mybatis çš„ xml é‡Œé¢çš„ ID ä¸å…è®¸é‡å¤ã€‚</p>
<p>Mybatis ç‰ˆæœ¬ 3.3.0ï¼Œäº²æµ‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mapperæ¥å£é‡Œé¢æ–¹æ³•é‡è½½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StuMapper</span> &#123;</span><br><span class="line"></span><br><span class="line"> List&lt;Student&gt; <span class="title function_">getAllStu</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"> List&lt;Student&gt; <span class="title function_">getAllStu</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨ <code>StuMapper.xml</code> ä¸­åˆ©ç”¨ Mybatis çš„åŠ¨æ€ sql å°±å¯ä»¥å®ç°ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getAllStu&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.pojo.Student&quot;</span>&gt;</span></span><br><span class="line">  select * from student</span><br><span class="line">  <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;id != null&quot;</span>&gt;</span></span><br><span class="line">      id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>èƒ½æ­£å¸¸è¿è¡Œï¼Œå¹¶èƒ½å¾—åˆ°ç›¸åº”çš„ç»“æœï¼Œè¿™æ ·å°±å®ç°äº†åœ¨ Dao æ¥å£ä¸­å†™é‡è½½æ–¹æ³•ã€‚</p>
<p><strong>Mybatis çš„ Dao æ¥å£å¯ä»¥æœ‰å¤šä¸ªé‡è½½æ–¹æ³•ï¼Œä½†æ˜¯å¤šä¸ªæ¥å£å¯¹åº”çš„æ˜ å°„å¿…é¡»åªæœ‰ä¸€ä¸ªï¼Œå¦åˆ™å¯åŠ¨ä¼šæŠ¥é”™ã€‚</strong></p>
<p>ç›¸å…³ issueï¼š<a href="https://github.com/Snailclimb/JavaGuide/issues/1122">æ›´æ­£ï¼šDao æ¥å£é‡Œçš„æ–¹æ³•å¯ä»¥é‡è½½ï¼Œä½†æ˜¯ Mybatis çš„ xml é‡Œé¢çš„ ID ä¸å…è®¸é‡å¤ï¼</a>ã€‚</p>
<p>Dao æ¥å£çš„å·¥ä½œåŸç†æ˜¯ JDK åŠ¨æ€ä»£ç†ï¼ŒMyBatis è¿è¡Œæ—¶ä¼šä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ä¸º Dao æ¥å£ç”Ÿæˆä»£ç† proxy å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡ proxy ä¼šæ‹¦æˆªæ¥å£æ–¹æ³•ï¼Œè½¬è€Œæ‰§è¡Œ <code>MappedStatement</code> æ‰€ä»£è¡¨çš„ sqlï¼Œç„¶åå°† sql æ‰§è¡Œç»“æœè¿”å›ã€‚</p>
<p><strong>è¡¥å……</strong>ï¼š</p>
<p>Dao æ¥å£æ–¹æ³•å¯ä»¥é‡è½½ï¼Œä½†æ˜¯éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ol>
<li>ä»…æœ‰ä¸€ä¸ªæ— å‚æ–¹æ³•å’Œä¸€ä¸ªæœ‰å‚æ–¹æ³•</li>
<li>å¤šä¸ªæœ‰å‚æ–¹æ³•æ—¶ï¼Œå‚æ•°æ•°é‡å¿…é¡»ä¸€è‡´ã€‚ä¸”ä½¿ç”¨ç›¸åŒçš„ <code>@Param</code> ï¼Œæˆ–è€…ä½¿ç”¨ <code>param1</code> è¿™ç§</li>
</ol>
<p><strong>æµ‹è¯•å¦‚ä¸‹</strong>ï¼š</p>
<p><code>PersonDao.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Person <span class="title function_">queryById</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">Person <span class="title function_">queryById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line"></span><br><span class="line">Person <span class="title function_">queryById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id, <span class="meta">@Param(&quot;name&quot;)</span> String name)</span>;</span><br></pre></td></tr></table></figure>

<p><code>PersonMapper.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryById&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;PersonMap&quot;</span>&gt;</span></span><br><span class="line">    select</span><br><span class="line">      id, name, age, address</span><br><span class="line">    from person</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;id != null&quot;</span>&gt;</span></span><br><span class="line">            id = #&#123;id&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class="line">            name = #&#123;name&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    limit 1</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>org.apache.ibatis.scripting.xmltags. DynamicContext. ContextAccessor#getProperty</code> æ–¹æ³•ç”¨äºè·å– <code>&lt;if&gt;</code> æ ‡ç­¾ä¸­çš„æ¡ä»¶å€¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getProperty</span><span class="params">(Map context, Object target, Object name)</span> &#123;</span><br><span class="line">  <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> (Map) target;</span><br><span class="line"></span><br><span class="line">  <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> map.get(name);</span><br><span class="line">  <span class="keyword">if</span> (map.containsKey(name) || result != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">Object</span> <span class="variable">parameterObject</span> <span class="operator">=</span> map.get(PARAMETER_OBJECT_KEY);</span><br><span class="line">  <span class="keyword">if</span> (parameterObject <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">    <span class="keyword">return</span> ((Map)parameterObject).get(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>parameterObject</code> ä¸º mapï¼Œå­˜æ”¾çš„æ˜¯ Dao æ¥å£ä¸­å‚æ•°ç›¸å…³ä¿¡æ¯ã€‚</p>
<p><code>((Map)parameterObject).get(name)</code> æ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">super</span>.containsKey(key)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindingException</span>(<span class="string">&quot;Parameter &#x27;&quot;</span> + key + <span class="string">&quot;&#x27; not found. Available parameters are &quot;</span> + keySet());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">super</span>.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>queryById()</code>æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œ<code>parameterObject</code>ä¸º nullï¼Œ<code>getProperty</code>æ–¹æ³•è¿”å› null å€¼ï¼Œ<code>&lt;if&gt;</code>æ ‡ç­¾è·å–çš„æ‰€æœ‰æ¡ä»¶å€¼éƒ½ä¸º nullï¼Œæ‰€æœ‰æ¡ä»¶ä¸æˆç«‹ï¼ŒåŠ¨æ€ sql å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚</li>
<li><code>queryById(1L)</code>æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œ<code>parameterObject</code>ä¸º mapï¼ŒåŒ…å«äº†<code>id</code>å’Œ<code>param1</code>ä¸¤ä¸ª key å€¼ã€‚å½“è·å–<code>&lt;if&gt;</code>æ ‡ç­¾ä¸­<code>name</code>çš„å±æ€§å€¼æ—¶ï¼Œè¿›å…¥<code>((Map)parameterObject).get(name)</code>æ–¹æ³•ä¸­ï¼Œmap ä¸­ key ä¸åŒ…å«<code>name</code>ï¼Œæ‰€ä»¥æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li><code>queryById(1L,&quot;1&quot;)</code>æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œ<code>parameterObject</code>ä¸­åŒ…å«<code>id</code>,<code>param1</code>,<code>name</code>,<code>param2</code>å››ä¸ª key å€¼ï¼Œ<code>id</code>å’Œ<code>name</code>å±æ€§éƒ½å¯ä»¥è·å–åˆ°ï¼ŒåŠ¨æ€ sql æ­£å¸¸æ‰§è¡Œã€‚</li>
</ol>
<h3 id="MyBatis-æ˜¯å¦‚ä½•è¿›è¡Œåˆ†é¡µçš„ï¼Ÿåˆ†é¡µæ’ä»¶çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#MyBatis-æ˜¯å¦‚ä½•è¿›è¡Œåˆ†é¡µçš„ï¼Ÿåˆ†é¡µæ’ä»¶çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="MyBatis æ˜¯å¦‚ä½•è¿›è¡Œåˆ†é¡µçš„ï¼Ÿåˆ†é¡µæ’ä»¶çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"></a>MyBatis æ˜¯å¦‚ä½•è¿›è¡Œåˆ†é¡µçš„ï¼Ÿåˆ†é¡µæ’ä»¶çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„ã€‚</p>
<p>ç­”ï¼š**(1)** MyBatis ä½¿ç”¨ RowBounds å¯¹è±¡è¿›è¡Œåˆ†é¡µï¼Œå®ƒæ˜¯é’ˆå¯¹ ResultSet ç»“æœé›†æ‰§è¡Œçš„å†…å­˜åˆ†é¡µï¼Œè€Œéç‰©ç†åˆ†é¡µï¼›**(2)** å¯ä»¥åœ¨ sql å†…ç›´æ¥ä¹¦å†™å¸¦æœ‰ç‰©ç†åˆ†é¡µçš„å‚æ•°æ¥å®Œæˆç‰©ç†åˆ†é¡µåŠŸèƒ½ï¼Œ**(3)** ä¹Ÿå¯ä»¥ä½¿ç”¨åˆ†é¡µæ’ä»¶æ¥å®Œæˆç‰©ç†åˆ†é¡µã€‚</p>
<p>åˆ†é¡µæ’ä»¶çš„åŸºæœ¬åŸç†æ˜¯ä½¿ç”¨ MyBatis æä¾›çš„æ’ä»¶æ¥å£ï¼Œå®ç°è‡ªå®šä¹‰æ’ä»¶ï¼Œåœ¨æ’ä»¶çš„æ‹¦æˆªæ–¹æ³•å†…æ‹¦æˆªå¾…æ‰§è¡Œçš„ sqlï¼Œç„¶åé‡å†™ sqlï¼Œæ ¹æ® dialect æ–¹è¨€ï¼Œæ·»åŠ å¯¹åº”çš„ç‰©ç†åˆ†é¡µè¯­å¥å’Œç‰©ç†åˆ†é¡µå‚æ•°ã€‚</p>
<p>ä¸¾ä¾‹ï¼š<code>select _ from student</code> ï¼Œæ‹¦æˆª sql åé‡å†™ä¸ºï¼š<code>select t._ from ï¼ˆselect \* from studentï¼‰t limit 0ï¼Œ10</code></p>
<h3 id="ç®€è¿°-MyBatis-çš„æ’ä»¶è¿è¡ŒåŸç†ï¼Œä»¥åŠå¦‚ä½•ç¼–å†™ä¸€ä¸ªæ’ä»¶"><a href="#ç®€è¿°-MyBatis-çš„æ’ä»¶è¿è¡ŒåŸç†ï¼Œä»¥åŠå¦‚ä½•ç¼–å†™ä¸€ä¸ªæ’ä»¶" class="headerlink" title="ç®€è¿° MyBatis çš„æ’ä»¶è¿è¡ŒåŸç†ï¼Œä»¥åŠå¦‚ä½•ç¼–å†™ä¸€ä¸ªæ’ä»¶"></a>ç®€è¿° MyBatis çš„æ’ä»¶è¿è¡ŒåŸç†ï¼Œä»¥åŠå¦‚ä½•ç¼–å†™ä¸€ä¸ªæ’ä»¶</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„ã€‚</p>
<p>ç­”ï¼šMyBatis ä»…å¯ä»¥ç¼–å†™é’ˆå¯¹ <code>ParameterHandler</code>ã€ <code>ResultSetHandler</code>ã€ <code>StatementHandler</code>ã€ <code>Executor</code> è¿™ 4 ç§æ¥å£çš„æ’ä»¶ï¼ŒMyBatis ä½¿ç”¨ JDK çš„åŠ¨æ€ä»£ç†ï¼Œä¸ºéœ€è¦æ‹¦æˆªçš„æ¥å£ç”Ÿæˆä»£ç†å¯¹è±¡ä»¥å®ç°æ¥å£æ–¹æ³•æ‹¦æˆªåŠŸèƒ½ï¼Œæ¯å½“æ‰§è¡Œè¿™ 4 ç§æ¥å£å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œå°±ä¼šè¿›å…¥æ‹¦æˆªæ–¹æ³•ï¼Œå…·ä½“å°±æ˜¯ <code>InvocationHandler</code> çš„ <code>invoke()</code> æ–¹æ³•ï¼Œå½“ç„¶ï¼Œåªä¼šæ‹¦æˆªé‚£äº›ä½ æŒ‡å®šéœ€è¦æ‹¦æˆªçš„æ–¹æ³•ã€‚</p>
<p>å®ç° MyBatis çš„ <code>Interceptor</code> æ¥å£å¹¶å¤å†™ <code>intercept()</code> æ–¹æ³•ï¼Œç„¶ååœ¨ç»™æ’ä»¶ç¼–å†™æ³¨è§£ï¼ŒæŒ‡å®šè¦æ‹¦æˆªå“ªä¸€ä¸ªæ¥å£çš„å“ªäº›æ–¹æ³•å³å¯ï¼Œè®°ä½ï¼Œåˆ«å¿˜äº†åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ä½ ç¼–å†™çš„æ’ä»¶ã€‚</p>
<h3 id="MyBatis-æ‰§è¡Œæ‰¹é‡æ’å…¥ï¼Œèƒ½è¿”å›æ•°æ®åº“ä¸»é”®åˆ—è¡¨å—ï¼Ÿ"><a href="#MyBatis-æ‰§è¡Œæ‰¹é‡æ’å…¥ï¼Œèƒ½è¿”å›æ•°æ®åº“ä¸»é”®åˆ—è¡¨å—ï¼Ÿ" class="headerlink" title="MyBatis æ‰§è¡Œæ‰¹é‡æ’å…¥ï¼Œèƒ½è¿”å›æ•°æ®åº“ä¸»é”®åˆ—è¡¨å—ï¼Ÿ"></a>MyBatis æ‰§è¡Œæ‰¹é‡æ’å…¥ï¼Œèƒ½è¿”å›æ•°æ®åº“ä¸»é”®åˆ—è¡¨å—ï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„ã€‚</p>
<p>ç­”ï¼šèƒ½ï¼ŒJDBC éƒ½èƒ½ï¼ŒMyBatis å½“ç„¶ä¹Ÿèƒ½ã€‚</p>
<h3 id="MyBatis-åŠ¨æ€-sql-æ˜¯åšä»€ä¹ˆçš„ï¼Ÿéƒ½æœ‰å“ªäº›åŠ¨æ€-sqlï¼Ÿèƒ½ç®€è¿°ä¸€ä¸‹åŠ¨æ€-sql-çš„æ‰§è¡ŒåŸç†ä¸ï¼Ÿ"><a href="#MyBatis-åŠ¨æ€-sql-æ˜¯åšä»€ä¹ˆçš„ï¼Ÿéƒ½æœ‰å“ªäº›åŠ¨æ€-sqlï¼Ÿèƒ½ç®€è¿°ä¸€ä¸‹åŠ¨æ€-sql-çš„æ‰§è¡ŒåŸç†ä¸ï¼Ÿ" class="headerlink" title="MyBatis åŠ¨æ€ sql æ˜¯åšä»€ä¹ˆçš„ï¼Ÿéƒ½æœ‰å“ªäº›åŠ¨æ€ sqlï¼Ÿèƒ½ç®€è¿°ä¸€ä¸‹åŠ¨æ€ sql çš„æ‰§è¡ŒåŸç†ä¸ï¼Ÿ"></a>MyBatis åŠ¨æ€ sql æ˜¯åšä»€ä¹ˆçš„ï¼Ÿéƒ½æœ‰å“ªäº›åŠ¨æ€ sqlï¼Ÿèƒ½ç®€è¿°ä¸€ä¸‹åŠ¨æ€ sql çš„æ‰§è¡ŒåŸç†ä¸ï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„ã€‚</p>
<p>ç­”ï¼šMyBatis åŠ¨æ€ sql å¯ä»¥è®©æˆ‘ä»¬åœ¨ xml æ˜ å°„æ–‡ä»¶å†…ï¼Œä»¥æ ‡ç­¾çš„å½¢å¼ç¼–å†™åŠ¨æ€ sqlï¼Œå®Œæˆé€»è¾‘åˆ¤æ–­å’ŒåŠ¨æ€æ‹¼æ¥ sql çš„åŠŸèƒ½ã€‚å…¶æ‰§è¡ŒåŸç†ä¸ºï¼Œä½¿ç”¨ OGNL ä» sql å‚æ•°å¯¹è±¡ä¸­è®¡ç®—è¡¨è¾¾å¼çš„å€¼ï¼Œæ ¹æ®è¡¨è¾¾å¼çš„å€¼åŠ¨æ€æ‹¼æ¥ sqlï¼Œä»¥æ­¤æ¥å®ŒæˆåŠ¨æ€ sql çš„åŠŸèƒ½ã€‚</p>
<p>MyBatis æä¾›äº† 9 ç§åŠ¨æ€ sql æ ‡ç­¾:</p>
<ul>
<li><code>&lt;if&gt;&lt;/if&gt;</code></li>
<li><code>&lt;where&gt;&lt;/where&gt;(trim,set)</code></li>
<li><code>&lt;choose&gt;&lt;/choose&gt;ï¼ˆwhen, otherwiseï¼‰</code></li>
<li><code>&lt;foreach&gt;&lt;/foreach&gt;</code></li>
<li><code>&lt;bind/&gt;</code></li>
</ul>
<p>å…³äº MyBatis åŠ¨æ€ SQL çš„è¯¦ç»†ä»‹ç»ï¼Œè¯·çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://segmentfault.com/a/1190000039335704">Mybatis ç³»åˆ—å…¨è§£ï¼ˆå…«ï¼‰ï¼šMybatis çš„ 9 å¤§åŠ¨æ€ SQL æ ‡ç­¾ä½ çŸ¥é“å‡ ä¸ªï¼Ÿ</a> ã€‚</p>
<p>å…³äºè¿™äº›åŠ¨æ€ SQL çš„å…·ä½“ä½¿ç”¨æ–¹æ³•ï¼Œè¯·çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://cloud.tencent.com/developer/article/1943349">Mybatisã€13ã€‘â€“ Mybatis åŠ¨æ€ sql æ ‡ç­¾æ€ä¹ˆä½¿ç”¨ï¼Ÿ</a></p>
<h3 id="MyBatis-æ˜¯å¦‚ä½•å°†-sql-æ‰§è¡Œç»“æœå°è£…ä¸ºç›®æ ‡å¯¹è±¡å¹¶è¿”å›çš„ï¼Ÿéƒ½æœ‰å“ªäº›æ˜ å°„å½¢å¼ï¼Ÿ"><a href="#MyBatis-æ˜¯å¦‚ä½•å°†-sql-æ‰§è¡Œç»“æœå°è£…ä¸ºç›®æ ‡å¯¹è±¡å¹¶è¿”å›çš„ï¼Ÿéƒ½æœ‰å“ªäº›æ˜ å°„å½¢å¼ï¼Ÿ" class="headerlink" title="MyBatis æ˜¯å¦‚ä½•å°† sql æ‰§è¡Œç»“æœå°è£…ä¸ºç›®æ ‡å¯¹è±¡å¹¶è¿”å›çš„ï¼Ÿéƒ½æœ‰å“ªäº›æ˜ å°„å½¢å¼ï¼Ÿ"></a>MyBatis æ˜¯å¦‚ä½•å°† sql æ‰§è¡Œç»“æœå°è£…ä¸ºç›®æ ‡å¯¹è±¡å¹¶è¿”å›çš„ï¼Ÿéƒ½æœ‰å“ªäº›æ˜ å°„å½¢å¼ï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„ã€‚</p>
<p>ç­”ï¼šç¬¬ä¸€ç§æ˜¯ä½¿ç”¨ <code>&lt;resultMap&gt;</code> æ ‡ç­¾ï¼Œé€ä¸€å®šä¹‰åˆ—åå’Œå¯¹è±¡å±æ€§åä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚ç¬¬äºŒç§æ˜¯ä½¿ç”¨ sql åˆ—çš„åˆ«ååŠŸèƒ½ï¼Œå°†åˆ—åˆ«åä¹¦å†™ä¸ºå¯¹è±¡å±æ€§åï¼Œæ¯”å¦‚ T_NAME AS NAMEï¼Œå¯¹è±¡å±æ€§åä¸€èˆ¬æ˜¯ nameï¼Œå°å†™ï¼Œä½†æ˜¯åˆ—åä¸åŒºåˆ†å¤§å°å†™ï¼ŒMyBatis ä¼šå¿½ç•¥åˆ—åå¤§å°å†™ï¼Œæ™ºèƒ½æ‰¾åˆ°ä¸ä¹‹å¯¹åº”å¯¹è±¡å±æ€§åï¼Œä½ ç”šè‡³å¯ä»¥å†™æˆ T_NAME AS NaMeï¼ŒMyBatis ä¸€æ ·å¯ä»¥æ­£å¸¸å·¥ä½œã€‚</p>
<p>æœ‰äº†åˆ—åä¸å±æ€§åçš„æ˜ å°„å…³ç³»åï¼ŒMyBatis é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡ï¼ŒåŒæ—¶ä½¿ç”¨åå°„ç»™å¯¹è±¡çš„å±æ€§é€ä¸€èµ‹å€¼å¹¶è¿”å›ï¼Œé‚£äº›æ‰¾ä¸åˆ°æ˜ å°„å…³ç³»çš„å±æ€§ï¼Œæ˜¯æ— æ³•å®Œæˆèµ‹å€¼çš„ã€‚</p>
<h3 id="MyBatis-èƒ½æ‰§è¡Œä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šçš„å…³è”æŸ¥è¯¢å—ï¼Ÿéƒ½æœ‰å“ªäº›å®ç°æ–¹å¼ï¼Œä»¥åŠå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«"><a href="#MyBatis-èƒ½æ‰§è¡Œä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šçš„å…³è”æŸ¥è¯¢å—ï¼Ÿéƒ½æœ‰å“ªäº›å®ç°æ–¹å¼ï¼Œä»¥åŠå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«" class="headerlink" title="MyBatis èƒ½æ‰§è¡Œä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šçš„å…³è”æŸ¥è¯¢å—ï¼Ÿéƒ½æœ‰å“ªäº›å®ç°æ–¹å¼ï¼Œä»¥åŠå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«"></a>MyBatis èƒ½æ‰§è¡Œä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šçš„å…³è”æŸ¥è¯¢å—ï¼Ÿéƒ½æœ‰å“ªäº›å®ç°æ–¹å¼ï¼Œä»¥åŠå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„ã€‚</p>
<p>ç­”ï¼šèƒ½ï¼ŒMyBatis ä¸ä»…å¯ä»¥æ‰§è¡Œä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šçš„å…³è”æŸ¥è¯¢ï¼Œè¿˜å¯ä»¥æ‰§è¡Œå¤šå¯¹ä¸€ï¼Œå¤šå¯¹å¤šçš„å…³è”æŸ¥è¯¢ï¼Œå¤šå¯¹ä¸€æŸ¥è¯¢ï¼Œå…¶å®å°±æ˜¯ä¸€å¯¹ä¸€æŸ¥è¯¢ï¼Œåªéœ€è¦æŠŠ <code>selectOne()</code> ä¿®æ”¹ä¸º <code>selectList()</code> å³å¯ï¼›å¤šå¯¹å¤šæŸ¥è¯¢ï¼Œå…¶å®å°±æ˜¯ä¸€å¯¹å¤šæŸ¥è¯¢ï¼Œåªéœ€è¦æŠŠ <code>selectOne()</code> ä¿®æ”¹ä¸º <code>selectList()</code> å³å¯ã€‚</p>
<p>å…³è”å¯¹è±¡æŸ¥è¯¢ï¼Œæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼Œä¸€ç§æ˜¯å•ç‹¬å‘é€ä¸€ä¸ª sql å»æŸ¥è¯¢å…³è”å¯¹è±¡ï¼Œèµ‹ç»™ä¸»å¯¹è±¡ï¼Œç„¶åè¿”å›ä¸»å¯¹è±¡ã€‚å¦ä¸€ç§æ˜¯ä½¿ç”¨åµŒå¥—æŸ¥è¯¢ï¼ŒåµŒå¥—æŸ¥è¯¢çš„å«ä¹‰ä¸ºä½¿ç”¨ join æŸ¥è¯¢ï¼Œä¸€éƒ¨åˆ†åˆ—æ˜¯ A å¯¹è±¡çš„å±æ€§å€¼ï¼Œå¦å¤–ä¸€éƒ¨åˆ†åˆ—æ˜¯å…³è”å¯¹è±¡ B çš„å±æ€§å€¼ï¼Œå¥½å¤„æ˜¯åªå‘ä¸€ä¸ª sql æŸ¥è¯¢ï¼Œå°±å¯ä»¥æŠŠä¸»å¯¹è±¡å’Œå…¶å…³è”å¯¹è±¡æŸ¥å‡ºæ¥ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œjoin æŸ¥è¯¢å‡ºæ¥ 100 æ¡è®°å½•ï¼Œå¦‚ä½•ç¡®å®šä¸»å¯¹è±¡æ˜¯ 5 ä¸ªï¼Œè€Œä¸æ˜¯ 100 ä¸ªï¼Ÿå…¶å»é‡å¤çš„åŸç†æ˜¯ <code>&lt;resultMap&gt;</code> æ ‡ç­¾å†…çš„ <code>&lt;id&gt;</code> å­æ ‡ç­¾ï¼ŒæŒ‡å®šäº†å”¯ä¸€ç¡®å®šä¸€æ¡è®°å½•çš„ id åˆ—ï¼ŒMyBatis æ ¹æ® <code>&lt;id&gt;</code> åˆ—å€¼æ¥å®Œæˆ 100 æ¡è®°å½•çš„å»é‡å¤åŠŸèƒ½ï¼Œ <code>&lt;id&gt;</code> å¯ä»¥æœ‰å¤šä¸ªï¼Œä»£è¡¨äº†è”åˆä¸»é”®çš„è¯­æ„ã€‚</p>
<p>åŒæ ·ä¸»å¯¹è±¡çš„å…³è”å¯¹è±¡ï¼Œä¹Ÿæ˜¯æ ¹æ®è¿™ä¸ªåŸç†å»é‡å¤çš„ï¼Œå°½ç®¡ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸»å¯¹è±¡ä¼šæœ‰é‡å¤è®°å½•ï¼Œå…³è”å¯¹è±¡ä¸€èˆ¬ä¸ä¼šé‡å¤ã€‚</p>
<p>ä¸¾ä¾‹ï¼šä¸‹é¢ join æŸ¥è¯¢å‡ºæ¥ 6 æ¡è®°å½•ï¼Œä¸€ã€äºŒåˆ—æ˜¯ Teacher å¯¹è±¡åˆ—ï¼Œç¬¬ä¸‰åˆ—ä¸º Student å¯¹è±¡åˆ—ï¼ŒMyBatis å»é‡å¤å¤„ç†åï¼Œç»“æœä¸º 1 ä¸ªè€å¸ˆ 6 ä¸ªå­¦ç”Ÿï¼Œè€Œä¸æ˜¯ 6 ä¸ªè€å¸ˆ 6 ä¸ªå­¦ç”Ÿã€‚</p>
<table>
<thead>
<tr>
<th>t_id</th>
<th>t_name</th>
<th>s_id</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>teacher</td>
<td>38</td>
</tr>
<tr>
<td>1</td>
<td>teacher</td>
<td>39</td>
</tr>
<tr>
<td>1</td>
<td>teacher</td>
<td>40</td>
</tr>
<tr>
<td>1</td>
<td>teacher</td>
<td>41</td>
</tr>
<tr>
<td>1</td>
<td>teacher</td>
<td>42</td>
</tr>
<tr>
<td>1</td>
<td>teacher</td>
<td>43</td>
</tr>
</tbody></table>
<h3 id="MyBatis-æ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Ÿå¦‚æœæ”¯æŒï¼Œå®ƒçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#MyBatis-æ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Ÿå¦‚æœæ”¯æŒï¼Œå®ƒçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="MyBatis æ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Ÿå¦‚æœæ”¯æŒï¼Œå®ƒçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"></a>MyBatis æ˜¯å¦æ”¯æŒå»¶è¿ŸåŠ è½½ï¼Ÿå¦‚æœæ”¯æŒï¼Œå®ƒçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„ã€‚</p>
<p>ç­”ï¼šMyBatis ä»…æ”¯æŒ association å…³è”å¯¹è±¡å’Œ collection å…³è”é›†åˆå¯¹è±¡çš„å»¶è¿ŸåŠ è½½ï¼Œassociation æŒ‡çš„å°±æ˜¯ä¸€å¯¹ä¸€ï¼Œcollection æŒ‡çš„å°±æ˜¯ä¸€å¯¹å¤šæŸ¥è¯¢ã€‚åœ¨ MyBatis é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥é…ç½®æ˜¯å¦å¯ç”¨å»¶è¿ŸåŠ è½½ <code>lazyLoadingEnabled=true|falseã€‚</code></p>
<p>å®ƒçš„åŸç†æ˜¯ï¼Œä½¿ç”¨ <code>CGLIB</code> åˆ›å»ºç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œå½“è°ƒç”¨ç›®æ ‡æ–¹æ³•æ—¶ï¼Œè¿›å…¥æ‹¦æˆªå™¨æ–¹æ³•ï¼Œæ¯”å¦‚è°ƒç”¨ <code>a.getB().getName()</code> ï¼Œæ‹¦æˆªå™¨ <code>invoke()</code> æ–¹æ³•å‘ç° <code>a.getB()</code> æ˜¯ null å€¼ï¼Œé‚£ä¹ˆå°±ä¼šå•ç‹¬å‘é€äº‹å…ˆä¿å­˜å¥½çš„æŸ¥è¯¢å…³è” B å¯¹è±¡çš„ sqlï¼ŒæŠŠ B æŸ¥è¯¢ä¸Šæ¥ï¼Œç„¶åè°ƒç”¨ a.setB(b)ï¼Œäºæ˜¯ a çš„å¯¹è±¡ b å±æ€§å°±æœ‰å€¼äº†ï¼Œæ¥ç€å®Œæˆ <code>a.getB().getName()</code> æ–¹æ³•çš„è°ƒç”¨ã€‚è¿™å°±æ˜¯å»¶è¿ŸåŠ è½½çš„åŸºæœ¬åŸç†ã€‚</p>
<p>å½“ç„¶äº†ï¼Œä¸å…‰æ˜¯ MyBatisï¼Œå‡ ä¹æ‰€æœ‰çš„åŒ…æ‹¬ Hibernateï¼Œæ”¯æŒå»¶è¿ŸåŠ è½½çš„åŸç†éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
<h3 id="MyBatis-çš„-xml-æ˜ å°„æ–‡ä»¶ä¸­ï¼Œä¸åŒçš„-xml-æ˜ å°„æ–‡ä»¶ï¼Œid-æ˜¯å¦å¯ä»¥é‡å¤ï¼Ÿ"><a href="#MyBatis-çš„-xml-æ˜ å°„æ–‡ä»¶ä¸­ï¼Œä¸åŒçš„-xml-æ˜ å°„æ–‡ä»¶ï¼Œid-æ˜¯å¦å¯ä»¥é‡å¤ï¼Ÿ" class="headerlink" title="MyBatis çš„ xml æ˜ å°„æ–‡ä»¶ä¸­ï¼Œä¸åŒçš„ xml æ˜ å°„æ–‡ä»¶ï¼Œid æ˜¯å¦å¯ä»¥é‡å¤ï¼Ÿ"></a>MyBatis çš„ xml æ˜ å°„æ–‡ä»¶ä¸­ï¼Œä¸åŒçš„ xml æ˜ å°„æ–‡ä»¶ï¼Œid æ˜¯å¦å¯ä»¥é‡å¤ï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„ã€‚</p>
<p>ç­”ï¼šä¸åŒçš„ xml æ˜ å°„æ–‡ä»¶ï¼Œå¦‚æœé…ç½®äº† namespaceï¼Œé‚£ä¹ˆ id å¯ä»¥é‡å¤ï¼›å¦‚æœæ²¡æœ‰é…ç½® namespaceï¼Œé‚£ä¹ˆ id ä¸èƒ½é‡å¤ï¼›æ¯•ç«Ÿ namespace ä¸æ˜¯å¿…é¡»çš„ï¼Œåªæ˜¯æœ€ä½³å®è·µè€Œå·²ã€‚</p>
<p>åŸå› å°±æ˜¯ namespace+id æ˜¯ä½œä¸º <code>Map&lt;String, MappedStatement&gt;</code> çš„ key ä½¿ç”¨çš„ï¼Œå¦‚æœæ²¡æœ‰ namespaceï¼Œå°±å‰©ä¸‹ idï¼Œé‚£ä¹ˆï¼Œid é‡å¤ä¼šå¯¼è‡´æ•°æ®äº’ç›¸è¦†ç›–ã€‚æœ‰äº† namespaceï¼Œè‡ªç„¶ id å°±å¯ä»¥é‡å¤ï¼Œnamespace ä¸åŒï¼Œnamespace+id è‡ªç„¶ä¹Ÿå°±ä¸åŒã€‚</p>
<h3 id="MyBatis-ä¸­å¦‚ä½•æ‰§è¡Œæ‰¹å¤„ç†ï¼Ÿ"><a href="#MyBatis-ä¸­å¦‚ä½•æ‰§è¡Œæ‰¹å¤„ç†ï¼Ÿ" class="headerlink" title="MyBatis ä¸­å¦‚ä½•æ‰§è¡Œæ‰¹å¤„ç†ï¼Ÿ"></a>MyBatis ä¸­å¦‚ä½•æ‰§è¡Œæ‰¹å¤„ç†ï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„ã€‚</p>
<p>ç­”ï¼šä½¿ç”¨ <code>BatchExecutor</code> å®Œæˆæ‰¹å¤„ç†ã€‚</p>
<h3 id="MyBatis-éƒ½æœ‰å“ªäº›-Executor-æ‰§è¡Œå™¨ï¼Ÿå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#MyBatis-éƒ½æœ‰å“ªäº›-Executor-æ‰§è¡Œå™¨ï¼Ÿå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="MyBatis éƒ½æœ‰å“ªäº› Executor æ‰§è¡Œå™¨ï¼Ÿå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"></a>MyBatis éƒ½æœ‰å“ªäº› Executor æ‰§è¡Œå™¨ï¼Ÿå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„</p>
<p>ç­”ï¼šMyBatis æœ‰ä¸‰ç§åŸºæœ¬çš„ <code>Executor</code> æ‰§è¡Œå™¨ï¼š</p>
<ul>
<li><strong><code>SimpleExecutor</code>ï¼š</strong> æ¯æ‰§è¡Œä¸€æ¬¡ update æˆ– selectï¼Œå°±å¼€å¯ä¸€ä¸ª Statement å¯¹è±¡ï¼Œç”¨å®Œç«‹åˆ»å…³é—­ Statement å¯¹è±¡ã€‚</li>
<li><strong><code>ReuseExecutor</code>ï¼š</strong> æ‰§è¡Œ update æˆ– selectï¼Œä»¥ sql ä½œä¸º key æŸ¥æ‰¾ Statement å¯¹è±¡ï¼Œå­˜åœ¨å°±ä½¿ç”¨ï¼Œä¸å­˜åœ¨å°±åˆ›å»ºï¼Œç”¨å®Œåï¼Œä¸å…³é—­ Statement å¯¹è±¡ï¼Œè€Œæ˜¯æ”¾ç½®äº Map&lt;String, Statement&gt;å†…ï¼Œä¾›ä¸‹ä¸€æ¬¡ä½¿ç”¨ã€‚ç®€è¨€ä¹‹ï¼Œå°±æ˜¯é‡å¤ä½¿ç”¨ Statement å¯¹è±¡ã€‚</li>
<li>**<code>BatchExecutor</code>**ï¼šæ‰§è¡Œ updateï¼ˆæ²¡æœ‰ selectï¼ŒJDBC æ‰¹å¤„ç†ä¸æ”¯æŒ selectï¼‰ï¼Œå°†æ‰€æœ‰ sql éƒ½æ·»åŠ åˆ°æ‰¹å¤„ç†ä¸­ï¼ˆaddBatch()ï¼‰ï¼Œç­‰å¾…ç»Ÿä¸€æ‰§è¡Œï¼ˆexecuteBatch()ï¼‰ï¼Œå®ƒç¼“å­˜äº†å¤šä¸ª Statement å¯¹è±¡ï¼Œæ¯ä¸ª Statement å¯¹è±¡éƒ½æ˜¯ addBatch()å®Œæ¯•åï¼Œç­‰å¾…é€ä¸€æ‰§è¡Œ executeBatch()æ‰¹å¤„ç†ã€‚ä¸ JDBC æ‰¹å¤„ç†ç›¸åŒã€‚</li>
</ul>
<p>ä½œç”¨èŒƒå›´ï¼š<code>Executor</code> çš„è¿™äº›ç‰¹ç‚¹ï¼Œéƒ½ä¸¥æ ¼é™åˆ¶åœ¨ SqlSession ç”Ÿå‘½å‘¨æœŸèŒƒå›´å†…ã€‚</p>
<h3 id="MyBatis-ä¸­å¦‚ä½•æŒ‡å®šä½¿ç”¨å“ªä¸€ç§-Executor-æ‰§è¡Œå™¨ï¼Ÿ"><a href="#MyBatis-ä¸­å¦‚ä½•æŒ‡å®šä½¿ç”¨å“ªä¸€ç§-Executor-æ‰§è¡Œå™¨ï¼Ÿ" class="headerlink" title="MyBatis ä¸­å¦‚ä½•æŒ‡å®šä½¿ç”¨å“ªä¸€ç§ Executor æ‰§è¡Œå™¨ï¼Ÿ"></a>MyBatis ä¸­å¦‚ä½•æŒ‡å®šä½¿ç”¨å“ªä¸€ç§ Executor æ‰§è¡Œå™¨ï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„</p>
<p>ç­”ï¼šåœ¨ MyBatis é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥æŒ‡å®šé»˜è®¤çš„ <code>ExecutorType</code> æ‰§è¡Œå™¨ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨ç»™ <code>DefaultSqlSessionFactory</code> çš„åˆ›å»º SqlSession çš„æ–¹æ³•ä¼ é€’ <code>ExecutorType</code> ç±»å‹å‚æ•°ã€‚</p>
<h3 id="MyBatis-æ˜¯å¦å¯ä»¥æ˜ å°„-Enum-æšä¸¾ç±»ï¼Ÿ"><a href="#MyBatis-æ˜¯å¦å¯ä»¥æ˜ å°„-Enum-æšä¸¾ç±»ï¼Ÿ" class="headerlink" title="MyBatis æ˜¯å¦å¯ä»¥æ˜ å°„ Enum æšä¸¾ç±»ï¼Ÿ"></a>MyBatis æ˜¯å¦å¯ä»¥æ˜ å°„ Enum æšä¸¾ç±»ï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„</p>
<p>ç­”ï¼šMyBatis å¯ä»¥æ˜ å°„æšä¸¾ç±»ï¼Œä¸å•å¯ä»¥æ˜ å°„æšä¸¾ç±»ï¼ŒMyBatis å¯ä»¥æ˜ å°„ä»»ä½•å¯¹è±¡åˆ°è¡¨çš„ä¸€åˆ—ä¸Šã€‚æ˜ å°„æ–¹å¼ä¸ºè‡ªå®šä¹‰ä¸€ä¸ª <code>TypeHandler</code> ï¼Œå®ç° <code>TypeHandler</code> çš„ <code>setParameter()</code> å’Œ <code>getResult()</code> æ¥å£æ–¹æ³•ã€‚ <code>TypeHandler</code> æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p>
<ul>
<li>ä¸€æ˜¯å®Œæˆä» javaType è‡³ jdbcType çš„è½¬æ¢ï¼›</li>
<li>äºŒæ˜¯å®Œæˆ jdbcType è‡³ javaType çš„è½¬æ¢ï¼Œä½“ç°ä¸º <code>setParameter()</code> å’Œ <code>getResult()</code> ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ä»£è¡¨è®¾ç½® sql é—®å·å ä½ç¬¦å‚æ•°å’Œè·å–åˆ—æŸ¥è¯¢ç»“æœã€‚</li>
</ul>
<h3 id="MyBatis-æ˜ å°„æ–‡ä»¶ä¸­ï¼Œå¦‚æœ-A-æ ‡ç­¾é€šè¿‡-include-å¼•ç”¨äº†-B-æ ‡ç­¾çš„å†…å®¹ï¼Œè¯·é—®ï¼ŒB-æ ‡ç­¾èƒ½å¦å®šä¹‰åœ¨-A-æ ‡ç­¾çš„åé¢ï¼Œè¿˜æ˜¯è¯´å¿…é¡»å®šä¹‰åœ¨-A-æ ‡ç­¾çš„å‰é¢ï¼Ÿ"><a href="#MyBatis-æ˜ å°„æ–‡ä»¶ä¸­ï¼Œå¦‚æœ-A-æ ‡ç­¾é€šè¿‡-include-å¼•ç”¨äº†-B-æ ‡ç­¾çš„å†…å®¹ï¼Œè¯·é—®ï¼ŒB-æ ‡ç­¾èƒ½å¦å®šä¹‰åœ¨-A-æ ‡ç­¾çš„åé¢ï¼Œè¿˜æ˜¯è¯´å¿…é¡»å®šä¹‰åœ¨-A-æ ‡ç­¾çš„å‰é¢ï¼Ÿ" class="headerlink" title="MyBatis æ˜ å°„æ–‡ä»¶ä¸­ï¼Œå¦‚æœ A æ ‡ç­¾é€šè¿‡ include å¼•ç”¨äº† B æ ‡ç­¾çš„å†…å®¹ï¼Œè¯·é—®ï¼ŒB æ ‡ç­¾èƒ½å¦å®šä¹‰åœ¨ A æ ‡ç­¾çš„åé¢ï¼Œè¿˜æ˜¯è¯´å¿…é¡»å®šä¹‰åœ¨ A æ ‡ç­¾çš„å‰é¢ï¼Ÿ"></a>MyBatis æ˜ å°„æ–‡ä»¶ä¸­ï¼Œå¦‚æœ A æ ‡ç­¾é€šè¿‡ include å¼•ç”¨äº† B æ ‡ç­¾çš„å†…å®¹ï¼Œè¯·é—®ï¼ŒB æ ‡ç­¾èƒ½å¦å®šä¹‰åœ¨ A æ ‡ç­¾çš„åé¢ï¼Œè¿˜æ˜¯è¯´å¿…é¡»å®šä¹‰åœ¨ A æ ‡ç­¾çš„å‰é¢ï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„</p>
<p>ç­”ï¼šè™½ç„¶ MyBatis è§£æ xml æ˜ å°„æ–‡ä»¶æ˜¯æŒ‰ç…§é¡ºåºè§£æçš„ï¼Œä½†æ˜¯ï¼Œè¢«å¼•ç”¨çš„ B æ ‡ç­¾ä¾ç„¶å¯ä»¥å®šä¹‰åœ¨ä»»ä½•åœ°æ–¹ï¼ŒMyBatis éƒ½å¯ä»¥æ­£ç¡®è¯†åˆ«ã€‚</p>
<p>åŸç†æ˜¯ï¼ŒMyBatis è§£æ A æ ‡ç­¾ï¼Œå‘ç° A æ ‡ç­¾å¼•ç”¨äº† B æ ‡ç­¾ï¼Œä½†æ˜¯ B æ ‡ç­¾å°šæœªè§£æåˆ°ï¼Œå°šä¸å­˜åœ¨ï¼Œæ­¤æ—¶ï¼ŒMyBatis ä¼šå°† A æ ‡ç­¾æ ‡è®°ä¸ºæœªè§£æçŠ¶æ€ï¼Œç„¶åç»§ç»­è§£æä½™ä¸‹çš„æ ‡ç­¾ï¼ŒåŒ…å« B æ ‡ç­¾ï¼Œå¾…æ‰€æœ‰æ ‡ç­¾è§£æå®Œæ¯•ï¼ŒMyBatis ä¼šé‡æ–°è§£æé‚£äº›è¢«æ ‡è®°ä¸ºæœªè§£æçš„æ ‡ç­¾ï¼Œæ­¤æ—¶å†è§£æ A æ ‡ç­¾æ—¶ï¼ŒB æ ‡ç­¾å·²ç»å­˜åœ¨ï¼ŒA æ ‡ç­¾ä¹Ÿå°±å¯ä»¥æ­£å¸¸è§£æå®Œæˆäº†ã€‚</p>
<h3 id="ç®€è¿°-MyBatis-çš„-xml-æ˜ å°„æ–‡ä»¶å’Œ-MyBatis-å†…éƒ¨æ•°æ®ç»“æ„ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Ÿ"><a href="#ç®€è¿°-MyBatis-çš„-xml-æ˜ å°„æ–‡ä»¶å’Œ-MyBatis-å†…éƒ¨æ•°æ®ç»“æ„ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Ÿ" class="headerlink" title="ç®€è¿° MyBatis çš„ xml æ˜ å°„æ–‡ä»¶å’Œ MyBatis å†…éƒ¨æ•°æ®ç»“æ„ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Ÿ"></a>ç®€è¿° MyBatis çš„ xml æ˜ å°„æ–‡ä»¶å’Œ MyBatis å†…éƒ¨æ•°æ®ç»“æ„ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„</p>
<p>ç­”ï¼šMyBatis å°†æ‰€æœ‰ xml é…ç½®ä¿¡æ¯éƒ½å°è£…åˆ° All-In-One é‡é‡çº§å¯¹è±¡ Configuration å†…éƒ¨ã€‚åœ¨ xml æ˜ å°„æ–‡ä»¶ä¸­ï¼Œ <code>&lt;parameterMap&gt;</code> æ ‡ç­¾ä¼šè¢«è§£æä¸º <code>ParameterMap</code> å¯¹è±¡ï¼Œå…¶æ¯ä¸ªå­å…ƒç´ ä¼šè¢«è§£æä¸º ParameterMapping å¯¹è±¡ã€‚ <code>&lt;resultMap&gt;</code> æ ‡ç­¾ä¼šè¢«è§£æä¸º <code>ResultMap</code> å¯¹è±¡ï¼Œå…¶æ¯ä¸ªå­å…ƒç´ ä¼šè¢«è§£æä¸º <code>ResultMapping</code> å¯¹è±¡ã€‚æ¯ä¸€ä¸ª <code>&lt;select&gt;ã€&lt;insert&gt;ã€&lt;update&gt;ã€&lt;delete&gt;</code> æ ‡ç­¾å‡ä¼šè¢«è§£æä¸º <code>MappedStatement</code> å¯¹è±¡ï¼Œæ ‡ç­¾å†…çš„ sql ä¼šè¢«è§£æä¸º BoundSql å¯¹è±¡ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆè¯´-MyBatis-æ˜¯åŠè‡ªåŠ¨-ORM-æ˜ å°„å·¥å…·ï¼Ÿå®ƒä¸å…¨è‡ªåŠ¨çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¯´-MyBatis-æ˜¯åŠè‡ªåŠ¨-ORM-æ˜ å°„å·¥å…·ï¼Ÿå®ƒä¸å…¨è‡ªåŠ¨çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¯´ MyBatis æ˜¯åŠè‡ªåŠ¨ ORM æ˜ å°„å·¥å…·ï¼Ÿå®ƒä¸å…¨è‡ªåŠ¨çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¯´ MyBatis æ˜¯åŠè‡ªåŠ¨ ORM æ˜ å°„å·¥å…·ï¼Ÿå®ƒä¸å…¨è‡ªåŠ¨çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿ</h3><p>æ³¨ï¼šæˆ‘å‡ºçš„</p>
<p>ç­”ï¼šHibernate å±äºå…¨è‡ªåŠ¨ ORM æ˜ å°„å·¥å…·ï¼Œä½¿ç”¨ Hibernate æŸ¥è¯¢å…³è”å¯¹è±¡æˆ–è€…å…³è”é›†åˆå¯¹è±¡æ—¶ï¼Œå¯ä»¥æ ¹æ®å¯¹è±¡å…³ç³»æ¨¡å‹ç›´æ¥è·å–ï¼Œæ‰€ä»¥å®ƒæ˜¯å…¨è‡ªåŠ¨çš„ã€‚è€Œ MyBatis åœ¨æŸ¥è¯¢å…³è”å¯¹è±¡æˆ–å…³è”é›†åˆå¯¹è±¡æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨ç¼–å†™ sql æ¥å®Œæˆï¼Œæ‰€ä»¥ï¼Œç§°ä¹‹ä¸ºåŠè‡ªåŠ¨ ORM æ˜ å°„å·¥å…·ã€‚</p>
<p>é¢è¯•é¢˜çœ‹ä¼¼éƒ½å¾ˆç®€å•ï¼Œä½†æ˜¯æƒ³è¦èƒ½æ­£ç¡®å›ç­”ä¸Šæ¥ï¼Œå¿…å®šæ˜¯ç ”ç©¶è¿‡æºç ä¸”æ·±å…¥çš„äººï¼Œè€Œä¸æ˜¯ä»…ä¼šä½¿ç”¨çš„äººæˆ–è€…ç”¨çš„å¾ˆç†Ÿçš„äººï¼Œä»¥ä¸Šæ‰€æœ‰é¢è¯•é¢˜åŠå…¶ç­”æ¡ˆæ‰€æ¶‰åŠçš„å†…å®¹ï¼Œåœ¨æˆ‘çš„ MyBatis ç³»åˆ—åšå®¢ä¸­éƒ½æœ‰è¯¦ç»†è®²è§£å’ŒåŸç†åˆ†æã€‚</p>
<!-- @include: @article-footer.snippet.md -->

<h3 id="æ–‡ç« æ¨è"><a href="#æ–‡ç« æ¨è" class="headerlink" title="æ–‡ç« æ¨è"></a>æ–‡ç« æ¨è</h3><ul>
<li><a href="https://juejin.cn/post/7273516671574687759">2W å­—å…¨é¢å‰–æ Mybatis ä¸­çš„ 9 ç§è®¾è®¡æ¨¡å¼</a></li>
<li><a href="https://mp.weixin.qq.com/s/WUEAdFDwZsZ4EKO8ix0ijg">ä»é›¶å¼€å§‹å®ç°ä¸€ä¸ª MyBatis åŠ è§£å¯†æ’ä»¶</a></li>
<li><a href="https://juejin.cn/post/7051910683264286750">MyBatis æœ€å…¨ä½¿ç”¨æŒ‡å—</a></li>
<li><a href="https://juejin.cn/post/7269390456530190376">è„‘æ´æ‰“å¼€ï¼ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™æ ·ä½¿ç”¨ MyBatis çš„ï¼Œçœ‹å¾—æˆ‘ä¸€æ„£ä¸€æ„£çš„ã€‚</a></li>
<li><a href="https://juejin.cn/post/7264921613551730722">MyBatis å±…ç„¶ä¹Ÿæœ‰å¹¶å‘é—®é¢˜</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/03/05/io-basis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/03/05/io-basis/" itemprop="url">Java IO åŸºç¡€çŸ¥è¯†æ€»ç»“</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2022-03-05T23:09:48+08:00">
                2022-03-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ï¼Œ 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/io/" itemprop="url" rel="index">
                    <span itemprop="name">io</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2022/03/05/io-basis/" class="leancloud_visitors" data-flag-title="Java IO åŸºç¡€çŸ¥è¯†æ€»ç»“">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  5k å­—
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  20 åˆ†é’Ÿ
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <!-- @include: @small-advertisement.snippet.md -->

<h2 id="IO-æµç®€ä»‹"><a href="#IO-æµç®€ä»‹" class="headerlink" title="IO æµç®€ä»‹"></a>IO æµç®€ä»‹</h2><p>IO å³ <code>Input/Output</code>ï¼Œè¾“å…¥å’Œè¾“å‡ºã€‚æ•°æ®è¾“å…¥åˆ°è®¡ç®—æœºå†…å­˜çš„è¿‡ç¨‹å³è¾“å…¥ï¼Œåä¹‹è¾“å‡ºåˆ°å¤–éƒ¨å­˜å‚¨ï¼ˆæ¯”å¦‚æ•°æ®åº“ï¼Œæ–‡ä»¶ï¼Œè¿œç¨‹ä¸»æœºï¼‰çš„è¿‡ç¨‹å³è¾“å‡ºã€‚æ•°æ®ä¼ è¾“è¿‡ç¨‹ç±»ä¼¼äºæ°´æµï¼Œå› æ­¤ç§°ä¸º IO æµã€‚IO æµåœ¨ Java ä¸­åˆ†ä¸ºè¾“å…¥æµå’Œè¾“å‡ºæµï¼Œè€Œæ ¹æ®æ•°æ®çš„å¤„ç†æ–¹å¼åˆåˆ†ä¸ºå­—èŠ‚æµå’Œå­—ç¬¦æµã€‚</p>
<p>Java IO æµçš„ 40 å¤šä¸ªç±»éƒ½æ˜¯ä»å¦‚ä¸‹ 4 ä¸ªæŠ½è±¡ç±»åŸºç±»ä¸­æ´¾ç”Ÿå‡ºæ¥çš„ã€‚</p>
<ul>
<li><code>InputStream</code>&#x2F;<code>Reader</code>: æ‰€æœ‰çš„è¾“å…¥æµçš„åŸºç±»ï¼Œå‰è€…æ˜¯å­—èŠ‚è¾“å…¥æµï¼Œåè€…æ˜¯å­—ç¬¦è¾“å…¥æµã€‚</li>
<li><code>OutputStream</code>&#x2F;<code>Writer</code>: æ‰€æœ‰è¾“å‡ºæµçš„åŸºç±»ï¼Œå‰è€…æ˜¯å­—èŠ‚è¾“å‡ºæµï¼Œåè€…æ˜¯å­—ç¬¦è¾“å‡ºæµã€‚</li>
</ul>
<h2 id="å­—èŠ‚æµ"><a href="#å­—èŠ‚æµ" class="headerlink" title="å­—èŠ‚æµ"></a>å­—èŠ‚æµ</h2><h3 id="InputStreamï¼ˆå­—èŠ‚è¾“å…¥æµï¼‰"><a href="#InputStreamï¼ˆå­—èŠ‚è¾“å…¥æµï¼‰" class="headerlink" title="InputStreamï¼ˆå­—èŠ‚è¾“å…¥æµï¼‰"></a>InputStreamï¼ˆå­—èŠ‚è¾“å…¥æµï¼‰</h3><p><code>InputStream</code>ç”¨äºä»æºå¤´ï¼ˆé€šå¸¸æ˜¯æ–‡ä»¶ï¼‰è¯»å–æ•°æ®ï¼ˆå­—èŠ‚ä¿¡æ¯ï¼‰åˆ°å†…å­˜ä¸­ï¼Œ<code>java.io.InputStream</code>æŠ½è±¡ç±»æ˜¯æ‰€æœ‰å­—èŠ‚è¾“å…¥æµçš„çˆ¶ç±»ã€‚</p>
<p><code>InputStream</code> å¸¸ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><code>read()</code>ï¼šè¿”å›è¾“å…¥æµä¸­ä¸‹ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚è¿”å›çš„å€¼ä»‹äº 0 åˆ° 255 ä¹‹é—´ã€‚å¦‚æœæœªè¯»å–ä»»ä½•å­—èŠ‚ï¼Œåˆ™ä»£ç è¿”å› <code>-1</code> ï¼Œè¡¨ç¤ºæ–‡ä»¶ç»“æŸã€‚</li>
<li><code>read(byte b[ ])</code> : ä»è¾“å…¥æµä¸­è¯»å–ä¸€äº›å­—èŠ‚å­˜å‚¨åˆ°æ•°ç»„ <code>b</code> ä¸­ã€‚å¦‚æœæ•°ç»„ <code>b</code> çš„é•¿åº¦ä¸ºé›¶ï¼Œåˆ™ä¸è¯»å–ã€‚å¦‚æœæ²¡æœ‰å¯ç”¨å­—èŠ‚è¯»å–ï¼Œè¿”å› <code>-1</code>ã€‚å¦‚æœæœ‰å¯ç”¨å­—èŠ‚è¯»å–ï¼Œåˆ™æœ€å¤šè¯»å–çš„å­—èŠ‚æ•°æœ€å¤šç­‰äº <code>b.length</code> ï¼Œ è¿”å›è¯»å–çš„å­—èŠ‚æ•°ã€‚è¿™ä¸ªæ–¹æ³•ç­‰ä»·äº <code>read(b, 0, b.length)</code>ã€‚</li>
<li><code>read(byte b[], int off, int len)</code>ï¼šåœ¨<code>read(byte b[ ])</code> æ–¹æ³•çš„åŸºç¡€ä¸Šå¢åŠ äº† <code>off</code> å‚æ•°ï¼ˆåç§»é‡ï¼‰å’Œ <code>len</code> å‚æ•°ï¼ˆè¦è¯»å–çš„æœ€å¤§å­—èŠ‚æ•°ï¼‰ã€‚</li>
<li><code>skip(long n)</code>ï¼šå¿½ç•¥è¾“å…¥æµä¸­çš„ n ä¸ªå­—èŠ‚ ,è¿”å›å®é™…å¿½ç•¥çš„å­—èŠ‚æ•°ã€‚</li>
<li><code>available()</code>ï¼šè¿”å›è¾“å…¥æµä¸­å¯ä»¥è¯»å–çš„å­—èŠ‚æ•°ã€‚</li>
<li><code>close()</code>ï¼šå…³é—­è¾“å…¥æµé‡Šæ”¾ç›¸å…³çš„ç³»ç»Ÿèµ„æºã€‚</li>
</ul>
<p>ä» Java 9 å¼€å§‹ï¼Œ<code>InputStream</code> æ–°å¢åŠ äº†å¤šä¸ªå®ç”¨çš„æ–¹æ³•ï¼š</p>
<ul>
<li><code>readAllBytes()</code>ï¼šè¯»å–è¾“å…¥æµä¸­çš„æ‰€æœ‰å­—èŠ‚ï¼Œè¿”å›å­—èŠ‚æ•°ç»„ã€‚</li>
<li><code>readNBytes(byte[] b, int off, int len)</code>ï¼šé˜»å¡ç›´åˆ°è¯»å– <code>len</code> ä¸ªå­—èŠ‚ã€‚</li>
<li><code>transferTo(OutputStream out)</code>ï¼šå°†æ‰€æœ‰å­—èŠ‚ä»ä¸€ä¸ªè¾“å…¥æµä¼ é€’åˆ°ä¸€ä¸ªè¾“å‡ºæµã€‚</li>
</ul>
<p><code>FileInputStream</code> æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„å­—èŠ‚è¾“å…¥æµå¯¹è±¡ï¼Œå¯ç›´æ¥æŒ‡å®šæ–‡ä»¶è·¯å¾„ï¼Œå¯ä»¥ç›´æ¥è¯»å–å•å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå¯ä»¥è¯»å–è‡³å­—èŠ‚æ•°ç»„ä¸­ã€‚</p>
<p><code>FileInputStream</code> ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;input.txt&quot;</span>)) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Number of remaining bytes:&quot;</span></span><br><span class="line">            + fis.available());</span><br><span class="line">    <span class="type">int</span> content;</span><br><span class="line">    <span class="type">long</span> <span class="variable">skip</span> <span class="operator">=</span> fis.skip(<span class="number">2</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;The actual number of bytes skipped:&quot;</span> + skip);</span><br><span class="line">    System.out.print(<span class="string">&quot;The content read from file:&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> ((content = fis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">        System.out.print((<span class="type">char</span>) content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>input.txt</code> æ–‡ä»¶å†…å®¹ï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/image-20220419155214614.png"></p>
<p>è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Number of remaining bytes:11</span><br><span class="line">The actual number of bytes skipped:2</span><br><span class="line">The content read from file:JavaGuide</span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡ï¼Œä¸€èˆ¬æˆ‘ä»¬æ˜¯ä¸ä¼šç›´æ¥å•ç‹¬ä½¿ç”¨ <code>FileInputStream</code> ï¼Œé€šå¸¸ä¼šé…åˆ <code>BufferedInputStream</code>ï¼ˆå­—èŠ‚ç¼“å†²è¾“å…¥æµï¼Œåæ–‡ä¼šè®²åˆ°ï¼‰æ¥ä½¿ç”¨ã€‚</p>
<p>åƒä¸‹é¢è¿™æ®µä»£ç åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­å°±æ¯”è¾ƒå¸¸è§ï¼Œæˆ‘ä»¬é€šè¿‡ <code>readAllBytes()</code> è¯»å–è¾“å…¥æµæ‰€æœ‰å­—èŠ‚å¹¶å°†å…¶ç›´æ¥èµ‹å€¼ç»™ä¸€ä¸ª <code>String</code> å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–°å»ºä¸€ä¸ª BufferedInputStream å¯¹è±¡</span></span><br><span class="line"><span class="type">BufferedInputStream</span> <span class="variable">bufferedInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;input.txt&quot;</span>));</span><br><span class="line"><span class="comment">// è¯»å–æ–‡ä»¶çš„å†…å®¹å¹¶å¤åˆ¶åˆ° String å¯¹è±¡ä¸­</span></span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bufferedInputStream.readAllBytes());</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure>

<p><code>DataInputStream</code> ç”¨äºè¯»å–æŒ‡å®šç±»å‹æ•°æ®ï¼Œä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œå¿…é¡»ç»“åˆå…¶å®ƒæµï¼Œæ¯”å¦‚ <code>FileInputStream</code> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;input.txt&quot;</span>);</span><br><span class="line"><span class="comment">//å¿…é¡»å°†fileInputStreamä½œä¸ºæ„é€ å‚æ•°æ‰èƒ½ä½¿ç”¨</span></span><br><span class="line"><span class="type">DataInputStream</span> <span class="variable">dataInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(fileInputStream);</span><br><span class="line"><span class="comment">//å¯ä»¥è¯»å–ä»»æ„å…·ä½“çš„ç±»å‹æ•°æ®</span></span><br><span class="line">dataInputStream.readBoolean();</span><br><span class="line">dataInputStream.readInt();</span><br><span class="line">dataInputStream.readUTF();</span><br></pre></td></tr></table></figure>

<p><code>ObjectInputStream</code> ç”¨äºä»è¾“å…¥æµä¸­è¯»å– Java å¯¹è±¡ï¼ˆååºåˆ—åŒ–ï¼‰ï¼Œ<code>ObjectOutputStream</code> ç”¨äºå°†å¯¹è±¡å†™å…¥åˆ°è¾“å‡ºæµ(åºåˆ—åŒ–)ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.data&quot;</span>));</span><br><span class="line"><span class="type">MyClass</span> <span class="variable">object</span> <span class="operator">=</span> (MyClass) input.readObject();</span><br><span class="line">input.close();</span><br></pre></td></tr></table></figure>

<p>å¦å¤–ï¼Œç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ç±»å¿…é¡»å®ç° <code>Serializable</code> æ¥å£ï¼Œå¯¹è±¡ä¸­å¦‚æœæœ‰å±æ€§ä¸æƒ³è¢«åºåˆ—åŒ–ï¼Œä½¿ç”¨ <code>transient</code> ä¿®é¥°ã€‚</p>
<h3 id="OutputStreamï¼ˆå­—èŠ‚è¾“å‡ºæµï¼‰"><a href="#OutputStreamï¼ˆå­—èŠ‚è¾“å‡ºæµï¼‰" class="headerlink" title="OutputStreamï¼ˆå­—èŠ‚è¾“å‡ºæµï¼‰"></a>OutputStreamï¼ˆå­—èŠ‚è¾“å‡ºæµï¼‰</h3><p><code>OutputStream</code>ç”¨äºå°†æ•°æ®ï¼ˆå­—èŠ‚ä¿¡æ¯ï¼‰å†™å…¥åˆ°ç›®çš„åœ°ï¼ˆé€šå¸¸æ˜¯æ–‡ä»¶ï¼‰ï¼Œ<code>java.io.OutputStream</code>æŠ½è±¡ç±»æ˜¯æ‰€æœ‰å­—èŠ‚è¾“å‡ºæµçš„çˆ¶ç±»ã€‚</p>
<p><code>OutputStream</code> å¸¸ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><code>write(int b)</code>ï¼šå°†ç‰¹å®šå­—èŠ‚å†™å…¥è¾“å‡ºæµã€‚</li>
<li><code>write(byte b[ ])</code> : å°†æ•°ç»„<code>b</code> å†™å…¥åˆ°è¾“å‡ºæµï¼Œç­‰ä»·äº <code>write(b, 0, b.length)</code> ã€‚</li>
<li><code>write(byte[] b, int off, int len)</code> : åœ¨<code>write(byte b[ ])</code> æ–¹æ³•çš„åŸºç¡€ä¸Šå¢åŠ äº† <code>off</code> å‚æ•°ï¼ˆåç§»é‡ï¼‰å’Œ <code>len</code> å‚æ•°ï¼ˆè¦è¯»å–çš„æœ€å¤§å­—èŠ‚æ•°ï¼‰ã€‚</li>
<li><code>flush()</code>ï¼šåˆ·æ–°æ­¤è¾“å‡ºæµå¹¶å¼ºåˆ¶å†™å‡ºæ‰€æœ‰ç¼“å†²çš„è¾“å‡ºå­—èŠ‚ã€‚</li>
<li><code>close()</code>ï¼šå…³é—­è¾“å‡ºæµé‡Šæ”¾ç›¸å…³çš„ç³»ç»Ÿèµ„æºã€‚</li>
</ul>
<p><code>FileOutputStream</code> æ˜¯æœ€å¸¸ç”¨çš„å­—èŠ‚è¾“å‡ºæµå¯¹è±¡ï¼Œå¯ç›´æ¥æŒ‡å®šæ–‡ä»¶è·¯å¾„ï¼Œå¯ä»¥ç›´æ¥è¾“å‡ºå•å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå¯ä»¥è¾“å‡ºæŒ‡å®šçš„å­—èŠ‚æ•°ç»„ã€‚</p>
<p><code>FileOutputStream</code> ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">FileOutputStream</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;output.txt&quot;</span>)) &#123;</span><br><span class="line">    <span class="type">byte</span>[] array = <span class="string">&quot;JavaGuide&quot;</span>.getBytes();</span><br><span class="line">    output.write(array);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/image-20220419155514392.png"></p>
<p>ç±»ä¼¼äº <code>FileInputStream</code>ï¼Œ<code>FileOutputStream</code> é€šå¸¸ä¹Ÿä¼šé…åˆ <code>BufferedOutputStream</code>ï¼ˆå­—èŠ‚ç¼“å†²è¾“å‡ºæµï¼Œåæ–‡ä¼šè®²åˆ°ï¼‰æ¥ä½¿ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;output.txt&quot;</span>);</span><br><span class="line"><span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(fileOutputStream)</span><br></pre></td></tr></table></figure>

<p><strong><code>DataOutputStream</code></strong> ç”¨äºå†™å…¥æŒ‡å®šç±»å‹æ•°æ®ï¼Œä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œå¿…é¡»ç»“åˆå…¶å®ƒæµï¼Œæ¯”å¦‚ <code>FileOutputStream</code> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¾“å‡ºæµ</span></span><br><span class="line"><span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;out.txt&quot;</span>);</span><br><span class="line"><span class="type">DataOutputStream</span> <span class="variable">dataOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(fileOutputStream);</span><br><span class="line"><span class="comment">// è¾“å‡ºä»»æ„æ•°æ®ç±»å‹</span></span><br><span class="line">dataOutputStream.writeBoolean(<span class="literal">true</span>);</span><br><span class="line">dataOutputStream.writeByte(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p><code>ObjectInputStream</code> ç”¨äºä»è¾“å…¥æµä¸­è¯»å– Java å¯¹è±¡ï¼ˆ<code>ObjectInputStream</code>,ååºåˆ—åŒ–ï¼‰ï¼Œ<code>ObjectOutputStream</code>å°†å¯¹è±¡å†™å…¥åˆ°è¾“å‡ºæµ(<code>ObjectOutputStream</code>ï¼Œåºåˆ—åŒ–)ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;file.txt&quot;</span>)</span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Guideå“¥&quot;</span>, <span class="string">&quot;JavaGuideä½œè€…&quot;</span>);</span><br><span class="line">output.writeObject(person);</span><br></pre></td></tr></table></figure>

<h2 id="å­—ç¬¦æµ"><a href="#å­—ç¬¦æµ" class="headerlink" title="å­—ç¬¦æµ"></a>å­—ç¬¦æµ</h2><p>ä¸ç®¡æ˜¯æ–‡ä»¶è¯»å†™è¿˜æ˜¯ç½‘ç»œå‘é€æ¥æ”¶ï¼Œä¿¡æ¯çš„æœ€å°å­˜å‚¨å•å…ƒéƒ½æ˜¯å­—èŠ‚ã€‚ <strong>é‚£ä¸ºä»€ä¹ˆ I&#x2F;O æµæ“ä½œè¦åˆ†ä¸ºå­—èŠ‚æµæ“ä½œå’Œå­—ç¬¦æµæ“ä½œå‘¢ï¼Ÿ</strong></p>
<p>ä¸ªäººè®¤ä¸ºä¸»è¦æœ‰ä¸¤ç‚¹åŸå› ï¼š</p>
<ul>
<li>å­—ç¬¦æµæ˜¯ç”± Java è™šæ‹Ÿæœºå°†å­—èŠ‚è½¬æ¢å¾—åˆ°çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹è¿˜ç®—æ˜¯æ¯”è¾ƒè€—æ—¶ã€‚</li>
<li>å¦‚æœæˆ‘ä»¬ä¸çŸ¥é“ç¼–ç ç±»å‹å°±å¾ˆå®¹æ˜“å‡ºç°ä¹±ç é—®é¢˜ã€‚</li>
</ul>
<p>ä¹±ç é—®é¢˜è¿™ä¸ªå¾ˆå®¹æ˜“å°±å¯ä»¥å¤ç°ï¼Œæˆ‘ä»¬åªéœ€è¦å°†ä¸Šé¢æåˆ°çš„ <code>FileInputStream</code> ä»£ç ç¤ºä¾‹ä¸­çš„ <code>input.txt</code> æ–‡ä»¶å†…å®¹æ”¹ä¸ºä¸­æ–‡å³å¯ï¼ŒåŸä»£ç ä¸éœ€è¦æ”¹åŠ¨ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/image-20220419154632551.png"></p>
<p>è¾“å‡ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Number of remaining bytes:<span class="number">9</span></span><br><span class="line">The actual number of bytes skipped:<span class="number">2</span></span><br><span class="line">The content read from file:Â§Ã¥Â®Â¶Ã¥Â¥Â½</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å¾ˆæ˜æ˜¾åœ°çœ‹åˆ°è¯»å–å‡ºæ¥çš„å†…å®¹å·²ç»å˜æˆäº†ä¹±ç ã€‚</p>
<p>å› æ­¤ï¼ŒI&#x2F;O æµå°±å¹²è„†æä¾›äº†ä¸€ä¸ªç›´æ¥æ“ä½œå­—ç¬¦çš„æ¥å£ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¹³æ—¶å¯¹å­—ç¬¦è¿›è¡Œæµæ“ä½œã€‚å¦‚æœéŸ³é¢‘æ–‡ä»¶ã€å›¾ç‰‡ç­‰åª’ä½“æ–‡ä»¶ç”¨å­—èŠ‚æµæ¯”è¾ƒå¥½ï¼Œå¦‚æœæ¶‰åŠåˆ°å­—ç¬¦çš„è¯ä½¿ç”¨å­—ç¬¦æµæ¯”è¾ƒå¥½ã€‚</p>
<p>å­—ç¬¦æµé»˜è®¤é‡‡ç”¨çš„æ˜¯ <code>Unicode</code> ç¼–ç ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•è‡ªå®šä¹‰ç¼–ç ã€‚</p>
<p>Unicode æœ¬èº«åªæ˜¯ä¸€ç§å­—ç¬¦é›†ï¼Œå®ƒä¸ºæ¯ä¸ªå­—ç¬¦åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„æ•°å­—ç¼–å·ï¼Œå¹¶æ²¡æœ‰è§„å®šå…·ä½“çš„å­˜å‚¨æ–¹å¼ã€‚UTF-8ã€UTF-16ã€UTF-32 éƒ½æ˜¯ Unicode çš„ç¼–ç æ–¹å¼ï¼Œå®ƒä»¬ä½¿ç”¨ä¸åŒçš„å­—èŠ‚æ•°æ¥è¡¨ç¤º Unicode å­—ç¬¦ã€‚ä¾‹å¦‚ï¼ŒUTF-8 :è‹±æ–‡å  1 å­—èŠ‚ï¼Œä¸­æ–‡å  3 å­—èŠ‚ã€‚</p>
<h3 id="Readerï¼ˆå­—ç¬¦è¾“å…¥æµï¼‰"><a href="#Readerï¼ˆå­—ç¬¦è¾“å…¥æµï¼‰" class="headerlink" title="Readerï¼ˆå­—ç¬¦è¾“å…¥æµï¼‰"></a>Readerï¼ˆå­—ç¬¦è¾“å…¥æµï¼‰</h3><p><code>Reader</code>ç”¨äºä»æºå¤´ï¼ˆé€šå¸¸æ˜¯æ–‡ä»¶ï¼‰è¯»å–æ•°æ®ï¼ˆå­—ç¬¦ä¿¡æ¯ï¼‰åˆ°å†…å­˜ä¸­ï¼Œ<code>java.io.Reader</code>æŠ½è±¡ç±»æ˜¯æ‰€æœ‰å­—ç¬¦è¾“å…¥æµçš„çˆ¶ç±»ã€‚</p>
<p><code>Reader</code> ç”¨äºè¯»å–æ–‡æœ¬ï¼Œ <code>InputStream</code> ç”¨äºè¯»å–åŸå§‹å­—èŠ‚ã€‚</p>
<p><code>Reader</code> å¸¸ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><code>read()</code> : ä»è¾“å…¥æµè¯»å–ä¸€ä¸ªå­—ç¬¦ã€‚</li>
<li><code>read(char[] cbuf)</code> : ä»è¾“å…¥æµä¸­è¯»å–ä¸€äº›å­—ç¬¦ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åˆ°å­—ç¬¦æ•°ç»„ <code>cbuf</code>ä¸­ï¼Œç­‰ä»·äº <code>read(cbuf, 0, cbuf.length)</code> ã€‚</li>
<li><code>read(char[] cbuf, int off, int len)</code>ï¼šåœ¨<code>read(char[] cbuf)</code> æ–¹æ³•çš„åŸºç¡€ä¸Šå¢åŠ äº† <code>off</code> å‚æ•°ï¼ˆåç§»é‡ï¼‰å’Œ <code>len</code> å‚æ•°ï¼ˆè¦è¯»å–çš„æœ€å¤§å­—ç¬¦æ•°ï¼‰ã€‚</li>
<li><code>skip(long n)</code>ï¼šå¿½ç•¥è¾“å…¥æµä¸­çš„ n ä¸ªå­—ç¬¦ ,è¿”å›å®é™…å¿½ç•¥çš„å­—ç¬¦æ•°ã€‚</li>
<li><code>close()</code> : å…³é—­è¾“å…¥æµå¹¶é‡Šæ”¾ç›¸å…³çš„ç³»ç»Ÿèµ„æºã€‚</li>
</ul>
<p><code>InputStreamReader</code> æ˜¯å­—èŠ‚æµè½¬æ¢ä¸ºå­—ç¬¦æµçš„æ¡¥æ¢ï¼Œå…¶å­ç±» <code>FileReader</code> æ˜¯åŸºäºè¯¥åŸºç¡€ä¸Šçš„å°è£…ï¼Œå¯ä»¥ç›´æ¥æ“ä½œå­—ç¬¦æ–‡ä»¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­—èŠ‚æµè½¬æ¢ä¸ºå­—ç¬¦æµçš„æ¡¥æ¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InputStreamReader</span> <span class="keyword">extends</span> <span class="title class_">Reader</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç”¨äºè¯»å–å­—ç¬¦æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileReader</span> <span class="keyword">extends</span> <span class="title class_">InputStreamReader</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>FileReader</code> ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">FileReader</span> <span class="variable">fileReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(<span class="string">&quot;input.txt&quot;</span>);) &#123;</span><br><span class="line">    <span class="type">int</span> content;</span><br><span class="line">    <span class="type">long</span> <span class="variable">skip</span> <span class="operator">=</span> fileReader.skip(<span class="number">3</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;The actual number of bytes skipped:&quot;</span> + skip);</span><br><span class="line">    System.out.print(<span class="string">&quot;The content read from file:&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> ((content = fileReader.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">        System.out.print((<span class="type">char</span>) content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>input.txt</code> æ–‡ä»¶å†…å®¹ï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/image-20220419154632551.png"></p>
<p>è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The actual number of bytes skipped:3</span><br><span class="line">The content read from file:æˆ‘æ˜¯Guideã€‚</span><br></pre></td></tr></table></figure>

<h3 id="Writerï¼ˆå­—ç¬¦è¾“å‡ºæµï¼‰"><a href="#Writerï¼ˆå­—ç¬¦è¾“å‡ºæµï¼‰" class="headerlink" title="Writerï¼ˆå­—ç¬¦è¾“å‡ºæµï¼‰"></a>Writerï¼ˆå­—ç¬¦è¾“å‡ºæµï¼‰</h3><p><code>Writer</code>ç”¨äºå°†æ•°æ®ï¼ˆå­—ç¬¦ä¿¡æ¯ï¼‰å†™å…¥åˆ°ç›®çš„åœ°ï¼ˆé€šå¸¸æ˜¯æ–‡ä»¶ï¼‰ï¼Œ<code>java.io.Writer</code>æŠ½è±¡ç±»æ˜¯æ‰€æœ‰å­—ç¬¦è¾“å‡ºæµçš„çˆ¶ç±»ã€‚</p>
<p><code>Writer</code> å¸¸ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><code>write(int c)</code> : å†™å…¥å•ä¸ªå­—ç¬¦ã€‚</li>
<li><code>write(char[] cbuf)</code>ï¼šå†™å…¥å­—ç¬¦æ•°ç»„ <code>cbuf</code>ï¼Œç­‰ä»·äº<code>write(cbuf, 0, cbuf.length)</code>ã€‚</li>
<li><code>write(char[] cbuf, int off, int len)</code>ï¼šåœ¨<code>write(char[] cbuf)</code> æ–¹æ³•çš„åŸºç¡€ä¸Šå¢åŠ äº† <code>off</code> å‚æ•°ï¼ˆåç§»é‡ï¼‰å’Œ <code>len</code> å‚æ•°ï¼ˆè¦è¯»å–çš„æœ€å¤§å­—ç¬¦æ•°ï¼‰ã€‚</li>
<li><code>write(String str)</code>ï¼šå†™å…¥å­—ç¬¦ä¸²ï¼Œç­‰ä»·äº <code>write(str, 0, str.length())</code> ã€‚</li>
<li><code>write(String str, int off, int len)</code>ï¼šåœ¨<code>write(String str)</code> æ–¹æ³•çš„åŸºç¡€ä¸Šå¢åŠ äº† <code>off</code> å‚æ•°ï¼ˆåç§»é‡ï¼‰å’Œ <code>len</code> å‚æ•°ï¼ˆè¦è¯»å–çš„æœ€å¤§å­—ç¬¦æ•°ï¼‰ã€‚</li>
<li><code>append(CharSequence csq)</code>ï¼šå°†æŒ‡å®šçš„å­—ç¬¦åºåˆ—é™„åŠ åˆ°æŒ‡å®šçš„ <code>Writer</code> å¯¹è±¡å¹¶è¿”å›è¯¥ <code>Writer</code> å¯¹è±¡ã€‚</li>
<li><code>append(char c)</code>ï¼šå°†æŒ‡å®šçš„å­—ç¬¦é™„åŠ åˆ°æŒ‡å®šçš„ <code>Writer</code> å¯¹è±¡å¹¶è¿”å›è¯¥ <code>Writer</code> å¯¹è±¡ã€‚</li>
<li><code>flush()</code>ï¼šåˆ·æ–°æ­¤è¾“å‡ºæµå¹¶å¼ºåˆ¶å†™å‡ºæ‰€æœ‰ç¼“å†²çš„è¾“å‡ºå­—ç¬¦ã€‚</li>
<li><code>close()</code>:å…³é—­è¾“å‡ºæµé‡Šæ”¾ç›¸å…³çš„ç³»ç»Ÿèµ„æºã€‚</li>
</ul>
<p><code>OutputStreamWriter</code> æ˜¯å­—ç¬¦æµè½¬æ¢ä¸ºå­—èŠ‚æµçš„æ¡¥æ¢ï¼Œå…¶å­ç±» <code>FileWriter</code> æ˜¯åŸºäºè¯¥åŸºç¡€ä¸Šçš„å°è£…ï¼Œå¯ä»¥ç›´æ¥å°†å­—ç¬¦å†™å…¥åˆ°æ–‡ä»¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­—ç¬¦æµè½¬æ¢ä¸ºå­—èŠ‚æµçš„æ¡¥æ¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OutputStreamWriter</span> <span class="keyword">extends</span> <span class="title class_">Writer</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç”¨äºå†™å…¥å­—ç¬¦åˆ°æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileWriter</span> <span class="keyword">extends</span> <span class="title class_">OutputStreamWriter</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>FileWriter</code> ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">Writer</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="string">&quot;output.txt&quot;</span>)) &#123;</span><br><span class="line">    output.write(<span class="string">&quot;ä½ å¥½ï¼Œæˆ‘æ˜¯Guideã€‚&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/image-20220419155802288.png"></p>
<h2 id="å­—èŠ‚ç¼“å†²æµ"><a href="#å­—èŠ‚ç¼“å†²æµ" class="headerlink" title="å­—èŠ‚ç¼“å†²æµ"></a>å­—èŠ‚ç¼“å†²æµ</h2><p>IO æ“ä½œæ˜¯å¾ˆæ¶ˆè€—æ€§èƒ½çš„ï¼Œç¼“å†²æµå°†æ•°æ®åŠ è½½è‡³ç¼“å†²åŒºï¼Œä¸€æ¬¡æ€§è¯»å–&#x2F;å†™å…¥å¤šä¸ªå­—èŠ‚ï¼Œä»è€Œé¿å…é¢‘ç¹çš„ IO æ“ä½œï¼Œæé«˜æµçš„ä¼ è¾“æ•ˆç‡ã€‚</p>
<p>å­—èŠ‚ç¼“å†²æµè¿™é‡Œé‡‡ç”¨äº†è£…é¥°å™¨æ¨¡å¼æ¥å¢å¼º <code>InputStream</code> å’Œ<code>OutputStream</code>å­ç±»å¯¹è±¡çš„åŠŸèƒ½ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>BufferedInputStream</code>ï¼ˆå­—èŠ‚ç¼“å†²è¾“å…¥æµï¼‰æ¥å¢å¼º <code>FileInputStream</code> çš„åŠŸèƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–°å»ºä¸€ä¸ª BufferedInputStream å¯¹è±¡</span></span><br><span class="line"><span class="type">BufferedInputStream</span> <span class="variable">bufferedInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;input.txt&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>å­—èŠ‚æµå’Œå­—èŠ‚ç¼“å†²æµçš„æ€§èƒ½å·®åˆ«ä¸»è¦ä½“ç°åœ¨æˆ‘ä»¬ä½¿ç”¨ä¸¤è€…çš„æ—¶å€™éƒ½æ˜¯è°ƒç”¨ <code>write(int b)</code> å’Œ <code>read()</code> è¿™ä¸¤ä¸ªä¸€æ¬¡åªè¯»å–ä¸€ä¸ªå­—èŠ‚çš„æ–¹æ³•çš„æ—¶å€™ã€‚ç”±äºå­—èŠ‚ç¼“å†²æµå†…éƒ¨æœ‰ç¼“å†²åŒºï¼ˆå­—èŠ‚æ•°ç»„ï¼‰ï¼Œå› æ­¤ï¼Œå­—èŠ‚ç¼“å†²æµä¼šå…ˆå°†è¯»å–åˆ°çš„å­—èŠ‚å­˜æ”¾åœ¨ç¼“å­˜åŒºï¼Œå¤§å¹…å‡å°‘ IO æ¬¡æ•°ï¼Œæé«˜è¯»å–æ•ˆç‡ã€‚</p>
<p>æˆ‘ä½¿ç”¨ <code>write(int b)</code> å’Œ <code>read()</code> æ–¹æ³•ï¼Œåˆ†åˆ«é€šè¿‡å­—èŠ‚æµå’Œå­—èŠ‚ç¼“å†²æµå¤åˆ¶ä¸€ä¸ª <code>524.9 mb</code> çš„ PDF æ–‡ä»¶è€—æ—¶å¯¹æ¯”å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨ç¼“å†²æµå¤åˆ¶PDFæ–‡ä»¶æ€»è€—æ—¶:15428 æ¯«ç§’</span><br><span class="line">ä½¿ç”¨æ™®é€šå­—èŠ‚æµå¤åˆ¶PDFæ–‡ä»¶æ€»è€—æ—¶:2555062 æ¯«ç§’</span><br></pre></td></tr></table></figure>

<p>ä¸¤è€…è€—æ—¶å·®åˆ«éå¸¸å¤§ï¼Œç¼“å†²æµè€—è´¹çš„æ—¶é—´æ˜¯å­—èŠ‚æµçš„ 1&#x2F;165ã€‚</p>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">copy_pdf_to_another_pdf_buffer_stream</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;æ·±å…¥ç†è§£è®¡ç®—æœºæ“ä½œç³»ç»Ÿ.pdf&quot;</span>));</span><br><span class="line">         <span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;æ·±å…¥ç†è§£è®¡ç®—æœºæ“ä½œç³»ç»Ÿ-å‰¯æœ¬.pdf&quot;</span>))) &#123;</span><br><span class="line">        <span class="type">int</span> content;</span><br><span class="line">        <span class="keyword">while</span> ((content = bis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            bos.write(content);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®°å½•ç»“æŸæ—¶é—´</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;ä½¿ç”¨ç¼“å†²æµå¤åˆ¶PDFæ–‡ä»¶æ€»è€—æ—¶:&quot;</span> + (end - start) + <span class="string">&quot; æ¯«ç§’&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">copy_pdf_to_another_pdf_stream</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;æ·±å…¥ç†è§£è®¡ç®—æœºæ“ä½œç³»ç»Ÿ.pdf&quot;</span>);</span><br><span class="line">         <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;æ·±å…¥ç†è§£è®¡ç®—æœºæ“ä½œç³»ç»Ÿ-å‰¯æœ¬.pdf&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">int</span> content;</span><br><span class="line">        <span class="keyword">while</span> ((content = fis.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">            fos.write(content);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®°å½•ç»“æŸæ—¶é—´</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;ä½¿ç”¨æ™®é€šæµå¤åˆ¶PDFæ–‡ä»¶æ€»è€—æ—¶:&quot;</span> + (end - start) + <span class="string">&quot; æ¯«ç§’&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯è°ƒç”¨ <code>read(byte b[])</code> å’Œ <code>write(byte b[], int off, int len)</code> è¿™ä¸¤ä¸ªå†™å…¥ä¸€ä¸ªå­—èŠ‚æ•°ç»„çš„æ–¹æ³•çš„è¯ï¼Œåªè¦å­—èŠ‚æ•°ç»„çš„å¤§å°åˆé€‚ï¼Œä¸¤è€…çš„æ€§èƒ½å·®è·å…¶å®ä¸å¤§ï¼ŒåŸºæœ¬å¯ä»¥å¿½ç•¥ã€‚</p>
<p>è¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨ <code>read(byte b[])</code> å’Œ <code>write(byte b[], int off, int len)</code> æ–¹æ³•ï¼Œåˆ†åˆ«é€šè¿‡å­—èŠ‚æµå’Œå­—èŠ‚ç¼“å†²æµå¤åˆ¶ä¸€ä¸ª 524.9 mb çš„ PDF æ–‡ä»¶è€—æ—¶å¯¹æ¯”å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨ç¼“å†²æµå¤åˆ¶PDFæ–‡ä»¶æ€»è€—æ—¶:695 æ¯«ç§’</span><br><span class="line">ä½¿ç”¨æ™®é€šå­—èŠ‚æµå¤åˆ¶PDFæ–‡ä»¶æ€»è€—æ—¶:989 æ¯«ç§’</span><br></pre></td></tr></table></figure>

<p>ä¸¤è€…è€—æ—¶å·®åˆ«ä¸æ˜¯å¾ˆå¤§ï¼Œç¼“å†²æµçš„æ€§èƒ½è¦ç•¥å¾®å¥½ä¸€ç‚¹ç‚¹ã€‚</p>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">copy_pdf_to_another_pdf_with_byte_array_buffer_stream</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;æ·±å…¥ç†è§£è®¡ç®—æœºæ“ä½œç³»ç»Ÿ.pdf&quot;</span>));</span><br><span class="line">         <span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;æ·±å…¥ç†è§£è®¡ç®—æœºæ“ä½œç³»ç»Ÿ-å‰¯æœ¬.pdf&quot;</span>))) &#123;</span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span> * <span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">while</span> ((len = bis.read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            bos.write(bytes, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®°å½•ç»“æŸæ—¶é—´</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;ä½¿ç”¨ç¼“å†²æµå¤åˆ¶PDFæ–‡ä»¶æ€»è€—æ—¶:&quot;</span> + (end - start) + <span class="string">&quot; æ¯«ç§’&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">copy_pdf_to_another_pdf_with_byte_array_stream</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è®°å½•å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;æ·±å…¥ç†è§£è®¡ç®—æœºæ“ä½œç³»ç»Ÿ.pdf&quot;</span>);</span><br><span class="line">         <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;æ·±å…¥ç†è§£è®¡ç®—æœºæ“ä½œç³»ç»Ÿ-å‰¯æœ¬.pdf&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span> * <span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">while</span> ((len = fis.read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            fos.write(bytes, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®°å½•ç»“æŸæ—¶é—´</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;ä½¿ç”¨æ™®é€šæµå¤åˆ¶PDFæ–‡ä»¶æ€»è€—æ—¶:&quot;</span> + (end - start) + <span class="string">&quot; æ¯«ç§’&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BufferedInputStreamï¼ˆå­—èŠ‚ç¼“å†²è¾“å…¥æµï¼‰"><a href="#BufferedInputStreamï¼ˆå­—èŠ‚ç¼“å†²è¾“å…¥æµï¼‰" class="headerlink" title="BufferedInputStreamï¼ˆå­—èŠ‚ç¼“å†²è¾“å…¥æµï¼‰"></a>BufferedInputStreamï¼ˆå­—èŠ‚ç¼“å†²è¾“å…¥æµï¼‰</h3><p><code>BufferedInputStream</code> ä»æºå¤´ï¼ˆé€šå¸¸æ˜¯æ–‡ä»¶ï¼‰è¯»å–æ•°æ®ï¼ˆå­—èŠ‚ä¿¡æ¯ï¼‰åˆ°å†…å­˜çš„è¿‡ç¨‹ä¸­ä¸ä¼šä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„è¯»å–ï¼Œè€Œæ˜¯ä¼šå…ˆå°†è¯»å–åˆ°çš„å­—èŠ‚å­˜æ”¾åœ¨ç¼“å­˜åŒºï¼Œå¹¶ä»å†…éƒ¨ç¼“å†²åŒºä¸­å•ç‹¬è¯»å–å­—èŠ‚ã€‚è¿™æ ·å¤§å¹…å‡å°‘äº† IO æ¬¡æ•°ï¼Œæé«˜äº†è¯»å–æ•ˆç‡ã€‚</p>
<p><code>BufferedInputStream</code> å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºå®é™…å°±æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œé€šè¿‡é˜…è¯» <code>BufferedInputStream</code> æºç å³å¯å¾—åˆ°è¿™ä¸ªç»“è®ºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BufferedInputStream</span> <span class="keyword">extends</span> <span class="title class_">FilterInputStream</span> &#123;</span><br><span class="line">    <span class="comment">// å†…éƒ¨ç¼“å†²åŒºæ•°ç»„</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="type">byte</span> buf[];</span><br><span class="line">    <span class="comment">// ç¼“å†²åŒºçš„é»˜è®¤å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">DEFAULT_BUFFER_SIZE</span> <span class="operator">=</span> <span class="number">8192</span>;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨é»˜è®¤çš„ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BufferedInputStream</span><span class="params">(InputStream in)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(in, DEFAULT_BUFFER_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BufferedInputStream</span><span class="params">(InputStream in, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(in);</span><br><span class="line">        <span class="keyword">if</span> (size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Buffer size &lt;= 0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        buf = <span class="keyword">new</span> <span class="title class_">byte</span>[size];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼“å†²åŒºçš„å¤§å°é»˜è®¤ä¸º <strong>8192</strong> å­—èŠ‚ï¼Œå½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ <code>BufferedInputStream(InputStream in, int size)</code> è¿™ä¸ªæ„é€ æ–¹æ³•æ¥æŒ‡å®šç¼“å†²åŒºçš„å¤§å°ã€‚</p>
<h3 id="BufferedOutputStreamï¼ˆå­—èŠ‚ç¼“å†²è¾“å‡ºæµï¼‰"><a href="#BufferedOutputStreamï¼ˆå­—èŠ‚ç¼“å†²è¾“å‡ºæµï¼‰" class="headerlink" title="BufferedOutputStreamï¼ˆå­—èŠ‚ç¼“å†²è¾“å‡ºæµï¼‰"></a>BufferedOutputStreamï¼ˆå­—èŠ‚ç¼“å†²è¾“å‡ºæµï¼‰</h3><p><code>BufferedOutputStream</code> å°†æ•°æ®ï¼ˆå­—èŠ‚ä¿¡æ¯ï¼‰å†™å…¥åˆ°ç›®çš„åœ°ï¼ˆé€šå¸¸æ˜¯æ–‡ä»¶ï¼‰çš„è¿‡ç¨‹ä¸­ä¸ä¼šä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„å†™å…¥ï¼Œè€Œæ˜¯ä¼šå…ˆå°†è¦å†™å…¥çš„å­—èŠ‚å­˜æ”¾åœ¨ç¼“å­˜åŒºï¼Œå¹¶ä»å†…éƒ¨ç¼“å†²åŒºä¸­å•ç‹¬å†™å…¥å­—èŠ‚ã€‚è¿™æ ·å¤§å¹…å‡å°‘äº† IO æ¬¡æ•°ï¼Œæé«˜äº†è¯»å–æ•ˆç‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;output.txt&quot;</span>))) &#123;</span><br><span class="line">    <span class="type">byte</span>[] array = <span class="string">&quot;JavaGuide&quot;</span>.getBytes();</span><br><span class="line">    bos.write(array);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç±»ä¼¼äº <code>BufferedInputStream</code> ï¼Œ<code>BufferedOutputStream</code> å†…éƒ¨ä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªç¼“å†²åŒºï¼Œå¹¶ä¸”ï¼Œè¿™ä¸ªç¼“å­˜åŒºçš„å¤§å°ä¹Ÿæ˜¯ <strong>8192</strong> å­—èŠ‚ã€‚</p>
<h2 id="å­—ç¬¦ç¼“å†²æµ"><a href="#å­—ç¬¦ç¼“å†²æµ" class="headerlink" title="å­—ç¬¦ç¼“å†²æµ"></a>å­—ç¬¦ç¼“å†²æµ</h2><p><code>BufferedReader</code> ï¼ˆå­—ç¬¦ç¼“å†²è¾“å…¥æµï¼‰å’Œ <code>BufferedWriter</code>ï¼ˆå­—ç¬¦ç¼“å†²è¾“å‡ºæµï¼‰ç±»ä¼¼äº <code>BufferedInputStream</code>ï¼ˆå­—èŠ‚ç¼“å†²è¾“å…¥æµï¼‰å’Œ<code>BufferedOutputStream</code>ï¼ˆå­—èŠ‚ç¼“å†²è¾“å…¥æµï¼‰ï¼Œå†…éƒ¨éƒ½ç»´æŠ¤äº†ä¸€ä¸ªå­—èŠ‚æ•°ç»„ä½œä¸ºç¼“å†²åŒºã€‚ä¸è¿‡ï¼Œå‰è€…ä¸»è¦æ˜¯ç”¨æ¥æ“ä½œå­—ç¬¦ä¿¡æ¯ã€‚</p>
<h2 id="æ‰“å°æµ"><a href="#æ‰“å°æµ" class="headerlink" title="æ‰“å°æµ"></a>æ‰“å°æµ</h2><p>ä¸‹é¢è¿™æ®µä»£ç å¤§å®¶ç»å¸¸ä½¿ç”¨å§ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.out.print(<span class="string">&quot;Helloï¼&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;Helloï¼&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><code>System.out</code> å®é™…æ˜¯ç”¨äºè·å–ä¸€ä¸ª <code>PrintStream</code> å¯¹è±¡ï¼Œ<code>print</code>æ–¹æ³•å®é™…è°ƒç”¨çš„æ˜¯ <code>PrintStream</code> å¯¹è±¡çš„ <code>write</code> æ–¹æ³•ã€‚</p>
<p><code>PrintStream</code> å±äºå­—èŠ‚æ‰“å°æµï¼Œä¸ä¹‹å¯¹åº”çš„æ˜¯ <code>PrintWriter</code> ï¼ˆå­—ç¬¦æ‰“å°æµï¼‰ã€‚<code>PrintStream</code> æ˜¯ <code>OutputStream</code> çš„å­ç±»ï¼Œ<code>PrintWriter</code> æ˜¯ <code>Writer</code> çš„å­ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrintStream</span> <span class="keyword">extends</span> <span class="title class_">FilterOutputStream</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Appendable</span>, Closeable &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrintWriter</span> <span class="keyword">extends</span> <span class="title class_">Writer</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="éšæœºè®¿é—®æµ"><a href="#éšæœºè®¿é—®æµ" class="headerlink" title="éšæœºè®¿é—®æµ"></a>éšæœºè®¿é—®æµ</h2><p>è¿™é‡Œè¦ä»‹ç»çš„éšæœºè®¿é—®æµæŒ‡çš„æ˜¯æ”¯æŒéšæ„è·³è½¬åˆ°æ–‡ä»¶çš„ä»»æ„ä½ç½®è¿›è¡Œè¯»å†™çš„ <code>RandomAccessFile</code> ã€‚</p>
<p><code>RandomAccessFile</code> çš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®š <code>mode</code>ï¼ˆè¯»å†™æ¨¡å¼ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// openAndDelete å‚æ•°é»˜è®¤ä¸º false è¡¨ç¤ºæ‰“å¼€æ–‡ä»¶å¹¶ä¸”è¿™ä¸ªæ–‡ä»¶ä¸ä¼šè¢«åˆ é™¤</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">RandomAccessFile</span><span class="params">(File file, String mode)</span></span><br><span class="line">    <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">    <span class="built_in">this</span>(file, mode, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç§æœ‰æ–¹æ³•</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">RandomAccessFile</span><span class="params">(File file, String mode, <span class="type">boolean</span> openAndDelete)</span>  <span class="keyword">throws</span> FileNotFoundException&#123;</span><br><span class="line">  <span class="comment">// çœç•¥å¤§éƒ¨åˆ†ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯»å†™æ¨¡å¼ä¸»è¦æœ‰ä¸‹é¢å››ç§ï¼š</p>
<ul>
<li><code>r</code> : åªè¯»æ¨¡å¼ã€‚</li>
<li><code>rw</code>: è¯»å†™æ¨¡å¼</li>
<li><code>rws</code>: ç›¸å¯¹äº <code>rw</code>ï¼Œ<code>rws</code> åŒæ­¥æ›´æ–°å¯¹â€œæ–‡ä»¶çš„å†…å®¹â€æˆ–â€œå…ƒæ•°æ®â€çš„ä¿®æ”¹åˆ°å¤–éƒ¨å­˜å‚¨è®¾å¤‡ã€‚</li>
<li><code>rwd</code> : ç›¸å¯¹äº <code>rw</code>ï¼Œ<code>rwd</code> åŒæ­¥æ›´æ–°å¯¹â€œæ–‡ä»¶çš„å†…å®¹â€çš„ä¿®æ”¹åˆ°å¤–éƒ¨å­˜å‚¨è®¾å¤‡ã€‚</li>
</ul>
<p>æ–‡ä»¶å†…å®¹æŒ‡çš„æ˜¯æ–‡ä»¶ä¸­å®é™…ä¿å­˜çš„æ•°æ®ï¼Œå…ƒæ•°æ®åˆ™æ˜¯ç”¨æ¥æè¿°æ–‡ä»¶å±æ€§æ¯”å¦‚æ–‡ä»¶çš„å¤§å°ä¿¡æ¯ã€åˆ›å»ºå’Œä¿®æ”¹æ—¶é—´ã€‚</p>
<p><code>RandomAccessFile</code> ä¸­æœ‰ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆç”¨æ¥è¡¨ç¤ºä¸‹ä¸€ä¸ªå°†è¦è¢«å†™å…¥æˆ–è€…è¯»å–çš„å­—èŠ‚æ‰€å¤„çš„ä½ç½®ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>RandomAccessFile</code> çš„ <code>seek(long pos)</code> æ–¹æ³•æ¥è®¾ç½®æ–‡ä»¶æŒ‡é’ˆçš„åç§»é‡ï¼ˆè·æ–‡ä»¶å¼€å¤´ <code>pos</code> ä¸ªå­—èŠ‚å¤„ï¼‰ã€‚å¦‚æœæƒ³è¦è·å–æ–‡ä»¶æŒ‡é’ˆå½“å‰çš„ä½ç½®çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ <code>getFilePointer()</code> æ–¹æ³•ã€‚</p>
<p><code>RandomAccessFile</code> ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RandomAccessFile</span> <span class="variable">randomAccessFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;input.txt&quot;</span>), <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;è¯»å–ä¹‹å‰çš„åç§»é‡ï¼š&quot;</span> + randomAccessFile.getFilePointer() + <span class="string">&quot;,å½“å‰è¯»å–åˆ°çš„å­—ç¬¦&quot;</span> + (<span class="type">char</span>) randomAccessFile.read() + <span class="string">&quot;ï¼Œè¯»å–ä¹‹åçš„åç§»é‡ï¼š&quot;</span> + randomAccessFile.getFilePointer());</span><br><span class="line"><span class="comment">// æŒ‡é’ˆå½“å‰åç§»é‡ä¸º 6</span></span><br><span class="line">randomAccessFile.seek(<span class="number">6</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;è¯»å–ä¹‹å‰çš„åç§»é‡ï¼š&quot;</span> + randomAccessFile.getFilePointer() + <span class="string">&quot;,å½“å‰è¯»å–åˆ°çš„å­—ç¬¦&quot;</span> + (<span class="type">char</span>) randomAccessFile.read() + <span class="string">&quot;ï¼Œè¯»å–ä¹‹åçš„åç§»é‡ï¼š&quot;</span> + randomAccessFile.getFilePointer());</span><br><span class="line"><span class="comment">// ä»åç§»é‡ 7 çš„ä½ç½®å¼€å§‹å¾€åå†™å…¥å­—èŠ‚æ•°æ®</span></span><br><span class="line">randomAccessFile.write(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>&#125;);</span><br><span class="line"><span class="comment">// æŒ‡é’ˆå½“å‰åç§»é‡ä¸º 0ï¼Œå›åˆ°èµ·å§‹ä½ç½®</span></span><br><span class="line">randomAccessFile.seek(<span class="number">0</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;è¯»å–ä¹‹å‰çš„åç§»é‡ï¼š&quot;</span> + randomAccessFile.getFilePointer() + <span class="string">&quot;,å½“å‰è¯»å–åˆ°çš„å­—ç¬¦&quot;</span> + (<span class="type">char</span>) randomAccessFile.read() + <span class="string">&quot;ï¼Œè¯»å–ä¹‹åçš„åç§»é‡ï¼š&quot;</span> + randomAccessFile.getFilePointer());</span><br></pre></td></tr></table></figure>

<p><code>input.txt</code> æ–‡ä»¶å†…å®¹ï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/image-20220421162050158.png"></p>
<p>è¾“å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¯»å–ä¹‹å‰çš„åç§»é‡ï¼š0,å½“å‰è¯»å–åˆ°çš„å­—ç¬¦Aï¼Œè¯»å–ä¹‹åçš„åç§»é‡ï¼š1</span><br><span class="line">è¯»å–ä¹‹å‰çš„åç§»é‡ï¼š6,å½“å‰è¯»å–åˆ°çš„å­—ç¬¦Gï¼Œè¯»å–ä¹‹åçš„åç§»é‡ï¼š7</span><br><span class="line">è¯»å–ä¹‹å‰çš„åç§»é‡ï¼š0,å½“å‰è¯»å–åˆ°çš„å­—ç¬¦Aï¼Œè¯»å–ä¹‹åçš„åç§»é‡ï¼š1</span><br></pre></td></tr></table></figure>

<p><code>input.txt</code> æ–‡ä»¶å†…å®¹å˜ä¸º <code>ABCDEFGHIJK</code> ã€‚</p>
<p><code>RandomAccessFile</code> çš„ <code>write</code> æ–¹æ³•åœ¨å†™å…¥å¯¹è±¡çš„æ—¶å€™å¦‚æœå¯¹åº”çš„ä½ç½®å·²ç»æœ‰æ•°æ®çš„è¯ï¼Œä¼šå°†å…¶è¦†ç›–æ‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RandomAccessFile</span> <span class="variable">randomAccessFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;input.txt&quot;</span>), <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">randomAccessFile.write(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>&#125;);</span><br></pre></td></tr></table></figure>

<p>å‡è®¾è¿è¡Œä¸Šé¢è¿™æ®µç¨‹åºä¹‹å‰ <code>input.txt</code> æ–‡ä»¶å†…å®¹å˜ä¸º <code>ABCD</code> ï¼Œè¿è¡Œä¹‹ååˆ™å˜ä¸º <code>HIJK</code> ã€‚</p>
<p><code>RandomAccessFile</code> æ¯”è¾ƒå¸¸è§çš„ä¸€ä¸ªåº”ç”¨å°±æ˜¯å®ç°å¤§æ–‡ä»¶çš„ <strong>æ–­ç‚¹ç»­ä¼ </strong> ã€‚ä½•è°“æ–­ç‚¹ç»­ä¼ ï¼Ÿç®€å•æ¥è¯´å°±æ˜¯ä¸Šä¼ æ–‡ä»¶ä¸­é€”æš‚åœæˆ–å¤±è´¥ï¼ˆæ¯”å¦‚é‡åˆ°ç½‘ç»œé—®é¢˜ï¼‰ä¹‹åï¼Œä¸éœ€è¦é‡æ–°ä¸Šä¼ ï¼Œåªéœ€è¦ä¸Šä¼ é‚£äº›æœªæˆåŠŸä¸Šä¼ çš„æ–‡ä»¶åˆ†ç‰‡å³å¯ã€‚åˆ†ç‰‡ï¼ˆå…ˆå°†æ–‡ä»¶åˆ‡åˆ†æˆå¤šä¸ªæ–‡ä»¶åˆ†ç‰‡ï¼‰ä¸Šä¼ æ˜¯æ–­ç‚¹ç»­ä¼ çš„åŸºç¡€ã€‚</p>
<p><code>RandomAccessFile</code> å¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆå¹¶æ–‡ä»¶åˆ†ç‰‡ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/io/20210609164749122.png"></p>
<p>æˆ‘åœ¨<a href="https://javaguide.cn/zhuanlan/java-mian-shi-zhi-bei.html">ã€ŠJava é¢è¯•æŒ‡åŒ—ã€‹</a>ä¸­è¯¦ç»†ä»‹ç»äº†å¤§æ–‡ä»¶çš„ä¸Šä¼ é—®é¢˜ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/image-20220428104115362.png"></p>
<p><code>RandomAccessFile</code> çš„å®ç°ä¾èµ–äº <code>FileDescriptor</code> (æ–‡ä»¶æè¿°ç¬¦) å’Œ <code>FileChannel</code> ï¼ˆå†…å­˜æ˜ å°„æ–‡ä»¶ï¼‰ã€‚</p>
<!-- @include: @article-footer.snippet.md -->

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/03/03/zookeeper-plus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/03/03/zookeeper-plus/" itemprop="url">ZooKeeperç›¸å…³æ¦‚å¿µæ€»ç»“(è¿›é˜¶)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2022-03-03T20:13:16+08:00">
                2022-03-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">åˆ†å¸ƒå¼</span>
                  </a>
                </span>

                
                
                  ï¼Œ 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index">
                    <span itemprop="name">ä¸­é—´ä»¶</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2022/03/03/zookeeper-plus/" class="leancloud_visitors" data-flag-title="ZooKeeperç›¸å…³æ¦‚å¿µæ€»ç»“(è¿›é˜¶)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  10.3k å­—
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  35 åˆ†é’Ÿ
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><a href="https://juejin.im/user/5c33853851882525ea106810">FrancisQ</a> æŠ•ç¨¿ã€‚</p>
</blockquote>
<h2 id="ä»€ä¹ˆæ˜¯-ZooKeeper"><a href="#ä»€ä¹ˆæ˜¯-ZooKeeper" class="headerlink" title="ä»€ä¹ˆæ˜¯ ZooKeeper"></a>ä»€ä¹ˆæ˜¯ ZooKeeper</h2><p><code>ZooKeeper</code> ç”± <code>Yahoo</code> å¼€å‘ï¼Œåæ¥æèµ ç»™äº† <code>Apache</code> ï¼Œç°å·²æˆä¸º <code>Apache</code> é¡¶çº§é¡¹ç›®ã€‚<code>ZooKeeper</code> æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºåè°ƒæœåŠ¡å™¨ï¼Œå…¶ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿæä¾›ä¸€è‡´æ€§æœåŠ¡ã€‚å…¶ä¸€è‡´æ€§æ˜¯é€šè¿‡åŸºäº <code>Paxos</code> ç®—æ³•çš„ <code>ZAB</code> åè®®å®Œæˆçš„ã€‚å…¶ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼šé…ç½®ç»´æŠ¤ã€åˆ†å¸ƒå¼åŒæ­¥ã€é›†ç¾¤ç®¡ç†ç­‰ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œ <code>ZooKeeper</code> æ˜¯ä¸€ä¸ª <strong>åˆ†å¸ƒå¼åè°ƒæœåŠ¡æ¡†æ¶</strong> ã€‚åˆ†å¸ƒå¼ï¼Ÿåè°ƒæœåŠ¡ï¼Ÿè¿™å•¥ç©æ„ï¼ŸğŸ¤”ğŸ¤”</p>
<p>å…¶å®è§£é‡Šåˆ°åˆ†å¸ƒå¼è¿™ä¸ªæ¦‚å¿µçš„æ—¶å€™ï¼Œæˆ‘å‘ç°æœ‰äº›åŒå­¦å¹¶ä¸æ˜¯èƒ½æŠŠ <strong>åˆ†å¸ƒå¼å’Œé›†ç¾¤</strong> è¿™ä¸¤ä¸ªæ¦‚å¿µå¾ˆå¥½çš„ç†è§£é€ã€‚å‰æ®µæ—¶é—´æœ‰åŒå­¦å’Œæˆ‘æ¢è®¨èµ·åˆ†å¸ƒå¼çš„ä¸œè¥¿ï¼Œä»–è¯´åˆ†å¸ƒå¼ä¸å°±æ˜¯åŠ æœºå™¨å—ï¼Ÿä¸€å°æœºå™¨ä¸å¤Ÿç”¨å†åŠ ä¸€å°æŠ—å‹å‘—ã€‚å½“ç„¶åŠ æœºå™¨è¿™ç§è¯´æ³•ä¹Ÿæ— å¯åšéï¼Œä½ ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¿…å®šæ¶‰åŠåˆ°å¤šä¸ªæœºå™¨ï¼Œä½†æ˜¯ä½ åˆ«å¿˜äº†ï¼Œè®¡ç®—æœºå­¦ç§‘ä¸­è¿˜æœ‰ä¸€ä¸ªç›¸ä¼¼çš„æ¦‚å¿µâ€”â€” <code>Cluster</code> ï¼Œé›†ç¾¤ä¸ä¹Ÿæ˜¯åŠ æœºå™¨å—ï¼Ÿä½†æ˜¯ é›†ç¾¤ å’Œ åˆ†å¸ƒå¼ å…¶å®å°±æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„æ¦‚å¿µã€‚</p>
<p>æ¯”å¦‚ï¼Œæˆ‘ç°åœ¨æœ‰ä¸€ä¸ªç§’æ€æœåŠ¡ï¼Œå¹¶å‘é‡å¤ªå¤§å•æœºç³»ç»Ÿæ‰¿å—ä¸ä½ï¼Œé‚£æˆ‘åŠ å‡ å°æœåŠ¡å™¨ä¹Ÿ <strong>ä¸€æ ·</strong> æä¾›ç§’æ€æœåŠ¡ï¼Œè¿™ä¸ªæ—¶å€™å°±æ˜¯ <strong><code>Cluster</code> é›†ç¾¤</strong> ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/60263e969b9e4a0f81724b1f4d5b3d58~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="cluster"></p>
<p>ä½†æ˜¯ï¼Œæˆ‘ç°åœ¨æ¢ä¸€ç§æ–¹å¼ï¼Œæˆ‘å°†ä¸€ä¸ªç§’æ€æœåŠ¡ <strong>æ‹†åˆ†æˆå¤šä¸ªå­æœåŠ¡</strong> ï¼Œæ¯”å¦‚åˆ›å»ºè®¢å•æœåŠ¡ï¼Œå¢åŠ ç§¯åˆ†æœåŠ¡ï¼Œæ‰£ä¼˜æƒ åˆ¸æœåŠ¡ç­‰ç­‰ï¼Œ<strong>ç„¶åæˆ‘å°†è¿™äº›å­æœåŠ¡éƒ½éƒ¨ç½²åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Š</strong> ï¼Œè¿™ä¸ªæ—¶å€™å°±æ˜¯ <strong><code>Distributed</code> åˆ†å¸ƒå¼</strong> ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/0d42e7b4249144b3a77a0c519216ae3d~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="distributed"></p>
<p>è€Œæˆ‘ä¸ºä»€ä¹ˆåé©³åŒå­¦æ‰€è¯´çš„åˆ†å¸ƒå¼å°±æ˜¯åŠ æœºå™¨å‘¢ï¼Ÿå› ä¸ºæˆ‘è®¤ä¸ºåŠ æœºå™¨æ›´åŠ é€‚ç”¨äºæ„å»ºé›†ç¾¤ï¼Œå› ä¸ºå®ƒçœŸæ˜¯åªæœ‰åŠ æœºå™¨ã€‚è€Œå¯¹äºåˆ†å¸ƒå¼æ¥è¯´ï¼Œä½ é¦–å…ˆéœ€è¦å°†ä¸šåŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œç„¶åå†åŠ æœºå™¨ï¼ˆä¸ä»…ä»…æ˜¯åŠ æœºå™¨é‚£ä¹ˆç®€å•ï¼‰ï¼ŒåŒæ—¶ä½ è¿˜è¦å»è§£å†³åˆ†å¸ƒå¼å¸¦æ¥çš„ä¸€ç³»åˆ—é—®é¢˜ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/e3662ca1a09c4444b07f15dbf85c6ba8~tplv-k3u1fbpfcp-zoom-1.jpeg"></p>
<p>æ¯”å¦‚å„ä¸ªåˆ†å¸ƒå¼ç»„ä»¶å¦‚ä½•åè°ƒèµ·æ¥ï¼Œå¦‚ä½•å‡å°‘å„ä¸ªç³»ç»Ÿä¹‹é—´çš„è€¦åˆåº¦ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡çš„å¤„ç†ï¼Œå¦‚ä½•å»é…ç½®æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿç­‰ç­‰ã€‚<code>ZooKeeper</code> ä¸»è¦å°±æ˜¯è§£å†³è¿™äº›é—®é¢˜çš„ã€‚</p>
<h2 id="ä¸€è‡´æ€§é—®é¢˜"><a href="#ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="ä¸€è‡´æ€§é—®é¢˜"></a>ä¸€è‡´æ€§é—®é¢˜</h2><p>è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¿…å®šä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜â€”â€” <strong>å› ä¸ºåˆ†åŒºå®¹å¿æ€§ï¼ˆpartition toleranceï¼‰çš„å­˜åœ¨ï¼Œå°±å¿…å®šè¦æ±‚æˆ‘ä»¬éœ€è¦åœ¨ç³»ç»Ÿå¯ç”¨æ€§ï¼ˆavailabilityï¼‰å’Œæ•°æ®ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰ä¸­åšå‡ºæƒè¡¡</strong> ã€‚è¿™å°±æ˜¯è‘—åçš„ <code>CAP</code> å®šç†ã€‚</p>
<p>ç†è§£èµ·æ¥å…¶å®å¾ˆç®€å•ï¼Œæ¯”å¦‚è¯´æŠŠä¸€ä¸ªç­çº§ä½œä¸ºæ•´ä¸ªç³»ç»Ÿï¼Œè€Œå­¦ç”Ÿæ˜¯ç³»ç»Ÿä¸­çš„ä¸€ä¸ªä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿã€‚è¿™ä¸ªæ—¶å€™ç­é‡Œçš„å°çº¢å°æ˜å·å·è°ˆæ‹çˆ±è¢«ç­é‡Œçš„å¤§å˜´å·´å°èŠ±å‘ç°äº†ï¼Œå°èŠ±æ¬£å–œè‹¥ç‹‚å‘Šè¯‰äº†å‘¨å›´çš„äººï¼Œç„¶åå°çº¢å°æ˜è°ˆæ‹çˆ±çš„æ¶ˆæ¯åœ¨ç­çº§é‡Œä¼ æ’­èµ·æ¥äº†ã€‚å½“åœ¨æ¶ˆæ¯çš„ä¼ æ’­ï¼ˆæ•£å¸ƒï¼‰è¿‡ç¨‹ä¸­ï¼Œä½ æŠ“åˆ°ä¸€ä¸ªåŒå­¦é—®ä»–ä»¬çš„æƒ…å†µï¼Œå¦‚æœå›ç­”ä½ ä¸çŸ¥é“ï¼Œé‚£ä¹ˆè¯´æ˜æ•´ä¸ªç­çº§ç³»ç»Ÿå‡ºç°äº†æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼ˆå› ä¸ºå°èŠ±å·²ç»çŸ¥é“è¿™ä¸ªæ¶ˆæ¯äº†ï¼‰ã€‚è€Œå¦‚æœä»–ç›´æ¥ä¸å›ç­”ä½ ï¼Œå› ä¸ºæ•´ä¸ªç­çº§æœ‰æ¶ˆæ¯åœ¨è¿›è¡Œä¼ æ’­ï¼ˆä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼Œéœ€è¦æ‰€æœ‰äººéƒ½çŸ¥é“æ‰å¯æä¾›æœåŠ¡ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™å°±å‡ºç°äº†ç³»ç»Ÿçš„å¯ç”¨æ€§é—®é¢˜ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/38b9ff4b193e4487afe32c9710c6d644~tplv-k3u1fbpfcp-zoom-1-20230717160254318-20230717160259975.jpeg"></p>
<p>è€Œä¸Šè¿°å‰è€…å°±æ˜¯ <code>Eureka</code> çš„å¤„ç†æ–¹å¼ï¼Œå®ƒä¿è¯äº† APï¼ˆå¯ç”¨æ€§ï¼‰ï¼Œåè€…å°±æ˜¯æˆ‘ä»¬ä»Šå¤©æ‰€è¦è®²çš„ <code>ZooKeeper</code> çš„å¤„ç†æ–¹å¼ï¼Œå®ƒä¿è¯äº† CPï¼ˆæ•°æ®ä¸€è‡´æ€§ï¼‰ã€‚</p>
<h2 id="ä¸€è‡´æ€§åè®®å’Œç®—æ³•"><a href="#ä¸€è‡´æ€§åè®®å’Œç®—æ³•" class="headerlink" title="ä¸€è‡´æ€§åè®®å’Œç®—æ³•"></a>ä¸€è‡´æ€§åè®®å’Œç®—æ³•</h2><p>è€Œä¸ºäº†è§£å†³æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œåœ¨ç§‘å­¦å®¶å’Œç¨‹åºå‘˜çš„ä¸æ–­æ¢ç´¢ä¸­ï¼Œå°±å‡ºç°äº†å¾ˆå¤šçš„ä¸€è‡´æ€§åè®®å’Œç®—æ³•ã€‚æ¯”å¦‚ 2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰ï¼Œ3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰ï¼ŒPaxos ç®—æ³•ç­‰ç­‰ã€‚</p>
<p>è¿™æ—¶å€™è¯·ä½ æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼ŒåŒå­¦ä¹‹é—´å¦‚æœé‡‡ç”¨ä¼ çº¸æ¡çš„æ–¹å¼å»ä¼ æ’­æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜â€”â€”æˆ‘å’‹çŸ¥é“æˆ‘çš„å°çº¸æ¡æœ‰æ²¡æœ‰ä¼ åˆ°æˆ‘æƒ³è¦ä¼ é€’çš„é‚£ä¸ªäººæ‰‹ä¸­å‘¢ï¼Ÿä¸‡ä¸€è¢«å“ªä¸ªå°å®¶ä¼™ç»™åŠ«æŒç¯¡æ”¹äº†å‘¢ï¼Œå¯¹å§ï¼Ÿ</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/8c73e264d28b4a93878f4252e4e3e43c~tplv-k3u1fbpfcp-zoom-1.jpeg"></p>
<p>è¿™ä¸ªæ—¶å€™å°±å¼•ç”³å‡ºä¸€ä¸ªæ¦‚å¿µâ€”â€” <strong>æ‹œå åº­å°†å†›é—®é¢˜</strong> ã€‚å®ƒæ„æŒ‡ <strong>åœ¨ä¸å¯é ä¿¡é“ä¸Šè¯•å›¾é€šè¿‡æ¶ˆæ¯ä¼ é€’çš„æ–¹å¼è¾¾åˆ°ä¸€è‡´æ€§æ˜¯ä¸å¯èƒ½çš„</strong>ï¼Œ æ‰€ä»¥æ‰€æœ‰çš„ä¸€è‡´æ€§ç®—æ³•çš„ <strong>å¿…è¦å‰æ</strong> å°±æ˜¯å®‰å…¨å¯é çš„æ¶ˆæ¯é€šé“ã€‚</p>
<p>è€Œä¸ºä»€ä¹ˆè¦å»è§£å†³æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼Ÿä½ æƒ³æƒ³ï¼Œå¦‚æœä¸€ä¸ªç§’æ€ç³»ç»Ÿå°†æœåŠ¡æ‹†åˆ†æˆäº†ä¸‹è®¢å•å’ŒåŠ ç§¯åˆ†æœåŠ¡ï¼Œè¿™ä¸¤ä¸ªæœåŠ¡éƒ¨ç½²åœ¨ä¸åŒçš„æœºå™¨ä¸Šäº†ï¼Œä¸‡ä¸€åœ¨æ¶ˆæ¯çš„ä¼ æ’­è¿‡ç¨‹ä¸­ç§¯åˆ†ç³»ç»Ÿå®•æœºäº†ï¼Œæ€»ä¸èƒ½ä½ è¿™è¾¹ä¸‹äº†è®¢å•å´æ²¡åŠ ç§¯åˆ†å§ï¼Ÿä½ æ€»å¾—ä¿è¯ä¸¤è¾¹çš„æ•°æ®éœ€è¦ä¸€è‡´å§ï¼Ÿ</p>
<h3 id="2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰"><a href="#2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰" class="headerlink" title="2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰"></a>2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰</h3><p>ä¸¤é˜¶æ®µæäº¤æ˜¯ä¸€ç§ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§çš„åè®®ï¼Œç°åœ¨å¾ˆå¤šæ•°æ®åº“éƒ½æ˜¯é‡‡ç”¨çš„ä¸¤é˜¶æ®µæäº¤åè®®æ¥å®Œæˆ <strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong> çš„å¤„ç†ã€‚</p>
<p>åœ¨ä»‹ç» 2PC ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æƒ³æƒ³åˆ†å¸ƒå¼äº‹åŠ¡åˆ°åº•æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p>
<p>è¿˜æ‹¿ç§’æ€ç³»ç»Ÿçš„ä¸‹è®¢å•å’ŒåŠ ç§¯åˆ†ä¸¤ä¸ªç³»ç»Ÿæ¥ä¸¾ä¾‹å§ï¼ˆæˆ‘æƒ³ä½ ä»¬å¯èƒ½éƒ½åäº† ğŸ¤®ğŸ¤®ğŸ¤®ï¼‰ï¼Œæˆ‘ä»¬æ­¤æ—¶ä¸‹å®Œè®¢å•ä¼šå‘ä¸ªæ¶ˆæ¯ç»™ç§¯åˆ†ç³»ç»Ÿå‘Šè¯‰å®ƒä¸‹é¢è¯¥å¢åŠ ç§¯åˆ†äº†ã€‚å¦‚æœæˆ‘ä»¬ä»…ä»…æ˜¯å‘é€ä¸€ä¸ªæ¶ˆæ¯ä¹Ÿä¸æ”¶å›å¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„è®¢å•ç³»ç»Ÿæ€ä¹ˆèƒ½çŸ¥é“ç§¯åˆ†ç³»ç»Ÿçš„æ”¶åˆ°æ¶ˆæ¯çš„æƒ…å†µå‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬å¢åŠ ä¸€ä¸ªæ”¶å›å¤çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆå½“ç§¯åˆ†ç³»ç»Ÿæ”¶åˆ°æ¶ˆæ¯åè¿”å›ç»™è®¢å•ç³»ç»Ÿä¸€ä¸ª <code>Response</code> ï¼Œä½†åœ¨ä¸­é—´å‡ºç°äº†ç½‘ç»œæ³¢åŠ¨ï¼Œé‚£ä¸ªå›å¤æ¶ˆæ¯æ²¡æœ‰å‘é€æˆåŠŸï¼Œè®¢å•ç³»ç»Ÿæ˜¯ä¸æ˜¯ä»¥ä¸ºç§¯åˆ†ç³»ç»Ÿæ¶ˆæ¯æ¥æ”¶å¤±è´¥äº†ï¼Ÿå®ƒæ˜¯ä¸æ˜¯ä¼šå›æ»šäº‹åŠ¡ï¼Ÿä½†æ­¤æ—¶ç§¯åˆ†ç³»ç»Ÿæ˜¯æˆåŠŸæ”¶åˆ°æ¶ˆæ¯çš„ï¼Œå®ƒå°±ä¼šå»å¤„ç†æ¶ˆæ¯ç„¶åç»™ç”¨æˆ·å¢åŠ ç§¯åˆ†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°ç§¯åˆ†åŠ äº†ä½†æ˜¯è®¢å•æ²¡ä¸‹æˆåŠŸã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬æ‰€éœ€è¦è§£å†³çš„æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ•´ä¸ªè°ƒç”¨é“¾ä¸­ï¼Œæˆ‘ä»¬æ‰€æœ‰æœåŠ¡çš„æ•°æ®å¤„ç†è¦ä¹ˆéƒ½æˆåŠŸè¦ä¹ˆéƒ½å¤±è´¥ï¼Œå³æ‰€æœ‰æœåŠ¡çš„ <strong>åŸå­æ€§é—®é¢˜</strong> ã€‚</p>
<p>åœ¨ä¸¤é˜¶æ®µæäº¤ä¸­ï¼Œä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªè§’è‰²ï¼Œåˆ†åˆ«æ˜¯åè°ƒè€…å’Œå‚ä¸è€…ã€‚</p>
<p>ç¬¬ä¸€é˜¶æ®µï¼šå½“è¦æ‰§è¡Œä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„æ—¶å€™ï¼Œäº‹åŠ¡å‘èµ·è€…é¦–å…ˆå‘åè°ƒè€…å‘èµ·äº‹åŠ¡è¯·æ±‚ï¼Œç„¶ååè°ƒè€…ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ <code>prepare</code> è¯·æ±‚ï¼ˆå…¶ä¸­åŒ…æ‹¬äº‹åŠ¡å†…å®¹ï¼‰å‘Šè¯‰å‚ä¸è€…ä½ ä»¬éœ€è¦æ‰§è¡Œäº‹åŠ¡äº†ï¼Œå¦‚æœèƒ½æ‰§è¡Œæˆ‘å‘çš„äº‹åŠ¡å†…å®¹é‚£ä¹ˆå°±å…ˆæ‰§è¡Œä½†ä¸æäº¤ï¼Œæ‰§è¡Œåè¯·ç»™æˆ‘å›å¤ã€‚ç„¶åå‚ä¸è€…æ”¶åˆ° <code>prepare</code> æ¶ˆæ¯åï¼Œä»–ä»¬ä¼šå¼€å§‹æ‰§è¡Œäº‹åŠ¡ï¼ˆä½†ä¸æäº¤ï¼‰ï¼Œå¹¶å°† <code>Undo</code> å’Œ <code>Redo</code> ä¿¡æ¯è®°å…¥äº‹åŠ¡æ—¥å¿—ä¸­ï¼Œä¹‹åå‚ä¸è€…å°±å‘åè°ƒè€…åé¦ˆæ˜¯å¦å‡†å¤‡å¥½äº†ã€‚</p>
<p>ç¬¬äºŒé˜¶æ®µï¼šç¬¬äºŒé˜¶æ®µä¸»è¦æ˜¯åè°ƒè€…æ ¹æ®å‚ä¸è€…åé¦ˆçš„æƒ…å†µæ¥å†³å®šæ¥ä¸‹æ¥æ˜¯å¦å¯ä»¥è¿›è¡Œäº‹åŠ¡çš„æäº¤æ“ä½œï¼Œå³æäº¤äº‹åŠ¡æˆ–è€…å›æ»šäº‹åŠ¡ã€‚</p>
<p>æ¯”å¦‚è¿™ä¸ªæ—¶å€™ <strong>æ‰€æœ‰çš„å‚ä¸è€…</strong> éƒ½è¿”å›äº†å‡†å¤‡å¥½äº†çš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ—¶å€™å°±è¿›è¡Œäº‹åŠ¡çš„æäº¤ï¼Œåè°ƒè€…æ­¤æ—¶ä¼šç»™æ‰€æœ‰çš„å‚ä¸è€…å‘é€ <strong><code>Commit</code> è¯·æ±‚</strong> ï¼Œå½“å‚ä¸è€…æ”¶åˆ° <code>Commit</code> è¯·æ±‚çš„æ—¶å€™ä¼šæ‰§è¡Œå‰é¢æ‰§è¡Œçš„äº‹åŠ¡çš„ <strong>æäº¤æ“ä½œ</strong> ï¼Œæäº¤å®Œæ¯•ä¹‹åå°†ç»™åè°ƒè€…å‘é€æäº¤æˆåŠŸçš„å“åº”ã€‚</p>
<p>è€Œå¦‚æœåœ¨ç¬¬ä¸€é˜¶æ®µå¹¶ä¸æ˜¯æ‰€æœ‰å‚ä¸è€…éƒ½è¿”å›äº†å‡†å¤‡å¥½äº†çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ­¤æ—¶åè°ƒè€…å°†ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ <strong>å›æ»šäº‹åŠ¡çš„ <code>rollback</code> è¯·æ±‚</strong>ï¼Œå‚ä¸è€…æ”¶åˆ°ä¹‹åå°†ä¼š <strong>å›æ»šå®ƒåœ¨ç¬¬ä¸€é˜¶æ®µæ‰€åšçš„äº‹åŠ¡å¤„ç†</strong> ï¼Œç„¶åå†å°†å¤„ç†æƒ…å†µè¿”å›ç»™åè°ƒè€…ï¼Œæœ€ç»ˆåè°ƒè€…æ”¶åˆ°å“åº”åä¾¿ç»™äº‹åŠ¡å‘èµ·è€…è¿”å›å¤„ç†å¤±è´¥çš„ç»“æœã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/1a7210167f1d4d4fb97afcec19902a59~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="2PCæµç¨‹"></p>
<p>ä¸ªäººè§‰å¾— 2PC å®ç°å¾—è¿˜æ˜¯æ¯”è¾ƒé¸¡è‚‹çš„ï¼Œå› ä¸ºäº‹å®ä¸Šå®ƒåªè§£å†³äº†å„ä¸ªäº‹åŠ¡çš„åŸå­æ€§é—®é¢˜ï¼Œéšä¹‹ä¹Ÿå¸¦æ¥äº†å¾ˆå¤šçš„é—®é¢˜ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/cc534022c7184770b9b82b2d0008432a~tplv-k3u1fbpfcp-zoom-1.jpeg"></p>
<ul>
<li><strong>å•ç‚¹æ•…éšœé—®é¢˜</strong>ï¼Œå¦‚æœåè°ƒè€…æŒ‚äº†é‚£ä¹ˆæ•´ä¸ªç³»ç»Ÿéƒ½å¤„äºä¸å¯ç”¨çš„çŠ¶æ€äº†ã€‚</li>
<li><strong>é˜»å¡é—®é¢˜</strong>ï¼Œå³å½“åè°ƒè€…å‘é€ <code>prepare</code> è¯·æ±‚ï¼Œå‚ä¸è€…æ”¶åˆ°ä¹‹åå¦‚æœèƒ½å¤„ç†é‚£ä¹ˆå®ƒå°†ä¼šè¿›è¡Œäº‹åŠ¡çš„å¤„ç†ä½†å¹¶ä¸æäº¤ï¼Œè¿™ä¸ªæ—¶å€™ä¼šä¸€ç›´å ç”¨ç€èµ„æºä¸é‡Šæ”¾ï¼Œå¦‚æœæ­¤æ—¶åè°ƒè€…æŒ‚äº†ï¼Œé‚£ä¹ˆè¿™äº›èµ„æºéƒ½ä¸ä¼šå†é‡Šæ”¾äº†ï¼Œè¿™ä¼šæå¤§å½±å“æ€§èƒ½ã€‚</li>
<li><strong>æ•°æ®ä¸ä¸€è‡´é—®é¢˜</strong>ï¼Œæ¯”å¦‚å½“ç¬¬äºŒé˜¶æ®µï¼Œåè°ƒè€…åªå‘é€äº†ä¸€éƒ¨åˆ†çš„ <code>commit</code> è¯·æ±‚å°±æŒ‚äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€ï¼Œæ”¶åˆ°æ¶ˆæ¯çš„å‚ä¸è€…ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤ï¼Œè€Œåé¢æ²¡æ”¶åˆ°çš„åˆ™ä¸ä¼šè¿›è¡Œäº‹åŠ¡æäº¤ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±ä¼šäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚</li>
</ul>
<h3 id="3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰"><a href="#3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰" class="headerlink" title="3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰"></a>3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰</h3><p>å› ä¸º 2PC å­˜åœ¨çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œæ¯”å¦‚å•ç‚¹ï¼Œå®¹é”™æœºåˆ¶ç¼ºé™·ç­‰ç­‰ï¼Œä»è€Œäº§ç”Ÿäº† <strong>3PCï¼ˆä¸‰é˜¶æ®µæäº¤ï¼‰</strong> ã€‚é‚£ä¹ˆè¿™ä¸‰é˜¶æ®µåˆåˆ†åˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<blockquote>
<p>åƒä¸‡ä¸è¦å§ PC ç†è§£æˆä¸ªäººç”µè„‘äº†ï¼Œå…¶å®ä»–ä»¬æ˜¯ phase-commit çš„ç¼©å†™ï¼Œå³é˜¶æ®µæäº¤ã€‚</p>
</blockquote>
<ol>
<li><strong>CanCommit é˜¶æ®µ</strong>ï¼šåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ <code>CanCommit</code> è¯·æ±‚ï¼Œå‚ä¸è€…æ”¶åˆ°è¯·æ±‚åä¼šæ ¹æ®è‡ªèº«æƒ…å†µæŸ¥çœ‹æ˜¯å¦èƒ½æ‰§è¡Œäº‹åŠ¡ï¼Œå¦‚æœå¯ä»¥åˆ™è¿”å› YES å“åº”å¹¶è¿›å…¥é¢„å¤‡çŠ¶æ€ï¼Œå¦åˆ™è¿”å› NO ã€‚</li>
<li><strong>PreCommit é˜¶æ®µ</strong>ï¼šåè°ƒè€…æ ¹æ®å‚ä¸è€…è¿”å›çš„å“åº”æ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›è¡Œä¸‹é¢çš„ <code>PreCommit</code> æ“ä½œã€‚å¦‚æœä¸Šé¢å‚ä¸è€…è¿”å›çš„éƒ½æ˜¯ YESï¼Œé‚£ä¹ˆåè°ƒè€…å°†å‘æ‰€æœ‰å‚ä¸è€…å‘é€ <code>PreCommit</code> é¢„æäº¤è¯·æ±‚ï¼Œ<strong>å‚ä¸è€…æ”¶åˆ°é¢„æäº¤è¯·æ±‚åï¼Œä¼šè¿›è¡Œäº‹åŠ¡çš„æ‰§è¡Œæ“ä½œï¼Œå¹¶å°† <code>Undo</code> å’Œ <code>Redo</code> ä¿¡æ¯å†™å…¥äº‹åŠ¡æ—¥å¿—ä¸­</strong> ï¼Œæœ€åå¦‚æœå‚ä¸è€…é¡ºåˆ©æ‰§è¡Œäº†äº‹åŠ¡åˆ™ç»™åè°ƒè€…è¿”å›æˆåŠŸçš„å“åº”ã€‚å¦‚æœåœ¨ç¬¬ä¸€é˜¶æ®µåè°ƒè€…æ”¶åˆ°äº† <strong>ä»»ä½•ä¸€ä¸ª NO</strong> çš„ä¿¡æ¯ï¼Œæˆ–è€… <strong>åœ¨ä¸€å®šæ—¶é—´å†…</strong> å¹¶æ²¡æœ‰æ”¶åˆ°å…¨éƒ¨çš„å‚ä¸è€…çš„å“åº”ï¼Œé‚£ä¹ˆå°±ä¼šä¸­æ–­äº‹åŠ¡ï¼Œå®ƒä¼šå‘æ‰€æœ‰å‚ä¸è€…å‘é€ä¸­æ–­è¯·æ±‚ï¼ˆabortï¼‰ï¼Œå‚ä¸è€…æ”¶åˆ°ä¸­æ–­è¯·æ±‚ä¹‹åä¼šç«‹å³ä¸­æ–­äº‹åŠ¡ï¼Œæˆ–è€…åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°åè°ƒè€…çš„è¯·æ±‚ï¼Œå®ƒä¹Ÿä¼šä¸­æ–­äº‹åŠ¡ã€‚</li>
<li><strong>DoCommit é˜¶æ®µ</strong>ï¼šè¿™ä¸ªé˜¶æ®µå…¶å®å’Œ <code>2PC</code> çš„ç¬¬äºŒé˜¶æ®µå·®ä¸å¤šï¼Œå¦‚æœåè°ƒè€…æ”¶åˆ°äº†æ‰€æœ‰å‚ä¸è€…åœ¨ <code>PreCommit</code> é˜¶æ®µçš„ YES å“åº”ï¼Œé‚£ä¹ˆåè°ƒè€…å°†ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ <code>DoCommit</code> è¯·æ±‚ï¼Œ<strong>å‚ä¸è€…æ”¶åˆ° <code>DoCommit</code> è¯·æ±‚ååˆ™ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤å·¥ä½œ</strong>ï¼Œå®Œæˆååˆ™ä¼šç»™åè°ƒè€…è¿”å›å“åº”ï¼Œåè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…è¿”å›çš„äº‹åŠ¡æäº¤æˆåŠŸçš„å“åº”ä¹‹ååˆ™å®Œæˆäº‹åŠ¡ã€‚è‹¥åè°ƒè€…åœ¨ <code>PreCommit</code> é˜¶æ®µ <strong>æ”¶åˆ°äº†ä»»ä½•ä¸€ä¸ª NO æˆ–è€…åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„å“åº”</strong> ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œä¸­æ–­è¯·æ±‚çš„å‘é€ï¼Œå‚ä¸è€…æ”¶åˆ°ä¸­æ–­è¯·æ±‚ååˆ™ä¼š <strong>é€šè¿‡ä¸Šé¢è®°å½•çš„å›æ»šæ—¥å¿—</strong> æ¥è¿›è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œï¼Œå¹¶å‘åè°ƒè€…åé¦ˆå›æ»šçŠ¶å†µï¼Œåè°ƒè€…æ”¶åˆ°å‚ä¸è€…è¿”å›çš„æ¶ˆæ¯åï¼Œä¸­æ–­äº‹åŠ¡ã€‚</li>
</ol>
<p><img src="https://oss.javaguide.cn/p3-juejin/80854635d48c42d896dbaa066abf5c26~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="3PCæµç¨‹"></p>
<blockquote>
<p>è¿™é‡Œæ˜¯ <code>3PC</code> åœ¨æˆåŠŸçš„ç¯å¢ƒä¸‹çš„æµç¨‹å›¾ï¼Œä½ å¯ä»¥çœ‹åˆ° <code>3PC</code> åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œäº†è¶…æ—¶ä¸­æ–­çš„å¤„ç†ï¼Œæ¯”å¦‚åè°ƒè€…åœ¨æŒ‡å®šæ—¶é—´å†…æœªæ”¶åˆ°å…¨éƒ¨çš„ç¡®è®¤æ¶ˆæ¯åˆ™è¿›è¡Œäº‹åŠ¡ä¸­æ–­çš„å¤„ç†ï¼Œè¿™æ ·èƒ½ <strong>å‡å°‘åŒæ­¥é˜»å¡çš„æ—¶é—´</strong> ã€‚è¿˜æœ‰éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**<code>3PC</code> åœ¨ <code>DoCommit</code> é˜¶æ®µå‚ä¸è€…å¦‚æœªæ”¶åˆ°åè°ƒè€…å‘é€çš„æäº¤äº‹åŠ¡çš„è¯·æ±‚ï¼Œå®ƒä¼šåœ¨ä¸€å®šæ—¶é—´å†…è¿›è¡Œäº‹åŠ¡çš„æäº¤<strong>ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿæ˜¯å› ä¸ºè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è‚¯å®š</strong>ä¿è¯äº†åœ¨ç¬¬ä¸€é˜¶æ®µæ‰€æœ‰çš„åè°ƒè€…å…¨éƒ¨è¿”å›äº†å¯ä»¥æ‰§è¡Œäº‹åŠ¡çš„å“åº”<strong>ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æœ‰ç†ç”±</strong>ç›¸ä¿¡å…¶ä»–ç³»ç»Ÿéƒ½èƒ½è¿›è¡Œäº‹åŠ¡çš„æ‰§è¡Œå’Œæäº¤<strong>ï¼Œæ‰€ä»¥</strong>ä¸ç®¡**åè°ƒè€…æœ‰æ²¡æœ‰å‘æ¶ˆæ¯ç»™å‚ä¸è€…ï¼Œè¿›å…¥ç¬¬ä¸‰é˜¶æ®µå‚ä¸è€…éƒ½ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤æ“ä½œã€‚</p>
</blockquote>
<p>æ€»ä¹‹ï¼Œ<code>3PC</code> é€šè¿‡ä¸€ç³»åˆ—çš„è¶…æ—¶æœºåˆ¶å¾ˆå¥½çš„ç¼“è§£äº†é˜»å¡é—®é¢˜ï¼Œä½†æ˜¯æœ€é‡è¦çš„ä¸€è‡´æ€§å¹¶æ²¡æœ‰å¾—åˆ°æ ¹æœ¬çš„è§£å†³ï¼Œæ¯”å¦‚åœ¨ <code>DoCommit</code> é˜¶æ®µï¼Œå½“ä¸€ä¸ªå‚ä¸è€…æ”¶åˆ°äº†è¯·æ±‚ä¹‹åå…¶ä»–å‚ä¸è€…å’Œåè°ƒè€…æŒ‚äº†æˆ–è€…å‡ºç°äº†ç½‘ç»œåˆ†åŒºï¼Œè¿™ä¸ªæ—¶å€™æ”¶åˆ°æ¶ˆæ¯çš„å‚ä¸è€…éƒ½ä¼šè¿›è¡Œäº‹åŠ¡æäº¤ï¼Œè¿™å°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
<p>æ‰€ä»¥ï¼Œè¦è§£å†³ä¸€è‡´æ€§é—®é¢˜è¿˜éœ€è¦é  <code>Paxos</code> ç®—æ³• â­ï¸ â­ï¸ â­ï¸ ã€‚</p>
<h3 id="Paxos-ç®—æ³•"><a href="#Paxos-ç®—æ³•" class="headerlink" title="Paxos ç®—æ³•"></a><code>Paxos</code> ç®—æ³•</h3><p><code>Paxos</code> ç®—æ³•æ˜¯åŸºäº<strong>æ¶ˆæ¯ä¼ é€’ä¸”å…·æœ‰é«˜åº¦å®¹é”™ç‰¹æ€§çš„ä¸€è‡´æ€§ç®—æ³•</strong>ï¼Œæ˜¯ç›®å‰å…¬è®¤çš„è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜æœ€æœ‰æ•ˆçš„ç®—æ³•ä¹‹ä¸€ï¼Œ<strong>å…¶è§£å†³çš„é—®é¢˜å°±æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¦‚ä½•å°±æŸä¸ªå€¼ï¼ˆå†³è®®ï¼‰è¾¾æˆä¸€è‡´</strong> ã€‚</p>
<p>åœ¨ <code>Paxos</code> ä¸­ä¸»è¦æœ‰ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«ä¸º <code>Proposerææ¡ˆè€…</code>ã€<code>Acceptorè¡¨å†³è€…</code>ã€<code>Learnerå­¦ä¹ è€…</code>ã€‚<code>Paxos</code> ç®—æ³•å’Œ <code>2PC</code> ä¸€æ ·ï¼Œä¹Ÿæœ‰ä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸º <code>Prepare</code> å’Œ <code>accept</code> é˜¶æ®µã€‚</p>
<h4 id="prepare-é˜¶æ®µ"><a href="#prepare-é˜¶æ®µ" class="headerlink" title="prepare é˜¶æ®µ"></a>prepare é˜¶æ®µ</h4><ul>
<li><code>Proposerææ¡ˆè€…</code>ï¼šè´Ÿè´£æå‡º <code>proposal</code>ï¼Œæ¯ä¸ªææ¡ˆè€…åœ¨æå‡ºææ¡ˆæ—¶éƒ½ä¼šé¦–å…ˆè·å–åˆ°ä¸€ä¸ª <strong>å…·æœ‰å…¨å±€å”¯ä¸€æ€§çš„ã€é€’å¢çš„ææ¡ˆç¼–å· N</strong>ï¼Œå³åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æ˜¯å”¯ä¸€çš„ç¼–å· Nï¼Œç„¶åå°†è¯¥ç¼–å·èµ‹äºˆå…¶è¦æå‡ºçš„ææ¡ˆï¼Œåœ¨<strong>ç¬¬ä¸€é˜¶æ®µæ˜¯åªå°†ææ¡ˆç¼–å·å‘é€ç»™æ‰€æœ‰çš„è¡¨å†³è€…</strong>ã€‚</li>
<li><code>Acceptorè¡¨å†³è€…</code>ï¼šæ¯ä¸ªè¡¨å†³è€…åœ¨ <code>accept</code> æŸææ¡ˆåï¼Œä¼šå°†è¯¥ææ¡ˆç¼–å· N è®°å½•åœ¨æœ¬åœ°ï¼Œè¿™æ ·æ¯ä¸ªè¡¨å†³è€…ä¸­ä¿å­˜çš„å·²ç»è¢« accept çš„ææ¡ˆä¸­ä¼šå­˜åœ¨ä¸€ä¸ª<strong>ç¼–å·æœ€å¤§çš„ææ¡ˆ</strong>ï¼Œå…¶ç¼–å·å‡è®¾ä¸º <code>maxN</code>ã€‚æ¯ä¸ªè¡¨å†³è€…ä»…ä¼š <code>accept</code> ç¼–å·å¤§äºè‡ªå·±æœ¬åœ° <code>maxN</code> çš„ææ¡ˆï¼Œåœ¨æ‰¹å‡†ææ¡ˆæ—¶è¡¨å†³è€…ä¼šå°†ä»¥å‰æ¥å—è¿‡çš„æœ€å¤§ç¼–å·çš„ææ¡ˆä½œä¸ºå“åº”åé¦ˆç»™ <code>Proposer</code> ã€‚</li>
</ul>
<blockquote>
<p>ä¸‹é¢æ˜¯ <code>prepare</code> é˜¶æ®µçš„æµç¨‹å›¾ï¼Œä½ å¯ä»¥å¯¹ç…§ç€å‚è€ƒä¸€ä¸‹ã€‚</p>
</blockquote>
<p><img src="https://oss.javaguide.cn/p3-juejin/cd1e5f78875b4ad6b54013738f570943~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="paxosç¬¬ä¸€é˜¶æ®µ"></p>
<h4 id="accept-é˜¶æ®µ"><a href="#accept-é˜¶æ®µ" class="headerlink" title="accept é˜¶æ®µ"></a>accept é˜¶æ®µ</h4><p>å½“ä¸€ä¸ªææ¡ˆè¢« <code>Proposer</code> æå‡ºåï¼Œå¦‚æœ <code>Proposer</code> æ”¶åˆ°äº†è¶…è¿‡åŠæ•°çš„ <code>Acceptor</code> çš„æ‰¹å‡†ï¼ˆ<code>Proposer</code> æœ¬èº«åŒæ„ï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶ <code>Proposer</code> ä¼šç»™æ‰€æœ‰çš„ <code>Acceptor</code> å‘é€çœŸæ­£çš„ææ¡ˆï¼ˆä½ å¯ä»¥ç†è§£ä¸ºç¬¬ä¸€é˜¶æ®µä¸ºè¯•æ¢ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™ <code>Proposer</code> å°±ä¼šå‘é€ææ¡ˆçš„å†…å®¹å’Œææ¡ˆç¼–å·ã€‚</p>
<p>è¡¨å†³è€…æ”¶åˆ°ææ¡ˆè¯·æ±‚åä¼šå†æ¬¡æ¯”è¾ƒæœ¬èº«å·²ç»æ‰¹å‡†è¿‡çš„æœ€å¤§ææ¡ˆç¼–å·å’Œè¯¥ææ¡ˆç¼–å·ï¼Œå¦‚æœè¯¥ææ¡ˆç¼–å· <strong>å¤§äºç­‰äº</strong> å·²ç»æ‰¹å‡†è¿‡çš„æœ€å¤§ææ¡ˆç¼–å·ï¼Œé‚£ä¹ˆå°± <code>accept</code> è¯¥ææ¡ˆï¼ˆæ­¤æ—¶æ‰§è¡Œææ¡ˆå†…å®¹ä½†ä¸æäº¤ï¼‰ï¼Œéšåå°†æƒ…å†µè¿”å›ç»™ <code>Proposer</code> ã€‚å¦‚æœä¸æ»¡è¶³åˆ™ä¸å›åº”æˆ–è€…è¿”å› NO ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/dad7f51d58b24a72b249278502ec04bd~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="paxosç¬¬äºŒé˜¶æ®µ1"></p>
<p>å½“ <code>Proposer</code> æ”¶åˆ°è¶…è¿‡åŠæ•°çš„ <code>accept</code> ï¼Œé‚£ä¹ˆå®ƒè¿™ä¸ªæ—¶å€™ä¼šå‘æ‰€æœ‰çš„ <code>acceptor</code> å‘é€ææ¡ˆçš„æäº¤è¯·æ±‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºä¸Šè¿°ä»…ä»…æ˜¯è¶…è¿‡åŠæ•°çš„ <code>acceptor</code> æ‰¹å‡†æ‰§è¡Œäº†è¯¥ææ¡ˆå†…å®¹ï¼Œå…¶ä»–æ²¡æœ‰æ‰¹å‡†çš„å¹¶æ²¡æœ‰æ‰§è¡Œè¯¥ææ¡ˆå†…å®¹ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™éœ€è¦<strong>å‘æœªæ‰¹å‡†çš„ <code>acceptor</code> å‘é€ææ¡ˆå†…å®¹å’Œææ¡ˆç¼–å·å¹¶è®©å®ƒæ— æ¡ä»¶æ‰§è¡Œå’Œæäº¤</strong>ï¼Œè€Œå¯¹äºå‰é¢å·²ç»æ‰¹å‡†è¿‡è¯¥ææ¡ˆçš„ <code>acceptor</code> æ¥è¯´ <strong>ä»…ä»…éœ€è¦å‘é€è¯¥ææ¡ˆçš„ç¼–å·</strong> ï¼Œè®© <code>acceptor</code> æ‰§è¡Œæäº¤å°±è¡Œäº†ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/9359bbabb511472e8de04d0826967996~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="paxosç¬¬äºŒé˜¶æ®µ2"></p>
<p>è€Œå¦‚æœ <code>Proposer</code> å¦‚æœæ²¡æœ‰æ”¶åˆ°è¶…è¿‡åŠæ•°çš„ <code>accept</code> é‚£ä¹ˆå®ƒå°†ä¼šå°† <strong>é€’å¢</strong> è¯¥ <code>Proposal</code> çš„ç¼–å·ï¼Œç„¶å <strong>é‡æ–°è¿›å…¥ <code>Prepare</code> é˜¶æ®µ</strong> ã€‚</p>
<blockquote>
<p>å¯¹äº <code>Learner</code> æ¥è¯´å¦‚ä½•å»å­¦ä¹  <code>Acceptor</code> æ‰¹å‡†çš„ææ¡ˆå†…å®¹ï¼Œè¿™æœ‰å¾ˆå¤šæ–¹å¼ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å»äº†è§£ä¸€ä¸‹ï¼Œè¿™é‡Œä¸åšè¿‡å¤šè§£é‡Šã€‚</p>
</blockquote>
<h4 id="paxos-ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜"><a href="#paxos-ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜" class="headerlink" title="paxos ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜"></a>paxos ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜</h4><p>å…¶å®å°±æœ‰ç‚¹ç±»ä¼¼äºä¸¤ä¸ªäººåµæ¶ï¼Œå°æ˜è¯´æˆ‘æ˜¯å¯¹çš„ï¼Œå°çº¢è¯´æˆ‘æ‰æ˜¯å¯¹çš„ï¼Œä¸¤ä¸ªäººæ®ç†åŠ›äº‰çš„è°ä¹Ÿä¸è®©è° ğŸ¤¬ğŸ¤¬ã€‚</p>
<p>æ¯”å¦‚è¯´ï¼Œæ­¤æ—¶ææ¡ˆè€… P1 æå‡ºä¸€ä¸ªæ–¹æ¡ˆ M1ï¼Œå®Œæˆäº† <code>Prepare</code> é˜¶æ®µçš„å·¥ä½œï¼Œè¿™ä¸ªæ—¶å€™ <code>acceptor</code> åˆ™æ‰¹å‡†äº† M1ï¼Œä½†æ˜¯æ­¤æ—¶ææ¡ˆè€… P2 åŒæ—¶ä¹Ÿæå‡ºäº†ä¸€ä¸ªæ–¹æ¡ˆ M2ï¼Œå®ƒä¹Ÿå®Œæˆäº† <code>Prepare</code> é˜¶æ®µçš„å·¥ä½œã€‚ç„¶å P1 çš„æ–¹æ¡ˆå·²ç»ä¸èƒ½åœ¨ç¬¬äºŒé˜¶æ®µè¢«æ‰¹å‡†äº†ï¼ˆå› ä¸º <code>acceptor</code> å·²ç»æ‰¹å‡†äº†æ¯” M1 æ›´å¤§çš„ M2ï¼‰ï¼Œæ‰€ä»¥ P1 è‡ªå¢æ–¹æ¡ˆå˜ä¸º M3 é‡æ–°è¿›å…¥ <code>Prepare</code> é˜¶æ®µï¼Œç„¶å <code>acceptor</code> ï¼Œåˆæ‰¹å‡†äº†æ–°çš„ M3 æ–¹æ¡ˆï¼Œå®ƒåˆä¸èƒ½æ‰¹å‡† M2 äº†ï¼Œè¿™ä¸ªæ—¶å€™ M2 åˆè‡ªå¢è¿›å…¥ <code>Prepare</code> é˜¶æ®µã€‚ã€‚ã€‚</p>
<p>å°±è¿™æ ·æ— ä¼‘æ— æ­¢çš„æ°¸è¿œææ¡ˆä¸‹å»ï¼Œè¿™å°±æ˜¯ <code>paxos</code> ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/bc3d45941abf4fca903f7f4b69405abf~tplv-k3u1fbpfcp-zoom-1.jpeg"></p>
<p>é‚£ä¹ˆå¦‚ä½•è§£å†³å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œäººå¤šäº†å®¹æ˜“åµæ¶ï¼Œæˆ‘ç°åœ¨ <strong>å°±å…è®¸ä¸€ä¸ªèƒ½ææ¡ˆ</strong> å°±è¡Œäº†ã€‚</p>
<h2 id="å¼•å‡º-ZAB"><a href="#å¼•å‡º-ZAB" class="headerlink" title="å¼•å‡º ZAB"></a>å¼•å‡º ZAB</h2><h3 id="Zookeeper-æ¶æ„"><a href="#Zookeeper-æ¶æ„" class="headerlink" title="Zookeeper æ¶æ„"></a>Zookeeper æ¶æ„</h3><p>ä½œä¸ºä¸€ä¸ªä¼˜ç§€é«˜æ•ˆä¸”å¯é çš„åˆ†å¸ƒå¼åè°ƒæ¡†æ¶ï¼Œ<code>ZooKeeper</code> åœ¨è§£å†³åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§é—®é¢˜æ—¶å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨ <code>Paxos</code> ï¼Œè€Œæ˜¯ä¸“é—¨å®šåˆ¶äº†ä¸€è‡´æ€§åè®®å«åš <code>ZAB(ZooKeeper Atomic Broadcast)</code> åŸå­å¹¿æ’­åè®®ï¼Œè¯¥åè®®èƒ½å¤Ÿå¾ˆå¥½åœ°æ”¯æŒ <strong>å´©æºƒæ¢å¤</strong> ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/07bf6c1e10f84fc58a2453766ca6bd18~tplv-k3u1fbpfcp-zoom-1.png" alt="Zookeeperæ¶æ„"></p>
<h3 id="ZAB-ä¸­çš„ä¸‰ä¸ªè§’è‰²"><a href="#ZAB-ä¸­çš„ä¸‰ä¸ªè§’è‰²" class="headerlink" title="ZAB ä¸­çš„ä¸‰ä¸ªè§’è‰²"></a>ZAB ä¸­çš„ä¸‰ä¸ªè§’è‰²</h3><p>å’Œä»‹ç» <code>Paxos</code> ä¸€æ ·ï¼Œåœ¨ä»‹ç» <code>ZAB</code> åè®®ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹åœ¨ <code>ZAB</code> ä¸­ä¸‰ä¸ªä¸»è¦çš„è§’è‰²ï¼Œ<code>Leader é¢†å¯¼è€…</code>ã€<code>Followerè·Ÿéšè€…</code>ã€<code>Observerè§‚å¯Ÿè€…</code> ã€‚</p>
<ul>
<li><code>Leader</code>ï¼šé›†ç¾¤ä¸­ <strong>å”¯ä¸€çš„å†™è¯·æ±‚å¤„ç†è€…</strong> ï¼Œèƒ½å¤Ÿå‘èµ·æŠ•ç¥¨ï¼ˆæŠ•ç¥¨ä¹Ÿæ˜¯ä¸ºäº†è¿›è¡Œå†™è¯·æ±‚ï¼‰ã€‚</li>
<li><code>Follower</code>ï¼šèƒ½å¤Ÿæ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¦‚æœæ˜¯è¯»è¯·æ±‚åˆ™å¯ä»¥è‡ªå·±å¤„ç†ï¼Œ<strong>å¦‚æœæ˜¯å†™è¯·æ±‚åˆ™è¦è½¬å‘ç»™ <code>Leader</code></strong> ã€‚åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­ä¼šå‚ä¸æŠ•ç¥¨ï¼Œ<strong>æœ‰é€‰ä¸¾æƒå’Œè¢«é€‰ä¸¾æƒ</strong> ã€‚</li>
<li><code>Observer</code>ï¼šå°±æ˜¯æ²¡æœ‰é€‰ä¸¾æƒå’Œè¢«é€‰ä¸¾æƒçš„ <code>Follower</code> ã€‚</li>
</ul>
<p>åœ¨ <code>ZAB</code> åè®®ä¸­å¯¹ <code>zkServer</code>(å³ä¸Šé¢æˆ‘ä»¬è¯´çš„ä¸‰ä¸ªè§’è‰²çš„æ€»ç§°) è¿˜æœ‰ä¸¤ç§æ¨¡å¼çš„å®šä¹‰ï¼Œåˆ†åˆ«æ˜¯ <strong>æ¶ˆæ¯å¹¿æ’­</strong> å’Œ <strong>å´©æºƒæ¢å¤</strong> ã€‚</p>
<h3 id="æ¶ˆæ¯å¹¿æ’­æ¨¡å¼"><a href="#æ¶ˆæ¯å¹¿æ’­æ¨¡å¼" class="headerlink" title="æ¶ˆæ¯å¹¿æ’­æ¨¡å¼"></a>æ¶ˆæ¯å¹¿æ’­æ¨¡å¼</h3><p>è¯´ç™½äº†å°±æ˜¯ <code>ZAB</code> åè®®æ˜¯å¦‚ä½•å¤„ç†å†™è¯·æ±‚çš„ï¼Œä¸Šé¢æˆ‘ä»¬ä¸æ˜¯è¯´åªæœ‰ <code>Leader</code> èƒ½å¤„ç†å†™è¯·æ±‚å˜›ï¼Ÿé‚£ä¹ˆæˆ‘ä»¬çš„ <code>Follower</code> å’Œ <code>Observer</code> æ˜¯ä¸æ˜¯ä¹Ÿéœ€è¦ <strong>åŒæ­¥æ›´æ–°æ•°æ®</strong> å‘¢ï¼Ÿæ€»ä¸èƒ½æ•°æ®åªåœ¨ <code>Leader</code> ä¸­æ›´æ–°äº†ï¼Œå…¶ä»–è§’è‰²éƒ½æ²¡æœ‰å¾—åˆ°æ›´æ–°å§ï¼Ÿ</p>
<p>ä¸å°±æ˜¯ <strong>åœ¨æ•´ä¸ªé›†ç¾¤ä¸­ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§</strong> å˜›ï¼Ÿå¦‚æœæ˜¯ä½ ï¼Œä½ ä¼šæ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<p>åºŸè¯ï¼Œç¬¬ä¸€æ­¥è‚¯å®šéœ€è¦ <code>Leader</code> å°†å†™è¯·æ±‚ <strong>å¹¿æ’­</strong> å‡ºå»å‘€ï¼Œè®© <code>Leader</code> é—®é—® <code>Followers</code> æ˜¯å¦åŒæ„æ›´æ–°ï¼Œå¦‚æœè¶…è¿‡åŠæ•°ä»¥ä¸Šçš„åŒæ„é‚£ä¹ˆå°±è¿›è¡Œ <code>Follower</code> å’Œ <code>Observer</code> çš„æ›´æ–°ï¼ˆå’Œ <code>Paxos</code> ä¸€æ ·ï¼‰ã€‚å½“ç„¶è¿™ä¹ˆè¯´æœ‰ç‚¹è™šï¼Œç”»å¼ å›¾ç†è§£ä¸€ä¸‹ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/b64c7f25a5d24766889da14260005e31~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="æ¶ˆæ¯å¹¿æ’­"></p>
<p>å—¯ã€‚ã€‚ã€‚çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œè²Œä¼¼æ‡‚äº† ğŸ¤¥ğŸ¤¥ğŸ¤¥ã€‚è¿™ä¸¤ä¸ª <code>Queue</code> å“ªå†’å‡ºæ¥çš„ï¼Ÿç­”æ¡ˆæ˜¯ <strong><code>ZAB</code> éœ€è¦è®© <code>Follower</code> å’Œ <code>Observer</code> ä¿è¯é¡ºåºæ€§</strong> ã€‚ä½•ä¸ºé¡ºåºæ€§ï¼Œæ¯”å¦‚æˆ‘ç°åœ¨æœ‰ä¸€ä¸ªå†™è¯·æ±‚ Aï¼Œæ­¤æ—¶ <code>Leader</code> å°†è¯·æ±‚ A å¹¿æ’­å‡ºå»ï¼Œå› ä¸ºåªéœ€è¦åŠæ•°åŒæ„å°±è¡Œï¼Œæ‰€ä»¥å¯èƒ½è¿™ä¸ªæ—¶å€™æœ‰ä¸€ä¸ª <code>Follower</code> F1 å› ä¸ºç½‘ç»œåŸå› æ²¡æœ‰æ”¶åˆ°ï¼Œè€Œ <code>Leader</code> åˆå¹¿æ’­äº†ä¸€ä¸ªè¯·æ±‚ Bï¼Œå› ä¸ºç½‘ç»œåŸå› ï¼ŒF1 ç«Ÿç„¶å…ˆæ”¶åˆ°äº†è¯·æ±‚ B ç„¶åæ‰æ”¶åˆ°äº†è¯·æ±‚ Aï¼Œè¿™ä¸ªæ—¶å€™è¯·æ±‚å¤„ç†çš„é¡ºåºä¸åŒå°±ä¼šå¯¼è‡´æ•°æ®çš„ä¸åŒï¼Œä»è€Œ <strong>äº§ç”Ÿæ•°æ®ä¸ä¸€è‡´é—®é¢˜</strong> ã€‚</p>
<p>æ‰€ä»¥åœ¨ <code>Leader</code> è¿™ç«¯ï¼Œå®ƒä¸ºæ¯ä¸ªå…¶ä»–çš„ <code>zkServer</code> å‡†å¤‡äº†ä¸€ä¸ª <strong>é˜Ÿåˆ—</strong> ï¼Œé‡‡ç”¨å…ˆè¿›å…ˆå‡ºçš„æ–¹å¼å‘é€æ¶ˆæ¯ã€‚ç”±äºåè®®æ˜¯ <strong>é€šè¿‡ <code>TCP</code></strong> æ¥è¿›è¡Œç½‘ç»œé€šä¿¡çš„ï¼Œä¿è¯äº†æ¶ˆæ¯çš„å‘é€é¡ºåºæ€§ï¼Œæ¥å—é¡ºåºæ€§ä¹Ÿå¾—åˆ°äº†ä¿è¯ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨ <code>ZAB</code> ä¸­è¿˜å®šä¹‰äº†ä¸€ä¸ª <strong>å…¨å±€å•è°ƒé€’å¢çš„äº‹åŠ¡ ID <code>ZXID</code></strong> ï¼Œå®ƒæ˜¯ä¸€ä¸ª 64 ä½ long å‹ï¼Œå…¶ä¸­é«˜ 32 ä½è¡¨ç¤º <code>epoch</code> å¹´ä»£ï¼Œä½ 32 ä½è¡¨ç¤ºäº‹åŠ¡ idã€‚<code>epoch</code> æ˜¯ä¼šæ ¹æ® <code>Leader</code> çš„å˜åŒ–è€Œå˜åŒ–çš„ï¼Œå½“ä¸€ä¸ª <code>Leader</code> æŒ‚äº†ï¼Œæ–°çš„ <code>Leader</code> ä¸Šä½çš„æ—¶å€™ï¼Œå¹´ä»£ï¼ˆ<code>epoch</code>ï¼‰å°±å˜äº†ã€‚è€Œä½ 32 ä½å¯ä»¥ç®€å•ç†è§£ä¸ºé€’å¢çš„äº‹åŠ¡ idã€‚</p>
<p>å®šä¹‰è¿™ä¸ªçš„åŸå› ä¹Ÿæ˜¯ä¸ºäº†é¡ºåºæ€§ï¼Œæ¯ä¸ª <code>proposal</code> åœ¨ <code>Leader</code> ä¸­ç”Ÿæˆåéœ€è¦ <strong>é€šè¿‡å…¶ <code>ZXID</code> æ¥è¿›è¡Œæ’åº</strong> ï¼Œæ‰èƒ½å¾—åˆ°å¤„ç†ã€‚</p>
<h3 id="å´©æºƒæ¢å¤æ¨¡å¼"><a href="#å´©æºƒæ¢å¤æ¨¡å¼" class="headerlink" title="å´©æºƒæ¢å¤æ¨¡å¼"></a>å´©æºƒæ¢å¤æ¨¡å¼</h3><p>è¯´åˆ°å´©æºƒæ¢å¤æˆ‘ä»¬é¦–å…ˆè¦æåˆ° <code>ZAB</code> ä¸­çš„ <code>Leader</code> é€‰ä¸¾ç®—æ³•ï¼Œå½“ç³»ç»Ÿå‡ºç°å´©æºƒå½±å“æœ€å¤§åº”è¯¥æ˜¯ <code>Leader</code> çš„å´©æºƒï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰ä¸€ä¸ª <code>Leader</code> ï¼Œæ‰€ä»¥å½“ <code>Leader</code> å‡ºç°é—®é¢˜çš„æ—¶å€™æˆ‘ä»¬åŠ¿å¿…éœ€è¦é‡æ–°é€‰ä¸¾ <code>Leader</code> ã€‚</p>
<p><code>Leader</code> é€‰ä¸¾å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªä¸åŒçš„é˜¶æ®µï¼Œç¬¬ä¸€ä¸ªæ˜¯æˆ‘ä»¬æåˆ°çš„ <code>Leader</code> å®•æœºéœ€è¦é‡æ–°é€‰ä¸¾ï¼Œç¬¬äºŒåˆ™æ˜¯å½“ <code>Zookeeper</code> å¯åŠ¨æ—¶éœ€è¦è¿›è¡Œç³»ç»Ÿçš„ <code>Leader</code> åˆå§‹åŒ–é€‰ä¸¾ã€‚ä¸‹é¢æˆ‘å…ˆæ¥ä»‹ç»ä¸€ä¸‹ <code>ZAB</code> æ˜¯å¦‚ä½•è¿›è¡Œåˆå§‹åŒ–é€‰ä¸¾çš„ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬é›†ç¾¤ä¸­æœ‰ 3 å°æœºå™¨ï¼Œé‚£ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¸¤å°ä»¥ä¸ŠåŒæ„ï¼ˆè¶…è¿‡åŠæ•°ï¼‰ã€‚æ¯”å¦‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯åŠ¨äº† <code>server1</code> ï¼Œå®ƒä¼šé¦–å…ˆ <strong>æŠ•ç¥¨ç»™è‡ªå·±</strong> ï¼ŒæŠ•ç¥¨å†…å®¹ä¸ºæœåŠ¡å™¨çš„ <code>myid</code> å’Œ <code>ZXID</code> ï¼Œå› ä¸ºåˆå§‹åŒ–æ‰€ä»¥ <code>ZXID</code> éƒ½ä¸º 0ï¼Œæ­¤æ—¶ <code>server1</code> å‘å‡ºçš„æŠ•ç¥¨ä¸º (1,0)ã€‚ä½†æ­¤æ—¶ <code>server1</code> çš„æŠ•ç¥¨ä»…ä¸º 1ï¼Œæ‰€ä»¥ä¸èƒ½ä½œä¸º <code>Leader</code> ï¼Œæ­¤æ—¶è¿˜åœ¨é€‰ä¸¾é˜¶æ®µæ‰€ä»¥æ•´ä¸ªé›†ç¾¤å¤„äº <strong><code>Looking</code> çŠ¶æ€</strong>ã€‚</p>
<p>æ¥ç€ <code>server2</code> å¯åŠ¨äº†ï¼Œå®ƒé¦–å…ˆä¹Ÿä¼šå°†æŠ•ç¥¨é€‰ç»™è‡ªå·±(2,0)ï¼Œå¹¶å°†æŠ•ç¥¨ä¿¡æ¯å¹¿æ’­å‡ºå»ï¼ˆ<code>server1</code>ä¹Ÿä¼šï¼Œåªæ˜¯å®ƒé‚£æ—¶æ²¡æœ‰å…¶ä»–çš„æœåŠ¡å™¨äº†ï¼‰ï¼Œ<code>server1</code> åœ¨æ”¶åˆ° <code>server2</code> çš„æŠ•ç¥¨ä¿¡æ¯åä¼šå°†æŠ•ç¥¨ä¿¡æ¯ä¸è‡ªå·±çš„ä½œæ¯”è¾ƒã€‚**é¦–å…ˆå®ƒä¼šæ¯”è¾ƒ <code>ZXID</code> ï¼Œ<code>ZXID</code> å¤§çš„ä¼˜å…ˆä¸º <code>Leader</code>ï¼Œå¦‚æœç›¸åŒåˆ™æ¯”è¾ƒ <code>myid</code>ï¼Œ<code>myid</code> å¤§çš„ä¼˜å…ˆä½œä¸º <code>Leader</code>**ã€‚æ‰€ä»¥æ­¤æ—¶<code>server1</code> å‘ç° <code>server2</code> æ›´é€‚åˆåš <code>Leader</code>ï¼Œå®ƒå°±ä¼šå°†è‡ªå·±çš„æŠ•ç¥¨ä¿¡æ¯æ›´æ”¹ä¸º(2,0)ç„¶åå†å¹¿æ’­å‡ºå»ï¼Œä¹‹å<code>server2</code> æ”¶åˆ°ä¹‹åå‘ç°å’Œè‡ªå·±çš„ä¸€æ ·æ— éœ€åšæ›´æ”¹ï¼Œå¹¶ä¸”è‡ªå·±çš„ <strong>æŠ•ç¥¨å·²ç»è¶…è¿‡åŠæ•°</strong> ï¼Œåˆ™ **ç¡®å®š <code>server2</code> ä¸º <code>Leader</code>**ï¼Œ<code>server1</code> ä¹Ÿä¼šå°†è‡ªå·±æœåŠ¡å™¨è®¾ç½®ä¸º <code>Following</code> å˜ä¸º <code>Follower</code>ã€‚æ•´ä¸ªæœåŠ¡å™¨å°±ä» <code>Looking</code> å˜ä¸ºäº†æ­£å¸¸çŠ¶æ€ã€‚</p>
<p>å½“ <code>server3</code> å¯åŠ¨å‘ç°é›†ç¾¤æ²¡æœ‰å¤„äº <code>Looking</code> çŠ¶æ€æ—¶ï¼Œå®ƒä¼šç›´æ¥ä»¥ <code>Follower</code> çš„èº«ä»½åŠ å…¥é›†ç¾¤ã€‚</p>
<p>è¿˜æ˜¯å‰é¢ä¸‰ä¸ª <code>server</code> çš„ä¾‹å­ï¼Œå¦‚æœåœ¨æ•´ä¸ªé›†ç¾¤è¿è¡Œçš„è¿‡ç¨‹ä¸­ <code>server2</code> æŒ‚äº†ï¼Œé‚£ä¹ˆæ•´ä¸ªé›†ç¾¤ä¼šå¦‚ä½•é‡æ–°é€‰ä¸¾ <code>Leader</code> å‘¢ï¼Ÿå…¶å®å’Œåˆå§‹åŒ–é€‰ä¸¾å·®ä¸å¤šã€‚</p>
<p>é¦–å…ˆæ¯«æ— ç–‘é—®çš„æ˜¯å‰©ä¸‹çš„ä¸¤ä¸ª <code>Follower</code> ä¼šå°†è‡ªå·±çš„çŠ¶æ€ <strong>ä» <code>Following</code> å˜ä¸º <code>Looking</code> çŠ¶æ€</strong> ï¼Œç„¶åæ¯ä¸ª <code>server</code> ä¼šå‘åˆå§‹åŒ–æŠ•ç¥¨ä¸€æ ·é¦–å…ˆç»™è‡ªå·±æŠ•ç¥¨ï¼ˆè¿™ä¸è¿‡è¿™é‡Œçš„ <code>zxid</code> å¯èƒ½ä¸æ˜¯ 0 äº†ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿éšä¾¿å–ä¸ªæ•°å­—ï¼‰ã€‚</p>
<p>å‡è®¾ <code>server1</code> ç»™è‡ªå·±æŠ•ç¥¨ä¸º(1,99)ï¼Œç„¶åå¹¿æ’­ç»™å…¶ä»– <code>server</code>ï¼Œ<code>server3</code> é¦–å…ˆä¹Ÿä¼šç»™è‡ªå·±æŠ•ç¥¨(3,95)ï¼Œç„¶åä¹Ÿå¹¿æ’­ç»™å…¶ä»– <code>server</code>ã€‚<code>server1</code> å’Œ <code>server3</code> æ­¤æ—¶ä¼šæ”¶åˆ°å½¼æ­¤çš„æŠ•ç¥¨ä¿¡æ¯ï¼Œå’Œä¸€å¼€å§‹é€‰ä¸¾ä¸€æ ·ï¼Œä»–ä»¬ä¹Ÿä¼šæ¯”è¾ƒè‡ªå·±çš„æŠ•ç¥¨å’Œæ”¶åˆ°çš„æŠ•ç¥¨ï¼ˆ<code>zxid</code> å¤§çš„ä¼˜å…ˆï¼Œå¦‚æœç›¸åŒé‚£ä¹ˆå°± <code>myid</code> å¤§çš„ä¼˜å…ˆï¼‰ã€‚è¿™ä¸ªæ—¶å€™ <code>server1</code> æ”¶åˆ°äº† <code>server3</code> çš„æŠ•ç¥¨å‘ç°æ²¡è‡ªå·±çš„åˆé€‚æ•…ä¸å˜ï¼Œ<code>server3</code> æ”¶åˆ° <code>server1</code> çš„æŠ•ç¥¨ç»“æœåå‘ç°æ¯”è‡ªå·±çš„åˆé€‚äºæ˜¯æ›´æ”¹æŠ•ç¥¨ä¸º(1,99)ç„¶åå¹¿æ’­å‡ºå»ï¼Œæœ€å <code>server1</code> æ”¶åˆ°äº†å‘ç°è‡ªå·±çš„æŠ•ç¥¨å·²ç»è¶…è¿‡åŠæ•°å°±æŠŠè‡ªå·±è®¾ä¸º <code>Leader</code>ï¼Œ<code>server3</code> ä¹Ÿéšä¹‹å˜ä¸º <code>Follower</code>ã€‚</p>
<blockquote>
<p>è¯·æ³¨æ„ <code>ZooKeeper</code> ä¸ºä»€ä¹ˆè¦è®¾ç½®å¥‡æ•°ä¸ªç»“ç‚¹ï¼Ÿæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬æ˜¯ä¸‰ä¸ªï¼ŒæŒ‚äº†ä¸€ä¸ªæˆ‘ä»¬è¿˜èƒ½æ­£å¸¸å·¥ä½œï¼ŒæŒ‚äº†ä¸¤ä¸ªæˆ‘ä»¬å°±ä¸èƒ½æ­£å¸¸å·¥ä½œäº†ï¼ˆå·²ç»æ²¡æœ‰è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹æ•°äº†ï¼Œæ‰€ä»¥æ— æ³•è¿›è¡ŒæŠ•ç¥¨ç­‰æ“ä½œäº†ï¼‰ã€‚è€Œå‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰å››ä¸ªï¼ŒæŒ‚äº†ä¸€ä¸ªä¹Ÿèƒ½å·¥ä½œï¼Œ<strong>ä½†æ˜¯æŒ‚äº†ä¸¤ä¸ªä¹Ÿä¸èƒ½æ­£å¸¸å·¥ä½œäº†</strong>ï¼Œè¿™æ˜¯å’Œä¸‰ä¸ªä¸€æ ·çš„ï¼Œè€Œä¸‰ä¸ªæ¯”å››ä¸ªè¿˜å°‘ä¸€ä¸ªï¼Œå¸¦æ¥çš„æ•ˆç›Šæ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ <code>Zookeeper</code> æ¨èå¥‡æ•°ä¸ª <code>server</code> ã€‚</p>
</blockquote>
<p>é‚£ä¹ˆè¯´å®Œäº† <code>ZAB</code> ä¸­çš„ <code>Leader</code> é€‰ä¸¾æ–¹å¼ä¹‹åæˆ‘ä»¬å†æ¥äº†è§£ä¸€ä¸‹ <strong>å´©æºƒæ¢å¤</strong> æ˜¯ä»€ä¹ˆç©æ„ï¼Ÿ</p>
<p>å…¶å®ä¸»è¦å°±æ˜¯ <strong>å½“é›†ç¾¤ä¸­æœ‰æœºå™¨æŒ‚äº†ï¼Œæˆ‘ä»¬æ•´ä¸ªé›†ç¾¤å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ</strong></p>
<p>å¦‚æœåªæ˜¯ <code>Follower</code> æŒ‚äº†ï¼Œè€Œä¸”æŒ‚çš„æ²¡è¶…è¿‡åŠæ•°çš„æ—¶å€™ï¼Œå› ä¸ºæˆ‘ä»¬ä¸€å¼€å§‹è®²äº†åœ¨ <code>Leader</code> ä¸­ä¼šç»´æŠ¤é˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒåé¢çš„æ•°æ®æ²¡æ¥æ”¶åˆ°å¯¼è‡´æ•°æ®ä¸ä¸€è‡´æ€§ã€‚</p>
<p>å¦‚æœ <code>Leader</code> æŒ‚äº†é‚£å°±éº»çƒ¦äº†ï¼Œæˆ‘ä»¬è‚¯å®šéœ€è¦å…ˆæš‚åœæœåŠ¡å˜ä¸º <code>Looking</code> çŠ¶æ€ç„¶åè¿›è¡Œ <code>Leader</code> çš„é‡æ–°é€‰ä¸¾ï¼ˆä¸Šé¢æˆ‘è®²è¿‡äº†ï¼‰ï¼Œä½†è¿™ä¸ªå°±è¦åˆ†ä¸ºä¸¤ç§æƒ…å†µäº†ï¼Œåˆ†åˆ«æ˜¯ <strong>ç¡®ä¿å·²ç»è¢« Leader æäº¤çš„ææ¡ˆæœ€ç»ˆèƒ½å¤Ÿè¢«æ‰€æœ‰çš„ Follower æäº¤</strong> å’Œ <strong>è·³è¿‡é‚£äº›å·²ç»è¢«ä¸¢å¼ƒçš„ææ¡ˆ</strong> ã€‚</p>
<p>ç¡®ä¿å·²ç»è¢« Leader æäº¤çš„ææ¡ˆæœ€ç»ˆèƒ½å¤Ÿè¢«æ‰€æœ‰çš„ Follower æäº¤æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p>
<p>å‡è®¾ <code>Leader (server2)</code> å‘é€ <code>commit</code> è¯·æ±‚ï¼ˆå¿˜äº†è¯·çœ‹ä¸Šé¢çš„æ¶ˆæ¯å¹¿æ’­æ¨¡å¼ï¼‰ï¼Œä»–å‘é€ç»™äº† <code>server3</code>ï¼Œç„¶åè¦å‘ç»™ <code>server1</code> çš„æ—¶å€™çªç„¶æŒ‚äº†ã€‚è¿™ä¸ªæ—¶å€™é‡æ–°é€‰ä¸¾çš„æ—¶å€™æˆ‘ä»¬å¦‚æœæŠŠ <code>server1</code> ä½œä¸º <code>Leader</code> çš„è¯ï¼Œé‚£ä¹ˆè‚¯å®šä¼šäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´æ€§ï¼Œå› ä¸º <code>server3</code> è‚¯å®šä¼šæäº¤åˆšåˆš <code>server2</code> å‘é€çš„ <code>commit</code> è¯·æ±‚çš„ææ¡ˆï¼Œè€Œ <code>server1</code> æ ¹æœ¬æ²¡æ”¶åˆ°æ‰€ä»¥ä¼šä¸¢å¼ƒã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/4b8365e80bdf441ea237847fb91236b7~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="å´©æºƒæ¢å¤"></p>
<p>é‚£æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p>
<p>èªæ˜çš„åŒå­¦è‚¯å®šä¼šè´¨ç–‘ï¼Œ<strong>è¿™ä¸ªæ—¶å€™ <code>server1</code> å·²ç»ä¸å¯èƒ½æˆä¸º <code>Leader</code> äº†ï¼Œå› ä¸º <code>server1</code> å’Œ <code>server3</code> è¿›è¡ŒæŠ•ç¥¨é€‰ä¸¾çš„æ—¶å€™ä¼šæ¯”è¾ƒ <code>ZXID</code> ï¼Œè€Œæ­¤æ—¶ <code>server3</code> çš„ <code>ZXID</code> è‚¯å®šæ¯” <code>server1</code> çš„å¤§äº†</strong>ã€‚(ä¸ç†è§£å¯ä»¥çœ‹å‰é¢çš„é€‰ä¸¾ç®—æ³•)</p>
<p>é‚£ä¹ˆè·³è¿‡é‚£äº›å·²ç»è¢«ä¸¢å¼ƒçš„ææ¡ˆåˆæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p>
<p>å‡è®¾ <code>Leader (server2)</code> æ­¤æ—¶åŒæ„äº†ææ¡ˆ N1ï¼Œè‡ªèº«æäº¤äº†è¿™ä¸ªäº‹åŠ¡å¹¶ä¸”è¦å‘é€ç»™æ‰€æœ‰ <code>Follower</code> è¦ <code>commit</code> çš„è¯·æ±‚ï¼Œå´åœ¨è¿™ä¸ªæ—¶å€™æŒ‚äº†ï¼Œæ­¤æ—¶è‚¯å®šè¦é‡æ–°è¿›è¡Œ <code>Leader</code> çš„é€‰ä¸¾ï¼Œæ¯”å¦‚è¯´æ­¤æ—¶é€‰ <code>server1</code> ä¸º <code>Leader</code> ï¼ˆè¿™æ— æ‰€è°“ï¼‰ã€‚ä½†æ˜¯è¿‡äº†ä¸€ä¼šï¼Œè¿™ä¸ª <strong>æŒ‚æ‰çš„ <code>Leader</code> åˆé‡æ–°æ¢å¤äº†</strong> ï¼Œæ­¤æ—¶å®ƒè‚¯å®šä¼šä½œä¸º <code>Follower</code> çš„èº«ä»½è¿›å…¥é›†ç¾¤ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åˆšåˆš <code>server2</code> å·²ç»åŒæ„æäº¤äº†ææ¡ˆ N1ï¼Œä½†å…¶ä»– <code>server</code> å¹¶æ²¡æœ‰æ”¶åˆ°å®ƒçš„ <code>commit</code> ä¿¡æ¯ï¼Œæ‰€ä»¥å…¶ä»– <code>server</code> ä¸å¯èƒ½å†æäº¤è¿™ä¸ªææ¡ˆ N1 äº†ï¼Œè¿™æ ·å°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜äº†ï¼Œæ‰€ä»¥ <strong>è¯¥ææ¡ˆ N1 æœ€ç»ˆéœ€è¦è¢«æŠ›å¼ƒæ‰</strong> ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/99cdca39ad6340ae8b77e8befe94e36e~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="å´©æºƒæ¢å¤"></p>
<h2 id="Zookeeper-çš„å‡ ä¸ªç†è®ºçŸ¥è¯†"><a href="#Zookeeper-çš„å‡ ä¸ªç†è®ºçŸ¥è¯†" class="headerlink" title="Zookeeper çš„å‡ ä¸ªç†è®ºçŸ¥è¯†"></a>Zookeeper çš„å‡ ä¸ªç†è®ºçŸ¥è¯†</h2><p>äº†è§£äº† <code>ZAB</code> åè®®è¿˜ä¸å¤Ÿï¼Œå®ƒä»…ä»…æ˜¯ <code>Zookeeper</code> å†…éƒ¨å®ç°çš„ä¸€ç§æ–¹å¼ï¼Œè€Œæˆ‘ä»¬å¦‚ä½•é€šè¿‡ <code>Zookeeper</code> å»åšä¸€äº›å…¸å‹çš„åº”ç”¨åœºæ™¯å‘¢ï¼Ÿæ¯”å¦‚è¯´é›†ç¾¤ç®¡ç†ï¼Œåˆ†å¸ƒå¼é”ï¼Œ<code>Master</code> é€‰ä¸¾ç­‰ç­‰ã€‚</p>
<p>è¿™å°±æ¶‰åŠåˆ°å¦‚ä½•ä½¿ç”¨ <code>Zookeeper</code> äº†ï¼Œä½†åœ¨ä½¿ç”¨ä¹‹å‰æˆ‘ä»¬è¿˜éœ€è¦æŒæ¡å‡ ä¸ªæ¦‚å¿µã€‚æ¯”å¦‚ <code>Zookeeper</code> çš„ <strong>æ•°æ®æ¨¡å‹</strong>ã€<strong>ä¼šè¯æœºåˆ¶</strong>ã€<strong>ACL</strong>ã€<strong>Watcher æœºåˆ¶</strong> ç­‰ç­‰ã€‚</p>
<h3 id="æ•°æ®æ¨¡å‹"><a href="#æ•°æ®æ¨¡å‹" class="headerlink" title="æ•°æ®æ¨¡å‹"></a>æ•°æ®æ¨¡å‹</h3><p><code>zookeeper</code> æ•°æ®å­˜å‚¨ç»“æ„ä¸æ ‡å‡†çš„ <code>Unix</code> æ–‡ä»¶ç³»ç»Ÿéå¸¸ç›¸ä¼¼ï¼Œéƒ½æ˜¯åœ¨æ ¹èŠ‚ç‚¹ä¸‹æŒ‚å¾ˆå¤šå­èŠ‚ç‚¹(æ ‘å‹)ã€‚ä½†æ˜¯ <code>zookeeper</code> ä¸­æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿä¸­ç›®å½•ä¸æ–‡ä»¶çš„æ¦‚å¿µï¼Œè€Œæ˜¯ <strong>ä½¿ç”¨äº† <code>znode</code> ä½œä¸ºæ•°æ®èŠ‚ç‚¹</strong> ã€‚<code>znode</code> æ˜¯ <code>zookeeper</code> ä¸­çš„æœ€å°æ•°æ®å•å…ƒï¼Œæ¯ä¸ª <code>znode</code> ä¸Šéƒ½å¯ä»¥ä¿å­˜æ•°æ®ï¼ŒåŒæ—¶è¿˜å¯ä»¥æŒ‚è½½å­èŠ‚ç‚¹ï¼Œå½¢æˆä¸€ä¸ªæ ‘å½¢åŒ–å‘½åç©ºé—´ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/663240470d524dd4ac6e68bde0b666eb~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="zkæ•°æ®æ¨¡å‹"></p>
<p>æ¯ä¸ª <code>znode</code> éƒ½æœ‰è‡ªå·±æ‰€å±çš„ <strong>èŠ‚ç‚¹ç±»å‹</strong> å’Œ <strong>èŠ‚ç‚¹çŠ¶æ€</strong>ã€‚</p>
<p>å…¶ä¸­èŠ‚ç‚¹ç±»å‹å¯ä»¥åˆ†ä¸º <strong>æŒä¹…èŠ‚ç‚¹</strong>ã€<strong>æŒä¹…é¡ºåºèŠ‚ç‚¹</strong>ã€<strong>ä¸´æ—¶èŠ‚ç‚¹</strong> å’Œ <strong>ä¸´æ—¶é¡ºåºèŠ‚ç‚¹</strong>ã€‚</p>
<ul>
<li>æŒä¹…èŠ‚ç‚¹ï¼šä¸€æ—¦åˆ›å»ºå°±ä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°å°†å…¶åˆ é™¤ã€‚</li>
<li>æŒä¹…é¡ºåºèŠ‚ç‚¹ï¼šä¸€ä¸ªçˆ¶èŠ‚ç‚¹å¯ä»¥ä¸ºå…¶å­èŠ‚ç‚¹ <strong>ç»´æŠ¤ä¸€ä¸ªåˆ›å»ºçš„å…ˆåé¡ºåº</strong> ï¼Œè¿™ä¸ªé¡ºåºä½“ç°åœ¨ <strong>èŠ‚ç‚¹åç§°</strong> ä¸Šï¼Œæ˜¯èŠ‚ç‚¹åç§°åè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªç”± 10 ä½æ•°å­—ç»„æˆçš„æ•°å­—ä¸²ï¼Œä» 0 å¼€å§‹è®¡æ•°ã€‚</li>
<li>ä¸´æ—¶èŠ‚ç‚¹ï¼šä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ <strong>å®¢æˆ·ç«¯ä¼šè¯</strong> ç»‘å®šçš„ï¼Œ<strong>ä¼šè¯æ¶ˆå¤±åˆ™èŠ‚ç‚¹æ¶ˆå¤±</strong> ã€‚ä¸´æ—¶èŠ‚ç‚¹ <strong>åªèƒ½åšå¶å­èŠ‚ç‚¹</strong> ï¼Œä¸èƒ½åˆ›å»ºå­èŠ‚ç‚¹ã€‚</li>
<li>ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼šçˆ¶èŠ‚ç‚¹å¯ä»¥åˆ›å»ºä¸€ä¸ªç»´æŒäº†é¡ºåºçš„ä¸´æ—¶èŠ‚ç‚¹(å’Œå‰é¢çš„æŒä¹…é¡ºåºæ€§èŠ‚ç‚¹ä¸€æ ·)ã€‚</li>
</ul>
<p>èŠ‚ç‚¹çŠ¶æ€ä¸­åŒ…å«äº†å¾ˆå¤šèŠ‚ç‚¹çš„å±æ€§æ¯”å¦‚ <code>czxid</code>ã€<code>mzxid</code> ç­‰ç­‰ï¼Œåœ¨ <code>zookeeper</code> ä¸­æ˜¯ä½¿ç”¨ <code>Stat</code> è¿™ä¸ªç±»æ¥ç»´æŠ¤çš„ã€‚ä¸‹é¢æˆ‘åˆ—ä¸¾ä¸€äº›å±æ€§è§£é‡Šã€‚</p>
<ul>
<li><code>czxid</code>ï¼š<code>Created ZXID</code>ï¼Œè¯¥æ•°æ®èŠ‚ç‚¹è¢« <strong>åˆ›å»º</strong> æ—¶çš„äº‹åŠ¡ IDã€‚</li>
<li><code>mzxid</code>ï¼š<code>Modified ZXID</code>ï¼ŒèŠ‚ç‚¹ <strong>æœ€åä¸€æ¬¡è¢«æ›´æ–°æ—¶</strong> çš„äº‹åŠ¡ IDã€‚</li>
<li><code>ctime</code>ï¼š<code>Created Time</code>ï¼Œè¯¥èŠ‚ç‚¹è¢«åˆ›å»ºçš„æ—¶é—´ã€‚</li>
<li><code>mtime</code>ï¼š<code>Modified Time</code>ï¼Œè¯¥èŠ‚ç‚¹æœ€åä¸€æ¬¡è¢«ä¿®æ”¹çš„æ—¶é—´ã€‚</li>
<li><code>version</code>ï¼šèŠ‚ç‚¹çš„ç‰ˆæœ¬å·ã€‚</li>
<li><code>cversion</code>ï¼š<strong>å­èŠ‚ç‚¹</strong> çš„ç‰ˆæœ¬å·ã€‚</li>
<li><code>aversion</code>ï¼šèŠ‚ç‚¹çš„ <code>ACL</code> ç‰ˆæœ¬å·ã€‚</li>
<li><code>ephemeralOwner</code>ï¼šåˆ›å»ºè¯¥èŠ‚ç‚¹çš„ä¼šè¯çš„ <code>sessionID</code> ï¼Œå¦‚æœè¯¥èŠ‚ç‚¹ä¸ºæŒä¹…èŠ‚ç‚¹ï¼Œè¯¥å€¼ä¸º 0ã€‚</li>
<li><code>dataLength</code>ï¼šèŠ‚ç‚¹æ•°æ®å†…å®¹çš„é•¿åº¦ã€‚</li>
<li><code>numChildre</code>ï¼šè¯¥èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°ï¼Œå¦‚æœä¸ºä¸´æ—¶èŠ‚ç‚¹ä¸º 0ã€‚</li>
<li><code>pzxid</code>ï¼šè¯¥èŠ‚ç‚¹å­èŠ‚ç‚¹åˆ—è¡¨æœ€åä¸€æ¬¡è¢«ä¿®æ”¹æ—¶çš„äº‹åŠ¡ IDï¼Œæ³¨æ„æ˜¯å­èŠ‚ç‚¹çš„ <strong>åˆ—è¡¨</strong> ï¼Œä¸æ˜¯å†…å®¹ã€‚</li>
</ul>
<h3 id="ä¼šè¯"><a href="#ä¼šè¯" class="headerlink" title="ä¼šè¯"></a>ä¼šè¯</h3><p>æˆ‘æƒ³è¿™ä¸ªå¯¹äºåç«¯å¼€å‘çš„æœ‹å‹è‚¯å®šä¸é™Œç”Ÿï¼Œä¸å°±æ˜¯ <code>session</code> å—ï¼Ÿåªä¸è¿‡ <code>zk</code> å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¯é€šè¿‡ <strong><code>TCP</code> é•¿è¿æ¥</strong> ç»´æŒçš„ä¼šè¯æœºåˆ¶ï¼Œå…¶å®å¯¹äºä¼šè¯æ¥è¯´ä½ å¯ä»¥ç†è§£ä¸º <strong>ä¿æŒè¿æ¥çŠ¶æ€</strong> ã€‚</p>
<p>åœ¨ <code>zookeeper</code> ä¸­ï¼Œä¼šè¯è¿˜æœ‰å¯¹åº”çš„äº‹ä»¶ï¼Œæ¯”å¦‚ <code>CONNECTION_LOSS è¿æ¥ä¸¢å¤±äº‹ä»¶</code>ã€<code>SESSION_MOVED ä¼šè¯è½¬ç§»äº‹ä»¶</code>ã€<code>SESSION_EXPIRED ä¼šè¯è¶…æ—¶å¤±æ•ˆäº‹ä»¶</code> ã€‚</p>
<h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><p><code>ACL</code> ä¸º <code>Access Control Lists</code> ï¼Œå®ƒæ˜¯ä¸€ç§æƒé™æ§åˆ¶ã€‚åœ¨ <code>zookeeper</code> ä¸­å®šä¹‰äº† 5 ç§æƒé™ï¼Œå®ƒä»¬åˆ†åˆ«ä¸ºï¼š</p>
<ul>
<li><code>CREATE</code>ï¼šåˆ›å»ºå­èŠ‚ç‚¹çš„æƒé™ã€‚</li>
<li><code>READ</code>ï¼šè·å–èŠ‚ç‚¹æ•°æ®å’Œå­èŠ‚ç‚¹åˆ—è¡¨çš„æƒé™ã€‚</li>
<li><code>WRITE</code>ï¼šæ›´æ–°èŠ‚ç‚¹æ•°æ®çš„æƒé™ã€‚</li>
<li><code>DELETE</code>ï¼šåˆ é™¤å­èŠ‚ç‚¹çš„æƒé™ã€‚</li>
<li><code>ADMIN</code>ï¼šè®¾ç½®èŠ‚ç‚¹ ACL çš„æƒé™ã€‚</li>
</ul>
<h3 id="Watcher-æœºåˆ¶"><a href="#Watcher-æœºåˆ¶" class="headerlink" title="Watcher æœºåˆ¶"></a>Watcher æœºåˆ¶</h3><p><code>Watcher</code> ä¸ºäº‹ä»¶ç›‘å¬å™¨ï¼Œæ˜¯ <code>zk</code> éå¸¸é‡è¦çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå¾ˆå¤šåŠŸèƒ½éƒ½ä¾èµ–äºå®ƒï¼Œå®ƒæœ‰ç‚¹ç±»ä¼¼äºè®¢é˜…çš„æ–¹å¼ï¼Œå³å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ <strong>æ³¨å†Œ</strong> æŒ‡å®šçš„ <code>watcher</code> ï¼Œå½“æœåŠ¡ç«¯ç¬¦åˆäº† <code>watcher</code> çš„æŸäº›äº‹ä»¶æˆ–è¦æ±‚åˆ™ä¼š <strong>å‘å®¢æˆ·ç«¯å‘é€äº‹ä»¶é€šçŸ¥</strong> ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°é€šçŸ¥åæ‰¾åˆ°è‡ªå·±å®šä¹‰çš„ <code>Watcher</code> ç„¶å <strong>æ‰§è¡Œç›¸åº”çš„å›è°ƒæ–¹æ³•</strong> ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/ac87b7cff7b44c63997ff0f6a7b6d2eb~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="watcheræœºåˆ¶"></p>
<h2 id="Zookeeper-çš„å‡ ä¸ªå…¸å‹åº”ç”¨åœºæ™¯"><a href="#Zookeeper-çš„å‡ ä¸ªå…¸å‹åº”ç”¨åœºæ™¯" class="headerlink" title="Zookeeper çš„å‡ ä¸ªå…¸å‹åº”ç”¨åœºæ™¯"></a>Zookeeper çš„å‡ ä¸ªå…¸å‹åº”ç”¨åœºæ™¯</h2><p>å‰é¢è¯´äº†è¿™ä¹ˆå¤šçš„ç†è®ºçŸ¥è¯†ï¼Œä½ å¯èƒ½å¬å¾—ä¸€å¤´é›¾æ°´ï¼Œè¿™äº›ç©æ„æœ‰å•¥ç”¨ï¼Ÿèƒ½å¹²å•¥äº‹ï¼Ÿåˆ«æ€¥ï¼Œå¬æˆ‘æ…¢æ…¢é“æ¥ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/dbc1a52b0c304bb093ef08fb1d4c704c~tplv-k3u1fbpfcp-zoom-1.jpeg"></p>
<h3 id="é€‰ä¸»"><a href="#é€‰ä¸»" class="headerlink" title="é€‰ä¸»"></a>é€‰ä¸»</h3><p>è¿˜è®°å¾—ä¸Šé¢æˆ‘ä»¬çš„æ‰€è¯´çš„ä¸´æ—¶èŠ‚ç‚¹å—ï¼Ÿå› ä¸º <code>Zookeeper</code> çš„å¼ºä¸€è‡´æ€§ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°åœ¨ä¿è¯ <strong>åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ä¿è¯èŠ‚ç‚¹åˆ›å»ºçš„å…¨å±€å”¯ä¸€æ€§</strong> (å³æ— æ³•é‡å¤åˆ›å»ºåŒæ ·çš„èŠ‚ç‚¹)ã€‚</p>
<p>åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ <strong>è®©å¤šä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæŒ‡å®šçš„èŠ‚ç‚¹</strong> ï¼Œåˆ›å»ºæˆåŠŸçš„å°±æ˜¯ <code>master</code>ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœè¿™ä¸ª <code>master</code> æŒ‚äº†æ€ä¹ˆåŠï¼Ÿï¼Ÿï¼Ÿ</p>
<p>ä½ æƒ³æƒ³ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ï¼Ÿè¿˜è®°å¾—ä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸå—ï¼Ÿ<code>master</code> æŒ‚äº†æ˜¯ä¸æ˜¯ä»£è¡¨ä¼šè¯æ–­äº†ï¼Ÿä¼šè¯æ–­äº†æ˜¯ä¸æ˜¯æ„å‘³ç€è¿™ä¸ªèŠ‚ç‚¹æ²¡äº†ï¼Ÿè¿˜è®°å¾— <code>watcher</code> å—ï¼Ÿæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ <strong>è®©å…¶ä»–ä¸æ˜¯ <code>master</code> çš„èŠ‚ç‚¹ç›‘å¬èŠ‚ç‚¹çš„çŠ¶æ€</strong> ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ç›‘å¬è¿™ä¸ªä¸´æ—¶èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹ä¸ªæ•°å˜äº†å°±ä»£è¡¨ <code>master</code> æŒ‚äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ <strong>è§¦å‘å›è°ƒå‡½æ•°è¿›è¡Œé‡æ–°é€‰ä¸¾</strong> ï¼Œæˆ–è€…æˆ‘ä»¬ç›´æ¥ç›‘å¬èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡èŠ‚ç‚¹æ˜¯å¦å·²ç»å¤±å»è¿æ¥æ¥åˆ¤æ–­ <code>master</code> æ˜¯å¦æŒ‚äº†ç­‰ç­‰ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/00468757fb8f4f51875f645fbb7b25a2~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="é€‰ä¸»"></p>
<p>æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å®Œå…¨ <strong>åˆ©ç”¨ ä¸´æ—¶èŠ‚ç‚¹ã€èŠ‚ç‚¹çŠ¶æ€ å’Œ <code>watcher</code> æ¥å®ç°é€‰ä¸»çš„åŠŸèƒ½</strong>ï¼Œä¸´æ—¶èŠ‚ç‚¹ä¸»è¦ç”¨æ¥é€‰ä¸¾ï¼ŒèŠ‚ç‚¹çŠ¶æ€å’Œ<code>watcher</code> å¯ä»¥ç”¨æ¥åˆ¤æ–­ <code>master</code> çš„æ´»æ€§å’Œè¿›è¡Œé‡æ–°é€‰ä¸¾ã€‚</p>
<h3 id="æ•°æ®å‘å¸ƒ-è®¢é˜…"><a href="#æ•°æ®å‘å¸ƒ-è®¢é˜…" class="headerlink" title="æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…"></a>æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…</h3><p>è¿˜è®°å¾— Zookeeper çš„ <code>Watcher</code> æœºåˆ¶å—ï¼Ÿ Zookeeper é€šè¿‡è¿™ç§æ¨æ‹‰ç›¸ç»“åˆçš„æ–¹å¼å®ç°å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„äº¤äº’ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯æ³¨å†ŒèŠ‚ç‚¹ï¼Œä¸€æ—¦ç›¸åº”èŠ‚ç‚¹çš„æ•°æ®å˜æ›´ï¼ŒæœåŠ¡ç«¯å°±ä¼šå‘â€œç›‘å¬â€è¯¥èŠ‚ç‚¹çš„å®¢æˆ·ç«¯å‘é€ <code>Watcher</code> äº‹ä»¶é€šçŸ¥ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°é€šçŸ¥åéœ€è¦ <strong>ä¸»åŠ¨</strong> åˆ°æœåŠ¡ç«¯è·å–æœ€æ–°çš„æ•°æ®ã€‚åŸºäºè¿™ç§æ–¹å¼ï¼ŒZookeeper å®ç°äº† <strong>æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…</strong> åŠŸèƒ½ã€‚</p>
<p>ä¸€ä¸ªå…¸å‹çš„åº”ç”¨åœºæ™¯ä¸º <strong>å…¨å±€é…ç½®ä¿¡æ¯çš„é›†ä¸­ç®¡ç†</strong>ã€‚ å®¢æˆ·ç«¯åœ¨å¯åŠ¨æ—¶ä¼šä¸»åŠ¨åˆ° Zookeeper æœåŠ¡ç«¯è·å–é…ç½®ä¿¡æ¯ï¼ŒåŒæ—¶ <strong>åœ¨æŒ‡å®šèŠ‚ç‚¹æ³¨å†Œä¸€ä¸ª</strong> <code>Watcher</code> <strong>ç›‘å¬</strong>ã€‚å½“é…ç½®ä¿¡æ¯å‘ç”Ÿå˜æ›´ï¼ŒæœåŠ¡ç«¯é€šçŸ¥æ‰€æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯é‡æ–°è·å–é…ç½®ä¿¡æ¯ï¼Œå®ç°é…ç½®ä¿¡æ¯çš„å®æ—¶æ›´æ–°ã€‚</p>
<p>ä¸Šé¢æ‰€æåˆ°çš„å…¨å±€é…ç½®ä¿¡æ¯é€šå¸¸åŒ…æ‹¬æœºå™¨åˆ—è¡¨ä¿¡æ¯ã€è¿è¡Œæ—¶çš„å¼€å…³é…ç½®ã€æ•°æ®åº“é…ç½®ä¿¡æ¯ç­‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç±»å…¨å±€é…ç½®ä¿¡æ¯é€šå¸¸å…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>æ•°æ®é‡è¾ƒå°</li>
<li>æ•°æ®å†…å®¹åœ¨è¿è¡Œæ—¶åŠ¨æ€å˜åŒ–</li>
<li>é›†ç¾¤ä¸­æœºå™¨å…±äº«ä¸€è‡´é…ç½®</li>
</ul>
<h3 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h3><p>å¯ä»¥é€šè¿‡ Zookeeper çš„ <strong>ä¸´æ—¶èŠ‚ç‚¹</strong> å®ç°è´Ÿè½½å‡è¡¡ã€‚å›é¡¾ä¸€ä¸‹ä¸´æ—¶èŠ‚ç‚¹çš„ç‰¹æ€§ï¼šå½“åˆ›å»ºèŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´æ–­å¼€è¿æ¥ï¼Œå³å®¢æˆ·ç«¯ä¼šè¯ï¼ˆsessionï¼‰æ¶ˆå¤±æ—¶ï¼Œå¯¹åº”èŠ‚ç‚¹ä¹Ÿä¼šè‡ªåŠ¨æ¶ˆå¤±ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸´æ—¶èŠ‚ç‚¹æ¥ç»´æŠ¤ Server çš„åœ°å€åˆ—è¡¨ï¼Œä»è€Œä¿è¯è¯·æ±‚ä¸ä¼šè¢«åˆ†é…åˆ°å·²åœæœºçš„æœåŠ¡ä¸Šã€‚</p>
<p>å…·ä½“åœ°ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é›†ç¾¤çš„æ¯ä¸€ä¸ª Server ä¸­éƒ½ä½¿ç”¨ Zookeeper å®¢æˆ·ç«¯è¿æ¥ Zookeeper æœåŠ¡ç«¯ï¼ŒåŒæ—¶ç”¨ Server <strong>è‡ªèº«çš„åœ°å€ä¿¡æ¯</strong>åœ¨æœåŠ¡ç«¯æŒ‡å®šç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ã€‚å½“å®¢æˆ·ç«¯è¯·æ±‚è°ƒç”¨é›†ç¾¤æœåŠ¡æ—¶ï¼Œé¦–å…ˆé€šè¿‡ Zookeeper è·å–è¯¥ç›®å½•ä¸‹çš„èŠ‚ç‚¹åˆ—è¡¨ ï¼ˆå³æ‰€æœ‰å¯ç”¨çš„ Serverï¼‰ï¼Œéšåæ ¹æ®ä¸åŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥å°†è¯·æ±‚è½¬å‘åˆ°æŸä¸€å…·ä½“çš„ Serverã€‚</p>
<h3 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="headerlink" title="åˆ†å¸ƒå¼é”"></a>åˆ†å¸ƒå¼é”</h3><p>åˆ†å¸ƒå¼é”çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ <code>Redis</code>ã€æ•°æ®åº“ã€<code>zookeeper</code> ç­‰ã€‚ä¸ªäººè®¤ä¸º <code>zookeeper</code> åœ¨å®ç°åˆ†å¸ƒå¼é”è¿™æ–¹é¢æ˜¯éå¸¸éå¸¸ç®€å•çš„ã€‚</p>
<p>ä¸Šé¢æˆ‘ä»¬å·²ç»æåˆ°è¿‡äº† <strong>zk åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ä¿è¯èŠ‚ç‚¹åˆ›å»ºçš„å…¨å±€å”¯ä¸€æ€§</strong>ï¼Œè¿™ç©æ„ä¸€çœ‹å°±çŸ¥é“èƒ½å¹²å•¥äº†ã€‚å®ç°äº’æ–¥é”å‘—ï¼Œåˆå› ä¸ºèƒ½åœ¨åˆ†å¸ƒå¼çš„æƒ…å†µä¸‹ï¼Œæ‰€ä»¥èƒ½å®ç°åˆ†å¸ƒå¼é”å‘—ã€‚</p>
<p>å¦‚ä½•å®ç°å‘¢ï¼Ÿè¿™ç©æ„å…¶å®è·Ÿé€‰ä¸»åŸºæœ¬ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨ä¸´æ—¶èŠ‚ç‚¹çš„åˆ›å»ºæ¥å®ç°ã€‚</p>
<p>é¦–å…ˆè‚¯å®šæ˜¯å¦‚ä½•è·å–é”ï¼Œå› ä¸ºåˆ›å»ºèŠ‚ç‚¹çš„å”¯ä¸€æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è®©å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ï¼Œ<strong>åˆ›å»ºæˆåŠŸçš„å°±è¯´æ˜è·å–åˆ°äº†é”</strong> ã€‚ç„¶åæ²¡æœ‰è·å–åˆ°é”çš„å®¢æˆ·ç«¯ä¹Ÿåƒä¸Šé¢é€‰ä¸»çš„éä¸»èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ª <code>watcher</code> è¿›è¡ŒèŠ‚ç‚¹çŠ¶æ€çš„ç›‘å¬ï¼Œå¦‚æœè¿™ä¸ªäº’æ–¥é”è¢«é‡Šæ”¾äº†ï¼ˆå¯èƒ½è·å–é”çš„å®¢æˆ·ç«¯å®•æœºäº†ï¼Œæˆ–è€…é‚£ä¸ªå®¢æˆ·ç«¯ä¸»åŠ¨é‡Šæ”¾äº†é”ï¼‰å¯ä»¥è°ƒç”¨å›è°ƒå‡½æ•°é‡æ–°è·å¾—é”ã€‚</p>
<blockquote>
<p><code>zk</code> ä¸­ä¸éœ€è¦å‘ <code>redis</code> é‚£æ ·è€ƒè™‘é”å¾—ä¸åˆ°é‡Šæ”¾çš„é—®é¢˜äº†ï¼Œå› ä¸ºå½“å®¢æˆ·ç«¯æŒ‚äº†ï¼ŒèŠ‚ç‚¹ä¹ŸæŒ‚äº†ï¼Œé”ä¹Ÿé‡Šæ”¾äº†ã€‚æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿ</p>
</blockquote>
<p>é‚£èƒ½ä¸èƒ½ä½¿ç”¨ <code>zookeeper</code> åŒæ—¶å®ç° <strong>å…±äº«é”å’Œç‹¬å é”</strong> å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä¸è¿‡ç¨å¾®æœ‰ç‚¹å¤æ‚è€Œå·²ã€‚</p>
<p>è¿˜è®°å¾— <strong>æœ‰åºçš„èŠ‚ç‚¹</strong> å—ï¼Ÿ</p>
<p>è¿™ä¸ªæ—¶å€™æˆ‘è§„å®šæ‰€æœ‰åˆ›å»ºèŠ‚ç‚¹å¿…é¡»æœ‰åºï¼Œå½“ä½ æ˜¯è¯»è¯·æ±‚ï¼ˆè¦è·å–å…±äº«é”ï¼‰çš„è¯ï¼Œå¦‚æœ <strong>æ²¡æœ‰æ¯”è‡ªå·±æ›´å°çš„èŠ‚ç‚¹ï¼Œæˆ–æ¯”è‡ªå·±å°çš„èŠ‚ç‚¹éƒ½æ˜¯è¯»è¯·æ±‚</strong> ï¼Œåˆ™å¯ä»¥è·å–åˆ°è¯»é”ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹è¯»äº†ã€‚<strong>è‹¥æ¯”è‡ªå·±å°çš„èŠ‚ç‚¹ä¸­æœ‰å†™è¯·æ±‚</strong> ï¼Œåˆ™å½“å‰å®¢æˆ·ç«¯æ— æ³•è·å–åˆ°è¯»é”ï¼Œåªèƒ½ç­‰å¾…å‰é¢çš„å†™è¯·æ±‚å®Œæˆã€‚</p>
<p>å¦‚æœä½ æ˜¯å†™è¯·æ±‚ï¼ˆè·å–ç‹¬å é”ï¼‰ï¼Œè‹¥ <strong>æ²¡æœ‰æ¯”è‡ªå·±æ›´å°çš„èŠ‚ç‚¹</strong> ï¼Œåˆ™è¡¨ç¤ºå½“å‰å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥è·å–åˆ°å†™é”ï¼Œå¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚è‹¥å‘ç° <strong>æœ‰æ¯”è‡ªå·±æ›´å°çš„èŠ‚ç‚¹ï¼Œæ— è®ºæ˜¯è¯»æ“ä½œè¿˜æ˜¯å†™æ“ä½œï¼Œå½“å‰å®¢æˆ·ç«¯éƒ½æ— æ³•è·å–åˆ°å†™é”</strong> ï¼Œç­‰å¾…æ‰€æœ‰å‰é¢çš„æ“ä½œå®Œæˆã€‚</p>
<p>è¿™å°±å¾ˆå¥½åœ°åŒæ—¶å®ç°äº†å…±äº«é”å’Œç‹¬å é”ï¼Œå½“ç„¶è¿˜æœ‰ä¼˜åŒ–çš„åœ°æ–¹ï¼Œæ¯”å¦‚å½“ä¸€ä¸ªé”å¾—åˆ°é‡Šæ”¾å®ƒä¼šé€šçŸ¥æ‰€æœ‰ç­‰å¾…çš„å®¢æˆ·ç«¯ä»è€Œé€ æˆ <strong>ç¾Šç¾¤æ•ˆåº”</strong> ã€‚æ­¤æ—¶ä½ å¯ä»¥é€šè¿‡è®©ç­‰å¾…çš„èŠ‚ç‚¹åªç›‘å¬ä»–ä»¬å‰é¢çš„èŠ‚ç‚¹ã€‚</p>
<p>å…·ä½“æ€ä¹ˆåšå‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œä½ å¯ä»¥è®© <strong>è¯»è¯·æ±‚ç›‘å¬æ¯”è‡ªå·±å°çš„æœ€åä¸€ä¸ªå†™è¯·æ±‚èŠ‚ç‚¹ï¼Œå†™è¯·æ±‚åªç›‘å¬æ¯”è‡ªå·±å°çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</strong> ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªå·±å»ç ”ç©¶ä¸€ä¸‹ã€‚</p>
<h3 id="å‘½åæœåŠ¡"><a href="#å‘½åæœåŠ¡" class="headerlink" title="å‘½åæœåŠ¡"></a>å‘½åæœåŠ¡</h3><p>å¦‚ä½•ç»™ä¸€ä¸ªå¯¹è±¡è®¾ç½® IDï¼Œå¤§å®¶å¯èƒ½éƒ½ä¼šæƒ³åˆ° <code>UUID</code>ï¼Œä½†æ˜¯ <code>UUID</code> æœ€å¤§çš„é—®é¢˜å°±åœ¨äºå®ƒå¤ªé•¿äº†ã€‚ã€‚ã€‚(å¤ªé•¿ä¸ä¸€å®šæ˜¯å¥½äº‹ï¼Œå˜¿å˜¿å˜¿)ã€‚é‚£ä¹ˆåœ¨æ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½ä½¿ç”¨ <code>zookeeper</code> æ¥å®ç°å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡ <code>zookeeper</code> æ˜¯é€šè¿‡ <strong>æ ‘å½¢ç»“æ„</strong> æ¥å­˜å‚¨æ•°æ®èŠ‚ç‚¹çš„ï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ¯ä¸ªèŠ‚ç‚¹çš„ <strong>å…¨è·¯å¾„</strong>ï¼Œå®ƒå¿…å®šæ˜¯å”¯ä¸€çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨èŠ‚ç‚¹çš„å…¨è·¯å¾„ä½œä¸ºå‘½åæ–¹å¼äº†ã€‚è€Œä¸”æ›´é‡è¦çš„æ˜¯ï¼Œè·¯å¾„æ˜¯æˆ‘ä»¬å¯ä»¥è‡ªå·±å®šä¹‰çš„ï¼Œè¿™å¯¹äºæˆ‘ä»¬å¯¹æœ‰äº›æœ‰è¯­æ„çš„å¯¹è±¡çš„ ID è®¾ç½®å¯ä»¥æ›´åŠ ä¾¿äºç†è§£ã€‚</p>
<h3 id="é›†ç¾¤ç®¡ç†å’Œæ³¨å†Œä¸­å¿ƒ"><a href="#é›†ç¾¤ç®¡ç†å’Œæ³¨å†Œä¸­å¿ƒ" class="headerlink" title="é›†ç¾¤ç®¡ç†å’Œæ³¨å†Œä¸­å¿ƒ"></a>é›†ç¾¤ç®¡ç†å’Œæ³¨å†Œä¸­å¿ƒ</h3><p>çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯è§‰å¾— <code>zookeeper</code> å®åœ¨æ˜¯å¤ªå¼ºå¤§äº†ï¼Œå®ƒæ€ä¹ˆèƒ½è¿™ä¹ˆèƒ½å¹²ï¼</p>
<p>åˆ«æ€¥ï¼Œå®ƒèƒ½å¹²çš„äº‹æƒ…è¿˜å¾ˆå¤šå‘¢ã€‚å¯èƒ½æˆ‘ä»¬ä¼šæœ‰è¿™æ ·çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£æ•´ä¸ªé›†ç¾¤ä¸­æœ‰å¤šå°‘æœºå™¨åœ¨å·¥ä½œï¼Œæˆ‘ä»¬æƒ³å¯¹é›†ç¾¤ä¸­çš„æ¯å°æœºå™¨çš„è¿è¡Œæ—¶çŠ¶æ€è¿›è¡Œæ•°æ®é‡‡é›†ï¼Œå¯¹é›†ç¾¤ä¸­æœºå™¨è¿›è¡Œä¸Šä¸‹çº¿æ“ä½œç­‰ç­‰ã€‚</p>
<p>è€Œ <code>zookeeper</code> å¤©ç„¶æ”¯æŒçš„ <code>watcher</code> å’Œ ä¸´æ—¶èŠ‚ç‚¹èƒ½å¾ˆå¥½çš„å®ç°è¿™äº›éœ€æ±‚ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºæ¯æ¡æœºå™¨åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ï¼Œå¹¶ç›‘æ§å…¶çˆ¶èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹åˆ—è¡¨æœ‰å˜åŠ¨ï¼ˆæˆ‘ä»¬å¯èƒ½åˆ›å»ºåˆ é™¤äº†ä¸´æ—¶èŠ‚ç‚¹ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åœ¨å…¶çˆ¶èŠ‚ç‚¹ç»‘å®šçš„ <code>watcher</code> è¿›è¡ŒçŠ¶æ€ç›‘æ§å’Œå›è°ƒã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/f3d70709f10f4fa6b09125a56a976fda~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="é›†ç¾¤ç®¡ç†"></p>
<p>è‡³äºæ³¨å†Œä¸­å¿ƒä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬åŒæ ·ä¹Ÿæ˜¯è®© <strong>æœåŠ¡æä¾›è€…</strong> åœ¨ <code>zookeeper</code> ä¸­åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹å¹¶ä¸”å°†è‡ªå·±çš„ <code>ipã€portã€è°ƒç”¨æ–¹å¼</code> å†™å…¥èŠ‚ç‚¹ï¼Œå½“ <strong>æœåŠ¡æ¶ˆè´¹è€…</strong> éœ€è¦è¿›è¡Œè°ƒç”¨çš„æ—¶å€™ä¼š <strong>é€šè¿‡æ³¨å†Œä¸­å¿ƒæ‰¾åˆ°ç›¸åº”çš„æœåŠ¡çš„åœ°å€åˆ—è¡¨(IP ç«¯å£ä»€ä¹ˆçš„)</strong> ï¼Œå¹¶ç¼“å­˜åˆ°æœ¬åœ°(æ–¹ä¾¿ä»¥åè°ƒç”¨)ï¼Œå½“æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡æ—¶ï¼Œä¸ä¼šå†å»è¯·æ±‚æ³¨å†Œä¸­å¿ƒï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡è´Ÿè½½å‡è¡¡ç®—æ³•ä»åœ°å€åˆ—è¡¨ä¸­å–ä¸€ä¸ªæœåŠ¡æä¾›è€…çš„æœåŠ¡å™¨è°ƒç”¨æœåŠ¡ã€‚</p>
<p>å½“æœåŠ¡æä¾›è€…çš„æŸå°æœåŠ¡å™¨å®•æœºæˆ–ä¸‹çº¿æ—¶ï¼Œç›¸åº”çš„åœ°å€ä¼šä»æœåŠ¡æä¾›è€…åœ°å€åˆ—è¡¨ä¸­ç§»é™¤ã€‚åŒæ—¶ï¼Œæ³¨å†Œä¸­å¿ƒä¼šå°†æ–°çš„æœåŠ¡åœ°å€åˆ—è¡¨å‘é€ç»™æœåŠ¡æ¶ˆè´¹è€…çš„æœºå™¨å¹¶ç¼“å­˜åœ¨æ¶ˆè´¹è€…æœ¬æœºï¼ˆå½“ç„¶ä½ å¯ä»¥è®©æ¶ˆè´¹è€…è¿›è¡ŒèŠ‚ç‚¹ç›‘å¬ï¼Œæˆ‘è®°å¾— <code>Eureka</code> ä¼šå…ˆè¯•é”™ï¼Œç„¶åå†æ›´æ–°ï¼‰ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/469cebf9670740d1a6711fe54db70e05~tplv-k3u1fbpfcp-zoom-1.jpeg" alt="æ³¨å†Œä¸­å¿ƒ"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>çœ‹åˆ°è¿™é‡Œçš„åŒå­¦å®åœ¨æ˜¯å¤ªæœ‰è€å¿ƒäº† ğŸ‘ğŸ‘ğŸ‘ ä¸çŸ¥é“å¤§å®¶æ˜¯å¦è¿˜è®°å¾—æˆ‘è®²äº†ä»€ä¹ˆ ğŸ˜’ã€‚</p>
<p><img src="https://oss.javaguide.cn/p3-juejin/912c1aa6b7794d4aac8ebe6a14832cae~tplv-k3u1fbpfcp-zoom-1.jpeg"></p>
<p>è¿™ç¯‡æ–‡ç« ä¸­æˆ‘å¸¦å¤§å®¶å…¥é—¨äº† <code>zookeeper</code> è¿™ä¸ªå¼ºå¤§çš„åˆ†å¸ƒå¼åè°ƒæ¡†æ¶ã€‚ç°åœ¨æˆ‘ä»¬æ¥ç®€å•æ¢³ç†ä¸€ä¸‹æ•´ç¯‡æ–‡ç« çš„å†…å®¹ã€‚</p>
<ul>
<li><p>åˆ†å¸ƒå¼ä¸é›†ç¾¤çš„åŒºåˆ«</p>
</li>
<li><p><code>2PC</code>ã€<code>3PC</code> ä»¥åŠ <code>paxos</code> ç®—æ³•è¿™äº›ä¸€è‡´æ€§æ¡†æ¶çš„åŸç†å’Œå®ç°ã€‚</p>
</li>
<li><p><code>zookeeper</code> ä¸“é—¨çš„ä¸€è‡´æ€§ç®—æ³• <code>ZAB</code> åŸå­å¹¿æ’­åè®®çš„å†…å®¹ï¼ˆ<code>Leader</code> é€‰ä¸¾ã€å´©æºƒæ¢å¤ã€æ¶ˆæ¯å¹¿æ’­ï¼‰ã€‚</p>
</li>
<li><p><code>zookeeper</code> ä¸­çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œæ¯”å¦‚ <code>ACL</code>ï¼Œæ•°æ®èŠ‚ç‚¹ï¼Œä¼šè¯ï¼Œ<code>watcher</code>æœºåˆ¶ç­‰ç­‰ã€‚</p>
</li>
<li><p><code>zookeeper</code> çš„å…¸å‹åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚é€‰ä¸»ï¼Œæ³¨å†Œä¸­å¿ƒç­‰ç­‰ã€‚</p>
<p>å¦‚æœå¿˜äº†å¯ä»¥å›å»çœ‹çœ‹å†æ¬¡ç†è§£ä¸€ä¸‹ï¼Œå¦‚æœæœ‰ç–‘é—®å’Œå»ºè®®æ¬¢è¿æå‡º ğŸ¤ğŸ¤ğŸ¤ã€‚</p>
</li>
</ul>
<!-- @include: @article-footer.snippet.md -->

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/02/24/zookeeper-intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/02/24/zookeeper-intro/" itemprop="url">ZooKeeperç›¸å…³æ¦‚å¿µæ€»ç»“(å…¥é—¨)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2022-02-24T20:44:43+08:00">
                2022-02-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">åˆ†å¸ƒå¼</span>
                  </a>
                </span>

                
                
                  ï¼Œ 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index">
                    <span itemprop="name">ä¸­é—´ä»¶</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2022/02/24/zookeeper-intro/" class="leancloud_visitors" data-flag-title="ZooKeeperç›¸å…³æ¦‚å¿µæ€»ç»“(å…¥é—¨)">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  6.7k å­—
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  23 åˆ†é’Ÿ
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ç›¸ä¿¡å¤§å®¶å¯¹ ZooKeeper åº”è¯¥ä¸ç®—é™Œç”Ÿã€‚ä½†æ˜¯ä½ çœŸçš„äº†è§£ ZooKeeper åˆ°åº•æœ‰å•¥ç”¨ä¸ï¼Ÿå¦‚æœåˆ«äºº&#x2F;é¢è¯•å®˜è®©ä½ ç»™ä»–è®²è®²å¯¹äº ZooKeeper çš„è®¤è¯†ï¼Œä½ èƒ½å›ç­”åˆ°ä»€ä¹ˆåœ°æ­¥å‘¢ï¼Ÿ</p>
<p>æ‹¿æˆ‘è‡ªå·±æ¥è¯´å§ï¼æˆ‘æœ¬äººåœ¨å¤§å­¦æ›¾ç»ä½¿ç”¨ Dubbo æ¥åšåˆ†å¸ƒå¼é¡¹ç›®çš„æ—¶å€™ï¼Œä½¿ç”¨äº† ZooKeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒã€‚ä¸ºäº†ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿèƒ½å¤ŸåŒæ­¥è®¿é—®æŸä¸ªèµ„æºï¼Œæˆ‘è¿˜ä½¿ç”¨ ZooKeeper åšè¿‡åˆ†å¸ƒå¼é”ã€‚å¦å¤–ï¼Œæˆ‘åœ¨å­¦ä¹  Kafka çš„æ—¶å€™ï¼ŒçŸ¥é“ Kafka å¾ˆå¤šåŠŸèƒ½çš„å®ç°ä¾èµ–äº† ZooKeeperã€‚</p>
<p>å‰å‡ å¤©ï¼Œæ€»ç»“é¡¹ç›®ç»éªŒçš„æ—¶å€™ï¼Œæˆ‘çªç„¶é—®è‡ªå·± ZooKeeper åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿæƒ³äº†åŠå¤©ï¼Œè„‘æµ·ä¸­åªæ˜¯ç®€å•çš„èƒ½æµ®ç°å‡ºå‡ å¥è¯ï¼š</p>
<ol>
<li>ZooKeeper å¯ä»¥è¢«ç”¨ä½œæ³¨å†Œä¸­å¿ƒã€åˆ†å¸ƒå¼é”ï¼›</li>
<li>ZooKeeper æ˜¯ Hadoop ç”Ÿæ€ç³»ç»Ÿçš„ä¸€å‘˜ï¼›</li>
<li>æ„å»º ZooKeeper é›†ç¾¤çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æœåŠ¡å™¨æœ€å¥½æ˜¯å¥‡æ•°å°ã€‚</li>
</ol>
<p>ç”±æ­¤å¯è§ï¼Œæˆ‘å¯¹äº ZooKeeper çš„ç†è§£ä»…ä»…æ˜¯åœç•™åœ¨äº†è¡¨é¢ã€‚</p>
<p>æ‰€ä»¥ï¼Œé€šè¿‡æœ¬æ–‡ï¼Œå¸Œæœ›å¸¦å¤§å®¶ç¨å¾®è¯¦ç»†çš„äº†è§£ä¸€ä¸‹ ZooKeeper ã€‚å¦‚æœæ²¡æœ‰å­¦è¿‡ ZooKeeper ï¼Œé‚£ä¹ˆæœ¬æ–‡å°†ä¼šæ˜¯ä½ è¿›å…¥ ZooKeeper å¤§é—¨çš„å«è„šç –ã€‚å¦‚æœä½ å·²ç»æ¥è§¦è¿‡ ZooKeeper ï¼Œé‚£ä¹ˆæœ¬æ–‡å°†å¸¦ä½ å›é¡¾ä¸€ä¸‹ ZooKeeper çš„ä¸€äº›åŸºç¡€æ¦‚å¿µã€‚</p>
<p>å¦å¤–ï¼Œæœ¬æ–‡ä¸å…‰ä¼šæ¶‰åŠåˆ° ZooKeeper çš„ä¸€äº›æ¦‚å¿µï¼Œåé¢çš„æ–‡ç« ä¼šä»‹ç»åˆ° ZooKeeper å¸¸è§å‘½ä»¤çš„ä½¿ç”¨ä»¥åŠä½¿ç”¨ Apache Curator ä½œä¸º ZooKeeper çš„å®¢æˆ·ç«¯ã€‚</p>
<p><em>å¦‚æœæ–‡ç« æœ‰ä»»ä½•éœ€è¦æ”¹å–„å’Œå®Œå–„çš„åœ°æ–¹ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæŒ‡å‡ºï¼Œå…±åŒè¿›æ­¥ï¼</em></p>
<h2 id="ZooKeeper-ä»‹ç»"><a href="#ZooKeeper-ä»‹ç»" class="headerlink" title="ZooKeeper ä»‹ç»"></a>ZooKeeper ä»‹ç»</h2><h3 id="ZooKeeper-ç”±æ¥"><a href="#ZooKeeper-ç”±æ¥" class="headerlink" title="ZooKeeper ç”±æ¥"></a>ZooKeeper ç”±æ¥</h3><p>æ­£å¼ä»‹ç» ZooKeeper ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ ZooKeeper çš„ç”±æ¥ï¼Œè¿˜æŒºæœ‰æ„æ€çš„ã€‚</p>
<p>ä¸‹é¢è¿™æ®µå†…å®¹æ‘˜è‡ªã€Šä» Paxos åˆ° ZooKeeperã€‹ç¬¬å››ç« ç¬¬ä¸€èŠ‚ï¼Œæ¨èå¤§å®¶é˜…è¯»ä¸€ä¸‹ï¼š</p>
<blockquote>
<p>ZooKeeper æœ€æ—©èµ·æºäºé›…è™ç ”ç©¶é™¢çš„ä¸€ä¸ªç ”ç©¶å°ç»„ã€‚åœ¨å½“æ—¶ï¼Œç ”ç©¶äººå‘˜å‘ç°ï¼Œåœ¨é›…è™å†…éƒ¨å¾ˆå¤šå¤§å‹ç³»ç»ŸåŸºæœ¬éƒ½éœ€è¦ä¾èµ–ä¸€ä¸ªç±»ä¼¼çš„ç³»ç»Ÿæ¥è¿›è¡Œåˆ†å¸ƒå¼åè°ƒï¼Œä½†æ˜¯è¿™äº›ç³»ç»Ÿå¾€å¾€éƒ½å­˜åœ¨åˆ†å¸ƒå¼å•ç‚¹é—®é¢˜ã€‚æ‰€ä»¥ï¼Œé›…è™çš„å¼€å‘äººå‘˜å°±è¯•å›¾å¼€å‘ä¸€ä¸ªé€šç”¨çš„æ— å•ç‚¹é—®é¢˜çš„åˆ†å¸ƒå¼åè°ƒæ¡†æ¶ï¼Œä»¥ä¾¿è®©å¼€å‘äººå‘˜å°†ç²¾åŠ›é›†ä¸­åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘ä¸Šã€‚</p>
<p>å…³äºâ€œZooKeeperâ€è¿™ä¸ªé¡¹ç›®çš„åå­—ï¼Œå…¶å®ä¹Ÿæœ‰ä¸€æ®µè¶£é—»ã€‚åœ¨ç«‹é¡¹åˆæœŸï¼Œè€ƒè™‘åˆ°ä¹‹å‰å†…éƒ¨å¾ˆå¤šé¡¹ç›®éƒ½æ˜¯ä½¿ç”¨åŠ¨ç‰©çš„åå­—æ¥å‘½åçš„ï¼ˆä¾‹å¦‚è‘—åçš„ Pig é¡¹ç›®),é›…è™çš„å·¥ç¨‹å¸ˆå¸Œæœ›ç»™è¿™ä¸ªé¡¹ç›®ä¹Ÿå–ä¸€ä¸ªåŠ¨ç‰©çš„åå­—ã€‚æ—¶ä»»ç ”ç©¶é™¢çš„é¦–å¸­ç§‘å­¦å®¶ RaghuRamakrishnan å¼€ç©ç¬‘åœ°è¯´ï¼šâ€œåœ¨è¿™æ ·ä¸‹å»ï¼Œæˆ‘ä»¬è¿™å„¿å°±å˜æˆåŠ¨ç‰©å›­äº†ï¼â€æ­¤è¯ä¸€å‡ºï¼Œå¤§å®¶çº·çº·è¡¨ç¤ºå°±å«åŠ¨ç‰©å›­ç®¡ç†å‘˜å§ä¸€ä¸€ä¸€å› ä¸ºå„ä¸ªä»¥åŠ¨ç‰©å‘½åçš„åˆ†å¸ƒå¼ç»„ä»¶æ”¾åœ¨ä¸€èµ·ï¼Œé›…è™çš„æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçœ‹ä¸Šå»å°±åƒä¸€ä¸ªå¤§å‹çš„åŠ¨ç‰©å›­äº†ï¼Œè€Œ ZooKeeper æ­£å¥½è¦ç”¨æ¥è¿›è¡Œåˆ†å¸ƒå¼ç¯å¢ƒçš„åè°ƒä¸€ä¸€äºæ˜¯ï¼ŒZooKeeper çš„åå­—ä¹Ÿå°±ç”±æ­¤è¯ç”Ÿäº†ã€‚</p>
</blockquote>
<h3 id="ZooKeeper-æ¦‚è§ˆ"><a href="#ZooKeeper-æ¦‚è§ˆ" class="headerlink" title="ZooKeeper æ¦‚è§ˆ"></a>ZooKeeper æ¦‚è§ˆ</h3><p>ZooKeeper æ˜¯ä¸€ä¸ªå¼€æºçš„<strong>åˆ†å¸ƒå¼åè°ƒæœåŠ¡</strong>ï¼Œå®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯å°†é‚£äº›å¤æ‚ä¸”å®¹æ˜“å‡ºé”™çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§æœåŠ¡å°è£…èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªé«˜æ•ˆå¯é çš„åŸè¯­é›†ï¼Œå¹¶ä»¥ä¸€ç³»åˆ—ç®€å•æ˜“ç”¨çš„æ¥å£æä¾›ç»™ç”¨æˆ·ä½¿ç”¨ã€‚</p>
<blockquote>
<p><strong>åŸè¯­ï¼š</strong> æ“ä½œç³»ç»Ÿæˆ–è®¡ç®—æœºç½‘ç»œç”¨è¯­èŒƒç•´ã€‚æ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆçš„ï¼Œç”¨äºå®Œæˆä¸€å®šåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ã€‚å…·æœ‰ä¸å¯åˆ†å‰²æ€§ï¼Œå³åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ã€‚</p>
</blockquote>
<p>ZooKeeper ä¸ºæˆ‘ä»¬æä¾›äº†é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€ç¨³å®šçš„åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆï¼Œé€šå¸¸è¢«ç”¨äºå®ç°è¯¸å¦‚æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…ã€è´Ÿè½½å‡è¡¡ã€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼åè°ƒ&#x2F;é€šçŸ¥ã€é›†ç¾¤ç®¡ç†ã€Master é€‰ä¸¾ã€åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é˜Ÿåˆ—ç­‰åŠŸèƒ½ã€‚è¿™äº›åŠŸèƒ½çš„å®ç°ä¸»è¦ä¾èµ–äº ZooKeeper æä¾›çš„ <strong>æ•°æ®å­˜å‚¨+äº‹ä»¶ç›‘å¬</strong> åŠŸèƒ½ï¼ˆåæ–‡ä¼šè¯¦ç»†ä»‹ç»åˆ°ï¼‰ ã€‚</p>
<p>ZooKeeper å°†æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ€§èƒ½æ˜¯ä¸é”™çš„ã€‚ åœ¨â€œè¯»â€å¤šäºâ€œå†™â€çš„åº”ç”¨ç¨‹åºä¸­å°¤å…¶åœ°é«˜æ€§èƒ½ï¼Œå› ä¸ºâ€œå†™â€ä¼šå¯¼è‡´æ‰€æœ‰çš„æœåŠ¡å™¨é—´åŒæ­¥çŠ¶æ€ã€‚ï¼ˆâ€œè¯»â€å¤šäºâ€œå†™â€æ˜¯åè°ƒæœåŠ¡çš„å…¸å‹åœºæ™¯ï¼‰ã€‚</p>
<p>å¦å¤–ï¼Œå¾ˆå¤šé¡¶çº§çš„å¼€æºé¡¹ç›®éƒ½ç”¨åˆ°äº† ZooKeeperï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><strong>Kafka</strong> : ZooKeeper ä¸»è¦ä¸º Kafka æä¾› Broker å’Œ Topic çš„æ³¨å†Œä»¥åŠå¤šä¸ª Partition çš„è´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½ã€‚ä¸è¿‡ï¼Œåœ¨ Kafka 2.8 ä¹‹åï¼Œå¼•å…¥äº†åŸºäº Raft åè®®çš„ KRaft æ¨¡å¼ï¼Œä¸å†ä¾èµ– Zookeeperï¼Œå¤§å¤§ç®€åŒ–äº† Kafka çš„æ¶æ„ã€‚</li>
<li><strong>Hbase</strong> : ZooKeeper ä¸º Hbase æä¾›ç¡®ä¿æ•´ä¸ªé›†ç¾¤åªæœ‰ä¸€ä¸ª Master ä»¥åŠä¿å­˜å’Œæä¾› regionserver çŠ¶æ€ä¿¡æ¯ï¼ˆæ˜¯å¦åœ¨çº¿ï¼‰ç­‰åŠŸèƒ½ã€‚</li>
<li><strong>Hadoop</strong> : ZooKeeper ä¸º Namenode æä¾›é«˜å¯ç”¨æ”¯æŒã€‚</li>
</ul>
<h3 id="ZooKeeper-ç‰¹ç‚¹"><a href="#ZooKeeper-ç‰¹ç‚¹" class="headerlink" title="ZooKeeper ç‰¹ç‚¹"></a>ZooKeeper ç‰¹ç‚¹</h3><ul>
<li><strong>é¡ºåºä¸€è‡´æ€§ï¼š</strong> ä»åŒä¸€å®¢æˆ·ç«¯å‘èµ·çš„äº‹åŠ¡è¯·æ±‚ï¼Œæœ€ç»ˆå°†ä¼šä¸¥æ ¼åœ°æŒ‰ç…§é¡ºåºè¢«åº”ç”¨åˆ° ZooKeeper ä¸­å»ã€‚</li>
<li><strong>åŸå­æ€§ï¼š</strong> æ‰€æœ‰äº‹åŠ¡è¯·æ±‚çš„å¤„ç†ç»“æœåœ¨æ•´ä¸ªé›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¸Šçš„åº”ç”¨æƒ…å†µæ˜¯ä¸€è‡´çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¦ä¹ˆæ•´ä¸ªé›†ç¾¤ä¸­æ‰€æœ‰çš„æœºå™¨éƒ½æˆåŠŸåº”ç”¨äº†æŸä¸€ä¸ªäº‹åŠ¡ï¼Œè¦ä¹ˆéƒ½æ²¡æœ‰åº”ç”¨ã€‚</li>
<li><strong>å•ä¸€ç³»ç»Ÿæ˜ åƒï¼š</strong> æ— è®ºå®¢æˆ·ç«¯è¿åˆ°å“ªä¸€ä¸ª ZooKeeper æœåŠ¡å™¨ä¸Šï¼Œå…¶çœ‹åˆ°çš„æœåŠ¡ç«¯æ•°æ®æ¨¡å‹éƒ½æ˜¯ä¸€è‡´çš„ã€‚</li>
<li><strong>å¯é æ€§ï¼š</strong> ä¸€æ—¦ä¸€æ¬¡æ›´æ”¹è¯·æ±‚è¢«åº”ç”¨ï¼Œæ›´æ”¹çš„ç»“æœå°±ä¼šè¢«æŒä¹…åŒ–ï¼Œç›´åˆ°è¢«ä¸‹ä¸€æ¬¡æ›´æ”¹è¦†ç›–ã€‚</li>
<li><strong>å®æ—¶æ€§ï¼š</strong> ä¸€æ—¦æ•°æ®å‘ç”Ÿå˜æ›´ï¼Œå…¶ä»–èŠ‚ç‚¹ä¼šå®æ—¶æ„ŸçŸ¥åˆ°ã€‚æ¯ä¸ªå®¢æˆ·ç«¯çš„ç³»ç»Ÿè§†å›¾éƒ½æ˜¯æœ€æ–°çš„ã€‚</li>
<li><strong>é›†ç¾¤éƒ¨ç½²</strong>ï¼š3~5 å°ï¼ˆæœ€å¥½å¥‡æ•°å°ï¼‰æœºå™¨å°±å¯ä»¥ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œæ¯å°æœºå™¨éƒ½åœ¨å†…å­˜ä¿å­˜äº† ZooKeeper çš„å…¨éƒ¨æ•°æ®ï¼Œæœºå™¨ä¹‹é—´äº’ç›¸é€šä¿¡åŒæ­¥æ•°æ®ï¼Œå®¢æˆ·ç«¯è¿æ¥ä»»ä½•ä¸€å°æœºå™¨éƒ½å¯ä»¥ã€‚</li>
<li><strong>é«˜å¯ç”¨ï¼š</strong>å¦‚æœæŸå°æœºå™¨å®•æœºï¼Œä¼šä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€‚é›†ç¾¤ä¸­æŒ‚æ‰ä¸è¶…è¿‡ä¸€åŠçš„æœºå™¨ï¼Œéƒ½èƒ½ä¿è¯é›†ç¾¤å¯ç”¨ã€‚æ¯”å¦‚ 3 å°æœºå™¨å¯ä»¥æŒ‚ 1 å°ï¼Œ5 å°æœºå™¨å¯ä»¥æŒ‚ 2 å°ã€‚</li>
</ul>
<h3 id="ZooKeeper-åº”ç”¨åœºæ™¯"><a href="#ZooKeeper-åº”ç”¨åœºæ™¯" class="headerlink" title="ZooKeeper åº”ç”¨åœºæ™¯"></a>ZooKeeper åº”ç”¨åœºæ™¯</h3><p>ZooKeeper æ¦‚è§ˆä¸­ï¼Œæˆ‘ä»¬ä»‹ç»åˆ°ä½¿ç”¨å…¶é€šå¸¸è¢«ç”¨äºå®ç°è¯¸å¦‚æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…ã€è´Ÿè½½å‡è¡¡ã€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼åè°ƒ&#x2F;é€šçŸ¥ã€é›†ç¾¤ç®¡ç†ã€Master é€‰ä¸¾ã€åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é˜Ÿåˆ—ç­‰åŠŸèƒ½ã€‚</p>
<p>ä¸‹é¢é€‰ 3 ä¸ªå…¸å‹çš„åº”ç”¨åœºæ™¯æ¥ä¸“é—¨è¯´è¯´ï¼š</p>
<ol>
<li><strong>å‘½åæœåŠ¡</strong>ï¼šå¯ä»¥é€šè¿‡ ZooKeeper çš„é¡ºåºèŠ‚ç‚¹ç”Ÿæˆå…¨å±€å”¯ä¸€ IDã€‚</li>
<li><strong>æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…</strong>ï¼šé€šè¿‡ <strong>Watcher æœºåˆ¶</strong> å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ç°æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…ã€‚å½“ä½ å°†æ•°æ®å‘å¸ƒåˆ° ZooKeeper è¢«ç›‘å¬çš„èŠ‚ç‚¹ä¸Šï¼Œå…¶ä»–æœºå™¨å¯é€šè¿‡ç›‘å¬ ZooKeeper ä¸ŠèŠ‚ç‚¹çš„å˜åŒ–æ¥å®ç°é…ç½®çš„åŠ¨æ€æ›´æ–°ã€‚</li>
<li><strong>åˆ†å¸ƒå¼é”</strong>ï¼šé€šè¿‡åˆ›å»ºå”¯ä¸€èŠ‚ç‚¹è·å¾—åˆ†å¸ƒå¼é”ï¼Œå½“è·å¾—é”çš„ä¸€æ–¹æ‰§è¡Œå®Œç›¸å…³ä»£ç æˆ–è€…æ˜¯æŒ‚æ‰ä¹‹åå°±é‡Šæ”¾é”ã€‚åˆ†å¸ƒå¼é”çš„å®ç°ä¹Ÿéœ€è¦ç”¨åˆ° <strong>Watcher æœºåˆ¶</strong> ï¼Œæˆ‘åœ¨ <a href="https://javaguide.cn/distributed-system/distributed-lock.html">åˆ†å¸ƒå¼é”è¯¦è§£</a> è¿™ç¯‡æ–‡ç« ä¸­æœ‰è¯¦ç»†ä»‹ç»åˆ°å¦‚ä½•åŸºäº ZooKeeper å®ç°åˆ†å¸ƒå¼é”ã€‚</li>
</ol>
<p>å®é™…ä¸Šï¼Œè¿™äº›åŠŸèƒ½çš„å®ç°åŸºæœ¬éƒ½å¾—ç›Šäº ZooKeeper å¯ä»¥ä¿å­˜æ•°æ®çš„åŠŸèƒ½ï¼Œä½†æ˜¯ ZooKeeper ä¸é€‚åˆä¿å­˜å¤§é‡æ•°æ®ï¼Œè¿™ä¸€ç‚¹éœ€è¦æ³¨æ„ã€‚</p>
<h2 id="ZooKeeper-é‡è¦æ¦‚å¿µ"><a href="#ZooKeeper-é‡è¦æ¦‚å¿µ" class="headerlink" title="ZooKeeper é‡è¦æ¦‚å¿µ"></a>ZooKeeper é‡è¦æ¦‚å¿µ</h2><p><em>ç ´éŸ³ï¼šæ‹¿å‡ºå°æœ¬æœ¬ï¼Œä¸‹é¢çš„å†…å®¹éå¸¸é‡è¦å“¦ï¼</em></p>
<h3 id="Data-modelï¼ˆæ•°æ®æ¨¡å‹ï¼‰"><a href="#Data-modelï¼ˆæ•°æ®æ¨¡å‹ï¼‰" class="headerlink" title="Data modelï¼ˆæ•°æ®æ¨¡å‹ï¼‰"></a>Data modelï¼ˆæ•°æ®æ¨¡å‹ï¼‰</h3><p>ZooKeeper æ•°æ®æ¨¡å‹é‡‡ç”¨å±‚æ¬¡åŒ–çš„å¤šå‰æ ‘å½¢ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½å¯ä»¥å­˜å‚¨æ•°æ®ï¼Œè¿™äº›æ•°æ®å¯ä»¥æ˜¯æ•°å­—ã€å­—ç¬¦ä¸²æˆ–è€…æ˜¯äºŒè¿›åˆ¶åºåˆ—ã€‚å¹¶ä¸”ã€‚æ¯ä¸ªèŠ‚ç‚¹è¿˜å¯ä»¥æ‹¥æœ‰ N ä¸ªå­èŠ‚ç‚¹ï¼Œæœ€ä¸Šå±‚æ˜¯æ ¹èŠ‚ç‚¹ä»¥â€œ&#x2F;â€æ¥ä»£è¡¨ã€‚æ¯ä¸ªæ•°æ®èŠ‚ç‚¹åœ¨ ZooKeeper ä¸­è¢«ç§°ä¸º <strong>znode</strong>ï¼Œå®ƒæ˜¯ ZooKeeper ä¸­æ•°æ®çš„æœ€å°å•å…ƒã€‚å¹¶ä¸”ï¼Œæ¯ä¸ª znode éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„è·¯å¾„æ ‡è¯†ã€‚</p>
<p>å¼ºè°ƒä¸€å¥ï¼š<strong>ZooKeeper ä¸»è¦æ˜¯ç”¨æ¥åè°ƒæœåŠ¡çš„ï¼Œè€Œä¸æ˜¯ç”¨æ¥å­˜å‚¨ä¸šåŠ¡æ•°æ®çš„ï¼Œæ‰€ä»¥ä¸è¦æ”¾æ¯”è¾ƒå¤§çš„æ•°æ®åœ¨ znode ä¸Šï¼ŒZooKeeper ç»™å‡ºçš„æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®å¤§å°ä¸Šé™æ˜¯ 1M ã€‚</strong></p>
<p>ä»ä¸‹å›¾å¯ä»¥æ›´ç›´è§‚åœ°çœ‹å‡ºï¼šZooKeeper èŠ‚ç‚¹è·¯å¾„æ ‡è¯†æ–¹å¼å’Œ Unix æ–‡ä»¶ç³»ç»Ÿè·¯å¾„éå¸¸ç›¸ä¼¼ï¼Œéƒ½æ˜¯ç”±ä¸€ç³»åˆ—ä½¿ç”¨æ–œæ â€&#x2F;â€œè¿›è¡Œåˆ†å‰²çš„è·¯å¾„è¡¨ç¤ºï¼Œå¼€å‘äººå‘˜å¯ä»¥å‘è¿™ä¸ªèŠ‚ç‚¹ä¸­å†™å…¥æ•°æ®ï¼Œä¹Ÿå¯ä»¥åœ¨èŠ‚ç‚¹ä¸‹é¢åˆ›å»ºå­èŠ‚ç‚¹ã€‚è¿™äº›æ“ä½œæˆ‘ä»¬åé¢éƒ½ä¼šä»‹ç»åˆ°ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/distributed-system/zookeeper/znode-structure.png" alt="ZooKeeper æ•°æ®æ¨¡å‹"></p>
<h3 id="znodeï¼ˆæ•°æ®èŠ‚ç‚¹ï¼‰"><a href="#znodeï¼ˆæ•°æ®èŠ‚ç‚¹ï¼‰" class="headerlink" title="znodeï¼ˆæ•°æ®èŠ‚ç‚¹ï¼‰"></a>znodeï¼ˆæ•°æ®èŠ‚ç‚¹ï¼‰</h3><p>ä»‹ç»äº† ZooKeeper æ ‘å½¢æ•°æ®æ¨¡å‹ä¹‹åï¼Œæˆ‘ä»¬çŸ¥é“æ¯ä¸ªæ•°æ®èŠ‚ç‚¹åœ¨ ZooKeeper ä¸­è¢«ç§°ä¸º <strong>znode</strong>ï¼Œå®ƒæ˜¯ ZooKeeper ä¸­æ•°æ®çš„æœ€å°å•å…ƒã€‚ä½ è¦å­˜æ”¾çš„æ•°æ®å°±æ”¾åœ¨ä¸Šé¢ï¼Œæ˜¯ä½ ä½¿ç”¨ ZooKeeper è¿‡ç¨‹ä¸­ç»å¸¸éœ€è¦æ¥è§¦åˆ°çš„ä¸€ä¸ªæ¦‚å¿µã€‚</p>
<p>æˆ‘ä»¬é€šå¸¸æ˜¯å°† znode åˆ†ä¸º 4 å¤§ç±»ï¼š</p>
<ul>
<li><strong>æŒä¹…ï¼ˆPERSISTENTï¼‰èŠ‚ç‚¹</strong>ï¼šä¸€æ—¦åˆ›å»ºå°±ä¸€ç›´å­˜åœ¨å³ä½¿ ZooKeeper é›†ç¾¤å®•æœºï¼Œç›´åˆ°å°†å…¶åˆ é™¤ã€‚</li>
<li><strong>ä¸´æ—¶ï¼ˆEPHEMERALï¼‰èŠ‚ç‚¹</strong>ï¼šä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ <strong>å®¢æˆ·ç«¯ä¼šè¯ï¼ˆsessionï¼‰</strong> ç»‘å®šçš„ï¼Œ<strong>ä¼šè¯æ¶ˆå¤±åˆ™èŠ‚ç‚¹æ¶ˆå¤±</strong>ã€‚å¹¶ä¸”ï¼Œ<strong>ä¸´æ—¶èŠ‚ç‚¹åªèƒ½åšå¶å­èŠ‚ç‚¹</strong> ï¼Œä¸èƒ½åˆ›å»ºå­èŠ‚ç‚¹ã€‚</li>
<li><strong>æŒä¹…é¡ºåºï¼ˆPERSISTENT_SEQUENTIALï¼‰èŠ‚ç‚¹</strong>ï¼šé™¤äº†å…·æœ‰æŒä¹…ï¼ˆPERSISTENTï¼‰èŠ‚ç‚¹çš„ç‰¹æ€§ä¹‹å¤–ï¼Œ å­èŠ‚ç‚¹çš„åç§°è¿˜å…·æœ‰é¡ºåºæ€§ã€‚æ¯”å¦‚ <code>/node1/app0000000001</code>ã€<code>/node1/app0000000002</code> ã€‚</li>
<li><strong>ä¸´æ—¶é¡ºåºï¼ˆEPHEMERAL_SEQUENTIALï¼‰èŠ‚ç‚¹</strong>ï¼šé™¤äº†å…·å¤‡ä¸´æ—¶ï¼ˆEPHEMERALï¼‰èŠ‚ç‚¹çš„ç‰¹æ€§ä¹‹å¤–ï¼Œå­èŠ‚ç‚¹çš„åç§°è¿˜å…·æœ‰é¡ºåºæ€§</li>
</ul>
<p>æ¯ä¸ª znode ç”± 2 éƒ¨åˆ†ç»„æˆ:</p>
<ul>
<li><strong>stat</strong>ï¼šçŠ¶æ€ä¿¡æ¯</li>
<li><strong>data</strong>ï¼šèŠ‚ç‚¹å­˜æ”¾çš„æ•°æ®çš„å…·ä½“å†…å®¹</li>
</ul>
<p>å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘é€šè¿‡ get å‘½ä»¤æ¥è·å– æ ¹ç›®å½•ä¸‹çš„ dubbo èŠ‚ç‚¹çš„å†…å®¹ã€‚ï¼ˆget å‘½ä»¤åœ¨ä¸‹é¢ä¼šä»‹ç»åˆ°ï¼‰ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[zk: 127.0.0.1:2181(CONNECTED) 6] get /dubbo</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¯¥æ•°æ®èŠ‚ç‚¹å…³è”çš„æ•°æ®å†…å®¹ä¸ºç©º</span></span><br><span class="line">null</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸‹é¢æ˜¯è¯¥æ•°æ®èŠ‚ç‚¹çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œå…¶å®å°±æ˜¯ Stat å¯¹è±¡çš„æ ¼å¼åŒ–è¾“å‡º</span></span><br><span class="line">cZxid = 0x2</span><br><span class="line">ctime = Tue Nov 27 11:05:34 CST 2018</span><br><span class="line">mZxid = 0x2</span><br><span class="line">mtime = Tue Nov 27 11:05:34 CST 2018</span><br><span class="line">pZxid = 0x3</span><br><span class="line">cversion = 1</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 0</span><br><span class="line">numChildren = 1</span><br></pre></td></tr></table></figure>

<p>Stat ç±»ä¸­åŒ…å«äº†ä¸€ä¸ªæ•°æ®èŠ‚ç‚¹çš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯çš„å­—æ®µï¼ŒåŒ…æ‹¬äº‹åŠ¡ IDï¼ˆcZxidï¼‰ã€èŠ‚ç‚¹åˆ›å»ºæ—¶é—´ï¼ˆctimeï¼‰ å’Œå­èŠ‚ç‚¹ä¸ªæ•°ï¼ˆnumChildrenï¼‰ ç­‰ç­‰ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ¯ä¸ª znode çŠ¶æ€ä¿¡æ¯ç©¶ç«Ÿä»£è¡¨çš„æ˜¯ä»€ä¹ˆå§ï¼ï¼ˆä¸‹é¢çš„å†…å®¹æ¥æºäºã€Šä» Paxos åˆ° ZooKeeper åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ï¼Œå› ä¸º Guide ç¡®å®ä¹Ÿä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šï¼Œè¦å­¦ä¼šå‚è€ƒèµ„æ–™çš„å˜›ï¼ ï¼‰ï¼š</p>
<table>
<thead>
<tr>
<th>znode çŠ¶æ€ä¿¡æ¯</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td>cZxid</td>
<td>create ZXIDï¼Œå³è¯¥æ•°æ®èŠ‚ç‚¹è¢«åˆ›å»ºæ—¶çš„äº‹åŠ¡ id</td>
</tr>
<tr>
<td>ctime</td>
<td>create timeï¼Œå³è¯¥èŠ‚ç‚¹çš„åˆ›å»ºæ—¶é—´</td>
</tr>
<tr>
<td>mZxid</td>
<td>modified ZXIDï¼Œå³è¯¥èŠ‚ç‚¹æœ€ç»ˆä¸€æ¬¡æ›´æ–°æ—¶çš„äº‹åŠ¡ id</td>
</tr>
<tr>
<td>mtime</td>
<td>modified timeï¼Œå³è¯¥èŠ‚ç‚¹æœ€åä¸€æ¬¡çš„æ›´æ–°æ—¶é—´</td>
</tr>
<tr>
<td>pZxid</td>
<td>è¯¥èŠ‚ç‚¹çš„å­èŠ‚ç‚¹åˆ—è¡¨æœ€åä¸€æ¬¡ä¿®æ”¹æ—¶çš„äº‹åŠ¡ idï¼Œåªæœ‰å­èŠ‚ç‚¹åˆ—è¡¨å˜æ›´æ‰ä¼šæ›´æ–° pZxidï¼Œå­èŠ‚ç‚¹å†…å®¹å˜æ›´ä¸ä¼šæ›´æ–°</td>
</tr>
<tr>
<td>cversion</td>
<td>å­èŠ‚ç‚¹ç‰ˆæœ¬å·ï¼Œå½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ¯æ¬¡å˜åŒ–æ—¶å€¼å¢åŠ  1</td>
</tr>
<tr>
<td>dataVersion</td>
<td>æ•°æ®èŠ‚ç‚¹å†…å®¹ç‰ˆæœ¬å·ï¼ŒèŠ‚ç‚¹åˆ›å»ºæ—¶ä¸º 0ï¼Œæ¯æ›´æ–°ä¸€æ¬¡èŠ‚ç‚¹å†…å®¹(ä¸ç®¡å†…å®¹æœ‰æ— å˜åŒ–)è¯¥ç‰ˆæœ¬å·çš„å€¼å¢åŠ  1</td>
</tr>
<tr>
<td>aclVersion</td>
<td>èŠ‚ç‚¹çš„ ACL ç‰ˆæœ¬å·ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹ ACL ä¿¡æ¯å˜æ›´æ¬¡æ•°</td>
</tr>
<tr>
<td>ephemeralOwner</td>
<td>åˆ›å»ºè¯¥ä¸´æ—¶èŠ‚ç‚¹çš„ä¼šè¯çš„ sessionIdï¼›å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºæŒä¹…èŠ‚ç‚¹ï¼Œåˆ™ ephemeralOwner&#x3D;0</td>
</tr>
<tr>
<td>dataLength</td>
<td>æ•°æ®èŠ‚ç‚¹å†…å®¹é•¿åº¦</td>
</tr>
<tr>
<td>numChildren</td>
<td>å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°</td>
</tr>
</tbody></table>
<h3 id="ç‰ˆæœ¬ï¼ˆversionï¼‰"><a href="#ç‰ˆæœ¬ï¼ˆversionï¼‰" class="headerlink" title="ç‰ˆæœ¬ï¼ˆversionï¼‰"></a>ç‰ˆæœ¬ï¼ˆversionï¼‰</h3><p>åœ¨å‰é¢æˆ‘ä»¬å·²ç»æåˆ°ï¼Œå¯¹åº”äºæ¯ä¸ª znodeï¼ŒZooKeeper éƒ½ä¼šä¸ºå…¶ç»´æŠ¤ä¸€ä¸ªå«ä½œ <strong>Stat</strong> çš„æ•°æ®ç»“æ„ï¼ŒStat ä¸­è®°å½•äº†è¿™ä¸ª znode çš„ä¸‰ä¸ªç›¸å…³çš„ç‰ˆæœ¬ï¼š</p>
<ul>
<li><strong>dataVersion</strong>ï¼šå½“å‰ znode èŠ‚ç‚¹çš„ç‰ˆæœ¬å·</li>
<li><strong>cversion</strong>ï¼šå½“å‰ znode å­èŠ‚ç‚¹çš„ç‰ˆæœ¬</li>
<li><strong>aclVersion</strong>ï¼šå½“å‰ znode çš„ ACL çš„ç‰ˆæœ¬ã€‚</li>
</ul>
<h3 id="ACLï¼ˆæƒé™æ§åˆ¶ï¼‰"><a href="#ACLï¼ˆæƒé™æ§åˆ¶ï¼‰" class="headerlink" title="ACLï¼ˆæƒé™æ§åˆ¶ï¼‰"></a>ACLï¼ˆæƒé™æ§åˆ¶ï¼‰</h3><p>ZooKeeper é‡‡ç”¨ ACLï¼ˆAccessControlListsï¼‰ç­–ç•¥æ¥è¿›è¡Œæƒé™æ§åˆ¶ï¼Œç±»ä¼¼äº UNIX æ–‡ä»¶ç³»ç»Ÿçš„æƒé™æ§åˆ¶ã€‚</p>
<p>å¯¹äº znode æ“ä½œçš„æƒé™ï¼ŒZooKeeper æä¾›äº†ä»¥ä¸‹ 5 ç§ï¼š</p>
<ul>
<li><strong>CREATE</strong> : èƒ½åˆ›å»ºå­èŠ‚ç‚¹</li>
<li><strong>READ</strong>ï¼šèƒ½è·å–èŠ‚ç‚¹æ•°æ®å’Œåˆ—å‡ºå…¶å­èŠ‚ç‚¹</li>
<li><strong>WRITE</strong> : èƒ½è®¾ç½®&#x2F;æ›´æ–°èŠ‚ç‚¹æ•°æ®</li>
<li><strong>DELETE</strong> : èƒ½åˆ é™¤å­èŠ‚ç‚¹</li>
<li><strong>ADMIN</strong> : èƒ½è®¾ç½®èŠ‚ç‚¹ ACL çš„æƒé™</li>
</ul>
<p>å…¶ä¸­å°¤å…¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>CREATE</strong> å’Œ <strong>DELETE</strong> è¿™ä¸¤ç§æƒé™éƒ½æ˜¯é’ˆå¯¹ <strong>å­èŠ‚ç‚¹</strong> çš„æƒé™æ§åˆ¶ã€‚</p>
<p>å¯¹äºèº«ä»½è®¤è¯ï¼Œæä¾›äº†ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p>
<ul>
<li><strong>world</strong>ï¼šé»˜è®¤æ–¹å¼ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½å¯æ— æ¡ä»¶è®¿é—®ã€‚</li>
<li><strong>auth</strong> :ä¸ä½¿ç”¨ä»»ä½• idï¼Œä»£è¡¨ä»»ä½•å·²è®¤è¯çš„ç”¨æˆ·ã€‚</li>
<li><strong>digest</strong> :ç”¨æˆ·å:å¯†ç è®¤è¯æ–¹å¼ï¼š<em>username:password</em> ã€‚</li>
<li><strong>ip</strong> : å¯¹æŒ‡å®š ip è¿›è¡Œé™åˆ¶ã€‚</li>
</ul>
<h3 id="Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰"><a href="#Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰" class="headerlink" title="Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰"></a>Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰</h3><p>Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰ï¼Œæ˜¯ ZooKeeper ä¸­çš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹æ€§ã€‚ZooKeeper å…è®¸ç”¨æˆ·åœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€äº› Watcherï¼Œå¹¶ä¸”åœ¨ä¸€äº›ç‰¹å®šäº‹ä»¶è§¦å‘çš„æ—¶å€™ï¼ŒZooKeeper æœåŠ¡ç«¯ä¼šå°†äº‹ä»¶é€šçŸ¥åˆ°æ„Ÿå…´è¶£çš„å®¢æˆ·ç«¯ä¸Šå»ï¼Œè¯¥æœºåˆ¶æ˜¯ ZooKeeper å®ç°åˆ†å¸ƒå¼åè°ƒæœåŠ¡çš„é‡è¦ç‰¹æ€§ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/distributed-system/zookeeper/zookeeper-watcher.png" alt="ZooKeeper Watcher æœºåˆ¶"></p>
<p><em>ç ´éŸ³ï¼šéå¸¸æœ‰ç”¨çš„ä¸€ä¸ªç‰¹æ€§ï¼Œéƒ½æ‹¿å‡ºå°æœ¬æœ¬è®°å¥½äº†ï¼Œåé¢ç”¨åˆ° ZooKeeper åŸºæœ¬ç¦»ä¸å¼€ Watcherï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰æœºåˆ¶ã€‚</em></p>
<h3 id="ä¼šè¯ï¼ˆSessionï¼‰"><a href="#ä¼šè¯ï¼ˆSessionï¼‰" class="headerlink" title="ä¼šè¯ï¼ˆSessionï¼‰"></a>ä¼šè¯ï¼ˆSessionï¼‰</h3><p>Session å¯ä»¥çœ‹ä½œæ˜¯ ZooKeeper æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„ä¹‹é—´çš„ä¸€ä¸ª TCP é•¿è¿æ¥ï¼Œé€šè¿‡è¿™ä¸ªè¿æ¥ï¼Œå®¢æˆ·ç«¯èƒ½å¤Ÿé€šè¿‡å¿ƒè·³æ£€æµ‹ä¸æœåŠ¡å™¨ä¿æŒæœ‰æ•ˆçš„ä¼šè¯ï¼Œä¹Ÿèƒ½å¤Ÿå‘ ZooKeeper æœåŠ¡å™¨å‘é€è¯·æ±‚å¹¶æ¥å—å“åº”ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿé€šè¿‡è¯¥è¿æ¥æ¥æ”¶æ¥è‡ªæœåŠ¡å™¨çš„ Watcher äº‹ä»¶é€šçŸ¥ã€‚</p>
<p>Session æœ‰ä¸€ä¸ªå±æ€§å«åšï¼š<code>sessionTimeout</code> ï¼Œ<code>sessionTimeout</code> ä»£è¡¨ä¼šè¯çš„è¶…æ—¶æ—¶é—´ã€‚å½“ç”±äºæœåŠ¡å™¨å‹åŠ›å¤ªå¤§ã€ç½‘ç»œæ•…éšœæˆ–æ˜¯å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥ç­‰å„ç§åŸå› å¯¼è‡´å®¢æˆ·ç«¯è¿æ¥æ–­å¼€æ—¶ï¼Œåªè¦åœ¨<code>sessionTimeout</code>è§„å®šçš„æ—¶é—´å†…èƒ½å¤Ÿé‡æ–°è¿æ¥ä¸Šé›†ç¾¤ä¸­ä»»æ„ä¸€å°æœåŠ¡å™¨ï¼Œé‚£ä¹ˆä¹‹å‰åˆ›å»ºçš„ä¼šè¯ä»ç„¶æœ‰æ•ˆã€‚</p>
<p>å¦å¤–ï¼Œåœ¨ä¸ºå®¢æˆ·ç«¯åˆ›å»ºä¼šè¯ä¹‹å‰ï¼ŒæœåŠ¡ç«¯é¦–å…ˆä¼šä¸ºæ¯ä¸ªå®¢æˆ·ç«¯éƒ½åˆ†é…ä¸€ä¸ª <code>sessionID</code>ã€‚ç”±äº <code>sessionID</code>æ˜¯ ZooKeeper ä¼šè¯çš„ä¸€ä¸ªé‡è¦æ ‡è¯†ï¼Œè®¸å¤šä¸ä¼šè¯ç›¸å…³çš„è¿è¡Œæœºåˆ¶éƒ½æ˜¯åŸºäºè¿™ä¸ª <code>sessionID</code> çš„ï¼Œå› æ­¤ï¼Œæ— è®ºæ˜¯å“ªå°æœåŠ¡å™¨ä¸ºå®¢æˆ·ç«¯åˆ†é…çš„ <code>sessionID</code>ï¼Œéƒ½åŠ¡å¿…ä¿è¯å…¨å±€å”¯ä¸€ã€‚</p>
<h2 id="ZooKeeper-é›†ç¾¤"><a href="#ZooKeeper-é›†ç¾¤" class="headerlink" title="ZooKeeper é›†ç¾¤"></a>ZooKeeper é›†ç¾¤</h2><p>ä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼Œæœ€å¥½æ˜¯ä»¥é›†ç¾¤å½¢æ€æ¥éƒ¨ç½² ZooKeeperï¼Œè¿™æ ·åªè¦é›†ç¾¤ä¸­å¤§éƒ¨åˆ†æœºå™¨æ˜¯å¯ç”¨çš„ï¼ˆèƒ½å¤Ÿå®¹å¿ä¸€å®šçš„æœºå™¨æ•…éšœï¼‰ï¼Œé‚£ä¹ˆ ZooKeeper æœ¬èº«ä»ç„¶æ˜¯å¯ç”¨çš„ã€‚é€šå¸¸ 3 å°æœåŠ¡å™¨å°±å¯ä»¥æ„æˆä¸€ä¸ª ZooKeeper é›†ç¾¤äº†ã€‚ZooKeeper å®˜æ–¹æä¾›çš„æ¶æ„å›¾å°±æ˜¯ä¸€ä¸ª ZooKeeper é›†ç¾¤æ•´ä½“å¯¹å¤–æä¾›æœåŠ¡ã€‚</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/distributed-system/zookeeper/zookeeper-cluster.png" alt="ZooKeeper é›†ç¾¤æ¶æ„"></p>
<p>ä¸Šå›¾ä¸­æ¯ä¸€ä¸ª Server ä»£è¡¨ä¸€ä¸ªå®‰è£… ZooKeeper æœåŠ¡çš„æœåŠ¡å™¨ã€‚ç»„æˆ ZooKeeper æœåŠ¡çš„æœåŠ¡å™¨éƒ½ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤å½“å‰çš„æœåŠ¡å™¨çŠ¶æ€ï¼Œå¹¶ä¸”æ¯å°æœåŠ¡å™¨ä¹‹é—´éƒ½äº’ç›¸ä¿æŒç€é€šä¿¡ã€‚é›†ç¾¤é—´é€šè¿‡ ZAB åè®®ï¼ˆZooKeeper Atomic Broadcastï¼‰æ¥ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚</p>
<p><strong>æœ€å…¸å‹é›†ç¾¤æ¨¡å¼ï¼šMaster&#x2F;Slave æ¨¡å¼ï¼ˆä¸»å¤‡æ¨¡å¼ï¼‰</strong>ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œé€šå¸¸ Master æœåŠ¡å™¨ä½œä¸ºä¸»æœåŠ¡å™¨æä¾›å†™æœåŠ¡ï¼Œå…¶ä»–çš„ Slave æœåŠ¡å™¨ä»æœåŠ¡å™¨é€šè¿‡å¼‚æ­¥å¤åˆ¶çš„æ–¹å¼è·å– Master æœåŠ¡å™¨æœ€æ–°çš„æ•°æ®æä¾›è¯»æœåŠ¡ã€‚</p>
<h3 id="ZooKeeper-é›†ç¾¤è§’è‰²"><a href="#ZooKeeper-é›†ç¾¤è§’è‰²" class="headerlink" title="ZooKeeper é›†ç¾¤è§’è‰²"></a>ZooKeeper é›†ç¾¤è§’è‰²</h3><p>ä½†æ˜¯ï¼Œåœ¨ ZooKeeper ä¸­æ²¡æœ‰é€‰æ‹©ä¼ ç»Ÿçš„ Master&#x2F;Slave æ¦‚å¿µï¼Œè€Œæ˜¯å¼•å…¥äº† Leaderã€Follower å’Œ Observer ä¸‰ç§è§’è‰²ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/distributed-system/zookeeper/zookeeper-cluser-roles.png" alt="ZooKeeper é›†ç¾¤ä¸­è§’è‰²"></p>
<p>ZooKeeper é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨é€šè¿‡ä¸€ä¸ª <strong>Leader é€‰ä¸¾è¿‡ç¨‹</strong> æ¥é€‰å®šä¸€å°ç§°ä¸º â€œ<strong>Leader</strong>â€ çš„æœºå™¨ï¼ŒLeader æ—¢å¯ä»¥ä¸ºå®¢æˆ·ç«¯æä¾›å†™æœåŠ¡åˆèƒ½æä¾›è¯»æœåŠ¡ã€‚é™¤äº† Leader å¤–ï¼Œ<strong>Follower</strong> å’Œ <strong>Observer</strong> éƒ½åªèƒ½æä¾›è¯»æœåŠ¡ã€‚Follower å’Œ Observer å”¯ä¸€çš„åŒºåˆ«åœ¨äº Observer æœºå™¨ä¸å‚ä¸ Leader çš„é€‰ä¸¾è¿‡ç¨‹ï¼Œä¹Ÿä¸å‚ä¸å†™æ“ä½œçš„â€œè¿‡åŠå†™æˆåŠŸâ€ç­–ç•¥ï¼Œå› æ­¤ Observer æœºå™¨å¯ä»¥åœ¨ä¸å½±å“å†™æ€§èƒ½çš„æƒ…å†µä¸‹æå‡é›†ç¾¤çš„è¯»æ€§èƒ½ã€‚</p>
<table>
<thead>
<tr>
<th>è§’è‰²</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>Leader</td>
<td>ä¸ºå®¢æˆ·ç«¯æä¾›è¯»å’Œå†™çš„æœåŠ¡ï¼Œè´Ÿè´£æŠ•ç¥¨çš„å‘èµ·å’Œå†³è®®ï¼Œæ›´æ–°ç³»ç»ŸçŠ¶æ€ã€‚</td>
</tr>
<tr>
<td>Follower</td>
<td>ä¸ºå®¢æˆ·ç«¯æä¾›è¯»æœåŠ¡ï¼Œå¦‚æœæ˜¯å†™æœåŠ¡åˆ™è½¬å‘ç»™ Leaderã€‚å‚ä¸é€‰ä¸¾è¿‡ç¨‹ä¸­çš„æŠ•ç¥¨ã€‚</td>
</tr>
<tr>
<td>Observer</td>
<td>ä¸ºå®¢æˆ·ç«¯æä¾›è¯»æœåŠ¡ï¼Œå¦‚æœæ˜¯å†™æœåŠ¡åˆ™è½¬å‘ç»™ Leaderã€‚ä¸å‚ä¸é€‰ä¸¾è¿‡ç¨‹ä¸­çš„æŠ•ç¥¨ï¼Œä¹Ÿä¸å‚ä¸â€œè¿‡åŠå†™æˆåŠŸâ€ç­–ç•¥ã€‚åœ¨ä¸å½±å“å†™æ€§èƒ½çš„æƒ…å†µä¸‹æå‡é›†ç¾¤çš„è¯»æ€§èƒ½ã€‚æ­¤è§’è‰²äº ZooKeeper3.3 ç³»åˆ—æ–°å¢çš„è§’è‰²ã€‚</td>
</tr>
</tbody></table>
<h3 id="ZooKeeper-é›†ç¾¤-Leader-é€‰ä¸¾è¿‡ç¨‹"><a href="#ZooKeeper-é›†ç¾¤-Leader-é€‰ä¸¾è¿‡ç¨‹" class="headerlink" title="ZooKeeper é›†ç¾¤ Leader é€‰ä¸¾è¿‡ç¨‹"></a>ZooKeeper é›†ç¾¤ Leader é€‰ä¸¾è¿‡ç¨‹</h3><p>å½“ Leader æœåŠ¡å™¨å‡ºç°ç½‘ç»œä¸­æ–­ã€å´©æºƒé€€å‡ºä¸é‡å¯ç­‰å¼‚å¸¸æƒ…å†µæ—¶ï¼Œå°±ä¼šè¿›å…¥ Leader é€‰ä¸¾è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šé€‰ä¸¾äº§ç”Ÿæ–°çš„ Leader æœåŠ¡å™¨ã€‚</p>
<p>è¿™ä¸ªè¿‡ç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li><strong>Leader electionï¼ˆé€‰ä¸¾é˜¶æ®µï¼‰</strong>ï¼šèŠ‚ç‚¹åœ¨ä¸€å¼€å§‹éƒ½å¤„äºé€‰ä¸¾é˜¶æ®µï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹å¾—åˆ°è¶…åŠæ•°èŠ‚ç‚¹çš„ç¥¨æ•°ï¼Œå®ƒå°±å¯ä»¥å½“é€‰å‡† leaderã€‚</li>
<li><strong>Discoveryï¼ˆå‘ç°é˜¶æ®µï¼‰</strong>ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œfollowers è·Ÿå‡† leader è¿›è¡Œé€šä¿¡ï¼ŒåŒæ­¥ followers æœ€è¿‘æ¥æ”¶çš„äº‹åŠ¡æè®®ã€‚</li>
<li><strong>Synchronizationï¼ˆåŒæ­¥é˜¶æ®µï¼‰</strong>ï¼šåŒæ­¥é˜¶æ®µä¸»è¦æ˜¯åˆ©ç”¨ leader å‰ä¸€é˜¶æ®µè·å¾—çš„æœ€æ–°æè®®å†å²ï¼ŒåŒæ­¥é›†ç¾¤ä¸­æ‰€æœ‰çš„å‰¯æœ¬ã€‚åŒæ­¥å®Œæˆä¹‹åå‡† leader æ‰ä¼šæˆä¸ºçœŸæ­£çš„ leaderã€‚</li>
<li><strong>Broadcastï¼ˆå¹¿æ’­é˜¶æ®µï¼‰</strong>ï¼šåˆ°äº†è¿™ä¸ªé˜¶æ®µï¼ŒZooKeeper é›†ç¾¤æ‰èƒ½æ­£å¼å¯¹å¤–æä¾›äº‹åŠ¡æœåŠ¡ï¼Œå¹¶ä¸” leader å¯ä»¥è¿›è¡Œæ¶ˆæ¯å¹¿æ’­ã€‚åŒæ—¶å¦‚æœæœ‰æ–°çš„èŠ‚ç‚¹åŠ å…¥ï¼Œè¿˜éœ€è¦å¯¹æ–°èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥ã€‚</li>
</ol>
<p>ZooKeeper é›†ç¾¤ä¸­çš„æœåŠ¡å™¨çŠ¶æ€æœ‰ä¸‹é¢å‡ ç§ï¼š</p>
<ul>
<li><strong>LOOKING</strong>ï¼šå¯»æ‰¾ Leaderã€‚</li>
<li><strong>LEADING</strong>ï¼šLeader çŠ¶æ€ï¼Œå¯¹åº”çš„èŠ‚ç‚¹ä¸º Leaderã€‚</li>
<li><strong>FOLLOWING</strong>ï¼šFollower çŠ¶æ€ï¼Œå¯¹åº”çš„èŠ‚ç‚¹ä¸º Followerã€‚</li>
<li><strong>OBSERVING</strong>ï¼šObserver çŠ¶æ€ï¼Œå¯¹åº”èŠ‚ç‚¹ä¸º Observerï¼Œè¯¥èŠ‚ç‚¹ä¸å‚ä¸ Leader é€‰ä¸¾ã€‚</li>
</ul>
<h3 id="ZooKeeper-é›†ç¾¤ä¸ºå•¥æœ€å¥½å¥‡æ•°å°ï¼Ÿ"><a href="#ZooKeeper-é›†ç¾¤ä¸ºå•¥æœ€å¥½å¥‡æ•°å°ï¼Ÿ" class="headerlink" title="ZooKeeper é›†ç¾¤ä¸ºå•¥æœ€å¥½å¥‡æ•°å°ï¼Ÿ"></a>ZooKeeper é›†ç¾¤ä¸ºå•¥æœ€å¥½å¥‡æ•°å°ï¼Ÿ</h3><p>ZooKeeper é›†ç¾¤åœ¨å®•æ‰å‡ ä¸ª ZooKeeper æœåŠ¡å™¨ä¹‹åï¼Œå¦‚æœå‰©ä¸‹çš„ ZooKeeper æœåŠ¡å™¨ä¸ªæ•°å¤§äºå®•æ‰çš„ä¸ªæ•°çš„è¯æ•´ä¸ª ZooKeeper æ‰ä¾ç„¶å¯ç”¨ã€‚å‡å¦‚æˆ‘ä»¬çš„é›†ç¾¤ä¸­æœ‰ n å° ZooKeeper æœåŠ¡å™¨ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯å‰©ä¸‹çš„æœåŠ¡æ•°å¿…é¡»å¤§äº n&#x2F;2ã€‚å…ˆè¯´ä¸€ä¸‹ç»“è®ºï¼Œ2n å’Œ 2n-1 çš„å®¹å¿åº¦æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ n-1ï¼Œå¤§å®¶å¯ä»¥å…ˆè‡ªå·±ä»”ç»†æƒ³ä¸€æƒ³ï¼Œè¿™åº”è¯¥æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„æ•°å­¦é—®é¢˜äº†ã€‚</p>
<p>æ¯”å¦‚å‡å¦‚æˆ‘ä»¬æœ‰ 3 å°ï¼Œé‚£ä¹ˆæœ€å¤§å…è®¸å®•æ‰ 1 å° ZooKeeper æœåŠ¡å™¨ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ 4 å°çš„çš„æ—¶å€™ä¹ŸåŒæ ·åªå…è®¸å®•æ‰ 1 å°ã€‚<br>å‡å¦‚æˆ‘ä»¬æœ‰ 5 å°ï¼Œé‚£ä¹ˆæœ€å¤§å…è®¸å®•æ‰ 2 å° ZooKeeper æœåŠ¡å™¨ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ 6 å°çš„çš„æ—¶å€™ä¹ŸåŒæ ·åªå…è®¸å®•æ‰ 2 å°ã€‚</p>
<p>ç»¼ä¸Šï¼Œä½•å¿…å¢åŠ é‚£ä¸€ä¸ªä¸å¿…è¦çš„ ZooKeeper å‘¢ï¼Ÿ</p>
<h3 id="ZooKeeper-é€‰ä¸¾çš„è¿‡åŠæœºåˆ¶é˜²æ­¢è„‘è£‚"><a href="#ZooKeeper-é€‰ä¸¾çš„è¿‡åŠæœºåˆ¶é˜²æ­¢è„‘è£‚" class="headerlink" title="ZooKeeper é€‰ä¸¾çš„è¿‡åŠæœºåˆ¶é˜²æ­¢è„‘è£‚"></a>ZooKeeper é€‰ä¸¾çš„è¿‡åŠæœºåˆ¶é˜²æ­¢è„‘è£‚</h3><p><strong>ä½•ä¸ºé›†ç¾¤è„‘è£‚ï¼Ÿ</strong></p>
<p>å¯¹äºä¸€ä¸ªé›†ç¾¤ï¼Œé€šå¸¸å¤šå°æœºå™¨ä¼šéƒ¨ç½²åœ¨ä¸åŒæœºæˆ¿ï¼Œæ¥æé«˜è¿™ä¸ªé›†ç¾¤çš„å¯ç”¨æ€§ã€‚ä¿è¯å¯ç”¨æ€§çš„åŒæ—¶ï¼Œä¼šå‘ç”Ÿä¸€ç§æœºæˆ¿é—´ç½‘ç»œçº¿è·¯æ•…éšœï¼Œå¯¼è‡´æœºæˆ¿é—´ç½‘ç»œä¸é€šï¼Œè€Œé›†ç¾¤è¢«å‰²è£‚æˆå‡ ä¸ªå°é›†ç¾¤ã€‚è¿™æ—¶å€™å­é›†ç¾¤å„è‡ªé€‰ä¸»å¯¼è‡´â€œè„‘è£‚â€çš„æƒ…å†µã€‚</p>
<p>ä¸¾ä¾‹è¯´æ˜ï¼šæ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªç”± 6 å°æœåŠ¡å™¨æ‰€ç»„æˆçš„ä¸€ä¸ªé›†ç¾¤ï¼Œéƒ¨ç½²åœ¨äº† 2 ä¸ªæœºæˆ¿ï¼Œæ¯ä¸ªæœºæˆ¿ 3 å°ã€‚æ­£å¸¸æƒ…å†µä¸‹åªæœ‰ 1 ä¸ª leaderï¼Œä½†æ˜¯å½“ä¸¤ä¸ªæœºæˆ¿ä¸­é—´ç½‘ç»œæ–­å¼€çš„æ—¶å€™ï¼Œæ¯ä¸ªæœºæˆ¿çš„ 3 å°æœåŠ¡å™¨éƒ½ä¼šè®¤ä¸ºå¦ä¸€ä¸ªæœºæˆ¿çš„ 3 å°æœåŠ¡å™¨ä¸‹çº¿ï¼Œè€Œé€‰å‡ºè‡ªå·±çš„ leader å¹¶å¯¹å¤–æä¾›æœåŠ¡ã€‚è‹¥æ²¡æœ‰è¿‡åŠæœºåˆ¶ï¼Œå½“ç½‘ç»œæ¢å¤çš„æ—¶å€™ä¼šå‘ç°æœ‰ 2 ä¸ª leaderã€‚ä»¿ä½›æ˜¯ 1 ä¸ªå¤§è„‘ï¼ˆleaderï¼‰åˆ†æ•£æˆäº† 2 ä¸ªå¤§è„‘ï¼Œè¿™å°±å‘ç”Ÿäº†è„‘è£‚ç°è±¡ã€‚è„‘è£‚æœŸé—´ 2 ä¸ªå¤§è„‘éƒ½å¯èƒ½å¯¹å¤–æä¾›äº†æœåŠ¡ï¼Œè¿™å°†ä¼šå¸¦æ¥æ•°æ®ä¸€è‡´æ€§ç­‰é—®é¢˜ã€‚</p>
<p><strong>è¿‡åŠæœºåˆ¶æ˜¯å¦‚ä½•é˜²æ­¢è„‘è£‚ç°è±¡äº§ç”Ÿçš„ï¼Ÿ</strong></p>
<p>ZooKeeper çš„è¿‡åŠæœºåˆ¶å¯¼è‡´ä¸å¯èƒ½äº§ç”Ÿ 2 ä¸ª leaderï¼Œå› ä¸ºå°‘äºç­‰äºä¸€åŠæ˜¯ä¸å¯èƒ½äº§ç”Ÿ leader çš„ï¼Œè¿™å°±ä½¿å¾—ä¸è®ºæœºæˆ¿çš„æœºå™¨å¦‚ä½•åˆ†é…éƒ½ä¸å¯èƒ½å‘ç”Ÿè„‘è£‚ã€‚</p>
<h2 id="ZAB-åè®®å’Œ-Paxos-ç®—æ³•"><a href="#ZAB-åè®®å’Œ-Paxos-ç®—æ³•" class="headerlink" title="ZAB åè®®å’Œ Paxos ç®—æ³•"></a>ZAB åè®®å’Œ Paxos ç®—æ³•</h2><p>Paxos ç®—æ³•åº”è¯¥å¯ä»¥è¯´æ˜¯ ZooKeeper çš„çµé­‚äº†ã€‚ä½†æ˜¯ï¼ŒZooKeeper å¹¶æ²¡æœ‰å®Œå…¨é‡‡ç”¨ Paxos ç®—æ³• ï¼Œè€Œæ˜¯ä½¿ç”¨ ZAB åè®®ä½œä¸ºå…¶ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„æ ¸å¿ƒç®—æ³•ã€‚å¦å¤–ï¼Œåœ¨ ZooKeeper çš„å®˜æ–¹æ–‡æ¡£ä¸­ä¹ŸæŒ‡å‡ºï¼ŒZAB åè®®å¹¶ä¸åƒ Paxos ç®—æ³•é‚£æ ·ï¼Œæ˜¯ä¸€ç§é€šç”¨çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹åˆ«ä¸º Zookeeper è®¾è®¡çš„å´©æºƒå¯æ¢å¤çš„åŸå­æ¶ˆæ¯å¹¿æ’­ç®—æ³•ã€‚</p>
<h3 id="ZAB-åè®®ä»‹ç»"><a href="#ZAB-åè®®ä»‹ç»" class="headerlink" title="ZAB åè®®ä»‹ç»"></a>ZAB åè®®ä»‹ç»</h3><p>ZABï¼ˆZooKeeper Atomic Broadcastï¼ŒåŸå­å¹¿æ’­ï¼‰ åè®®æ˜¯ä¸ºåˆ†å¸ƒå¼åè°ƒæœåŠ¡ ZooKeeper ä¸“é—¨è®¾è®¡çš„ä¸€ç§æ”¯æŒå´©æºƒæ¢å¤çš„åŸå­å¹¿æ’­åè®®ã€‚ åœ¨ ZooKeeper ä¸­ï¼Œä¸»è¦ä¾èµ– ZAB åè®®æ¥å®ç°åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§ï¼ŒåŸºäºè¯¥åè®®ï¼ŒZooKeeper å®ç°äº†ä¸€ç§ä¸»å¤‡æ¨¡å¼çš„ç³»ç»Ÿæ¶æ„æ¥ä¿æŒé›†ç¾¤ä¸­å„ä¸ªå‰¯æœ¬ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ã€‚</p>
<h3 id="ZAB-åè®®ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼šå´©æºƒæ¢å¤å’Œæ¶ˆæ¯å¹¿æ’­"><a href="#ZAB-åè®®ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼šå´©æºƒæ¢å¤å’Œæ¶ˆæ¯å¹¿æ’­" class="headerlink" title="ZAB åè®®ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼šå´©æºƒæ¢å¤å’Œæ¶ˆæ¯å¹¿æ’­"></a>ZAB åè®®ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼šå´©æºƒæ¢å¤å’Œæ¶ˆæ¯å¹¿æ’­</h3><p>ZAB åè®®åŒ…æ‹¬ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯</p>
<ul>
<li><strong>å´©æºƒæ¢å¤</strong>ï¼šå½“æ•´ä¸ªæœåŠ¡æ¡†æ¶åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæˆ–æ˜¯å½“ Leader æœåŠ¡å™¨å‡ºç°ç½‘ç»œä¸­æ–­ã€å´©æºƒé€€å‡ºä¸é‡å¯ç­‰å¼‚å¸¸æƒ…å†µæ—¶ï¼ŒZAB åè®®å°±ä¼šè¿›å…¥æ¢å¤æ¨¡å¼å¹¶é€‰ä¸¾äº§ç”Ÿæ–°çš„ Leader æœåŠ¡å™¨ã€‚å½“é€‰ä¸¾äº§ç”Ÿäº†æ–°çš„ Leader æœåŠ¡å™¨ï¼ŒåŒæ—¶é›†ç¾¤ä¸­å·²ç»æœ‰è¿‡åŠçš„æœºå™¨ä¸è¯¥ Leader æœåŠ¡å™¨å®Œæˆäº†çŠ¶æ€åŒæ­¥ä¹‹åï¼ŒZAB åè®®å°±ä¼šé€€å‡ºæ¢å¤æ¨¡å¼ã€‚å…¶ä¸­ï¼Œ<strong>æ‰€è°“çš„çŠ¶æ€åŒæ­¥æ˜¯æŒ‡æ•°æ®åŒæ­¥ï¼Œç”¨æ¥ä¿è¯é›†ç¾¤ä¸­å­˜åœ¨è¿‡åŠçš„æœºå™¨èƒ½å¤Ÿå’Œ Leader æœåŠ¡å™¨çš„æ•°æ®çŠ¶æ€ä¿æŒä¸€è‡´</strong>ã€‚</li>
<li><strong>æ¶ˆæ¯å¹¿æ’­</strong>ï¼š<strong>å½“é›†ç¾¤ä¸­å·²ç»æœ‰è¿‡åŠçš„ Follower æœåŠ¡å™¨å®Œæˆäº†å’Œ Leader æœåŠ¡å™¨çš„çŠ¶æ€åŒæ­¥ï¼Œé‚£ä¹ˆæ•´ä¸ªæœåŠ¡æ¡†æ¶å°±å¯ä»¥è¿›å…¥æ¶ˆæ¯å¹¿æ’­æ¨¡å¼äº†ã€‚</strong> å½“ä¸€å°åŒæ ·éµå®ˆ ZAB åè®®çš„æœåŠ¡å™¨å¯åŠ¨ååŠ å…¥åˆ°é›†ç¾¤ä¸­æ—¶ï¼Œå¦‚æœæ­¤æ—¶é›†ç¾¤ä¸­å·²ç»å­˜åœ¨ä¸€ä¸ª Leader æœåŠ¡å™¨åœ¨è´Ÿè´£è¿›è¡Œæ¶ˆæ¯å¹¿æ’­ï¼Œé‚£ä¹ˆæ–°åŠ å…¥çš„æœåŠ¡å™¨å°±ä¼šè‡ªè§‰åœ°è¿›å…¥æ•°æ®æ¢å¤æ¨¡å¼ï¼šæ‰¾åˆ° Leader æ‰€åœ¨çš„æœåŠ¡å™¨ï¼Œå¹¶ä¸å…¶è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œç„¶åä¸€èµ·å‚ä¸åˆ°æ¶ˆæ¯å¹¿æ’­æµç¨‹ä¸­å»ã€‚</li>
</ul>
<h3 id="ZAB-åè®®-Paxos-ç®—æ³•æ–‡ç« æ¨è"><a href="#ZAB-åè®®-Paxos-ç®—æ³•æ–‡ç« æ¨è" class="headerlink" title="ZAB åè®®&amp;Paxos ç®—æ³•æ–‡ç« æ¨è"></a>ZAB åè®®&amp;Paxos ç®—æ³•æ–‡ç« æ¨è</h3><p>å…³äº <strong>ZAB åè®®&amp;Paxos ç®—æ³•</strong> éœ€è¦è®²å’Œç†è§£çš„ä¸œè¥¿å¤ªå¤šäº†ï¼Œå…·ä½“å¯ä»¥çœ‹ä¸‹é¢è¿™å‡ ç¯‡æ–‡ç« ï¼š</p>
<ul>
<li><a href="https://javaguide.cn/distributed-system/protocol/paxos-algorithm.html">Paxos ç®—æ³•è¯¦è§£</a></li>
<li><a href="https://wingsxdu.com/posts/database/zookeeper/">ZooKeeper ä¸ Zab åè®® Â· Analyze</a></li>
<li><a href="https://javaguide.cn/distributed-system/protocol/raft-algorithm.html">Raft ç®—æ³•è¯¦è§£</a></li>
</ul>
<h2 id="ZooKeeper-VS-ETCD"><a href="#ZooKeeper-VS-ETCD" class="headerlink" title="ZooKeeper VS ETCD"></a>ZooKeeper VS ETCD</h2><p><a href="https://etcd.io/">ETCD</a> æ˜¯ä¸€ç§å¼ºä¸€è‡´æ€§çš„åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ï¼Œå®ƒæä¾›äº†ä¸€ç§å¯é çš„æ–¹å¼æ¥å­˜å‚¨éœ€è¦ç”±åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–æœºå™¨é›†ç¾¤è®¿é—®çš„æ•°æ®ã€‚ETCD å†…éƒ¨é‡‡ç”¨ <a href="https://javaguide.cn/distributed-system/protocol/raft-algorithm.html">Raft ç®—æ³•</a>ä½œä¸ºä¸€è‡´æ€§ç®—æ³•ï¼ŒåŸºäº Go è¯­è¨€å®ç°ã€‚</p>
<p>ä¸ ZooKeeper ç±»ä¼¼ï¼ŒETCD ä¹Ÿå¯ç”¨äºæ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…ã€è´Ÿè½½å‡è¡¡ã€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼åè°ƒ&#x2F;é€šçŸ¥ã€åˆ†å¸ƒå¼é”ç­‰åœºæ™¯ã€‚é‚£äºŒè€…å¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿ</p>
<p>å¾—ç‰©æŠ€æœ¯çš„<a href="https://mp.weixin.qq.com/s/pBI3rjv5NdS1124Z7HQ-JA">æµ…æå¦‚ä½•åŸºäº ZooKeeper å®ç°é«˜å¯ç”¨æ¶æ„</a>è¿™ç¯‡æ–‡ç« ç»™å‡ºäº†å¦‚ä¸‹çš„å¯¹æ¯”è¡¨æ ¼ï¼ˆæˆ‘è¿›ä¸€æ­¥åšäº†ä¼˜åŒ–ï¼‰ï¼Œå¯ä»¥ä½œä¸ºå‚è€ƒï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>ZooKeeper</th>
<th>ETCD</th>
</tr>
</thead>
<tbody><tr>
<td><strong>è¯­è¨€</strong></td>
<td>Java</td>
<td>Go</td>
</tr>
<tr>
<td><strong>åè®®</strong></td>
<td>TCP</td>
<td>Grpc</td>
</tr>
<tr>
<td><strong>æ¥å£è°ƒç”¨</strong></td>
<td>å¿…é¡»è¦ä½¿ç”¨è‡ªå·±çš„ client è¿›è¡Œè°ƒç”¨</td>
<td>å¯é€šè¿‡ HTTP ä¼ è¾“ï¼Œå³å¯é€šè¿‡ CURL ç­‰å‘½ä»¤å®ç°è°ƒç”¨</td>
</tr>
<tr>
<td><strong>ä¸€è‡´æ€§ç®—æ³•</strong></td>
<td>Zab åè®®</td>
<td>Raft ç®—æ³•</td>
</tr>
<tr>
<td><strong>Watcher æœºåˆ¶</strong></td>
<td>è¾ƒå±€é™ï¼Œä¸€æ¬¡æ€§è§¦å‘å™¨</td>
<td>ä¸€æ¬¡ Watch å¯ä»¥ç›‘å¬æ‰€æœ‰çš„äº‹ä»¶</td>
</tr>
<tr>
<td><strong>æ•°æ®æ¨¡å‹</strong></td>
<td>åŸºäºç›®å½•çš„å±‚æ¬¡æ¨¡å¼</td>
<td>å‚è€ƒäº† zk çš„æ•°æ®æ¨¡å‹ï¼Œæ˜¯ä¸ªæ‰å¹³çš„ kv æ¨¡å‹</td>
</tr>
<tr>
<td><strong>å­˜å‚¨</strong></td>
<td>kv å­˜å‚¨ï¼Œä½¿ç”¨çš„æ˜¯ ConcurrentHashMapï¼Œå†…å­˜å­˜å‚¨ï¼Œä¸€èˆ¬ä¸å»ºè®®å­˜å‚¨è¾ƒå¤šæ•°æ®</td>
<td>kv å­˜å‚¨ï¼Œä½¿ç”¨ bbolt å­˜å‚¨å¼•æ“ï¼Œå¯ä»¥å¤„ç†å‡ ä¸ª GB çš„æ•°æ®ã€‚</td>
</tr>
<tr>
<td><strong>MVCC</strong></td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒï¼Œé€šè¿‡ä¸¤ä¸ª B+ Tree è¿›è¡Œç‰ˆæœ¬æ§åˆ¶</td>
</tr>
<tr>
<td><strong>å…¨å±€ Session</strong></td>
<td>å­˜åœ¨ç¼ºé™·</td>
<td>å®ç°æ›´çµæ´»ï¼Œé¿å…äº†å®‰å…¨æ€§é—®é¢˜</td>
</tr>
<tr>
<td><strong>æƒé™æ ¡éªŒ</strong></td>
<td>ACL</td>
<td>RBAC</td>
</tr>
<tr>
<td><strong>äº‹åŠ¡èƒ½åŠ›</strong></td>
<td>æä¾›äº†ç®€æ˜“çš„äº‹åŠ¡èƒ½åŠ›</td>
<td>åªæä¾›äº†ç‰ˆæœ¬å·çš„æ£€æŸ¥èƒ½åŠ›</td>
</tr>
<tr>
<td><strong>éƒ¨ç½²ç»´æŠ¤</strong></td>
<td>å¤æ‚</td>
<td>ç®€å•</td>
</tr>
</tbody></table>
<p>ZooKeeper åœ¨å­˜å‚¨æ€§èƒ½ã€å…¨å±€ Sessionã€Watcher æœºåˆ¶ç­‰æ–¹é¢å­˜åœ¨ä¸€å®šå±€é™æ€§ï¼Œè¶Šæ¥è¶Šå¤šçš„å¼€æºé¡¹ç›®åœ¨æ›¿æ¢ ZooKeeper ä¸º Raft å®ç°æˆ–å…¶å®ƒåˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œä¾‹å¦‚ï¼š<a href="https://www.confluent.io/blog/removing-zookeeper-dependency-in-kafka/">Kafka Needs No Keeper - Removing ZooKeeper Dependency (confluent.io)</a>ã€<a href="https://streamnative.io/blog/moving-toward-zookeeper-less-apache-pulsar">Moving Toward a ZooKeeper-Less Apache Pulsar (streamnative.io)</a>ã€‚</p>
<p>ETCD ç›¸å¯¹æ¥è¯´æ›´ä¼˜ç§€ä¸€äº›ï¼Œæä¾›äº†æ›´ç¨³å®šçš„é«˜è´Ÿè½½è¯»å†™èƒ½åŠ›ï¼Œå¯¹ ZooKeeper æš´éœ²çš„è®¸å¤šé—®é¢˜è¿›è¡Œäº†æ”¹è¿›ä¼˜åŒ–ã€‚å¹¶ä¸”ï¼ŒETCD åŸºæœ¬èƒ½å¤Ÿè¦†ç›– ZooKeeper çš„æ‰€æœ‰åº”ç”¨åœºæ™¯ï¼Œå®ç°å¯¹å…¶çš„æ›¿ä»£ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol>
<li>ZooKeeper æœ¬èº«å°±æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç¨‹åºï¼ˆåªè¦åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹å­˜æ´»ï¼ŒZooKeeper å°±èƒ½æ­£å¸¸æœåŠ¡ï¼‰ã€‚</li>
<li>ä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼Œæœ€å¥½æ˜¯ä»¥é›†ç¾¤å½¢æ€æ¥éƒ¨ç½² ZooKeeperï¼Œè¿™æ ·åªè¦é›†ç¾¤ä¸­å¤§éƒ¨åˆ†æœºå™¨æ˜¯å¯ç”¨çš„ï¼ˆèƒ½å¤Ÿå®¹å¿ä¸€å®šçš„æœºå™¨æ•…éšœï¼‰ï¼Œé‚£ä¹ˆ ZooKeeper æœ¬èº«ä»ç„¶æ˜¯å¯ç”¨çš„ã€‚</li>
<li>ZooKeeper å°†æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè¿™ä¹Ÿå°±ä¿è¯äº† é«˜ååé‡å’Œä½å»¶è¿Ÿï¼ˆä½†æ˜¯å†…å­˜é™åˆ¶äº†èƒ½å¤Ÿå­˜å‚¨çš„å®¹é‡ä¸å¤ªå¤§ï¼Œæ­¤é™åˆ¶ä¹Ÿæ˜¯ä¿æŒ znode ä¸­å­˜å‚¨çš„æ•°æ®é‡è¾ƒå°çš„è¿›ä¸€æ­¥åŸå› ï¼‰ã€‚</li>
<li>ZooKeeper æ˜¯é«˜æ€§èƒ½çš„ã€‚ åœ¨â€œè¯»â€å¤šäºâ€œå†™â€çš„åº”ç”¨ç¨‹åºä¸­å°¤å…¶åœ°æ˜æ˜¾ï¼Œå› ä¸ºâ€œå†™â€ä¼šå¯¼è‡´æ‰€æœ‰çš„æœåŠ¡å™¨é—´åŒæ­¥çŠ¶æ€ã€‚ï¼ˆâ€œè¯»â€å¤šäºâ€œå†™â€æ˜¯åè°ƒæœåŠ¡çš„å…¸å‹åœºæ™¯ã€‚ï¼‰</li>
<li>ZooKeeper æœ‰ä¸´æ—¶èŠ‚ç‚¹çš„æ¦‚å¿µã€‚ å½“åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¼šè¯ä¸€ç›´ä¿æŒæ´»åŠ¨ï¼Œç¬æ—¶èŠ‚ç‚¹å°±ä¸€ç›´å­˜åœ¨ã€‚è€Œå½“ä¼šè¯ç»ˆç»“æ—¶ï¼Œç¬æ—¶èŠ‚ç‚¹è¢«åˆ é™¤ã€‚æŒä¹…èŠ‚ç‚¹æ˜¯æŒ‡ä¸€æ—¦è¿™ä¸ª znode è¢«åˆ›å»ºäº†ï¼Œé™¤éä¸»åŠ¨è¿›è¡Œ znode çš„ç§»é™¤æ“ä½œï¼Œå¦åˆ™è¿™ä¸ª znode å°†ä¸€ç›´ä¿å­˜åœ¨ ZooKeeper ä¸Šã€‚</li>
<li>ZooKeeper åº•å±‚å…¶å®åªæä¾›äº†ä¸¤ä¸ªåŠŸèƒ½ï¼šâ‘  ç®¡ç†ï¼ˆå­˜å‚¨ã€è¯»å–ï¼‰ç”¨æˆ·ç¨‹åºæäº¤çš„æ•°æ®ï¼›â‘¡ ä¸ºç”¨æˆ·ç¨‹åºæä¾›æ•°æ®èŠ‚ç‚¹ç›‘å¬æœåŠ¡ã€‚</li>
</ol>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li>ã€Šä» Paxos åˆ° ZooKeeper åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹</li>
<li>è°ˆè°ˆ ZooKeeper çš„å±€é™æ€§ï¼š<a href="https://wingsxdu.com/posts/database/zookeeper-limitations/">https://wingsxdu.com/posts/database/zookeeper-limitations/</a></li>
</ul>
<!-- @include: @article-footer.snippet.md -->

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/02/10/virtual-thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/02/10/virtual-thread/" itemprop="url">è™šæ‹Ÿçº¿ç¨‹å¸¸è§é—®é¢˜æ€»ç»“</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2022-02-10T23:36:46+08:00">
                2022-02-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ï¼Œ 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/%E5%B9%B6%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">å¹¶å‘</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2022/02/10/virtual-thread/" class="leancloud_visitors" data-flag-title="è™šæ‹Ÿçº¿ç¨‹å¸¸è§é—®é¢˜æ€»ç»“">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡&#58;</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  1.6k å­—
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  6 åˆ†é’Ÿ
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>æœ¬æ–‡éƒ¨åˆ†å†…å®¹æ¥è‡ª <a href="https://github.com/Lorin-github">Lorin</a> çš„<a href="https://github.com/Snailclimb/JavaGuide/pull/2190">PR</a>ã€‚</p>
</blockquote>
<p>è™šæ‹Ÿçº¿ç¨‹åœ¨ Java 21 æ­£å¼å‘å¸ƒï¼Œè¿™æ˜¯ä¸€é¡¹é‡é‡çº§çš„æ›´æ–°ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯è™šæ‹Ÿçº¿ç¨‹ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯è™šæ‹Ÿçº¿ç¨‹ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯è™šæ‹Ÿçº¿ç¨‹ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯è™šæ‹Ÿçº¿ç¨‹ï¼Ÿ</h2><p>è™šæ‹Ÿçº¿ç¨‹ï¼ˆVirtual Threadï¼‰æ˜¯ JDK è€Œä¸æ˜¯ OS å®ç°çš„è½»é‡çº§çº¿ç¨‹(Lightweight Processï¼ŒLWPï¼‰ï¼Œç”± JVM è°ƒåº¦ã€‚è®¸å¤šè™šæ‹Ÿçº¿ç¨‹å…±äº«åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œè™šæ‹Ÿçº¿ç¨‹çš„æ•°é‡å¯ä»¥è¿œå¤§äºæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„æ•°é‡ã€‚</p>
<h2 id="è™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"><a href="#è™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ" class="headerlink" title="è™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"></a>è™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</h2><p>åœ¨å¼•å…¥è™šæ‹Ÿçº¿ç¨‹ä¹‹å‰ï¼Œ<code>java.lang.Thread</code> åŒ…å·²ç»æ”¯æŒæ‰€è°“çš„å¹³å°çº¿ç¨‹ï¼ˆPlatform Threadï¼‰ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è™šæ‹Ÿçº¿ç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸€ç›´ä½¿ç”¨çš„çº¿ç¨‹ã€‚JVM è°ƒåº¦ç¨‹åºé€šè¿‡å¹³å°çº¿ç¨‹ï¼ˆè½½ä½“çº¿ç¨‹ï¼‰æ¥ç®¡ç†è™šæ‹Ÿçº¿ç¨‹ï¼Œä¸€ä¸ªå¹³å°çº¿ç¨‹å¯ä»¥åœ¨ä¸åŒçš„æ—¶é—´æ‰§è¡Œä¸åŒçš„è™šæ‹Ÿçº¿ç¨‹ï¼ˆå¤šä¸ªè™šæ‹Ÿçº¿ç¨‹æŒ‚è½½åœ¨ä¸€ä¸ªå¹³å°çº¿ç¨‹ä¸Šï¼‰ï¼Œå½“è™šæ‹Ÿçº¿ç¨‹è¢«é˜»å¡æˆ–ç­‰å¾…æ—¶ï¼Œå¹³å°çº¿ç¨‹å¯ä»¥åˆ‡æ¢åˆ°æ‰§è¡Œå¦ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹ã€‚</p>
<p>è™šæ‹Ÿçº¿ç¨‹ã€å¹³å°çº¿ç¨‹å’Œç³»ç»Ÿå†…æ ¸çº¿ç¨‹çš„å…³ç³»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼ˆå›¾æºï¼š<a href="https://medium.com/javarevisited/how-to-use-java-19-virtual-threads-c16a32bad5f7">How to Use Java 19 Virtual Threads</a>ï¼‰ï¼š</p>
<p><img src="https://oss.javaguide.cn/github/javaguide/java/new-features/virtual-threads-platform-threads-kernel-threads-relationship.png" alt="è™šæ‹Ÿçº¿ç¨‹ã€å¹³å°çº¿ç¨‹å’Œç³»ç»Ÿå†…æ ¸çº¿ç¨‹çš„å…³ç³»"></p>
<p>å…³äºå¹³å°çº¿ç¨‹å’Œç³»ç»Ÿå†…æ ¸çº¿ç¨‹çš„å¯¹åº”å…³ç³»å¤šæä¸€ç‚¹ï¼šåœ¨ Windows å’Œ Linux ç­‰ä¸»æµæ“ä½œç³»ç»Ÿä¸­ï¼ŒJava çº¿ç¨‹é‡‡ç”¨çš„æ˜¯ä¸€å¯¹ä¸€çš„çº¿ç¨‹æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå¹³å°çº¿ç¨‹å¯¹åº”ä¸€ä¸ªç³»ç»Ÿå†…æ ¸çº¿ç¨‹ã€‚Solaris ç³»ç»Ÿæ˜¯ä¸€ä¸ªç‰¹ä¾‹ï¼ŒHotSpot VM åœ¨ Solaris ä¸Šæ”¯æŒå¤šå¯¹å¤šå’Œä¸€å¯¹ä¸€ã€‚å…·ä½“å¯ä»¥å‚è€ƒ R å¤§çš„å›ç­”: <a href="https://www.zhihu.com/question/23096638/answer/29617153">JVM ä¸­çš„çº¿ç¨‹æ¨¡å‹æ˜¯ç”¨æˆ·çº§çš„ä¹ˆï¼Ÿ</a>ã€‚</p>
<h2 id="è™šæ‹Ÿçº¿ç¨‹æœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Ÿ"><a href="#è™šæ‹Ÿçº¿ç¨‹æœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Ÿ" class="headerlink" title="è™šæ‹Ÿçº¿ç¨‹æœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Ÿ"></a>è™šæ‹Ÿçº¿ç¨‹æœ‰ä»€ä¹ˆä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Ÿ</h2><h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><ul>
<li><strong>éå¸¸è½»é‡çº§</strong>ï¼šå¯ä»¥åœ¨å•ä¸ªçº¿ç¨‹ä¸­åˆ›å»ºæˆç™¾ä¸Šåƒä¸ªè™šæ‹Ÿçº¿ç¨‹è€Œä¸ä¼šå¯¼è‡´è¿‡å¤šçš„çº¿ç¨‹åˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li>
<li><strong>ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹</strong>ï¼š è™šæ‹Ÿçº¿ç¨‹å¯ä»¥ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œä½¿ä»£ç æ›´æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚å®ƒå¯ä»¥å°†å¼‚æ­¥ä»£ç ç¼–å†™å¾—æ›´åƒåŒæ­¥ä»£ç ï¼Œé¿å…äº†å›è°ƒåœ°ç‹±ï¼ˆCallback Hellï¼‰ã€‚</li>
<li><strong>å‡å°‘èµ„æºå¼€é”€</strong>ï¼š ç”±äºè™šæ‹Ÿçº¿ç¨‹æ˜¯ç”± JVM å®ç°çš„ï¼Œå®ƒèƒ½å¤Ÿæ›´é«˜æ•ˆåœ°åˆ©ç”¨åº•å±‚èµ„æºï¼Œä¾‹å¦‚ CPU å’Œå†…å­˜ã€‚è™šæ‹Ÿçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”å¹³å°çº¿ç¨‹æ›´è½»é‡ï¼Œå› æ­¤èƒ½å¤Ÿæ›´å¥½åœ°æ”¯æŒé«˜å¹¶å‘åœºæ™¯ã€‚</li>
</ul>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ul>
<li><strong>ä¸é€‚ç”¨äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡</strong>ï¼š è™šæ‹Ÿçº¿ç¨‹é€‚ç”¨äº I&#x2F;O å¯†é›†å‹ä»»åŠ¡ï¼Œä½†ä¸é€‚ç”¨äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œå› ä¸ºå¯†é›†å‹è®¡ç®—å§‹ç»ˆéœ€è¦ CPU èµ„æºä½œä¸ºæ”¯æŒã€‚</li>
<li><strong>ä¸æŸäº›ç¬¬ä¸‰æ–¹åº“ä¸å…¼å®¹</strong>ï¼š è™½ç„¶è™šæ‹Ÿçº¿ç¨‹è®¾è®¡æ—¶è€ƒè™‘äº†ä¸ç°æœ‰ä»£ç çš„å…¼å®¹æ€§ï¼Œä½†æŸäº›ä¾èµ–å¹³å°çº¿ç¨‹ç‰¹æ€§çš„ç¬¬ä¸‰æ–¹åº“å¯èƒ½ä¸å®Œå…¨å…¼å®¹è™šæ‹Ÿçº¿ç¨‹ã€‚</li>
</ul>
<h2 id="å¦‚ä½•åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ï¼Ÿ"><a href="#å¦‚ä½•åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ï¼Ÿ" class="headerlink" title="å¦‚ä½•åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ï¼Ÿ"></a>å¦‚ä½•åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ï¼Ÿ</h2><p>å®˜æ–¹æä¾›äº†ä»¥ä¸‹å››ç§æ–¹å¼åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ï¼š</p>
<ol>
<li>ä½¿ç”¨ <code>Thread.startVirtualThread()</code> åˆ›å»º</li>
<li>ä½¿ç”¨ <code>Thread.ofVirtual()</code> åˆ›å»º</li>
<li>ä½¿ç”¨ <code>ThreadFactory</code> åˆ›å»º</li>
<li>ä½¿ç”¨ <code>Executors.newVirtualThreadPerTaskExecutor()</code>åˆ›å»º</li>
</ol>
<p><strong>1ã€ä½¿ç”¨ <code>Thread.startVirtualThread()</code> åˆ›å»º</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VirtualThreadTest</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">CustomThread</span> <span class="variable">customThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomThread</span>();</span><br><span class="line">    Thread.startVirtualThread(customThread);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CustomThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;CustomThread run&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2ã€ä½¿ç”¨ <code>Thread.ofVirtual()</code> åˆ›å»º</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VirtualThreadTest</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">CustomThread</span> <span class="variable">customThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomThread</span>();</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸å¯åŠ¨</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">unStarted</span> <span class="operator">=</span> Thread.ofVirtual().unstarted(customThread);</span><br><span class="line">    unStarted.start();</span><br><span class="line">    <span class="comment">// åˆ›å»ºç›´æ¥å¯åŠ¨</span></span><br><span class="line">    Thread.ofVirtual().start(customThread);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CustomThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;CustomThread run&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3ã€ä½¿ç”¨ <code>ThreadFactory</code> åˆ›å»º</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VirtualThreadTest</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">CustomThread</span> <span class="variable">customThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomThread</span>();</span><br><span class="line">    <span class="type">ThreadFactory</span> <span class="variable">factory</span> <span class="operator">=</span> Thread.ofVirtual().factory();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> factory.newThread(customThread);</span><br><span class="line">    thread.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CustomThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;CustomThread run&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4ã€ä½¿ç”¨<code>Executors.newVirtualThreadPerTaskExecutor()</code>åˆ›å»º</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VirtualThreadTest</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">CustomThread</span> <span class="variable">customThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomThread</span>();</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newVirtualThreadPerTaskExecutor();</span><br><span class="line">    executor.submit(customThread);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CustomThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;CustomThread run&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹æ€§èƒ½å¯¹æ¯”"><a href="#è™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹æ€§èƒ½å¯¹æ¯”" class="headerlink" title="è™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹æ€§èƒ½å¯¹æ¯”"></a>è™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹æ€§èƒ½å¯¹æ¯”</h2><p>é€šè¿‡å¤šçº¿ç¨‹å’Œè™šæ‹Ÿçº¿ç¨‹çš„æ–¹å¼å¤„ç†ç›¸åŒçš„ä»»åŠ¡ï¼Œå¯¹æ¯”åˆ›å»ºçš„ç³»ç»Ÿçº¿ç¨‹æ•°å’Œå¤„ç†è€—æ—¶ã€‚</p>
<p><strong>è¯´æ˜</strong>ï¼šç»Ÿè®¡åˆ›å»ºçš„ç³»ç»Ÿçº¿ç¨‹ä¸­éƒ¨åˆ†ä¸ºåå°çº¿ç¨‹ï¼ˆæ¯”å¦‚ GC çº¿ç¨‹ï¼‰ï¼Œä¸¤ç§åœºæ™¯ä¸‹éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥å¹¶ä¸å½±å“å¯¹æ¯”ã€‚</p>
<p><strong>æµ‹è¯•ä»£ç </strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VirtualThreadTest</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// å¼€å¯çº¿ç¨‹ ç»Ÿè®¡å¹³å°çº¿ç¨‹æ•°</span></span><br><span class="line">        <span class="type">ScheduledExecutorService</span> <span class="variable">scheduledExecutorService</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">        scheduledExecutorService.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">            <span class="type">ThreadMXBean</span> <span class="variable">threadBean</span> <span class="operator">=</span> ManagementFactory.getThreadMXBean();</span><br><span class="line">            ThreadInfo[] threadInfo = threadBean.dumpAllThreads(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            updateMaxThreadNum(threadInfo.length);</span><br><span class="line">        &#125;, <span class="number">10</span>, <span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// è™šæ‹Ÿçº¿ç¨‹</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span>  Executors.newVirtualThreadPerTaskExecutor();</span><br><span class="line">        <span class="comment">// ä½¿ç”¨å¹³å°çº¿ç¨‹</span></span><br><span class="line">        <span class="comment">// ExecutorService executor =  Executors.newFixedThreadPool(200);</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            executor.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// çº¿ç¨‹ç¡çœ  0.5 sï¼Œæ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†</span></span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        executor.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;maxï¼š&quot;</span> + list.get(<span class="number">0</span>) + <span class="string">&quot; platform thread/os thread&quot;</span>);</span><br><span class="line">        System.out.printf(<span class="string">&quot;totalMillisï¼š%dms\n&quot;</span>, System.currentTimeMillis() - start);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ›´æ–°åˆ›å»ºçš„å¹³å°æœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">updateMaxThreadNum</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (list.isEmpty()) &#123;</span><br><span class="line">            list.add(num);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> list.get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (num &gt; integer) &#123;</span><br><span class="line">                list.add(<span class="number">0</span>, num);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¯·æ±‚æ•° 10000 å•è¯·æ±‚è€—æ—¶ 1s</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// Virtual Thread</span><br><span class="line">maxï¼š22 platform thread/os thread</span><br><span class="line">totalMillisï¼š1806ms</span><br><span class="line"></span><br><span class="line">// Platform Thread  çº¿ç¨‹æ•°200</span><br><span class="line">maxï¼š209 platform thread/os thread</span><br><span class="line">totalMillisï¼š50578ms</span><br><span class="line"></span><br><span class="line">// Platform Thread  çº¿ç¨‹æ•°500</span><br><span class="line">maxï¼š509 platform thread/os thread</span><br><span class="line">totalMillisï¼š20254ms</span><br><span class="line"></span><br><span class="line">// Platform Thread  çº¿ç¨‹æ•°1000</span><br><span class="line">maxï¼š1009 platform thread/os thread</span><br><span class="line">totalMillisï¼š10214ms</span><br><span class="line"></span><br><span class="line">// Platform Thread  çº¿ç¨‹æ•°2000</span><br><span class="line">maxï¼š2009 platform thread/os thread</span><br><span class="line">totalMillisï¼š5358ms</span><br></pre></td></tr></table></figure>

<p><strong>è¯·æ±‚æ•° 10000 å•è¯·æ±‚è€—æ—¶ 0.5s</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// Virtual Thread</span><br><span class="line">maxï¼š22 platform thread/os thread</span><br><span class="line">totalMillisï¼š1316ms</span><br><span class="line"></span><br><span class="line">// Platform Thread  çº¿ç¨‹æ•°200</span><br><span class="line">maxï¼š209 platform thread/os thread</span><br><span class="line">totalMillisï¼š25619ms</span><br><span class="line"></span><br><span class="line">// Platform Thread  çº¿ç¨‹æ•°500</span><br><span class="line">maxï¼š509 platform thread/os thread</span><br><span class="line">totalMillisï¼š10277ms</span><br><span class="line"></span><br><span class="line">// Platform Thread  çº¿ç¨‹æ•°1000</span><br><span class="line">maxï¼š1009 platform thread/os thread</span><br><span class="line">totalMillisï¼š5197ms</span><br><span class="line"></span><br><span class="line">// Platform Thread  çº¿ç¨‹æ•°2000</span><br><span class="line">maxï¼š2009 platform thread/os thread</span><br><span class="line">totalMillisï¼š2865ms</span><br></pre></td></tr></table></figure>

<ul>
<li>å¯ä»¥çœ‹åˆ°åœ¨å¯†é›† IO çš„åœºæ™¯ä¸‹ï¼Œéœ€è¦åˆ›å»ºå¤§é‡çš„å¹³å°çº¿ç¨‹å¼‚æ­¥å¤„ç†æ‰èƒ½è¾¾åˆ°è™šæ‹Ÿçº¿ç¨‹çš„å¤„ç†é€Ÿåº¦ã€‚</li>
<li>å› æ­¤ï¼Œåœ¨å¯†é›† IO çš„åœºæ™¯ï¼Œè™šæ‹Ÿçº¿ç¨‹å¯ä»¥å¤§å¹…æé«˜çº¿ç¨‹çš„æ‰§è¡Œæ•ˆç‡ï¼Œå‡å°‘çº¿ç¨‹èµ„æºçš„åˆ›å»ºä»¥åŠä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li>
</ul>
<p><strong>æ³¨æ„</strong>ï¼šæœ‰æ®µæ—¶é—´ JDK ä¸€ç›´è‡´åŠ›äº Reactor å“åº”å¼ç¼–ç¨‹æ¥æé«˜ Java æ€§èƒ½ï¼Œä½†å“åº”å¼ç¼–ç¨‹éš¾ä»¥ç†è§£ã€è°ƒè¯•ã€ä½¿ç”¨ï¼Œæœ€ç»ˆåˆå›åˆ°äº†åŒæ­¥ç¼–ç¨‹ï¼Œæœ€ç»ˆè™šæ‹Ÿçº¿ç¨‹è¯ç”Ÿã€‚</p>
<h2 id="è™šæ‹Ÿçº¿ç¨‹çš„åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#è™šæ‹Ÿçº¿ç¨‹çš„åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="è™šæ‹Ÿçº¿ç¨‹çš„åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"></a>è™šæ‹Ÿçº¿ç¨‹çš„åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>å¦‚æœä½ æƒ³è¦è¯¦ç»†äº†è§£è™šæ‹Ÿçº¿ç¨‹å®ç°åŸç†ï¼Œæ¨èä¸€ç¯‡æ–‡ç« ï¼š<a href="https://www.cnblogs.com/throwable/p/16758997.html">è™šæ‹Ÿçº¿ç¨‹ - VirtualThread æºç é€è§†</a>ã€‚</p>
<p>é¢è¯•ä¸€èˆ¬æ˜¯ä¸ä¼šé—®åˆ°è¿™ä¸ªé—®é¢˜çš„ï¼Œä»…ä¾›å­¦æœ‰ä½™åŠ›çš„åŒå­¦è¿›ä¸€æ­¥ç ”ç©¶å­¦ä¹ ã€‚</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/11/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">240</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">38</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/JayVae" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/shi-hai-jie-35" target="_blank" title="Zhihu">
                      
                        <i class="fa fa-fw fa-globe"></i>Zhihu</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="wechat" target="_blank" title="Wechat">
                      
                        <i class="fa fa-fw fa-globe"></i>Wechat</a>
                  </span>
                
            </div>
          

		  <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=554191378&auto=1&height=66"></iframe>
		  
          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">å²æµ·æ°</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">712.5k</span>
  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    







  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("SWULgkVHBjhFp99nBHCr8oHC-gzGzoHsz", "DQQN5XsGzlq3PIf1OSvGvoRR");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
